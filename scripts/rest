#!/bin/bash
# servicesç›®å½•é‡ç»„è„šæœ¬
# ä»»åŠ¡008: AR Backend ä¸­æœŸä¼˜åŒ– - servicesç›®å½•é‡ç»„

set -e

PROJECT_DIR="/workspaces/yl-ar-dgn/AR-backend"
SERVICES_DIR="$PROJECT_DIR/services"
BACKUP_DIR="$PROJECT_DIR/services.backup.$(date +%Y%m%d_%H%M%S)"

echo "=========================================="
echo "  AR Backend Services ç›®å½•é‡ç»„"
echo "=========================================="
echo ""

# æ­¥éª¤1: å¤‡ä»½åŽŸç›®å½•
echo "ðŸ“¦ æ­¥éª¤1: å¤‡ä»½åŽŸç›®å½•"
echo "-------------------------------------------"
cp -r "$SERVICES_DIR" "$BACKUP_DIR"
echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
echo "å¤§å°: $(du -sh "$BACKUP_DIR" | cut -f1)"
echo ""

# æ­¥éª¤2: åˆ›å»ºæ–°ç›®å½•ç»“æž„
echo "ðŸ“ æ­¥éª¤2: åˆ›å»ºæ–°ç›®å½•ç»“æž„"
echo "-------------------------------------------"

# åˆ›å»ºä¸»ç›®å½•
mkdir -p "$SERVICES_DIR/core"
mkdir -p "$SERVICES_DIR/face/detection"
mkdir -p "$SERVICES_DIR/face/recognition"
mkdir -p "$SERVICES_DIR/face/synthesis"
mkdir -p "$SERVICES_DIR/pipeline/inference_engine"
mkdir -p "$SERVICES_DIR/pipeline/video_processor"
mkdir -p "$SERVICES_DIR/monitor/performance"
mkdir -p "$SERVICES_DIR/monitor/resource"
mkdir -p "$SERVICES_DIR/monitor/system"
mkdir -p "$SERVICES_DIR/monitor/health"
mkdir -p "$SERVICES_DIR/security"
mkdir -p "$SERVICES_DIR/integration"
mkdir -p "$SERVICES_DIR/utils"

# åˆ›å»º__init__.pyæ–‡ä»¶
touch "$SERVICES_DIR/__init__.py"
touch "$SERVICES_DIR/core/__init__.py"
touch "$SERVICES_DIR/face/__init__.py"
touch "$SERVICES_DIR/face/detection/__init__.py"
touch "$SERVICES_DIR/face/recognition/__init__.py"
touch "$SERVICES_DIR/face/synthesis/__init__.py"
touch "$SERVICES_DIR/pipeline/__init__.py"
touch "$SERVICES_DIR/pipeline/inference_engine/__init__.py"
touch "$SERVICES_DIR/monitor/__init__.py"
touch "$SERVICES_DIR/monitor/performance/__init__.py"
touch "$SERVICES_DIR/monitor/resource/__init__.py"
touch "$SERVICES_DIR/monitor/system/__init__.py"
touch "$SERVICES_DIR/monitor/health/__init__.py"
touch "$SERVICES_DIR/security/__init__.py"
touch "$SERVICES_DIR/integration/__init__.py"
touch "$SERVICES_DIR/utils/__init__.py"

echo "âœ… æ–°ç›®å½•ç»“æž„åˆ›å»ºå®Œæˆ"
echo ""

# æ­¥éª¤3: ç§»åŠ¨æ–‡ä»¶
echo "ðŸ“¦ æ­¥éª¤3: ç§»åŠ¨æ–‡ä»¶"
echo "-------------------------------------------"

# æ ¸å¿ƒæœåŠ¡
echo "  ç§»åŠ¨ core æœåŠ¡..."
cp "$SERVICES_DIR/health_check.py" "$SERVICES_DIR/core/health_check.py" 2>/dev/null || true
cp "$SERVICES_DIR/config_service.py" "$SERVICES_DIR/core/config_service.py" 2>/dev/null || true

# äººè„¸æ£€æµ‹
echo "  ç§»åŠ¨ face_detection..."
cp "$SERVICES_DIR/face_detection_processor.py" "$SERVICES_DIR/face/detection/processor.py" 2>/dev/null || true

# äººè„¸è¯†åˆ«
echo "  ç§»åŠ¨ face_recognition..."
cp "$SERVICES_DIR/face_recognition_processor.py" "$SERVICES_DIR/face/recognition/processor.py" 2>/dev/null || true

# äººè„¸åˆæˆ
echo "  ç§»åŠ¨ face_live_cam..."
cp "$SERVICES_DIR/face_live_cam.py" "$SERVICES_DIR/face/synthesis/live_cam.py" 2>/dev/null || true

# ç›‘æŽ§æ¨¡å—
echo "  ç§»åŠ¨ monitor..."
cp "$SERVICES_DIR/performance_collector.py" "$SERVICES_DIR/monitor/performance/collector.py" 2>/dev/null || true
cp "$SERVICES_DIR/performance_optimizer.py" "$SERVICES_DIR/monitor/performance/optimizer.py" 2>/dev/null || true
cp "$SERVICES_DIR/resource_monitor.py" "$SERVICES_DIR/monitor/resource/monitor.py" 2>/dev/null || true
cp "$SERVICES_DIR/system_monitor_service.py" "$SERVICES_DIR/monitor/system/service.py" 2>/dev/null || true
cp "$SERVICES_DIR/health_check_service.py" "$SERVICES_DIR/monitor/health/service.py" 2>/dev/null || true

# å®‰å…¨æ¨¡å—
echo "  ç§»åŠ¨ security..."
cp "$SERVICES_DIR/auth.py" "$SERVICES_DIR/security/auth.py" 2>/dev/null || true
cp "$SERVICES_DIR/rbac.py" "$SERVICES_DIR/security/rbac.py" 2>/dev/null || true
cp "$SERVICES_DIR/audit.py" "$SERVICES_DIR/security/audit.py" 2>/dev/null || true
cp "$SERVICES_DIR/security_manager.py" "$SERVICES_DIR/security/manager.py" 2>/dev/null || true

# é›†æˆæ¨¡å—
echo "  ç§»åŠ¨ integration..."
cp "$SERVICES_DIR/faceswap_module.py" "$SERVICES_DIR/integration/faceswap.py" 2>/dev/null || true
cp "$SERVICES_DIR/deep_face_lab.py" "$SERVICES_DIR/integration/deep_face_lab.py" 2>/dev/null || true
cp "$SERVICES_DIR/obs_virtual_camera.py" "$SERVICES_DIR/integration/obs_camera.py" 2>/dev/null || true

# å·¥å…·æ¨¡å—
echo "  ç§»åŠ¨ utils..."
cp "$SERVICES_DIR/cache_manager_service.py" "$SERVICES_DIR/utils/cache_manager.py" 2>/dev/null || true
cp "$SERVICES_DIR/notification_service.py" "$SERVICES_DIR/utils/notification.py" 2>/dev/null || true
cp "$SERVICES_DIR/deployment_tracker_service.py" "$SERVICES_DIR/utils/deployment_tracker.py" 2>/dev/null || true

echo "âœ… æ–‡ä»¶ç§»åŠ¨å®Œæˆ"
echo ""

# æ­¥éª¤4: åˆ é™¤åŽŸæ–‡ä»¶å’Œç©ºç›®å½•
echo "ðŸ—‘ï¸ æ­¥éª¤4: æ¸…ç†åŽŸæ–‡ä»¶"
echo "-------------------------------------------"

# åˆ é™¤åŽŸpyæ–‡ä»¶
rm -f "$SERVICES_DIR/health_check.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/config_service.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/face_detection_processor.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/face_recognition_processor.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/face_live_cam.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/performance_collector.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/performance_optimizer.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/resource_monitor.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/system_monitor_service.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/health_check_service.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/auth.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/rbac.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/audit.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/security_manager.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/faceswap_module.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/deep_face_lab.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/obs_virtual_camera.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/cache_manager_service.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/notification_service.py" 2>/dev/null || true
rm -f "$SERVICES_DIR/deployment_tracker_service.py" 2>/dev/null || true

# åˆ é™¤ç©ºå­ç›®å½•
rm -rf "$SERVICES_DIR/adaptive_optimizer" 2>/dev/null || true
rm -rf "$SERVICES_DIR/deploy" 2>/dev/null || true
rm -rf "$SERVICES_DIR/display_manager" 2>/dev/null || true
rm -rf "$SERVICES_DIR/face_alignment" 2>/dev/null || true
rm -rf "$SERVICES_DIR/face_blender" 2>/dev/null || true
rm -rf "$SERVICES_DIR/face_detection" 2>/dev/null || true
rm -rf "$SERVICES_DIR/face_recognition" 2>/dev/null || true
rm -rf "$SERVICES_DIR/face_synthesis" 2>/dev/null || true
rm -rf "$SERVICES_DIR/health" 2>/dev/null || true
rm -rf "$SERVICES_DIR/inference_engine" 2>/dev/null || true
rm -rf "$SERVICES_DIR/logging" 2>/dev/null || true
rm -rf "$SERVICES_DIR/model_loader" 2>/dev/null || true
rm -rf "$SERVICES_DIR/model_manager" 2>/dev/null || true
rm -rf "$SERVICES_DIR/monitor" 2>/dev/null || true
rm -rf "$SERVICES_DIR/output_processor" 2>/dev/null || true
rm -rf "$SERVICES_DIR/performance_monitor" 2>/dev/null || true
rm -rf "$SERVICES_DIR/pipeline" 2>/dev/null || true
rm -rf "$SERVICES_DIR/recorder" 2>/dev/null || true
rm -rf "$SERVICES_DIR/resource_manager" 2>/dev/null || true
rm -rf "$SERVICES_DIR/security" 2>/dev/null || true
rm -rf "$SERVICES_DIR/system_integrator" 2>/dev/null || true
rm -rf "$SERVICES_DIR/video_pipeline" 2>/dev/null || true
rm -rf "$SERVICES_DIR/video_stream" 2>/dev/null || true
rm -rf "$SERVICES_DIR/workflow_manager" 2>/dev/null || true

echo "âœ… æ¸…ç†å®Œæˆ"
echo ""

# æ­¥éª¤5: åˆ›å»ºç»Ÿä¸€å¯¼å‡ºç´¢å¼•
echo "ðŸ“ æ­¥éª¤5: åˆ›å»ºç»Ÿä¸€å¯¼å‡ºç´¢å¼•"
echo "-------------------------------------------"

cat > "$SERVICES_DIR/__init__.py" << 'INITEOF'
"""
AR Backend Services ç»Ÿä¸€å¯¼å‡ºæ¨¡å—

æ­¤æ¨¡å—æä¾›æ‰€æœ‰æœåŠ¡çš„ç»Ÿä¸€å¯¼å…¥æŽ¥å£ã€‚
æŒ‰ç…§åŠŸèƒ½åˆ†ä¸º: core, face, pipeline, monitor, security, integration, utils

ä½¿ç”¨æ–¹å¼:
    from services import HealthCheck
    from services.face.detection import FaceDetector
    from services.monitor.performance import PerformanceCollector

ç‰ˆæœ¬: 2.0.0
æœ€åŽæ›´æ–°: 2026-02-04
"""

__version__ = "2.0.0"
__author__ = "AI ç¼–ç¨‹ä»£ç†"

# Core services
try:
    from .core.health_check import HealthCheck
    from .core.config_service import ConfigService
except ImportError:
    pass

# Face services
try:
    from .face.detection.processor import FaceDetector
    from .face.recognition.processor import FaceRecognizer
    from .face.synthesis.live_cam import FaceLiveCam
except ImportError:
    pass

# Pipeline services
try:
    from .pipeline.frame_buffer import FrameBuffer
    from .pipeline.inference_engine import InferenceEngine
    from .pipeline.video_pipeline import VideoPipeline
    from .pipeline.output_processor import OutputProcessor
except ImportError:
    pass

# Monitor services
try:
    from .monitor.performance.performance_collector import PerformanceCollector
    from .monitor.performance.performance_optimizer import PerformanceOptimizer
    from .monitor.resource.monitor import ResourceMonitor
    from .monitor.system.service import SystemMonitorService
    from .monitor.health.service import HealthService
except ImportError:
    pass

# Security services
try:
    from .security.auth import AuthService
    from .security.rbac import RBACService
    from .security.audit import AuditService
    from .security.manager import SecurityManager
except ImportError:
    pass

# Integration services
try:
    from .integration.faceswap import FaceSwapIntegration
    from .integration.deep_face_lab import DeepFaceLabIntegration
    from .integration.obs_camera import OBSCameraIntegration
except ImportError:
    pass

# Utils services
try:
    from .utils.cache_manager import CacheManager
    from .utils.notification import NotificationService
    from .utils.deployment_tracker import DeploymentTracker
except ImportError:
    pass

# å¯¼å‡ºåˆ—è¡¨
__all__ = [
    # Core
    "HealthCheck",
    "ConfigService",
    
    # Face
    "FaceDetector",
    "FaceRecognizer",
    "FaceLiveCam",
    
    # Pipeline
    "FrameBuffer",
    "InferenceEngine",
    "VideoPipeline",
    "OutputProcessor",
    
    # Monitor
    "PerformanceCollector",
    "PerformanceOptimizer",
    "ResourceMonitor",
    "SystemMonitorService",
    "HealthService",
    
    # Security
    "AuthService",
    "RBACService",
    "AuditService",
    "SecurityManager",
    
    # Integration
    "FaceSwapIntegration",
    "DeepFaceLabIntegration",
    "OBSCameraIntegration",
    
    # Utils
    "CacheManager",
    "NotificationService",
    "DeploymentTracker",
]
INITEOF

echo "âœ… ç»Ÿä¸€å¯¼å‡ºç´¢å¼•åˆ›å»ºå®Œæˆ"
echo ""

# æ­¥éª¤6: æ˜¾ç¤ºæ–°ç»“æž„
echo "ðŸ“Š æ–°ç›®å½•ç»“æž„"
echo "-------------------------------------------"
find "$SERVICES_DIR" -type f -name "*.py" | head -50
echo ""

echo "âœ… é‡ç»„å®Œæˆ!"
echo ""
echo "=========================================="
echo "  é‡ç»„æ‘˜è¦"
echo "=========================================="
echo ""
echo "ðŸ“¦ å¤‡ä»½ä½ç½®: $BACKUP_DIR"
echo "ðŸ“ æ–°ç»“æž„ä½ç½®: $SERVICES_DIR"
echo ""
echo "æ–°ç›®å½•ç»“æž„:"
find "$SERVICES_DIR" -type d | sort
echo ""
echo "âœ… å¯ä½¿ç”¨å›žæ»šè„šæœ¬æ¢å¤:"
echo "   cp -rf $BACKUP_DIR/* $SERVICES_DIR/"
