{
  "name": "L3 约束层",
  "description": "技术/运维/资源约束 + 分成熟度 Gate（先宽松可跑，后逐步收紧）",
  "version": "1.2.0",
  "lastUpdated": "2026-02-16",
  "deploymentStatus": {
    "phase1": {
      "name": "监控整合",
      "status": "completed",
      "completedDate": "2026-02-16",
      "constraintsValidated": [
        "entrypoints-consistency",
        "logs-structure",
        "timeout"
      ]
    },
    "phase2": {
      "name": "User GUI优化",
      "status": "completed",
      "completedDate": "2026-02-16",
      "constraintsValidated": [
        "entrypoints-consistency",
        "script-contract",
        "secrets"
      ]
    },
    "phase3": {
      "name": "规则架构部署",
      "status": "in_progress",
      "progress": "60%",
      "constraintsValidated": [
        "api-map-registry"
      ],
      "constraintsPending": [
        "process-supervision",
        "cpu-memory"
      ]
    }
  },
  "constraints": {
    "technical": [
      {
        "id": "python-version",
        "rule": "Python 版本建议 >= 3.8（依赖栈与类型提示需求）",
        "enforcement": "recommended"
      },
      {
        "id": "entrypoints-consistency",
        "rule": "每个模块必须至少有 1 个可用入口（可执行、路径正确、README 指向一致）",
        "enforcement": "mandatory",
        "minMaturity": 1,
        "status": "validated",
        "validatedDate": "2026-02-16",
        "notes": "阶段1&2完成：YL-monitor(5500), AR-backend(5501), User GUI(5502)入口已验证"
      },
      {
        "id": "script-contract",
        "rule": "scripts/ 中被路由/服务引用的脚本必须存在且命名一致",
        "enforcement": "mandatory",
        "minMaturity": 2,
        "status": "validated",
        "validatedDate": "2026-02-16",
        "notes": "阶段2完成：yl-ar-dgn.sh统一入口已创建，所有脚本可访问"
      },
      {
        "id": "api-map-registry",
        "rule": "api-map/registry.json 必须能表达环境地址、服务端点与能力",
        "enforcement": "mandatory",
        "minMaturity": 3,
        "status": "validated",
        "validatedDate": "2026-02-16",
        "notes": "阶段1完成：五层监控端点已注册 /api/v1/monitor/*"
      },
      {
        "id": "monitoring-endpoints",
        "rule": "所有核心服务必须提供HTTP健康检查端点（/health, /status）",
        "enforcement": "mandatory",
        "minMaturity": 2,
        "status": "validated",
        "validatedDate": "2026-02-16",
        "notes": "阶段1完成：YL-monitor(5500), AR-backend(5501), User GUI(5502)健康端点已验证"
      },
      {
        "id": "path-manager",
        "rule": "跨模块引用必须通过统一路径管理器，禁止硬编码相对路径",
        "enforcement": "mandatory",
        "minMaturity": 2,
        "status": "validated",
        "validatedDate": "2026-02-16",
        "notes": "阶段2完成：user/core/path_manager.py已创建并验证"
      }
    ],
    "operational": [
      {
        "id": "logs-structure",
        "rule": "所有模块日志必须落在 logs/ 子目录并有 README 说明",
        "enforcement": "mandatory",
        "minMaturity": 2,
        "status": "validated",
        "validatedDate": "2026-02-16",
        "notes": "阶段1&2完成：所有组件日志目录已配置并验证"
      },
      {
        "id": "secrets",
        "rule": "敏感信息不得提交仓库；通过环境变量或本地配置注入",
        "enforcement": "critical",
        "minMaturity": 1,
        "status": "validated",
        "validatedDate": "2026-02-16",
        "notes": "阶段2完成：配置管理已统一，敏感信息通过环境变量注入"
      },
      {
        "id": "process-supervision",
        "rule": "关键服务需具备进程守护（systemd/supervisord 或容器编排）",
        "enforcement": "mandatory",
        "minMaturity": 3,
        "status": "pending",
        "notes": "阶段4计划：将配置systemd服务文件"
      },
      {
        "id": "quick-ops-scripts",
        "rule": "必须提供一键启动/停止/状态检查脚本，简化日常运维",
        "enforcement": "mandatory",
        "minMaturity": 2,
        "status": "validated",
        "validatedDate": "2026-02-16",
        "notes": "优化建议实施：start-all.sh, stop-all.sh, check-status.sh已创建"
      }
    ],
    "resource": [
      {
        "id": "timeout",
        "rule": "脚本/接口默认超时 <= 30 秒（可按白名单放宽）",
        "enforcement": "strict",
        "minMaturity": 1,
        "status": "validated",
        "validatedDate": "2026-02-16",
        "notes": "所有服务健康检查超时设置为5秒"
      },
      {
        "id": "cpu-memory",
        "rule": "CPU/内存利用率阈值需要可观测（告警阈值可先建议后强制）",
        "enforcement": "monitoring",
        "minMaturity": 3,
        "status": "pending",
        "notes": "阶段4计划：集成五层监控架构后实现资源告警"
      },
      {
        "id": "port-allocation",
        "rule": "服务端口必须按规范分配（5500-5509），避免冲突",
        "enforcement": "mandatory",
        "minMaturity": 1,
        "status": "validated",
        "validatedDate": "2026-02-16",
        "notes": "阶段1完成：YL-monitor(5500), AR-backend(5501), User GUI(5502)端口已分配"
      }
    ]
  },
  "rules": [
    {
      "id": "deploy-requires-constraints-check",
      "condition": { "field": "action", "operator": "contains", "value": "deploy" },
      "action": { "target": "validate", "value": "constraints" },
      "description": "部署动作默认触发约束校验"
    },
    {
      "id": "phase1-constraints-passed",
      "condition": { "field": "phase", "operator": "equals", "value": "1" },
      "action": { "target": "validate", "value": ["entrypoints-consistency", "monitoring-endpoints", "port-allocation"] },
      "description": "阶段1必须通过入口一致性、监控端点、端口分配约束校验"
    },
    {
      "id": "phase2-constraints-passed",
      "condition": { "field": "phase", "operator": "equals", "value": "2" },
      "action": { "target": "validate", "value": ["script-contract", "path-manager", "logs-structure", "secrets"] },
      "description": "阶段2必须通过脚本契约、路径管理、日志结构、安全约束校验"
    },
    {
      "id": "phase3-constraints-passed",
      "condition": { "field": "phase", "operator": "equals", "value": "3" },
      "action": { "target": "validate", "value": ["api-map-registry", "quick-ops-scripts"] },
      "description": "阶段3必须通过API注册表、快速运维脚本约束校验"
    }
  ]
}
