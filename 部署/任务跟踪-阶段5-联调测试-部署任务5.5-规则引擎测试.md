# Phase 5 - Task 5.5: Rule Engine Testing - Detailed Deployment Document

**Task ID:** 5.5  
**Task Name:** Rule Engine Testing  
**Priority:** P1 (High)  
**Estimated Hours:** 2 hours  
**Status:** Pending  
**Prerequisites:** Task 5.4 completed

---

## I. Task Objectives

Test the rule engine to ensure all L1-L5 rules are correctly loaded, validated, and executed.

## II. Test Scenarios

### 2.1 Test Coverage

| Layer | Test Case | Expected Result |
|-------|-----------|---------------|
| L1 | Load goals | Goals loaded correctly |
| L2 | Load context | Context loaded correctly |
| L3 | Check constraints | Constraints validated |
| L4 | Execute decision | Decision executed |
| L5 | Run procedure | Procedure completed |
| All | Validate all | All rules valid |

## III. Deployment Content

### 3.1 Rule Engine Test

#### File: test/integration/test_rules_engine.py

```python
#!/usr/bin/env python3
"""
Rule Engine Integration Tests
"""

import unittest
import sys
from pathlib import Path


class TestRuleEngineLoading(unittest.TestCase):
    """
    Test rule engine loading
    """

    def setUp(self):
        # Add rules to path
        rules_dir = Path(__file__).parent.parent.parent / 'rules'
        sys.path.insert(0, str(rules_dir))

    def test_import_rule_engine(self):
        """Test rule engine can be imported"""
        try:
            from engine import RuleEngine
            self.assertTrue(True)
        except ImportError as e:
            self.fail(f"Cannot import RuleEngine: {e}")

    def test_load_all_rules(self):
        """Test loading all rules"""
        from engine import RuleEngine

        engine = RuleEngine()
        success = engine.load_all_rules()
        self.assertTrue(success)

    def test_get_l1_rules(self):
        """Test getting L1 rules"""
        from engine import RuleEngine

        engine = RuleEngine()
        engine.load_all_rules()

        l1 = engine.get_rule('L1')
        self.assertIsNotNone(l1)
        self.assertEqual(l1.get('layer'), 'L1')

    def test_get_l2_rules(self):
        """Test getting L2 rules"""
        from engine import RuleEngine

        engine = RuleEngine()
        engine.load_all_rules()

        l2 = engine.get_rule('L2')
        self.assertIsNotNone(l2)

    def test_get_l3_rules(self):
        """Test getting L3 rules"""
        from engine import RuleEngine

        engine = RuleEngine()
        engine.load_all_rules()

        l3 = engine.get_rule('L3')
        self.assertIsNotNone(l3)

    def test_get_l4_rules(self):
        """Test getting L4 rules"""
        from engine import RuleEngine

        engine = RuleEngine()
        engine.load_all_rules()

        l4 = engine.get_rule('L4')
        self.assertIsNotNone(l4)

    def test_get_l5_rules(self):
        """Test getting L5 rules"""
        from engine import RuleEngine

        engine = RuleEngine()
        engine.load_all_rules()

        l5 = engine.get_rule('L5')
        self.assertIsNotNone(l5)


class TestRuleValidation(unittest.TestCase):
    """
    Test rule validation
    """

    def test_validate_all_rules(self):
        """Test validating all rules"""
        from engine import RuleEngine

        engine = RuleEngine()
        engine.load_all_rules()

        results = engine.validate_all()
        self.assertIsInstance(results, dict)

        # All layers should be validated
        for layer in ['L1', 'L2', 'L3', 'L4', 'L5']:
            self.assertIn(layer, results)

    def test_l1_validation(self):
        """Test L1 validation"""
        from engine import RuleEngine

        engine = RuleEngine()
        engine.load_all_rules()

        results = engine.validate_all()
        self.assertTrue(results.get('L1', False))

    def test_l2_validation(self):
        """Test L2 validation"""
        from engine import RuleEngine

        engine = RuleEngine()
        engine.load_all_rules()

        results = engine.validate_all()
        self.assertTrue(results.get('L2', False))


class TestRuleExecution(unittest.TestCase):
    """
    Test rule execution
    """

    def test_get_goals(self):
        """Test getting goals from L1"""
        from engine import RuleEngine

        engine = RuleEngine()
        engine.load_all_rules()

        goals = engine.get_goals()
        self.assertIsInstance(goals, list)

    def test_get_context(self):
        """Test getting context from L2"""
        from engine import RuleEngine

        engine = RuleEngine()
        engine.load_all_rules()

        context = engine.get_context()
        self.assertIsInstance(context, dict)

    def test_check_constraints(self):
        """Test checking constraints from L3"""
        from engine import RuleEngine

        engine = RuleEngine()
        engine.load_all_rules()

        constraints = engine.check_constraints()
        self.assertIsInstance(constraints, dict)

    def test_execute_decision(self):
        """Test executing decision from L4"""
        from engine import RuleEngine

        engine = RuleEngine()
        engine.load_all_rules()

        # Try to execute a decision (may not exist)
        result = engine.execute_decision('D1', {})
        self.assertIsInstance(result, dict)

    def test_run_procedure(self):
        """Test running procedure from L5"""
        from engine import RuleEngine

        engine = RuleEngine()
        engine.load_all_rules()

        # Try to run a procedure (may not exist)
        result = engine.run_procedure('E1')
        self.assertIsInstance(result, dict)


class TestRuleIntegration(unittest.TestCase):
    """
    Test rule integration with YL-monitor
    """

    def test_yl_monitor_integration(self):
        """Test YL-monitor rule integration"""
        try:
            from app.rules_integration import get_rules_integration

            integration = get_rules_integration()
            self.assertIsNotNone(integration)
        except ImportError:
            self.skipTest("YL-monitor integration not available")


def run_rule_tests():
    """Run all rule engine tests"""
    loader = unittest.TestLoader()
    suite = unittest.TestSuite()

    suite.addTests(loader.loadTestsFromTestCase(TestRuleEngineLoading))
    suite.addTests(loader.loadTestsFromTestCase(TestRuleValidation))
    suite.addTests(loader.loadTestsFromTestCase(TestRuleExecution))
    suite.addTests(loader.loadTestsFromTestCase(TestRuleIntegration))

    runner = unittest.TextTestRunner(verbosity=2)
    result = runner.run(suite)

    return result.wasSuccessful()


if __name__ == '__main__':
    success = run_rule_tests()
    exit(0 if success else 1)
```

### 3.2 Rule Test Runner

#### File: test/integration/run_rule_tests.sh

```bash
#!/bin/bash
# Run Rule Engine Tests

set -e

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
LOG_FILE="$PROJECT_ROOT/logs/rule_tests_$(date +%Y%m%d_%H%M%S).log"

mkdir -p "$(dirname "$LOG_FILE")"

echo "========================================"
echo "Rule Engine Tests"
echo "Started: $(date)"
echo "========================================"

# Check rule files exist
echo ""
echo "Checking rule files..."

for layer in L1 L2 L3 L4 L5; do
    files=$(find "$PROJECT_ROOT/rules" -name "${layer}-*.json" 2>/dev/null)
    if [ -n "$files" ]; then
        echo "  ✓ $layer rules found"
    else
        echo "  ✗ $layer rules not found"
    fi
done

# Run Python tests
echo ""
echo "Running Python tests..."

cd "$PROJECT_ROOT"
if python3 test/integration/test_rules_engine.py 2>&1 | tee -a "$LOG_FILE"; then
    echo ""
    echo "✓ Rule engine tests passed"
    TEST_RESULT=0
else
    echo ""
    echo "✗ Some rule tests failed"
    TEST_RESULT=1
fi

# Validate rules directly
echo ""
echo "Validating rules directly..."

if [ -f "$PROJECT_ROOT/test/rules/validate_all.py" ]; then
    python3 "$PROJECT_ROOT/test/rules/validate_all.py" 2>&1 | tee -a "$LOG_FILE"
fi

# Summary
echo ""
echo "========================================"
echo "Rule Test Summary"
echo "========================================"
echo "Log file: $LOG_FILE"

exit $TEST_RESULT
```

## IV. Deployment Steps

```bash
# 1. Create rule engine test
# Edit test/integration/test_rules_engine.py

# 2. Create test runner
# Edit test/integration/run_rule_tests.sh

# 3. Make executable
chmod +x test/integration/run_rule_tests.sh

# 4. Run tests
./test/integration/run_rule_tests.sh
```

## V. Verification Checklist

- [ ] Rule engine loads all layers
- [ ] L1 rules accessible
- [ ] L2 rules accessible
- [ ] L3 rules accessible
- [ ] L4 rules accessible
- [ ] L5 rules accessible
- [ ] Validation works
- [ ] Execution works

## VI. Next Step

After completing this task, proceed to **Task 5.6: End-to-End Testing**

View document: `部署/任务跟踪-阶段5-联调测试-部署任务5.6-端到端测试.md`
