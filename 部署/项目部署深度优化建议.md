# YL-AR-DGN é¡¹ç›®éƒ¨ç½²æ·±åº¦ä¼˜åŒ–å»ºè®®

**ç‰ˆæœ¬**: 2.0.0  
**åˆ†ææ—¥æœŸ**: 2026-02-16  
**åˆ†æäºº**: AI å…¨æ ˆæŠ€æœ¯å‘˜

---

## ä¸€ã€å½“å‰é¡¹ç›®ç—›ç‚¹æ·±åº¦åˆ†æ

### 1.1 æ¶æ„å±‚é¢é—®é¢˜

#### ç—›ç‚¹1: ç›‘æ§å™¨ä¸ä¸»åº”ç”¨å‰²è£‚
**ç°çŠ¶åˆ†æ**:
- 15ä¸ªç›‘æ§å™¨å·²å®ç°å¹¶æµ‹è¯•é€šè¿‡
- ä½†ç›‘æ§æ•°æ®ä»…åœ¨ç‹¬ç«‹æµ‹è¯•æ—¶å¯è®¿é—®
- YL-monitorä¸»åº”ç”¨æœªåŠ è½½è¿™äº›ç›‘æ§å™¨

**å…·ä½“å½±å“**:
```bash
# å½“å‰çŠ¶æ€ - ç›‘æ§å™¨æµ‹è¯•å¯ç”¨
$ python3 YL-monitor/app/services/infrastructure_monitor.py
âœ… æµ‹è¯•é€šè¿‡ï¼Œæ•°æ®æ­£å¸¸

# ä½†ä¸»åº”ç”¨æ— æ³•è®¿é—®
$ curl http://0.0.0.0:5500/api/v1/monitor/infrastructure
âŒ 404 Not Found
```

**æ ¹æœ¬åŸå› **:
- `YL-monitor/app/main.py` æœªæ³¨å†Œç›‘æ§è·¯ç”±
- ç¼ºå°‘ç»Ÿä¸€çš„æœåŠ¡æ³¨å†Œæœºåˆ¶

---

#### ç—›ç‚¹2: å¤šç«¯å£ç®¡ç†æ··ä¹±
**ç°çŠ¶åˆ†æ**:
| æœåŠ¡ | ç«¯å£ | çŠ¶æ€ |
|------|------|------|
| YL-monitor | 5500 | âœ… è¿è¡Œä¸­ |
| AR-backend | 5501 | âœ… è¿è¡Œä¸­ |
| User GUI | 5502 | âœ… è¿è¡Œä¸­ |
| ç›‘æ§ç«¯ç‚¹ | - | âŒ æœªç»Ÿä¸€ |

**é—®é¢˜**:
- æ¯ä¸ªæœåŠ¡ç‹¬ç«‹ç®¡ç†ç«¯å£
- æ— ç«¯å£å†²çªæ£€æµ‹æœºåˆ¶
- é…ç½®åˆ†æ•£åœ¨å„ç›®å½•

---

#### ç—›ç‚¹3: é…ç½®ç®¡ç†ç¢ç‰‡åŒ–
**ç°çŠ¶åˆ†æ**:
```
AR-backend/monitor_config.yaml      # åç«¯ç›‘æ§é…ç½®
YL-monitor/config/monitor.yaml      # YLç›‘æ§é…ç½®
user/config/settings.py             # ç”¨æˆ·é…ç½®
config/production.env               # ç¯å¢ƒé…ç½®
```

**é—®é¢˜**:
- é…ç½®æ ¼å¼ä¸ç»Ÿä¸€ï¼ˆYAML/JSON/Pythonï¼‰
- é‡å¤é…ç½®é¡¹ï¼ˆç«¯å£ã€è·¯å¾„ï¼‰
- æ— é…ç½®éªŒè¯æœºåˆ¶

---

### 1.2 è¿ç»´å±‚é¢é—®é¢˜

#### ç—›ç‚¹4: æ—¥å¿—ç®¡ç†ç¼ºå¤±
**ç°çŠ¶åˆ†æ**:
- å„ç»„ä»¶ç‹¬ç«‹è¾“å‡ºæ—¥å¿—
- æ—¥å¿—æ ¼å¼ä¸ç»Ÿä¸€
- æ— æ—¥å¿—èšåˆå’ŒæŸ¥è¯¢

**å½“å‰æ—¥å¿—çŠ¶æ€**:
```bash
# AR-backendæ—¥å¿—
tail -f AR-backend/logs/monitor.log
# æ ¼å¼: [2026-02-16 10:00:00] INFO: Message

# YL-monitoræ—¥å¿—  
tail -f YL-monitor/logs/app.log
# æ ¼å¼: 2026-02-16 10:00:00,123 - INFO - Message

# User GUIæ—¥å¿—
tail -f user/logs/gui.log
# æ ¼å¼: [GUI] 2026-02-16 10:00:00 - Message
```

---

#### ç—›ç‚¹5: æ•…éšœæ¢å¤æœºåˆ¶ç¼ºå¤±
**ç°çŠ¶åˆ†æ**:
- æœåŠ¡å´©æºƒåæ— è‡ªåŠ¨é‡å¯
- ä¾èµ–æœåŠ¡æ•…éšœæ—¶æ— ä¼˜é›…é™çº§
- æ— å¥åº·æ£€æŸ¥è‡ªåŠ¨ä¿®å¤

---

## äºŒã€æ·±åº¦ä¼˜åŒ–æ–¹æ¡ˆ

### 2.1 æ¶æ„ä¼˜åŒ–ï¼šç»Ÿä¸€æœåŠ¡æ³¨å†Œä¸­å¿ƒ

#### æ–¹æ¡ˆï¼šåˆ›å»ºç›‘æ§æœåŠ¡æ³¨å†Œå™¨

**å®ç°ä»£ç **:

```python
# YL-monitor/app/core/monitor_registry.py
"""
ç»Ÿä¸€ç›‘æ§æœåŠ¡æ³¨å†Œä¸­å¿ƒ
è‡ªåŠ¨æ³¨å†Œæ‰€æœ‰ç›‘æ§å™¨åˆ°FastAPIåº”ç”¨
"""

from typing import Dict, List, Type, Any
from fastapi import APIRouter, FastAPI
import importlib
import pkgutil
import logging

logger = logging.getLogger(__name__)


class MonitorRegistry:
    """ç›‘æ§å™¨æ³¨å†Œä¸­å¿ƒ"""
    
    def __init__(self):
        self._monitors: Dict[str, Any] = {}
        self._routers: Dict[str, APIRouter] = {}
        self._collectors: Dict[str, Any] = {}
    
    def register_monitor(self, name: str, monitor_instance: Any, 
                        router: APIRouter = None):
        """æ³¨å†Œç›‘æ§å™¨"""
        self._monitors[name] = monitor_instance
        if router:
            self._routers[name] = router
        logger.info(f"âœ… ç›‘æ§å™¨å·²æ³¨å†Œ: {name}")
    
    def register_collector(self, name: str, collector_class: Type):
        """æ³¨å†Œé‡‡é›†å™¨"""
        self._collectors[name] = collector_class
        logger.info(f"âœ… é‡‡é›†å™¨å·²æ³¨å†Œ: {name}")
    
    def auto_discover(self, package_path: str = "app.services"):
        """è‡ªåŠ¨å‘ç°ç›‘æ§å™¨"""
        try:
            package = importlib.import_module(package_path)
            for _, name, ispkg in pkgutil.iter_modules(package.__path__):
                if "monitor" in name and not ispkg:
                    try:
                        module = importlib.import_module(f"{package_path}.{name}")
                        # æŸ¥æ‰¾é‡‡é›†å™¨ç±»
                        for attr_name in dir(module):
                            attr = getattr(module, attr_name)
                            if (isinstance(attr, type) and 
                                "Collector" in attr_name and
                                hasattr(attr, "collect")):
                                self.register_collector(attr_name, attr)
                                logger.info(f"ğŸ” è‡ªåŠ¨å‘ç°: {attr_name}")
                    except Exception as e:
                        logger.warning(f"âš ï¸ åŠ è½½å¤±è´¥ {name}: {e}")
        except Exception as e:
            logger.error(f"âŒ è‡ªåŠ¨å‘ç°å¤±è´¥: {e}")
    
    def bind_to_app(self, app: FastAPI, prefix: str = "/api/v1/monitor"):
        """ç»‘å®šåˆ°FastAPIåº”ç”¨"""
        for name, router in self._routers.items():
            app.include_router(router, prefix=prefix)
            logger.info(f"ğŸ”— è·¯ç”±å·²ç»‘å®š: {prefix}/{name}")
        
        # æ·»åŠ ç»Ÿä¸€ç›‘æ§ç«¯ç‚¹
        @app.get(f"{prefix}/overview")
        async def get_monitoring_overview():
            """è·å–æ‰€æœ‰ç›‘æ§å±‚æ¦‚è§ˆ"""
            return {
                "layers": {
                    "L1_infrastructure": self._get_layer_status("infrastructure"),
                    "L2_system_resources": self._get_layer_status("system_resources"),
                    "L3_application": self._get_layer_status("application"),
                    "L4_business": self._get_layer_status("business"),
                    "L5_user_experience": self._get_layer_status("user_experience")
                },
                "total_monitors": len(self._monitors),
                "total_collectors": len(self._collectors),
                "timestamp": datetime.now().isoformat()
            }
        
        logger.info(f"âœ… ç›‘æ§ä¸­å¿ƒå·²ç»‘å®šåˆ°åº”ç”¨")
    
    def _get_layer_status(self, layer_name: str) -> dict:
        """è·å–æŒ‡å®šå±‚çŠ¶æ€"""
        # ä»å·²æ³¨å†Œçš„ç›‘æ§å™¨è·å–çŠ¶æ€
        if layer_name in self._monitors:
            monitor = self._monitors[layer_name]
            return {
                "status": "active",
                "last_update": getattr(monitor, 'last_update', None),
                "metrics_count": getattr(monitor, 'metrics_count', 0)
            }
        return {"status": "inactive"}


# å…¨å±€æ³¨å†Œä¸­å¿ƒå®ä¾‹
monitor_registry = MonitorRegistry()
```

**ä½¿ç”¨æ–¹å¼**:

```python
# YL-monitor/app/main.py ä¿®æ”¹
from app.core.monitor_registry import monitor_registry
from app.api.v1.monitor import (
    infrastructure,
    system_resources,
    application,
    business,
    user_experience
)

# åˆ›å»ºåº”ç”¨
app = FastAPI(title="YL-Monitor", version="1.0.0")

# æ³¨å†Œç›‘æ§å™¨
monitor_registry.register_monitor(
    "infrastructure", 
    infrastructure.infra_collector,
    infrastructure.router
)
monitor_registry.register_monitor(
    "system_resources",
    system_resources.resource_collector,
    system_resources.router
)
monitor_registry.register_monitor(
    "application",
    application.app_collector,
    application.router
)
monitor_registry.register_monitor(
    "business",
    business.business_collector,
    business.router
)
monitor_registry.register_monitor(
    "user_experience",
    user_experience.ux_collector,
    user_experience.router
)

# ç»‘å®šåˆ°åº”ç”¨
monitor_registry.bind_to_app(app)

# å¯é€‰ï¼šè‡ªåŠ¨å‘ç°
# monitor_registry.auto_discover("app.services")
```

---

### 2.2 é…ç½®ä¼˜åŒ–ï¼šç»Ÿä¸€é…ç½®ä¸­å¿ƒ

#### æ–¹æ¡ˆï¼šåˆ›å»ºåˆ†å±‚é…ç½®ç³»ç»Ÿ

**å®ç°ä»£ç **:

```python
# config/manager.py
"""
ç»Ÿä¸€é…ç½®ç®¡ç†ä¸­å¿ƒ
æ”¯æŒç¯å¢ƒè¦†ç›–ã€é…ç½®éªŒè¯ã€çƒ­é‡è½½
"""

import os
import yaml
import json
from typing import Dict, Any, Optional
from pathlib import Path
from dataclasses import dataclass, field
from datetime import datetime


@dataclass
class ServiceConfig:
    """æœåŠ¡é…ç½®"""
    name: str
    host: str = "0.0.0.0"
    port: int = 5500
    enabled: bool = True
    health_check_interval: int = 30
    timeout: int = 5


@dataclass
class MonitoringConfig:
    """ç›‘æ§é…ç½®"""
    enabled: bool = True
    collection_interval: int = 5  # ç§’
    retention_days: int = 30
    alert_thresholds: Dict[str, Any] = field(default_factory=dict)


@dataclass
class DatabaseConfig:
    """æ•°æ®åº“é…ç½®"""
    type: str = "sqlite"  # sqlite/postgresql
    host: str = "0.0.0.0"
    port: int = 5432
    database: str = "yl_monitor"
    username: str = ""
    password: str = ""
    pool_size: int = 10


class ConfigManager:
    """é…ç½®ç®¡ç†å™¨"""
    
    _instance = None
    
    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
            cls._instance._initialized = False
        return cls._instance
    
    def __init__(self):
        if self._initialized:
            return
        
        self._config: Dict[str, Any] = {}
        self._services: Dict[str, ServiceConfig] = {}
        self._monitoring: MonitoringConfig = MonitoringConfig()
        self._database: DatabaseConfig = DatabaseConfig()
        self._config_path: Optional[Path] = None
        self._last_load_time: Optional[datetime] = None
        
        self._initialized = True
    
    def load(self, config_path: str = "config/monitoring.yaml"):
        """åŠ è½½é…ç½®"""
        self._config_path = Path(config_path)
        
        # 1. åŠ è½½åŸºç¡€é…ç½®
        if self._config_path.exists():
            with open(self._config_path, 'r', encoding='utf-8') as f:
                self._config = yaml.safe_load(f) or {}
        else:
            self._config = self._get_default_config()
        
        # 2. ç¯å¢ƒå˜é‡è¦†ç›–
        self._apply_env_overrides()
        
        # 3. è§£æé…ç½®å¯¹è±¡
        self._parse_config()
        
        self._last_load_time = datetime.now()
        print(f"âœ… é…ç½®å·²åŠ è½½: {config_path}")
        return self
    
    def _get_default_config(self) -> Dict:
        """è·å–é»˜è®¤é…ç½®"""
        return {
            "services": {
                "yl-monitor": {
                    "host": "0.0.0.0",
                    "port": 5500,
                    "enabled": True
                },
                "ar-backend": {
                    "host": "0.0.0.0",
                    "port": 5501,
                    "enabled": True,
                    "health_check_interval": 30
                },
                "user-gui": {
                    "host": "0.0.0.0",
                    "port": 5502,
                    "enabled": True,
                    "health_check_interval": 30
                }
            },
            "monitoring": {
                "enabled": True,
                "collection_interval": 5,
                "retention_days": 30,
                "alert_thresholds": {
                    "cpu_usage": 80,
                    "memory_usage": 85,
                    "disk_usage": 90,
                    "api_response_time": 1000
                }
            },
            "database": {
                "type": "sqlite",
                "database": "data/monitoring.db"
            },
            "logging": {
                "level": "INFO",
                "format": "%(asctime)s - %(name)s - %(levelname)s - %(message)s",
                "file": "logs/monitoring.log",
                "max_size": "10MB",
                "backup_count": 5
            }
        }
    
    def _apply_env_overrides(self):
        """åº”ç”¨ç¯å¢ƒå˜é‡è¦†ç›–"""
        env_mappings = {
            "YL_MONITOR_HOST": ["services", "yl-monitor", "host"],
            "YL_MONITOR_PORT": ["services", "yl-monitor", "port"],
            "AR_BACKEND_HOST": ["services", "ar-backend", "host"],
            "AR_BACKEND_PORT": ["services", "ar-backend", "port"],
            "USER_GUI_HOST": ["services", "user-gui", "host"],
            "USER_GUI_PORT": ["services", "user-gui", "port"],
            "DB_TYPE": ["database", "type"],
            "DB_HOST": ["database", "host"],
            "DB_PORT": ["database", "port"],
            "DB_NAME": ["database", "database"],
            "LOG_LEVEL": ["logging", "level"],
            "MONITORING_INTERVAL": ["monitoring", "collection_interval"],
        }
        
        for env_var, path in env_mappings.items():
            value = os.getenv(env_var)
            if value:
                # ç±»å‹è½¬æ¢
                if path[-1] == "port" or path[-1] == "interval":
                    value = int(value)
                elif path[-1] == "enabled":
                    value = value.lower() == "true"
                
                # è®¾ç½®å€¼
                target = self._config
                for key in path[:-1]:
                    target = target.setdefault(key, {})
                target[path[-1]] = value
                print(f"ğŸ”§ ç¯å¢ƒå˜é‡è¦†ç›–: {env_var}={value}")
    
    def _parse_config(self):
        """è§£æé…ç½®åˆ°å¯¹è±¡"""
        # è§£ææœåŠ¡é…ç½®
        services = self._config.get("services", {})
        for name, cfg in services.items():
            self._services[name] = ServiceConfig(
                name=name,
                host=cfg.get("host", "0.0.0.0"),
                port=cfg.get("port", 5500),
                enabled=cfg.get("enabled", True),
                health_check_interval=cfg.get("health_check_interval", 30),
                timeout=cfg.get("timeout", 5)
            )
        
        # è§£æç›‘æ§é…ç½®
        monitoring = self._config.get("monitoring", {})
        self._monitoring = MonitoringConfig(
            enabled=monitoring.get("enabled", True),
            collection_interval=monitoring.get("collection_interval", 5),
            retention_days=monitoring.get("retention_days", 30),
            alert_thresholds=monitoring.get("alert_thresholds", {})
        )
        
        # è§£ææ•°æ®åº“é…ç½®
        database = self._config.get("database", {})
        self._database = DatabaseConfig(
            type=database.get("type", "sqlite"),
            host=database.get("host", "0.0.0.0"),
            port=database.get("port", 5432),
            database=database.get("database", "yl_monitor"),
            username=database.get("username", ""),
            password=database.get("password", ""),
            pool_size=database.get("pool_size", 10)
        )
    
    def get_service(self, name: str) -> Optional[ServiceConfig]:
        """è·å–æœåŠ¡é…ç½®"""
        return self._services.get(name)
    
    def get_monitoring(self) -> MonitoringConfig:
        """è·å–ç›‘æ§é…ç½®"""
        return self._monitoring
    
    def get_database(self) -> DatabaseConfig:
        """è·å–æ•°æ®åº“é…ç½®"""
        return self._database
    
    def get(self, path: str, default: Any = None) -> Any:
        """é€šè¿‡è·¯å¾„è·å–é…ç½®å€¼"""
        keys = path.split(".")
        target = self._config
        for key in keys:
            if isinstance(target, dict):
                target = target.get(key)
                if target is None:
                    return default
            else:
                return default
        return target
    
    def save(self):
        """ä¿å­˜é…ç½®åˆ°æ–‡ä»¶"""
        if self._config_path:
            with open(self._config_path, 'w', encoding='utf-8') as f:
                yaml.dump(self._config, f, default_flow_style=False, allow_unicode=True)
            print(f"ğŸ’¾ é…ç½®å·²ä¿å­˜: {self._config_path}")
    
    def reload(self):
        """çƒ­é‡è½½é…ç½®"""
        if self._config_path:
            self.load(str(self._config_path))
            print("ğŸ”„ é…ç½®å·²é‡è½½")
    
    def validate(self) -> List[str]:
        """éªŒè¯é…ç½®æœ‰æ•ˆæ€§"""
        errors = []
        
        # éªŒè¯æœåŠ¡ç«¯å£å†²çª
        ports = {}
        for name, service in self._services.items():
            if service.port in ports:
                errors.append(f"ç«¯å£å†²çª: {name} å’Œ {ports[service.port]} éƒ½ä½¿ç”¨ç«¯å£ {service.port}")
            else:
                ports[service.port] = name
        
        # éªŒè¯ç›‘æ§é—´éš”
        if self._monitoring.collection_interval < 1:
            errors.append("ç›‘æ§é—´éš”å¿…é¡» >= 1ç§’")
        
        # éªŒè¯æ•°æ®åº“é…ç½®
        if self._database.type not in ["sqlite", "postgresql"]:
            errors.append(f"ä¸æ”¯æŒçš„æ•°æ®åº“ç±»å‹: {self._database.type}")
        
        return errors


# å…¨å±€é…ç½®ç®¡ç†å™¨
config = ConfigManager()
```

**é…ç½®æ–‡ä»¶æ¨¡æ¿**:

```yaml
# config/monitoring.yaml
services:
  yl-monitor:
    host:0.0.0.0
    port: 5500
    enabled: true
  
  ar-backend:
    host:0.0.0.0
    port: 5501
    enabled: true
    health_check_interval: 30
  
  user-gui:
    host:0.0.0.0
    port: 5502
    enabled: true
    health_check_interval: 30

monitoring:
  enabled: true
  collection_interval: 5  # ç§’
  retention_days: 30
  alert_thresholds:
    cpu_usage: 80
    memory_usage: 85
    disk_usage: 90
    api_response_time: 1000  # ms
    fps_drop: 10

database:
  type: sqlite  # sqlite æˆ– postgresql
  database: data/monitoring.db

logging:
  level: INFO
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  file: logs/monitoring.log
  max_size: 10MB
  backup_count: 5
```

---

### 2.3 è¿ç»´ä¼˜åŒ–ï¼šç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ

#### æ–¹æ¡ˆï¼šåˆ›å»ºç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ

**å®ç°ä»£ç **:

```python
# utils/logging_config.py
"""
ç»Ÿä¸€æ—¥å¿—é…ç½®
æ”¯æŒç»“æ„åŒ–æ—¥å¿—ã€æ—¥å¿—è½®è½¬ã€å¤šç›®æ ‡è¾“å‡º
"""

import logging
import logging.handlers
import json
import sys
from datetime import datetime
from pathlib import Path
from typing import Dict, Any, Optional


class StructuredLogFormatter(logging.Formatter):
    """ç»“æ„åŒ–æ—¥å¿—æ ¼å¼å™¨"""
    
    def format(self, record: logging.LogRecord) -> str:
        log_data = {
            "timestamp": datetime.fromtimestamp(record.created).isoformat(),
            "level": record.levelname,
            "logger": record.name,
            "message": record.getMessage(),
            "module": record.module,
            "function": record.funcName,
            "line": record.lineno,
            "thread": record.thread,
        }
        
        # æ·»åŠ é¢å¤–å­—æ®µ
        if hasattr(record, "extra_data"):
            log_data.update(record.extra_data)
        
        # å¼‚å¸¸ä¿¡æ¯
        if record.exc_info:
            log_data["exception"] = self.formatException(record.exc_info)
        
        return json.dumps(log_data, ensure_ascii=False)


class ColoredConsoleFormatter(logging.Formatter):
    """å¸¦é¢œè‰²çš„æ§åˆ¶å°æ ¼å¼å™¨"""
    
    COLORS = {
        "DEBUG": "\033[36m",     # é’è‰²
        "INFO": "\033[32m",      # ç»¿è‰²
        "WARNING": "\033[33m",   # é»„è‰²
        "ERROR": "\033[31m",     # çº¢è‰²
        "CRITICAL": "\033[35m",  # ç´«è‰²
    }
    RESET = "\033[0m"
    
    def format(self, record: logging.LogRecord) -> str:
        color = self.COLORS.get(record.levelname, self.RESET)
        reset = self.RESET
        
        return (
            f"{color}[{record.levelname}]{reset} "
            f"{datetime.fromtimestamp(record.created).strftime('%H:%M:%S')} "
            f"[{record.name}] {record.getMessage()}"
        )


def setup_logging(
    level: str = "INFO",
    log_file: Optional[str] = None,
    max_size: str = "10MB",
    backup_count: int = 5,
    structured: bool = False,
    console_color: bool = True
) -> logging.Logger:
    """è®¾ç½®ç»Ÿä¸€æ—¥å¿—"""
    
    # åˆ›å»ºæ—¥å¿—ç›®å½•
    if log_file:
        log_path = Path(log_file)
        log_path.parent.mkdir(parents=True, exist_ok=True)
    
    # æ ¹æ—¥å¿—å™¨
    root_logger = logging.getLogger()
    root_logger.setLevel(getattr(logging, level.upper()))
    
    # æ¸…é™¤ç°æœ‰å¤„ç†å™¨
    root_logger.handlers.clear()
    
    # æ§åˆ¶å°å¤„ç†å™¨
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setLevel(logging.DEBUG)
    
    if console_color:
        console_formatter = ColoredConsoleFormatter()
    else:
        console_formatter = logging.Formatter(
            "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
        )
    console_handler.setFormatter(console_formatter)
    root_logger.addHandler(console_handler)
    
    # æ–‡ä»¶å¤„ç†å™¨
    if log_file:
        # è§£ææ–‡ä»¶å¤§å°
        size_multipliers = {
            "KB": 1024,
            "MB": 1024 * 1024,
            "GB": 1024 * 1024 * 1024
        }
        max_bytes = 10 * 1024 * 1024  # é»˜è®¤10MB
        for unit, multiplier in size_multipliers.items():
            if max_size.upper().endswith(unit):
                max_bytes = int(max_size[:-2]) * multiplier
                break
        
        file_handler = logging.handlers.RotatingFileHandler(
            log_file,
            maxBytes=max_bytes,
            backupCount=backup_count,
            encoding="utf-8"
        )
        file_handler.setLevel(logging.DEBUG)
        
        if structured:
            file_formatter = StructuredLogFormatter()
        else:
            file_formatter = logging.Formatter(
                "%(asctime)s - %(name)s - %(levelname)s - "
                "[%(module)s:%(lineno)d] - %(message)s"
            )
        file_handler.setFormatter(file_formatter)
        root_logger.addHandler(file_handler)
    
    return root_logger


def get_logger(name: str, extra: Dict[str, Any] = None) -> logging.Logger:
    """è·å–å¸¦ä¸Šä¸‹æ–‡çš„æ—¥å¿—å™¨"""
    logger = logging.getLogger(name)
    
    if extra:
        # åˆ›å»ºé€‚é…å™¨æ·»åŠ é¢å¤–å­—æ®µ
        class ContextAdapter(logging.LoggerAdapter):
            def process(self, msg, kwargs):
                kwargs.setdefault("extra", {}).update(self.extra)
                return msg, kwargs
        
        logger = ContextAdapter(logger, extra)
    
    return logger
```

---

### 2.4 éƒ¨ç½²ä¼˜åŒ–ï¼šä¸€é”®éƒ¨ç½²è„šæœ¬

#### æ–¹æ¡ˆï¼šåˆ›å»ºæ™ºèƒ½éƒ¨ç½²è„šæœ¬

**å®ç°ä»£ç **:

```bash
#!/bin/bash
# scripts/yl-ar-dgn.sh
# YL-AR-DGN é¡¹ç›®ç»Ÿä¸€éƒ¨ç½²ç®¡ç†è„šæœ¬

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# é¡¹ç›®é…ç½®
PROJECT_NAME="YL-AR-DGN"
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
CONFIG_FILE="${PROJECT_ROOT}/config/monitoring.yaml"
LOG_DIR="${PROJECT_ROOT}/logs"
DATA_DIR="${PROJECT_ROOT}/data"

# æœåŠ¡é…ç½®
SERVICES=(
    "yl-monitor:5500:${PROJECT_ROOT}/YL-monitor/start_server.py"
    "ar-backend:5501:${PROJECT_ROOT}/AR-backend/monitor_server.py"
    "user-gui:5502:${PROJECT_ROOT}/user/main.py"
)

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_debug() {
    echo -e "${BLUE}[DEBUG]${NC} $1"
}

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
check_command() {
    if ! command -v "$1" &> /dev/null; then
        log_error "å‘½ä»¤ '$1' æœªæ‰¾åˆ°ï¼Œè¯·å…ˆå®‰è£…"
        exit 1
    fi
}

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
check_port() {
    local port=$1
    if lsof -Pi :${port} -sTCP:LISTEN -t >/dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# è·å–æœåŠ¡PID
get_service_pid() {
    local port=$1
    lsof -Pi :${port} -sTCP:LISTEN -t 2>/dev/null || echo ""
}

# æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
check_health() {
    local name=$1
    local port=$2
    local endpoint=$3
    
    local url="http://0.0.0.0:${port}${endpoint}"
    
    if curl -s -o /dev/null -w "%{http_code}" "${url}" | grep -q "200"; then
        return 0
    else
        return 1
    fi
}

# åˆå§‹åŒ–ç¯å¢ƒ
init() {
    log_info "åˆå§‹åŒ– ${PROJECT_NAME} ç¯å¢ƒ..."
    
    # åˆ›å»ºå¿…è¦ç›®å½•
    mkdir -p "${LOG_DIR}" "${DATA_DIR}"
    
    # æ£€æŸ¥Pythonç¯å¢ƒ
    check_command python3
    
    # æ£€æŸ¥ä¾èµ–
    if [ ! -f "${PROJECT_ROOT}/requirements.txt" ]; then
        log_warn "æœªæ‰¾åˆ° requirements.txt"
    fi
    
    # åˆå§‹åŒ–é…ç½®æ–‡ä»¶
    if [ ! -f "${CONFIG_FILE}" ]; then
        log_info "åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶..."
        cat > "${CONFIG_FILE}" << 'EOF'
services:
  yl-monitor:
    host:0.0.0.0
    port: 5500
    enabled: true
  ar-backend:
    host:0.0.0.0
    port: 5501
    enabled: true
  user-gui:
    host:0.0.0.0
    port: 5502
    enabled: true

monitoring:
  enabled: true
  collection_interval: 5
  retention_days: 30
EOF
    fi
    
    log_info "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
}

# å¯åŠ¨æœåŠ¡
start_service() {
    local name=$1
    local port=$2
    local script=$3
    
    log_info "å¯åŠ¨ ${name} (ç«¯å£: ${port})..."
    
    # æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
    if check_port ${port}; then
        local pid=$(get_service_pid ${port})
        log_warn "${name} å·²åœ¨è¿è¡Œ (PID: ${pid})"
        return 0
    fi
    
    # æ£€æŸ¥è„šæœ¬æ˜¯å¦å­˜åœ¨
    if [ ! -f "${script}" ]; then
        log_error "å¯åŠ¨è„šæœ¬ä¸å­˜åœ¨: ${script}"
        return 1
    fi
    
    # å¯åŠ¨æœåŠ¡
    local log_file="${LOG_DIR}/${name}.log"
    nohup python3 "${script}" > "${log_file}" 2>&1 &
    local pid=$!
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    local retries=0
    local max_retries=30
    
    while [ $retries -lt $max_retries ]; do
        if check_port ${port}; then
            log_info "âœ… ${name} å¯åŠ¨æˆåŠŸ (PID: ${pid})"
            return 0
        fi
        sleep 1
        ((retries++))
    done
    
    log_error "âŒ ${name} å¯åŠ¨è¶…æ—¶"
    return 1
}

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
start() {
    log_info "å¯åŠ¨ ${PROJECT_NAME} æ‰€æœ‰æœåŠ¡..."
    
    local failed=0
    
    for service in "${SERVICES[@]}"; do
        IFS=':' read -r name port script <<< "$service"
        
        if ! start_service "$name" "$port" "$script"; then
            ((failed++))
        fi
    done
    
    if [ $failed -eq 0 ]; then
        log_info "âœ… æ‰€æœ‰æœåŠ¡å¯åŠ¨æˆåŠŸ"
        status
    else
        log_error "âŒ ${failed} ä¸ªæœåŠ¡å¯åŠ¨å¤±è´¥"
        return 1
    fi
}

# åœæ­¢æœåŠ¡
stop_service() {
    local name=$1
    local port=$2
    
    log_info "åœæ­¢ ${name}..."
    
    local pid=$(get_service_pid ${port})
    
    if [ -n "$pid" ]; then
        kill -TERM "$pid" 2>/dev/null || true
        sleep 2
        
        # å¼ºåˆ¶ç»ˆæ­¢
        if check_port ${port}; then
            kill -KILL "$pid" 2>/dev/null || true
        fi
        
        log_info "âœ… ${name} å·²åœæ­¢"
    else
        log_warn "${name} æœªè¿è¡Œ"
    fi
}

# åœæ­¢æ‰€æœ‰æœåŠ¡
stop() {
    log_info "åœæ­¢ ${PROJECT_NAME} æ‰€æœ‰æœåŠ¡..."
    
    for service in "${SERVICES[@]}"; do
        IFS=':' read -r name port script <<< "$service"
        stop_service "$name" "$port"
    done
    
    log_info "âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢"
}

# æŸ¥çœ‹çŠ¶æ€
status() {
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘           ${PROJECT_NAME} æœåŠ¡çŠ¶æ€                    â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    printf "%-15s %-8s %-10s %-10s %s\n" "æœåŠ¡" "ç«¯å£" "çŠ¶æ€" "PID" "å¥åº·æ£€æŸ¥"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    
    for service in "${SERVICES[@]}"; do
        IFS=':' read -r name port script <<< "$service"
        
        local pid=$(get_service_pid ${port})
        local status="åœæ­¢"
        local health="N/A"
        local health_endpoint="/health"
        
        if [ "$name" == "yl-monitor" ]; then
            health_endpoint="/api/health"
        fi
        
        if [ -n "$pid" ]; then
            status="è¿è¡Œä¸­"
            
            if check_health "$name" "$port" "$health_endpoint"; then
                health="âœ… å¥åº·"
            else
                health="âŒ å¼‚å¸¸"
            fi
            
            printf "%-15s %-8s %-10s %-10s %s\n" "$name" "$port" "$status" "$pid" "$health"
        else
            printf "%-15s %-8s %-10s %-10s %s\n" "$name" "$port" "$status" "-" "$health"
        fi
    done
    
    echo ""
}

# é‡å¯æœåŠ¡
restart() {
    log_info "é‡å¯ ${PROJECT_NAME} æœåŠ¡..."
    stop
    sleep 2
    start
}

# æŸ¥çœ‹æ—¥å¿—
logs() {
    local service=$1
    local lines=${2:-50}
    
    if [ -z "$service" ]; then
        log_info "æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—..."
        for log_file in "${LOG_DIR}"/*.log; do
            if [ -f "$log_file" ]; then
                echo ""
                echo "=== $(basename "$log_file") ==="
                tail -n "$lines" "$log_file"
            fi
        done
    else
        local log_file="${LOG_DIR}/${service}.log"
        if [ -f "$log_file" ]; then
            log_info "æŸ¥çœ‹ ${service} æ—¥å¿— (æœ€å ${lines} è¡Œ)..."
            tail -n "$lines" "$log_file"
        else
            log_error "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: ${log_file}"
        fi
    fi
}

# éªŒè¯éƒ¨ç½²
validate() {
    log_info "éªŒè¯ ${PROJECT_NAME} éƒ¨ç½²..."
    
    local errors=0
    
    # æ£€æŸ¥ç›®å½•ç»“æ„
    log_debug "æ£€æŸ¥ç›®å½•ç»“æ„..."
    for dir in "YL-monitor" "AR-backend" "user" "config" "logs" "data"; do
        if [ ! -d "${PROJECT_ROOT}/${dir}" ]; then
            log_error "ç›®å½•ä¸å­˜åœ¨: ${dir}"
            ((errors++))
        fi
    done
    
    # æ£€æŸ¥å…³é”®æ–‡ä»¶
    log_debug "æ£€æŸ¥å…³é”®æ–‡ä»¶..."
    for file in "YL-monitor/start_server.py" "AR-backend/monitor_server.py" "user/main.py"; do
        if [ ! -f "${PROJECT_ROOT}/${file}" ]; then
            log_error "æ–‡ä»¶ä¸å­˜åœ¨: ${file}"
            ((errors++))
        fi
    done
    
    # æ£€æŸ¥æœåŠ¡å¥åº·
    log_debug "æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
    for service in "${SERVICES[@]}"; do
        IFS=':' read -r name port script <<< "$service"
        
        if check_port ${port}; then
            local health_endpoint="/health"
            [ "$name" == "yl-monitor" ] && health_endpoint="/api/health"
            
            if check_health "$name" "$port" "$health_endpoint"; then
                log_info "âœ… ${name} å¥åº·æ£€æŸ¥é€šè¿‡"
            else
                log_error "âŒ ${name} å¥åº·æ£€æŸ¥å¤±è´¥"
                ((errors++))
            fi
        else
            log_warn "âš ï¸ ${name} æœªè¿è¡Œ"
        fi
    done
    
    # æ£€æŸ¥ç«¯å£è¿é€šæ€§
    log_debug "æ£€æŸ¥ç«¯å£è¿é€šæ€§..."
    for service in "${SERVICES[@]}"; do
        IFS=':' read -r name port script <<< "$service"
        if check_port ${port}; then
            log_info "âœ… ç«¯å£ ${port} (${name}) å¯è®¿é—®"
        fi
    done
    
    echo ""
    if [ $errors -eq 0 ]; then
        log_info "âœ… éƒ¨ç½²éªŒè¯é€šè¿‡ï¼Œæ‰€æœ‰æ£€æŸ¥é¡¹æ­£å¸¸"
        return 0
    else
        log_error "âŒ éƒ¨ç½²éªŒè¯å¤±è´¥ï¼Œå‘ç° ${errors} ä¸ªé—®é¢˜"
        return 1
    fi
}

# æ¸…ç†ç¯å¢ƒ
cleanup() {
    log_warn "æ¸…ç† ${PROJECT_NAME} ç¯å¢ƒ..."
    
    # åœæ­¢æœåŠ¡
    stop
    
    # æ¸…ç†æ—¥å¿—
    read -p "æ˜¯å¦æ¸…ç†æ—¥å¿—æ–‡ä»¶? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -f "${LOG_DIR}"/*.log
        log_info "æ—¥å¿—æ–‡ä»¶å·²æ¸…ç†"
    fi
    
    # æ¸…ç†æ•°æ®
    read -p "æ˜¯å¦æ¸…ç†æ•°æ®æ–‡ä»¶? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -f "${DATA_DIR}"/*.db
        log_info "æ•°æ®æ–‡ä»¶å·²æ¸…ç†"
    fi
    
    log_info "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"
}

# æ˜¾ç¤ºå¸®åŠ©
help() {
    cat << EOF
${PROJECT_NAME} éƒ¨ç½²ç®¡ç†è„šæœ¬

ç”¨æ³•: ./scripts/yl-ar-dgn.sh [å‘½ä»¤] [é€‰é¡¹]

å‘½ä»¤:
    init        åˆå§‹åŒ–ç¯å¢ƒ
    start       å¯åŠ¨æ‰€æœ‰æœåŠ¡
    stop        åœæ­¢æ‰€æœ‰æœåŠ¡
    restart     é‡å¯æ‰€æœ‰æœåŠ¡
    status      æŸ¥çœ‹æœåŠ¡çŠ¶æ€
    logs [æœåŠ¡] [è¡Œæ•°]  æŸ¥çœ‹æ—¥å¿— (é»˜è®¤50è¡Œ)
    validate    éªŒè¯éƒ¨ç½²
    cleanup     æ¸…ç†ç¯å¢ƒ
    help        æ˜¾ç¤ºå¸®åŠ©

ç¤ºä¾‹:
    ./scripts/yl-ar-dgn.sh init           # åˆå§‹åŒ–ç¯å¢ƒ
    ./scripts/yl-ar-dgn.sh start          # å¯åŠ¨æ‰€æœ‰æœåŠ¡
    ./scripts/yl-ar-dgn.sh status         # æŸ¥çœ‹çŠ¶æ€
    ./scripts/yl-ar-dgn.sh logs yl-monitor 100  # æŸ¥çœ‹100è¡Œæ—¥å¿—
    ./scripts/yl-ar-dgn.sh validate       # éªŒè¯éƒ¨ç½²

EOF
}

# ä¸»å…¥å£
main() {
    case "${1:-help}" in
        init)
            init
            ;;
        start)
            start
            ;;
        stop)
            stop
            ;;
        restart)
            restart
            ;;
        status)
            status
            ;;
        logs)
            logs "$2" "$3"
            ;;
        validate)
            validate
            ;;
        cleanup)
            cleanup
            ;;
        help|--help|-h)
            help
            ;;
        *)
            log_error "æœªçŸ¥å‘½ä»¤: $1"
            help
            exit 1
            ;;
    esac
}

main "$@"
```

---

## ä¸‰ã€å®æ–½ä¼˜å…ˆçº§å»ºè®®

### ç«‹å³å®æ–½ï¼ˆæœ¬å‘¨å†…ï¼‰

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | æ”¶ç›Š |
|--------|------|----------|------|
| ğŸ”´ P0 | é›†æˆç›‘æ§å™¨åˆ°ä¸»åº”ç”¨ | 1å¤© | ç›‘æ§æ•°æ®å¯è®¿é—® |
| ğŸ”´ P0 | åˆ›å»ºç»Ÿä¸€å¯åŠ¨è„šæœ¬ | 1å¤© | ä¸€é”®éƒ¨ç½² |
| ğŸŸ¡ P1 | ç»Ÿä¸€é…ç½®ä¸­å¿ƒ | 1å¤© | é…ç½®ç®¡ç†ç®€åŒ– |
| ğŸŸ¡ P1 | ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ | 0.5å¤© | æ—¥å¿—å¯æŸ¥è¯¢ |

### çŸ­æœŸå®æ–½ï¼ˆ2å‘¨å†…ï¼‰

| ä¼˜å…ˆçº§ | ä»»åŠ¡
