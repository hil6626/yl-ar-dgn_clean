# 部署任务8.4: 自动化部署脚本

**任务ID:** 8.4  
**所属阶段:** 阶段8 - 生产环境准备  
**任务名称:** 自动化部署脚本  
**优先级:** P1（重要优先级）  
**关键性:** 重要  
**预计工时:** 4小时  
**负责人:** DevOps工程师  
**前置依赖:** 任务8.3完成  
**状态:** 待开始

---

## 一、任务目标

创建自动化部署脚本，实现一键部署、回滚和健康检查功能。

---

## 二、工作内容

1. 部署脚本创建
2. 回滚脚本创建
3. 健康检查脚本
4. 日志收集脚本

---

## 三、实施步骤

### 步骤1: 创建部署脚本

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/deploy.sh << 'EOF'
#!/bin/bash
set -e

VERSION=${1:-latest}
ENV=${2:-production}

echo "========================================"
echo "AR Studio 部署脚本"
echo "版本: $VERSION"
echo "环境: $ENV"
echo "========================================"

# 1. 前置检查
echo "1. 执行前置检查..."
if ! command -v docker &> /dev/null; then
    echo "错误: Docker未安装"
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "错误: Docker Compose未安装"
    exit 1
fi

# 2. 备份当前版本
echo "2. 备份当前版本..."
BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"
mkdir -p $BACKUP_DIR
cp -r AR-backend YL-monitor config $BACKUP_DIR/ 2>/dev/null || true
echo "备份完成: $BACKUP_DIR"

# 3. 拉取最新代码
echo "3. 拉取最新代码..."
git pull origin main

# 4. 构建镜像
echo "4. 构建Docker镜像..."
docker-compose build --no-cache

# 5. 启动服务
echo "5. 启动服务..."
docker-compose up -d

# 6. 健康检查
echo "6. 执行健康检查..."
sleep 10
./scripts/health_check.sh

echo "========================================"
echo "部署完成!"
echo "========================================"
EOF

chmod +x /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/deploy.sh
echo "✓ 部署脚本已创建"
```

### 步骤2: 创建回滚脚本

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/rollback.sh << 'EOF'
#!/bin/bash
set -e

BACKUP_DIR=$1

if [ -z "$BACKUP_DIR" ]; then
    echo "用法: $0 <备份目录>"
    echo "可用备份:"
    ls -1d backups/* 2>/dev/null || echo "无可用备份"
    exit 1
fi

echo "========================================"
echo "AR Studio 回滚脚本"
echo "备份: $BACKUP_DIR"
echo "========================================"

# 1. 停止当前服务
echo "1. 停止当前服务..."
docker-compose down

# 2. 恢复备份
echo "2. 恢复备份..."
if [ -d "$BACKUP_DIR" ]; then
    cp -r $BACKUP_DIR/AR-backend . 2>/dev/null || true
    cp -r $BACKUP_DIR/YL-monitor . 2>/dev/null || true
    cp -r $BACKUP_DIR/config . 2>/dev/null || true
    echo "备份恢复完成"
else
    echo "错误: 备份目录不存在"
    exit 1
fi

# 3. 重新构建和启动
echo "3. 重新构建和启动..."
docker-compose build
docker-compose up -d

# 4. 健康检查
echo "4. 执行健康检查..."
sleep 5
./scripts/health_check.sh

echo "========================================"
echo "回滚完成!"
echo "========================================"
EOF

chmod +x /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/rollback.sh
echo "✓ 回滚脚本已创建"
```

### 步骤3: 验证部署脚本

```bash
cat > /tmp/verify_deployment.sh << 'EOF'
#!/bin/bash
echo "========================================"
echo "自动化部署脚本验证"
echo "========================================"

errors=0

# 检查部署脚本
echo -n "检查部署脚本... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/deploy.sh" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

# 检查回滚脚本
echo -n "检查回滚脚本... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/rollback.sh" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

echo "========================================"
if [ $errors -eq 0 ]; then
    echo "✓ 自动化部署脚本验证通过"
    exit 0
else
    echo "✗ 自动化部署脚本验证失败 ($errors 个错误)"
    exit 1
fi
EOF

chmod +x /tmp/verify_deployment.sh
/tmp/verify_deployment.sh
```

---

## 四、验证步骤

### 验证清单

- [ ] 部署脚本创建
- [ ] 回滚脚本创建
- [ ] 健康检查脚本创建

---

## 五、预期结果

| 指标 | 目标值 | 验证方法 |
|------|--------|----------|
| 部署脚本 | 创建 | 文件检查 |
| 回滚脚本 | 创建 | 文件检查 |
| 健康检查 | 创建 | 功能测试 |

---

## 六、关联文档

- [任务跟踪-阶段8-生产环境准备.md](./任务跟踪-阶段8-生产环境准备.md)
- [任务跟踪-阶段8-生产环境准备-部署任务8.3-安全配置加固.md](./任务跟踪-阶段8-生产环境准备-部署任务8.3-安全配置加固.md)
- [任务跟踪-阶段8-生产环境准备-部署任务8.5-日志和监控集成.md](./任务跟踪-阶段8-生产环境准备-部署任务8.5-日志和监控集成.md)

---

**创建时间:** 2026-02-11
