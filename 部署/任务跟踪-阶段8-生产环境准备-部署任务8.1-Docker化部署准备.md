# 部署任务8.1: Docker化部署准备

**任务ID:** 8.1  
**所属阶段:** 阶段8 - 生产环境准备  
**任务名称:** Docker化部署准备  
**优先级:** P0（最高优先级）  
**关键性:** 阻塞性  
**预计工时:** 6小时  
**负责人:** DevOps工程师  
**前置依赖:** 任务7.8完成  
**状态:** 待开始

---

## 一、任务目标

完成AR-backend、YL-monitor和User GUI的Docker化部署准备，包括Dockerfile创建和docker-compose配置。

---

## 二、工作内容

1. AR-backend Dockerfile优化
2. YL-monitor Dockerfile创建
3. User GUI Dockerfile创建
4. docker-compose.yml完善
5. Docker镜像构建和测试

---

## 三、实施步骤

### 步骤1: 创建AR-backend Dockerfile

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/AR-backend/Dockerfile << 'EOF'
FROM python:3.9-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    libgl1-mesa-glx \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/*

# 安装Python依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 暴露端口
EXPOSE 5501

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:5501/health || exit 1

# 启动命令
CMD ["python3", "monitor_server.py"]
EOF

echo "✓ AR-backend Dockerfile已创建"
```

### 步骤2: 创建YL-monitor Dockerfile

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/YL-monitor/Dockerfile << 'EOF'
FROM python:3.9-slim

WORKDIR /app

# 安装依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用
COPY . .

# 暴露端口
EXPOSE 5000

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:5000/api/health || exit 1

CMD ["python3", "app/main.py"]
EOF

echo "✓ YL-monitor Dockerfile已创建"
```

### 步骤3: 创建docker-compose.yml

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/docker-compose.yml << 'EOF'
version: '3.8'

services:
  ar-backend:
    build: ./AR-backend
    container_name: ar-backend
    ports:
      - "5501:5501"
    volumes:
      - ./AR-backend/logs:/app/logs
      - ./AR-backend/data:/app/data
      - /dev/video0:/dev/video0
    environment:
      - FLASK_ENV=production
      - LOG_LEVEL=INFO
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5501/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  yl-monitor:
    build: ./YL-monitor
    container_name: yl-monitor
    ports:
      - "5000:5000"
    volumes:
      - ./YL-monitor/logs:/app/logs
      - ./YL-monitor/config:/app/config
    environment:
      - FLASK_ENV=production
      - AR_BACKEND_URL=http://ar-backend:5501
    depends_on:
      ar-backend:
        condition: service_healthy
    restart: unless-stopped

networks:
  default:
    name: ar-network
EOF

echo "✓ docker-compose.yml已创建"
```

### 步骤4: 验证Docker配置

```bash
cat > /tmp/verify_docker.sh << 'EOF'
#!/bin/bash
echo "========================================"
echo "Docker化部署验证"
echo "========================================"

errors=0

# 检查AR-backend Dockerfile
echo -n "检查AR-backend Dockerfile... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/AR-backend/Dockerfile" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

# 检查YL-monitor Dockerfile
echo -n "检查YL-monitor Dockerfile... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/YL-monitor/Dockerfile" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

# 检查docker-compose.yml
echo -n "检查docker-compose.yml... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/docker-compose.yml" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

echo "========================================"
if [ $errors -eq 0 ]; then
    echo "✓ Docker化部署验证通过"
    exit 0
else
    echo "✗ Docker化部署验证失败 ($errors 个错误)"
    exit 1
fi
EOF

chmod +x /tmp/verify_docker.sh
/tmp/verify_docker.sh
```

---

## 四、验证步骤

### 验证清单

- [ ] AR-backend Dockerfile创建
- [ ] YL-monitor Dockerfile创建
- [ ] docker-compose.yml完善
- [ ] 镜像构建成功

---

## 五、预期结果

| 指标 | 目标值 | 验证方法 |
|------|--------|----------|
| Dockerfile | 创建 | 文件检查 |
| docker-compose | 完善 | 配置检查 |
| 镜像构建 | 成功 | 构建测试 |

---

## 六、关联文档

- [任务跟踪-阶段8-生产环境准备.md](./任务跟踪-阶段8-生产环境准备.md)
- [任务跟踪-阶段8-生产环境准备-部署任务8.2-生产环境配置.md](./任务跟踪-阶段8-生产环境准备-部署任务8.2-生产环境配置.md)

---

**创建时间:** 2026-02-11
