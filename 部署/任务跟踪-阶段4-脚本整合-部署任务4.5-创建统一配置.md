# Phase 4 - Task 4.5: Create Unified Configuration - Detailed Deployment Document

**Task ID:** 4.5  
**Task Name:** Create Unified Configuration  
**Priority:** P2 (Medium)  
**Estimated Hours:** 2 hours  
**Status:** Pending  
**Prerequisites:** Task 4.4 completed

---

## I. Task Objectives

Create a unified configuration system for all scripts to ensure consistency and ease of management.

## II. Deployment Content

### 2.1 Unified Configuration Files

#### File: config/scripts.yaml

```yaml
# Unified Scripts Configuration
# Used by all scripts in the project

project:
  name: YL-AR-DGN
  version: 1.0.0
  root_dir: /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean

components:
  yl_monitor:
    name: YL-monitor
    path: YL-monitor
    port: 5500
    health_endpoint: /api/health
    log_dir: YL-monitor/logs
    config_file: YL-monitor/config.yaml
    
  ar_backend:
    name: AR-backend
    path: AR-backend
    port: 5501
    health_endpoint: /health
    log_dir: AR-backend/logs
    config_file: AR-backend/config.yaml
    
  user_gui:
    name: User GUI
    path: user
    port: 5502
    health_endpoint: /health
    log_dir: user/logs
    config_file: user/config.yaml

scripts:
  log_level: INFO
  timeout_default: 30
  retry_count: 3
  backup_dir: backups
  temp_dir: /tmp/yl-ar-dgn

monitoring:
  health_check_interval: 30
  metrics_retention_days: 30
  alert_channels:
    - log
    - dashboard
    - email
    
deployment:
  parallel: false
  verify_after_deploy: true
  rollback_on_failure: true
  backup_before_deploy: true

cleanup:
  log_retention_days: 7
  temp_retention_hours: 24
  cache_auto_clean: true
```

#### File: scripts/lib/config_loader.py

```python
#!/usr/bin/env python3
"""
Unified Configuration Loader
Loads and provides access to project configuration
"""

import os
import yaml
import logging
from pathlib import Path
from typing import Dict, Any, Optional

logger = logging.getLogger('ConfigLoader')


class ConfigLoader:
    """
    Unified Configuration Loader
    """

    _instance = None
    _config = None

    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
        return cls._instance

    def __init__(self):
        if self._config is None:
            self._config = {}
            self._load_config()

    def _load_config(self):
        """Load configuration from files"""
        # Find project root
        script_dir = Path(__file__).parent.parent
        project_root = script_dir.parent

        # Load main config
        config_file = project_root / 'config' / 'scripts.yaml'
        if config_file.exists():
            with open(config_file) as f:
                self._config = yaml.safe_load(f)
                logger.info(f"Loaded config from {config_file}")
        else:
            logger.warning(f"Config file not found: {config_file}")
            self._config = self._default_config()

        # Override with environment variables
        self._apply_env_overrides()

    def _default_config(self) -> Dict:
        """Default configuration"""
        return {
            'project': {
                'name': 'YL-AR-DGN',
                'version': '1.0.0',
            },
            'components': {
                'yl_monitor': {'port': 5500},
                'ar_backend': {'port': 5501},
                'user_gui': {'port': 5502},
            },
            'scripts': {
                'log_level': 'INFO',
                'timeout_default': 30,
            }
        }

    def _apply_env_overrides(self):
        """Apply environment variable overrides"""
        env_mappings = {
            'YL_LOG_LEVEL': ['scripts', 'log_level'],
            'YL_TIMEOUT': ['scripts', 'timeout_default'],
            'YL_BACKUP_DIR': ['scripts', 'backup_dir'],
        }

        for env_var, path in env_mappings.items():
            value = os.getenv(env_var)
            if value:
                self._set_nested(path, value)
                logger.info(f"Override from {env_var}: {value}")

    def _set_nested(self, path: list, value: Any):
        """Set nested dictionary value"""
        current = self._config
        for key in path[:-1]:
            if key not in current:
                current[key] = {}
            current = current[key]
        current[path[-1]] = value

    def get(self, key: str, default: Any = None) -> Any:
        """
        Get configuration value by dot-notation key
        Example: get('components.yl_monitor.port')
        """
        keys = key.split('.')
        current = self._config

        for k in keys:
            if isinstance(current, dict) and k in current:
                current = current[k]
            else:
                return default

        return current

    def get_component(self, name: str) -> Dict:
        """Get component configuration"""
        return self.get(f'components.{name}', {})

    def get_all(self) -> Dict:
        """Get entire configuration"""
        return self._config.copy()

    def reload(self):
        """Reload configuration"""
        self._config = {}
        self._load_config()
        logger.info("Configuration reloaded")


# Global instance
_config_loader = None

def get_config() -> ConfigLoader:
    """Get configuration loader instance"""
    global _config_loader
    if _config_loader is None:
        _config_loader = ConfigLoader()
    return _config_loader


# Convenience functions
def get(key: str, default: Any = None) -> Any:
    """Get configuration value"""
    return get_config().get(key, default)


def get_component(name: str) -> Dict:
    """Get component configuration"""
    return get_config().get_component(name)


def reload():
    """Reload configuration"""
    get_config().reload()
```

### 2.2 Shell Configuration Loader

#### File: scripts/lib/config.sh

```bash
#!/bin/bash
# Shell Configuration Loader
# Source this file to load configuration

YL_CONFIG_FILE="${YL_CONFIG_FILE:-$(dirname "${BASH_SOURCE[0]}")/../../config/scripts.yaml}"

# Load YAML value (simple parser)
yl_get_config() {
    local key=$1
    local default=$2
    
    if [ -f "$YL_CONFIG_FILE" ]; then
        # Use Python to parse YAML
        python3 -c "
import yaml
import sys

try:
    with open('$YL_CONFIG_FILE') as f:
        config = yaml.safe_load(f)
    
    keys = '$key'.split('.')
    value = config
    for k in keys:
        if isinstance(value, dict) and k in value:
            value = value[k]
        else:
            print('$default')
            sys.exit(0)
    
    if isinstance(value, (str, int, float, bool)):
        print(value)
    else:
        print('$default')
except Exception as e:
    print('$default')
"
    else
        echo "$default"
    fi
}

# Get component configuration
yl_get_component() {
    local component=$1
    local key=$2
    local default=$3
    
    yl_get_config "components.${component}.${key}" "$default"
}

# Example usage in scripts:
# source "$(dirname "$0")/../lib/config.sh"
# PORT=$(yl_get_component "yl_monitor" "port" "5500")
```

## III. Deployment Steps

```bash
# 1. Create config directory
mkdir -p config

# 2. Create unified config
# Edit config/scripts.yaml

# 3. Create Python config loader
mkdir -p scripts/lib
# Edit scripts/lib/config_loader.py

# 4. Create shell config loader
# Edit scripts/lib/config.sh

# 5. Test Python loader
python3 -c "
from scripts.lib.config_loader import get_config, get
config = get_config()
print('Project:', get('project.name'))
print('YL-monitor port:', get('components.yl_monitor.port'))
"

# 6. Test shell loader
source scripts/lib/config.sh
echo "YL-monitor port: $(yl_get_component yl_monitor port 5500)"
```

## IV. Verification Checklist

- [ ] Config file created
- [ ] Python loader works
- [ ] Shell loader works
- [ ] Environment overrides work
- [ ] All components defined
- [ ] Default values work

## V. Next Step

After completing this task, proceed to **Task 4.6: Create Unified Logging**

View document: `部署/任务跟踪-阶段4-脚本整合-部署任务4.6-创建统一日志.md`
