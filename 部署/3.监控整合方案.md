# 3. YL-monitor 监控整合方案

**版本:** 1.0.0  
**创建日期:** 2026-02-09  
**状态:** 待执行

## 一、目标

让 YL-monitor 对以下两个目录的部署情况进行统一监控：
1. `/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/AR-backend` - 后端服务
2. `/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/user` - 前端GUI

## 二、现状分析

### 2.1 YL-monitor 现有能力
- **FastAPI 后端** (端口 5500)
- **AR 监控器** (app/services/ar_monitor.py) - 已具备节点监控能力
- **DAG 引擎** - 支持流水线编排
- **脚本执行器** - 支持自动化脚本
- **WebSocket** - 实时数据推送

### 2.2 AR-backend 现状
- **PyQt5 GUI 应用** - 实时视频处理
- **无 HTTP API** - 需要添加监控端点
- **进程运行** - 需要进程监控

### 2.3 user 目录现状
- **PyQt5 GUI 应用** - AR合成软件界面
- **backend 导入错误** - 路径问题
- **无远程通信** - 需要添加 API 客户端

## 三、整合方案

### 3.1 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                      YL-Monitor (5500)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │  Dashboard   │  │  AR Monitor  │  │  DAG Engine  │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
           ┌──────────────────┼──────────────────┐
           │                  │                  │
           ▼                  ▼                  ▼
    ┌──────────────┐   ┌──────────────┐   ┌──────────────┐
    │  AR-backend  │   │  user GUI    │   │  Scripts     │
    │  (/health)   │   │  (/status)   │   │  (监控脚本)   │
    └──────────────┘   └──────────────┘   └──────────────┘
```

### 3.2 实施步骤

#### 步骤1: AR-backend 添加监控端点 (任务1.1)

**目标:** 为 AR-backend 添加 HTTP 健康检查接口

**操作内容:**
1. 在 AR-backend 创建 `monitor_server.py`
2. 添加 `/health` 端点
3. 添加 `/status` 端点返回详细状态
4. 添加 `/metrics` 端点返回性能指标

**文件位置:** `AR-backend/monitor_server.py`

**验证标准:**
```bash
curl http://0.0.0.0:5501/health
# 预期返回: {"status": "healthy", "service": "ar-backend"}
```

#### 步骤2: User GUI 添加状态上报 (任务1.2)

**目标:** 让 User GUI 能够上报状态到 YL-monitor

**操作内容:**
1. 在 user 目录创建 `status_reporter.py`
2. 实现定时心跳上报
3. 添加本地 HTTP 服务供查询

**文件位置:** `user/status_reporter.py`

**验证标准:**
```bash
curl http://0.0.0.0:5502/status
# 预期返回: {"status": "running", "gui": "active"}
```

#### 步骤3: YL-monitor 配置监控目标 (任务1.3)

**目标:** 在 YL-monitor 中注册 AR-backend 和 user 为监控节点

**操作内容:**
1. 修改 `YL-monitor/app/services/ar_monitor.py`
2. 添加 AR-backend 节点配置
3. 添加 user 节点配置
4. 实现健康检查轮询

**配置示例:**
```python
AR_NODES = [
    {"id": "ar-backend", "name": "AR Backend", "url": "http://0.0.0.0:5501"},
    {"id": "user-gui", "name": "User GUI", "url": "http://0.0.0.0:5502"}
]
```

#### 步骤4: 统一监控面板 (任务1.4)

**目标:** 在 YL-monitor 前端展示所有监控对象

**操作内容:**
1. 修改 `YL-monitor/templates/ar.html`
2. 添加 AR-backend 状态卡片
3. 添加 User GUI 状态卡片
4. 实现实时 WebSocket 更新

## 四、技术实现

### 4.1 AR-backend 监控服务

```python
# AR-backend/monitor_server.py
from flask import Flask, jsonify
import psutil
import os

app = Flask(__name__)

@app.route('/health')
def health():
    return jsonify({
        "status": "healthy",
        "service": "ar-backend",
        "version": "2.0.0",
        "timestamp": datetime.utcnow().isoformat()
    })

@app.route('/status')
def status():
    return jsonify({
        "camera": check_camera_status(),
        "audio": check_audio_status(),
        "face_modules": check_face_modules(),
        "system": get_system_metrics()
    })

if __name__ == '__main__':
    app.run(port=5501)
```

### 4.2 User GUI 状态上报

```python
# user/status_reporter.py
import requests
import time
from threading import Thread

class StatusReporter:
    def __init__(self, monitor_url="http://0.0.0.0:5500"):
        self.monitor_url = monitor_url
        self.running = False
        
    def start(self):
        self.running = True
        Thread(target=self._report_loop, daemon=True).start()
        
    def _report_loop(self):
        while self.running:
            try:
                status = self._collect_status()
                requests.post(
                    f"{self.monitor_url}/api/ar/nodes/user-gui/heartbeat",
                    json=status
                )
            except Exception as e:
                print(f"Status report failed: {e}")
            time.sleep(30)  # 每30秒上报一次
```

### 4.3 YL-monitor 节点配置

```python
# YL-monitor/app/config/ar_nodes.py
AR_NODES_CONFIG = {
    "ar-backend": {
        "name": "AR Backend Service",
        "type": "backend",
        "health_url": "http://0.0.0.0:5501/health",
        "status_url": "http://0.0.0.0:5501/status",
        "check_interval": 30
    },
    "user-gui": {
        "name": "User GUI Application",
        "type": "frontend",
        "health_url": "http://0.0.0.0:5502/health",
        "check_interval": 30
    }
}
```

## 五、验证方案

### 5.1 功能验证

| 验证项 | 方法 | 预期结果 |
|--------|------|----------|
| AR-backend 健康检查 | `curl http://0.0.0.0:5501/health` | 返回 healthy |
| User GUI 状态查询 | `curl http://0.0.0.0:5502/status` | 返回 running |
| YL-monitor 节点列表 | 访问 `/api/ar/nodes` | 显示2个节点 |
| 监控面板显示 | 访问 `/ar` 页面 | 显示所有节点状态 |

### 5.2 性能验证

- 健康检查响应时间 < 500ms
- 状态上报不占用 GUI 主线程
- 监控面板刷新频率 5秒/次

## 六、风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| AR-backend 无 HTTP 服务 | 无法监控 | 新增 Flask 监控服务 |
| User GUI 阻塞 | 影响用户体验 | 使用独立线程上报 |
| 端口冲突 | 服务启动失败 | 配置可调整端口 |
| 网络隔离 | 无法通信 | 支持 Unix Socket 备选 |

## 七、执行检查点

- [ ] 检查点1: AR-backend 监控服务启动成功
- [ ] 检查点2: User GUI 状态上报正常
- [ ] 检查点3: YL-monitor 能显示两个节点
- [ ] 检查点4: 告警功能正常（模拟故障）
- [ ] 检查点5: 文档已更新

## 八、关联文档

- [2.整体方案.md](./2.整体方案.md)
- [4.User-GUI优化方案.md](./4.User-GUI优化方案.md)
- [7.联调测试方案.md](./7.联调测试方案.md)

---

**下一步:** 执行步骤1 - 创建 AR-backend 监控服务
