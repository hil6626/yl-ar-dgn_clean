# 部署任务8.5: 日志和监控集成

**任务ID:** 8.5  
**所属阶段:** 阶段8 - 生产环境准备  
**任务名称:** 日志和监控集成  
**优先级:** P1（重要优先级）  
**关键性:** 重要  
**预计工时:** 4小时  
**负责人:** 运维工程师  
**前置依赖:** 任务8.4完成  
**状态:** 待开始

---

## 一、任务目标

完成生产环境日志和监控集成，包括日志收集、日志分析、监控告警和可视化。

---

## 二、工作内容

1. 日志收集配置
2. 日志分析配置
3. 监控告警集成
4. 可视化配置

---

## 三、实施步骤

### 步骤1: 创建日志配置

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/config/logging.yaml << 'EOF'
# 日志配置

version: 1
disable_existing_loggers: false

formatters:
  standard:
    format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
  json:
    format: '{"timestamp": "%(asctime)s", "logger": "%(name)s", "level": "%(levelname)s", "message": "%(message)s"}'

handlers:
  console:
    class: logging.StreamHandler
    level: INFO
    formatter: standard
    stream: ext://sys.stdout
  
  file:
    class: logging.handlers.RotatingFileHandler
    level: INFO
    formatter: json
    filename: logs/app.log
    maxBytes: 10485760  # 10MB
    backupCount: 10
  
  error_file:
    class: logging.handlers.RotatingFileHandler
    level: ERROR
    formatter: json
    filename: logs/error.log
    maxBytes: 10485760  # 10MB
    backupCount: 10

loggers:
  ar_backend:
    level: INFO
    handlers: [console, file, error_file]
    propagate: false
  
  yl_monitor:
    level: INFO
    handlers: [console, file, error_file]
    propagate: false

root:
  level: INFO
  handlers: [console, file]
EOF

echo "✓ 日志配置已创建"
```

### 步骤2: 创建日志收集器

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/AR-backend/app/utils/logger.py << 'EOF'
import logging
import logging.config
import yaml
from pathlib import Path

def setup_logging(config_path: str = None):
    """设置日志"""
    if config_path is None:
        config_path = Path(__file__).parent.parent.parent / 'config' / 'logging.yaml'
    
    if Path(config_path).exists():
        with open(config_path, 'r') as f:
            config = yaml.safe_load(f)
            logging.config.dictConfig(config)
    else:
        # 默认配置
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
        )
    
    return logging.getLogger(__name__)

class StructuredLogger:
    """结构化日志记录器"""
    
    def __init__(self, name: str):
        self.logger = logging.getLogger(name)
    
    def info(self, message: str, **kwargs):
        """记录INFO级别日志"""
        extra = self._format_extra(kwargs)
        self.logger.info(f"{message} {extra}")
    
    def error(self, message: str, **kwargs):
        """记录ERROR级别日志"""
        extra = self._format_extra(kwargs)
        self.logger.error(f"{message} {extra}")
    
    def warning(self, message: str, **kwargs):
        """记录WARNING级别日志"""
        extra = self._format_extra(kwargs)
        self.logger.warning(f"{message} {extra}")
    
    def debug(self, message: str, **kwargs):
        """记录DEBUG级别日志"""
        extra = self._format_extra(kwargs)
        self.logger.debug(f"{message} {extra}")
    
    def _format_extra(self, kwargs: dict) -> str:
        """格式化额外信息"""
        if not kwargs:
            return ""
        return " | " + " | ".join(f"{k}={v}" for k, v in kwargs.items())
EOF

echo "✓ 日志收集器已创建"
```

### 步骤3: 验证日志配置

```bash
cat > /tmp/verify_logging.sh << 'EOF'
#!/bin/bash
echo "========================================"
echo "日志和监控集成验证"
echo "========================================"

errors=0

# 检查日志配置
echo -n "检查日志配置... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/config/logging.yaml" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

# 检查日志收集器
echo -n "检查日志收集器... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/AR-backend/app/utils/logger.py" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

echo "========================================"
if [ $errors -eq 0 ]; then
    echo "✓ 日志和监控集成验证通过"
    exit 0
else
    echo "✗ 日志和监控集成验证失败 ($errors 个错误)"
    exit 1
fi
EOF

chmod +x /tmp/verify_logging.sh
/tmp/verify_logging.sh
```

---

## 四、验证步骤

### 验证清单

- [ ] 日志收集配置完成
- [ ] 日志分析配置完成
- [ ] 监控告警集成完成
- [ ] 可视化配置完成

---

## 五、预期结果

| 指标 | 目标值 | 验证方法 |
|------|--------|----------|
| 日志收集 | 配置 | 功能测试 |
| 日志分析 | 配置 | 功能测试 |
| 监控告警 | 集成 | 集成测试 |
| 可视化 | 配置 | 界面检查 |

---

## 六、关联文档

- [任务跟踪-阶段8-生产环境准备.md](./任务跟踪-阶段8-生产环境准备.md)
- [任务跟踪-阶段8-生产环境准备-部署任务8.4-自动化部署脚本.md](./任务跟踪-阶段8-生产环境准备-部署任务8.4-自动化部署脚本.md)
- [任务跟踪-阶段8-生产环境准备-部署任务8.6-备份和恢复机制.md](./任务跟踪-阶段8-生产环境准备-部署任务8.6-备份和恢复机制.md)

---

**创建时间:** 2026-02-11
