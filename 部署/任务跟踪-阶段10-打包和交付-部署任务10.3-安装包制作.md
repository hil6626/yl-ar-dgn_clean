# 部署任务10.3: 安装包制作

**任务ID:** 10.3  
**所属阶段:** 阶段10 - 打包和交付  
**任务名称:** 安装包制作  
**优先级:** P0（最高优先级）  
**关键性:** 阻塞性  
**预计工时:** 4小时  
**负责人:** 构建工程师  
**前置依赖:** 任务10.2完成  
**状态:** 待开始

---

## 一、任务目标

制作安装包，包括Docker镜像打包、源码包制作、安装脚本创建和包验证。

---

## 二、工作内容

1. Docker镜像打包
2. 源码包制作
3. 安装脚本创建
4. 卸载脚本创建
5. 包验证

---

## 三、实施步骤

### 步骤1: 创建安装包制作脚本

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/build_package.sh << 'EOF'
#!/bin/bash
set -e

VERSION=${1:-$(cat VERSION 2>/dev/null || echo "2.0.0")}
PACKAGE_NAME="ar-studio-${VERSION}"
BUILD_DIR="build/${PACKAGE_NAME}"

echo "========================================"
echo "制作安装包"
echo "版本: ${VERSION}"
echo "========================================"

# 1. 清理并创建构建目录
echo "1. 准备构建目录..."
rm -rf ${BUILD_DIR}
mkdir -p ${BUILD_DIR}
echo "   ✓ 构建目录准备完成"

# 2. 复制项目文件
echo "2. 复制项目文件..."
cp -r AR-backend ${BUILD_DIR}/
cp -r YL-monitor ${BUILD_DIR}/
cp -r config ${BUILD_DIR}/
cp -r docs ${BUILD_DIR}/
cp -r scripts ${BUILD_DIR}/
cp docker-compose.yml ${BUILD_DIR}/
cp README.md ${BUILD_DIR}/
cp VERSION ${BUILD_DIR}/ 2>/dev/null || echo "${VERSION}" > ${BUILD_DIR}/VERSION
echo "   ✓ 项目文件复制完成"

# 3. 清理开发文件
echo "3. 清理开发文件..."
find ${BUILD_DIR} -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
find ${BUILD_DIR} -name "*.pyc" -delete 2>/dev/null || true
find ${BUILD_DIR} -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
find ${BUILD_DIR} -name "node_modules" -type d -exec rm -rf {} + 2>/dev/null || true
echo "   ✓ 开发文件清理完成"

# 4. 创建安装脚本
echo "4. 创建安装脚本..."
cat > ${BUILD_DIR}/install.sh << 'INSTALLSCRIPT'
#!/bin/bash
set -e

echo "========================================"
echo "AR Live Studio 安装程序"
echo "========================================"

# 检查依赖
echo "检查系统依赖..."
if ! command -v docker &> /dev/null; then
    echo "错误: Docker未安装"
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "错误: Docker Compose未安装"
    exit 1
fi

echo "✓ 依赖检查通过"

# 配置环境
echo "配置环境..."
if [ ! -f "config/production.env" ]; then
    cp config/production.env.example config/production.env 2>/dev/null || echo "请手动配置config/production.env"
fi

# 构建和启动
echo "构建和启动服务..."
docker-compose build
docker-compose up -d

# 健康检查
echo "执行健康检查..."
sleep 10
if curl -sf http://localhost:5501/health > /dev/null 2>&1; then
    echo "✓ 服务启动成功"
else
    echo "⚠ 服务可能未完全启动，请检查日志"
fi

echo "========================================"
echo "安装完成!"
echo "访问 http://localhost:5501 查看服务"
echo "========================================"
INSTALLSCRIPT

chmod +x ${BUILD_DIR}/install.sh
echo "   ✓ 安装脚本创建完成"

# 5. 创建卸载脚本
echo "5. 创建卸载脚本..."
cat > ${BUILD_DIR}/uninstall.sh << 'UNINSTALLSCRIPT'
#!/bin/bash

echo "========================================"
echo "AR Live Studio 卸载程序"
echo "========================================"

# 停止服务
echo "停止服务..."
docker-compose down 2>/dev/null || true

# 询问是否删除数据
read -p "是否删除数据目录? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    rm -rf AR-backend/data YL-monitor/data
    echo "✓ 数据已删除"
fi

echo "========================================"
echo "卸载完成"
echo "========================================"
UNINSTALLSCRIPT

chmod +x ${BUILD_DIR}/uninstall.sh
echo "   ✓ 卸载脚本创建完成"

# 6. 打包
echo "6. 打包..."
mkdir -p packages
tar -czf packages/${PACKAGE_NAME}.tar.gz -C build ${PACKAGE_NAME}
echo "   ✓ 安装包已创建: packages/${PACKAGE_NAME}.tar.gz"

echo "========================================"
echo "安装包制作完成!"
echo "输出: packages/${PACKAGE_NAME}.tar.gz"
echo "========================================"
EOF

chmod +x /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/build_package.sh
echo "✓ 安装包制作脚本已创建"
```

### 步骤2: 验证安装包

```bash
cat > /tmp/verify_package.sh << 'EOF'
#!/bin/bash
echo "========================================"
echo "安装包制作验证"
echo "========================================"

errors=0

# 检查安装包制作脚本
echo -n "检查安装包制作脚本... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/build_package.sh" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

echo "========================================"
if [ $errors -eq 0 ]; then
    echo "✓ 安装包制作验证通过"
    exit 0
else
    echo "✗ 安装包制作验证失败 ($errors 个错误)"
    exit 1
fi
EOF

chmod +x /tmp/verify_package.sh
/tmp/verify_package.sh
```

---

## 四、验证步骤

### 验证清单

- [ ] Docker镜像打包完成
- [ ] 源码包制作完成
- [ ] 安装脚本创建完成
- [ ] 卸载脚本创建完成

---

## 五、预期结果

| 指标 | 目标值 | 验证方法 |
|------|--------|----------|
| Docker镜像 | 打包 | 镜像检查 |
| 源码包 | 制作 | 包检查 |
| 安装脚本 | 创建 | 脚本检查 |
| 卸载脚本 | 创建 | 脚本检查 |

---

## 六、关联文档

- [任务跟踪-阶段10-打包和交付.md](./任务跟踪-阶段10-打包和交付.md)
- [任务跟踪-阶段10-打包和交付-部署任务10.2-版本标记和发布.md](./任务跟踪-阶段10-打包和交付-部署任务10.2-版本标记和发布.md)
- [任务跟踪-阶段10-打包和交付-部署任务10.4-交付文档编写.md](./任务跟踪-阶段10-打包和交付-部署任务10.4-交付文档编写.md)

---

**创建时间:** 2026-02-11
