一、整体目标拆解（先对齐共识）

你现在要解决的不是“写不写代码”，而是 系统工程问题：

YL-monitor
👉 统一监控 AR-backend + user 的 进程 / 服务 / 资源 / 接口健康

AR-backend
👉 作为 唯一业务核心与接口源头

user GUI
👉 只做 前端交互 + 调用 AR-backend 接口

rules（五层规则）
👉 约束 系统行为、调用边界、异常处理、自动化策略

scripts + YL-monitor 自动化
👉 分清 “部署控制” 和 “运行监控”

二、阶段化开发 & 部署方案（强烈建议按顺序）
阶段一：基础运行态统一（最关键）
目标

确保 三个主体都能被“可靠启动、停止、重启、检测”

1️⃣ 统一运行模型（强制）

建议你采用 进程级 + HTTP 健康检查 双机制：

模块	运行方式
AR-backend	Python / Flask / Gunicorn
user GUI	PyQt / Electron / exe / python
YL-monitor	Web + 后端监控进程
2️⃣ AR-backend 必须具备的接口（如果还没有，必须补）
GET /health
{
  "status": "ok",
  "modules": {
    "video": true,
    "audio": true,
    "face_swap": true,
    "virtual_cam": true
  }
}

GET /metrics
{
  "cpu": 23,
  "memory": 2048,
  "fps": 29.8
}


📌 这是 YL-monitor 能监控一切的前提

3️⃣ user GUI 调用链确认

明确调用逻辑（你可以直接贴在 README）：

user GUI
  ↓ HTTP / WebSocket
AR-backend API
  ↓
视频 / 音频 / 人脸模块


❗ user 不允许：

直接调用底层模型

直接拉摄像头

直接操作虚拟摄像头

验证方式（阶段一）

curl AR-backend/health 返回 OK

user GUI 启动 → 能连接 backend

backend 关闭 → user 有明确错误提示

backend 重启 → user 自动重连

阶段二：YL-monitor 监控体系落地
目标

YL-monitor 成为 唯一“上帝视角”

1️⃣ YL-monitor 监控内容分层
① 进程层（OS 级）

AR-backend 是否存活

user GUI 是否存活

CPU / 内存 / GPU

👉 使用：psutil

② 服务层（接口级）

/health

/metrics

核心模块状态

③ 业务层（逻辑级）

当前人脸模型是否加载

是否有视频流输入

虚拟摄像头是否输出成功

2️⃣ YL-monitor 目录职责明确
YL-monitor/
├── backend/        # 监控逻辑（轮询 / WebSocket）
├── frontend/       # 浏览器监控台
├── agents/         # 本地采集（psutil / gpu）
└── auto_actions/   # 重启 / 告警 / 自愈

3️⃣ 告警与自愈（建议最低配置）
事件	动作
AR-backend 停止	自动重启
FPS < 15	提示用户
GPU 占用 > 95%	禁止新任务
user 崩溃	提示重新打开
验证方式（阶段二）

人为 kill backend → YL-monitor 报警 + 重启

模型加载失败 → 页面提示

视频源断开 → 监控台红色状态

阶段三：user GUI 调用逻辑稳定化
目标

user GUI 100% 无业务逻辑，只是“遥控器”

user 应该做的事情

参数配置（模型 / 音效 / 视频源）

状态显示

用户交互

user 不应该做的事情

❌ 模型加载
❌ 视频处理
❌ 人脸计算
❌ 系统监控

推荐 user → backend 调用规范
POST /session/start
POST /session/stop
POST /effect/set
GET  /status


📌 所有失败 由 backend 定义错误码

验证方式（阶段三）

backend mock 掉 → user 仍能跑 UI

backend 返回错误 → user 有提示

切换模型 → backend 执行，user 不阻塞

阶段四：rules（五层规则架构）部署
目标

规则先行，代码其次

五层规则架构（推荐）
rules/
├── 01_system_rules.md        # 系统级
├── 02_process_rules.md       # 进程级
├── 03_api_rules.md           # 接口级
├── 04_business_rules.md      # 业务级
├── 05_automation_rules.md    # 自动化规则

各层规则示例
① 系统规则

所有服务必须支持 health check

禁止 GUI 直连硬件

② 进程规则

后端只能由 scripts 启动

不允许手动 python main.py

③ API 规则

API 失败必须返回 code + message

不允许 silent fail

④ 业务规则

同时只允许一个视频会话

人脸模型加载互斥

⑤ 自动化规则

崩溃 3 次 → 停止自启

GPU 过载 → 降级模式

验证方式（阶段四）

新人只看 rules 能理解系统

代码 review 时对照 rules

自动化脚本引用 rules

阶段五：自动化脚本职责切割（非常重要）
scripts 目录（部署 & 控制）

👉 “我来启动和配置系统”

scripts/
├── install_env.sh
├── start_backend.sh
├── stop_backend.sh
├── start_user.sh
└── deploy_all.sh


特点：

一次性

可重复

不常驻

YL-monitor 自动化（运行 & 监控）

👉 “我来盯着你跑得好不好”

YL-monitor/auto_actions/
├── restart_backend.py
├── notify_error.py
├── downgrade_mode.py


特点：

常驻

实时

自愈

🚨 严格边界
行为	scripts	YL-monitor
首次部署	✅	❌
启动服务	✅	⚠️
运行中重启	❌	✅
健康检测	❌	✅
最终交付检查清单（你可以照着验）

 AR-backend 有 health / metrics

 user GUI 只调用 API

 YL-monitor 能看到三方状态

 rules 目录完整

 scripts ≠ YL-monitor 自动化

 任一模块崩溃 → 可观测、可恢复

 📋 项目整合计划
一、信息收集总结
项目结构分析：

YL-monitor - FastAPI 监控平台（端口5500），已具备 DAG 引擎、脚本执行器、AR 监控器
AR-backend - PyQt5 GUI 应用，提供实时视频处理、人脸合成、音频处理
user - PyQt5 GUI 应用，前端用户 AR 合成软件界面
scripts - 39个自动化脚本，涵盖部署、监控、验证、安全
rules - 已存在五层规则架构（L1-L5）
关键发现：

YL-monitor 已内置 AR 监控服务（app/services/ar_monitor.py）
user/gui/gui.py 是完整的 AR Live Studio GUI（与 AR-backend 功能重叠）
scripts/monitor/ 目录已有监控脚本需要与 YL-monitor 整合
二、详细整合计划
阶段1：监控整合（任务1-3）
YL-monitor 监控 AR-backend

配置 AR-backend 健康检查端点
在 YL-monitor 注册 AR-backend 节点
实现进程监控和日志收集
YL-monitor 监控 user 目录

监控 user GUI 应用状态
集成用户操作日志
实现远程控制接口
统一监控面板

创建综合监控视图
整合告警规则
阶段2：User GUI 优化（任务4-6）
User GUI 调用逻辑修复

修复 backend 模块导入路径
实现与 AR-backend 的 API 通信
添加服务发现机制
User GUI 功能增强

添加监控数据展示
实现远程配置同步
User GUI 验证测试

功能测试
性能测试
阶段3：五层规则部署（任务7-8）
规则架构完善

验证 L1-L5 规则完整性
添加项目特定规则
实现规则引擎
规则集成

与 YL-monitor 集成
与 scripts 集成
阶段4：脚本整合（任务9-11）
脚本分类整合

YL-monitor 脚本 → 监控/管理类
scripts 目录脚本 → 部署/验证类
统一调用接口
脚本功能合并

去重和优化
统一日志格式
统一配置管理
脚本验证测试

功能验证
依赖检查
阶段5：文档与验证（任务12-14）
部署文档编写

创建带序号的任务部署文档
编写操作手册
系统联调测试

端到端测试
性能压测
最终验证与交付

完整功能验证
文档归档
三、依赖文件清单
需要修改的文件：

YL-monitor/app/services/ar_monitor.py - 扩展监控范围
YL-monitor/app/main.py - 添加 AR-backend 和 user 监控
user/gui/gui.py - 修复调用逻辑
user/main.py - 创建启动入口
scripts/monitor/monitor_server.py - 整合到 YL-monitor
rules/index.js - 完善规则引擎
需要创建的文档：

部署/3.监控整合方案.md
部署/4.User-GUI优化方案.md
部署/5.规则架构部署.md
部署/6.脚本整合方案.md
部署/7.联调测试方案.md
四、后续步骤
创建 TODO.md 跟踪任务进度
按阶段执行整合
每阶段完成后验证
最终整体联调