# 5. 五层规则架构部署方案

**版本:** 1.0.0  
**创建日期:** 2026-02-09  
**状态:** 待执行

## 一、目标

为整个项目部署五层规则架构（L1-L5），建立完整的规则引擎系统，确保：
1. 项目目标清晰（L1）
2. 需求理解一致（L2）
3. 约束条件明确（L3）
4. 决策逻辑规范（L4）
5. 执行流程标准化（L5）

## 二、现状分析

### 2.1 现有规则文件

```
rules/
├── index.js                    # 规则引擎入口
├── L1-meta-goal.json           # 元目标层
├── L2-understanding.json       # 理解层
├── L3-constraints.json         # 约束层
├── L4-decisions.json           # 决策层
├── L5-execution.json           # 执行层
├── rules.config.js             # 规则配置
└── README.md                   # 规则说明
```

### 2.2 现有内容分析

#### L1-meta-goal.json
- 已定义项目愿景、核心目标
- 缺少 AR-backend 和 User GUI 的具体目标

#### L2-understanding.json
- 已定义功能需求、非功能需求
- 缺少监控整合需求

#### L3-constraints.json
- 已定义技术约束、资源约束
- 缺少部署环境约束

#### L4-decisions.json
- 已定义架构决策、技术选型
- 需要更新以反映当前整合方案

#### L5-execution.json
- 已定义开发流程、质量标准
- 需要添加整合阶段的具体流程

## 三、规则架构设计

### 3.1 五层架构关系

```
┌─────────────────────────────────────────────────────────────┐
│ L1: Meta-Goal (元目标层)                                     │
│ 项目愿景、核心目标、成功标准                                   │
├─────────────────────────────────────────────────────────────┤
│ L2: Understanding (理解层)                                 │
│ 功能需求、非功能需求、用户场景                                 │
├─────────────────────────────────────────────────────────────┤
│ L3: Constraints (约束层)                                     │
│ 技术约束、资源约束、时间约束、合规约束                          │
├─────────────────────────────────────────────────────────────┤
│ L4: Decisions (决策层)                                       │
│ 架构决策、技术选型、设计模式、集成策略                          │
├─────────────────────────────────────────────────────────────┤
│ L5: Execution (执行层)                                       │
│ 开发流程、测试标准、部署流程、监控规则                          │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 规则引擎架构

```
┌─────────────────────────────────────────┐
│           规则引擎 (rules/index.js)       │
├─────────────────────────────────────────┤
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ │
│  │ 加载器   │ │ 验证器   │ │ 执行器   │ │
│  └────┬────┘ └────┬────┘ └────┬────┘ │
│       └─────────────┼─────────────┘   │
│                     ▼                  │
│            ┌─────────────┐            │
│            │   规则存储    │            │
│            └─────────────┘            │
└─────────────────────────────────────────┘
```

## 四、实施步骤

### 步骤1: 完善 L1 元目标层 (任务7.1)

**目标:** 更新项目愿景，包含整合目标

**文件:** `rules/L1-meta-goal.json`

**更新内容:**
```json
{
  "meta_goal": {
    "vision": "构建统一的 AR 实时处理与监控平台",
    "core_goals": [
      {
        "id": "CG-001",
        "name": "实时视频处理",
        "description": "提供低延迟的实时视频流处理"
      },
      {
        "id": "CG-002", 
        "name": "人脸合成服务",
        "description": "集成多种人脸合成算法"
      },
      {
        "id": "CG-003",
        "name": "统一监控平台",
        "description": "YL-monitor 统一监控 AR-backend 和 User GUI"
      },
      {
        "id": "CG-004",
        "name": "用户友好界面",
        "description": "提供直观的 AR 合成操作界面"
      }
    ],
    "success_criteria": {
      "monitoring": "YL-monitor 能实时监控所有组件",
      "usability": "User GUI 功能完整可用",
      "integration": "各组件间通信正常"
    }
  }
}
```

### 步骤2: 完善 L2 理解层 (任务7.2)

**目标:** 添加监控整合和 GUI 优化需求

**文件:** `rules/L2-understanding.json`

**更新内容:**
```json
{
  "understanding": {
    "functional_requirements": [
      {
        "id": "FR-001",
        "name": "AR-backend 监控",
        "description": "YL-monitor 能监控 AR-backend 健康状态",
        "priority": "high"
      },
      {
        "id": "FR-002",
        "name": "User GUI 监控",
        "description": "YL-monitor 能监控 User GUI 运行状态",
        "priority": "high"
      },
      {
        "id": "FR-003",
        "name": "GUI 功能修复",
        "description": "修复 User GUI 的模块导入和调用逻辑",
        "priority": "high"
      },
      {
        "id": "FR-004",
        "name": "服务发现",
        "description": "自动发现 AR-backend 和 YL-monitor 服务",
        "priority": "medium"
      }
    ],
    "non_functional_requirements": [
      {
        "id": "NFR-001",
        "name": "监控延迟",
        "description": "状态上报延迟 < 5秒",
        "priority": "high"
      },
      {
        "id": "NFR-002",
        "name": "GUI 响应",
        "description": "界面操作响应 < 100ms",
        "priority": "high"
      }
    ]
  }
}
```

### 步骤3: 完善 L3 约束层 (任务7.3)

**目标:** 添加部署和整合约束

**文件:** `rules/L3-constraints.json`

**更新内容:**
```json
{
  "constraints": {
    "technical": [
      {
        "id": "TC-001",
        "name": "Python 版本",
        "description": "所有组件使用 Python 3.8+",
        "type": "mandatory"
      },
      {
        "id": "TC-002",
        "name": "端口范围",
        "description": "服务端口 5500-5510",
        "type": "mandatory"
      },
      {
        "id": "TC-003",
        "name": "通信协议",
        "description": "HTTP/REST 或 WebSocket",
        "type": "mandatory"
      }
    ],
    "resource": [
      {
        "id": "RC-001",
        "name": "内存限制",
        "description": "AR-backend 最大 4GB",
        "type": "recommended"
      }
    ],
    "integration": [
      {
        "id": "IC-001",
        "name": "向后兼容",
        "description": "修改不得破坏现有功能",
        "type": "mandatory"
      },
      {
        "id": "IC-002",
        "name": "渐进式整合",
        "description": "分阶段整合，每阶段可独立验证",
        "type": "mandatory"
      }
    ]
  }
}
```

### 步骤4: 完善 L4 决策层 (任务7.4)

**目标:** 记录整合方案的关键决策

**文件:** `rules/L4-decisions.json`

**更新内容:**
```json
{
  "decisions": {
    "architecture": [
      {
        "id": "AD-001",
        "name": "监控架构",
        "decision": "YL-monitor 作为中心监控平台",
        "rationale": "统一监控视图，简化管理",
        "alternatives": ["各组件自监控", "第三方监控工具"],
        "consequences": ["需要添加监控端点", "依赖 YL-monitor 可用性"]
      },
      {
        "id": "AD-002",
        "name": "通信方式",
        "decision": "HTTP REST API + WebSocket",
        "rationale": "标准化接口，易于调试",
        "alternatives": ["gRPC", "消息队列"],
        "consequences": ["需要处理连接管理", "实时性稍差"]
      }
    ],
    "technology": [
      {
        "id": "TD-001",
        "name": "GUI 框架",
        "decision": "继续使用 PyQt5",
        "rationale": "现有代码基础，功能完整",
        "alternatives": ["PySide6", "Electron"],
        "consequences": ["需要修复导入问题", "保持现有用户体验"]
      }
    ]
  }
}
```

### 步骤5: 完善 L5 执行层 (任务7.5)

**目标:** 定义整合阶段的具体执行规则

**文件:** `rules/L5-execution.json`

**更新内容:**
```json
{
  "execution": {
    "phases": [
      {
        "id": "P1",
        "name": "监控整合",
        "order": 1,
        "tasks": ["AR-backend 监控服务", "User GUI 状态上报", "统一监控面板"],
        "exit_criteria": ["YL-monitor 显示所有节点", "告警功能正常"]
      },
      {
        "id": "P2",
        "name": "GUI 优化",
        "order": 2,
        "tasks": ["修复导入路径", "添加服务客户端", "功能验证"],
        "exit_criteria": ["GUI 功能完整", "与后端通信正常"]
      },
      {
        "id": "P3",
        "name": "规则部署",
        "order": 3,
        "tasks": ["完善 L1-L5", "规则引擎集成", "规则验证"],
        "exit_criteria": ["规则文件完整", "引擎运行正常"]
      },
      {
        "id": "P4",
        "name": "脚本整合",
        "order": 4,
        "tasks": ["分类整理", "功能合并", "统一接口"],
        "exit_criteria": ["脚本无重复", "功能完整"]
      },
      {
        "id": "P5",
        "name": "联调测试",
        "order": 5,
        "tasks": ["端到端测试", "性能测试", "文档归档"],
        "exit_criteria": ["所有功能正常", "文档完整"]
      }
    ],
    "quality_gates": [
      {
        "id": "QG-001",
        "name": "代码审查",
        "criteria": ["无导入错误", "有错误处理", "有日志记录"]
      },
      {
        "id": "QG-002",
        "name": "功能测试",
        "criteria": ["单元测试通过", "集成测试通过", "手动测试通过"]
      }
    ]
  }
}
```

### 步骤6: 完善规则引擎 (任务7.6)

**目标:** 增强规则引擎功能

**文件:** `rules/index.js`

**功能增强:**
- 添加规则验证
- 添加规则依赖检查
- 添加执行追踪

```javascript
class RulesEngine {
  constructor() {
    this.rules = {};
    this.loadRules();
  }
  
  loadRules() {
    // 加载 L1-L5 规则
    this.rules.L1 = require('./L1-meta-goal.json');
    this.rules.L2 = require('./L2-understanding.json');
    this.rules.L3 = require('./L3-constraints.json');
    this.rules.L4 = require('./L4-decisions.json');
    this.rules.L5 = require('./L5-execution.json');
  }
  
  validate() {
    // 验证规则完整性
    // 检查依赖关系
    // 验证约束一致性
  }
  
  execute(phase) {
    // 执行指定阶段的规则
    // 返回执行结果
  }
}
```

### 步骤7: 规则集成 (任务8.1)

**目标:** 将规则引擎与项目组件集成

**集成点:**

1. **YL-monitor 集成**
   - 添加规则检查 API
   - 在监控面板显示规则状态
   - 规则变更告警

2. **Scripts 集成**
   - 脚本执行前检查规则
   - 根据规则验证环境
   - 执行结果符合规则要求

3. **CI/CD 集成**
   - 提交前验证规则
   - 部署时检查约束
   - 自动执行质量门禁

## 五、验证方案

### 5.1 规则验证

| 验证项 | 方法 | 预期结果 |
|--------|------|----------|
| JSON 格式 | `jsonlint rules/L*.json` | 无语法错误 |
| 规则完整性 | 检查必填字段 | 所有字段存在 |
| 依赖一致性 | 检查 ID 引用 | 无悬空引用 |
| 约束可行性 | 人工审查 | 约束可实现 |

### 5.2 引擎验证

| 验证项 | 方法 | 预期结果 |
|--------|------|----------|
| 规则加载 | `node rules/index.js` | 成功加载 |
| 规则验证 | 调用 validate() | 返回通过 |
| 阶段执行 | 调用 execute('P1') | 返回执行计划 |

### 5.3 集成验证

| 验证项 | 方法 | 预期结果 |
|--------|------|----------|
| YL-monitor API | GET /api/rules/status | 返回规则状态 |
| 脚本检查 | 执行脚本 | 按规则验证环境 |
| 质量门禁 | 提交代码 | 触发规则检查 |

## 六、风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 规则过于复杂 | 难以执行 | 保持规则简洁，分阶段实施 |
| 规则冲突 | 执行矛盾 | 建立规则优先级，冲突时人工裁决 |
| 规则过时 | 与代码不符 | 每次代码变更同步更新规则 |
| 团队不熟悉 | 执行不到位 | 提供培训，建立规则检查清单 |

## 七、执行检查点

- [ ] 检查点1: L1-L5 JSON 文件格式正确
- [ ] 检查点2: 规则引擎能正常加载
- [ ] 检查点3: 规则验证通过
- [ ] 检查点4: YL-monitor 集成完成
- [ ] 检查点5: Scripts 集成完成
- [ ] 检查点6: 文档已更新

## 八、关联文档

- [3.监控整合方案.md](./3.监控整合方案.md)
- [4.User-GUI优化方案.md](./4.User-GUI优化方案.md)
- [6.脚本整合方案.md](./6.脚本整合方案.md)

---

**下一步:** 执行步骤1 - 完善 L1 元目标层
