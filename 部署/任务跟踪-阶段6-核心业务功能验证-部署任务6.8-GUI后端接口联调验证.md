# 部署任务6.8: GUI→后端接口联调验证

**任务ID:** 6.8  
**所属阶段:** 阶段6 - 核心业务功能验证  
**任务名称:** GUI→后端接口联调验证  
**优先级:** P0（最高优先级）  
**关键性:** 阻塞性  
**预计工时:** 4小时  
**负责人:** 全栈工程师  
**前置依赖:** 任务6.1-6.7完成  
**状态:** 待开始

---

## 一、任务目标

验证GUI到后端接口联调，确保视频流接口、控制命令接口、状态查询接口、错误处理和性能基准功能正常。

---

## 二、工作内容

1. 视频流接口联调
2. 控制命令接口联调
3. 状态查询接口联调
4. 错误处理联调
5. 性能基准测试

---

## 三、实施步骤

### 步骤1: 启动后端服务

```bash
# 1. 启动AR-backend
cd /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/AR-backend
./start_monitor.sh

# 2. 检查后端健康
curl http://localhost:5501/health
echo "✓ 后端服务已启动"
```

### 步骤2: 测试视频流接口

```bash
cat > /tmp/test_backend_video_api.py << 'EOF'
#!/usr/bin/env python3
import requests
import sys
import time

BASE_URL = "http://localhost:5501"

def test_video_stream_api():
    print("=" * 50)
    print("视频流接口测试")
    print("=" * 50)
    
    # 测试视频流端点
    print("\n测试视频流端点...")
    start = time.time()
    
    try:
        response = requests.get(f"{BASE_URL}/video/stream", stream=True, timeout=5)
        elapsed = (time.time() - start) * 1000
        
        if response.status_code == 200:
            print(f"  ✓ 视频流连接成功")
            print(f"  响应时间: {elapsed:.2f}ms")
            
            if elapsed < 100:
                print("  ✓ 响应时间达标 (<100ms)")
            else:
                print("  ⚠ 响应时间较长")
            
            return True
        else:
            print(f"  ✗ 视频流连接失败: HTTP {response.status_code}")
            return False
            
    except Exception as e:
        print(f"  ✗ 连接错误: {e}")
        return False

if __name__ == "__main__":
    success = test_video_stream_api()
    sys.exit(0 if success else 1)
EOF

python3 /tmp/test_backend_video_api.py
```

### 步骤3: 测试控制命令接口

```bash
cat > /tmp/test_backend_control_api.py << 'EOF'
#!/usr/bin/env python3
import requests
import sys
import time

BASE_URL = "http://localhost:5501"

def test_control_commands():
    print("=" * 50)
    print("控制命令接口测试")
    print("=" * 50)
    
    commands = [
        ("start_camera", "POST", {}),
        ("stop_camera", "POST", {}),
        ("set_params", "POST", {"brightness": 1.2, "contrast": 1.1}),
    ]
    
    all_passed = True
    
    for cmd, method, params in commands:
        print(f"\n测试命令: {cmd}")
        
        try:
            start = time.time()
            
            if method == "POST":
                response = requests.post(
                    f"{BASE_URL}/api/camera/{cmd}",
                    json=params,
                    timeout=5
                )
            else:
                response = requests.get(
                    f"{BASE_URL}/api/camera/{cmd}",
                    timeout=5
                )
            
            elapsed = (time.time() - start) * 1000
            
            if response.status_code == 200:
                print(f"  ✓ 命令执行成功")
                print(f"  响应时间: {elapsed:.2f}ms")
            else:
                print(f"  ✗ 命令执行失败: HTTP {response.status_code}")
                all_passed = False
                
        except Exception as e:
            print(f"  ✗ 命令错误: {e}")
            all_passed = False
    
    return all_passed

if __name__ == "__main__":
    success = test_control_commands()
    sys.exit(0 if success else 1)
EOF

python3 /tmp/test_backend_control_api.py
```

### 步骤4: 测试状态查询接口

```bash
cat > /tmp/test_backend_status_api.py << 'EOF'
#!/usr/bin/env python3
import requests
import sys

BASE_URL = "http://localhost:5501"

def test_status_api():
    print("=" * 50)
    print("状态查询接口测试")
    print("=" * 50)
    
    # 测试健康检查
    print("\n测试健康检查...")
    try:
        response = requests.get(f"{BASE_URL}/health", timeout=5)
        if response.status_code == 200:
            data = response.json()
            print(f"  ✓ 健康检查通过")
            print(f"  状态: {data.get('status', 'unknown')}")
        else:
            print(f"  ✗ 健康检查失败: HTTP {response.status_code}")
            return False
    except Exception as e:
        print(f"  ✗ 健康检查错误: {e}")
        return False
    
    # 测试状态端点
    print("\n测试状态端点...")
    try:
        response = requests.get(f"{BASE_URL}/status", timeout=5)
        if response.status_code == 200:
            data = response.json()
            print(f"  ✓ 状态查询成功")
            print(f"  摄像头: {data.get('camera', 'unknown')}")
            print(f"  音频: {data.get('audio', 'unknown')}")
        else:
            print(f"  ✗ 状态查询失败: HTTP {response.status_code}")
            return False
    except Exception as e:
        print(f"  ✗ 状态查询错误: {e}")
        return False
    
    # 测试指标端点
    print("\n测试指标端点...")
    try:
        response = requests.get(f"{BASE_URL}/metrics", timeout=5)
        if response.status_code == 200:
            data = response.json()
            print(f"  ✓ 指标查询成功")
            print(f"  系统: {data.get('system', {})}")
        else:
            print(f"  ✗ 指标查询失败: HTTP {response.status_code}")
            return False
    except Exception as e:
        print(f"  ✗ 指标查询错误: {e}")
        return False
    
    return True

if __name__ == "__main__":
    success = test_status_api()
    sys.exit(0 if success else 1)
EOF

python3 /tmp/test_backend_status_api.py
```

### 步骤5: 完整联调测试

```bash
cat > /tmp/test_full_integration.py << 'EOF'
#!/usr/bin/env python3
import requests
import sys
import time

BASE_URL = "http://localhost:5501"

def test_full_integration():
    print("=" * 50)
    print("完整联调测试")
    print("=" * 50)
    
    # 1. 健康检查
    print("\n1. 健康检查...")
    try:
        response = requests.get(f"{BASE_URL}/health", timeout=5)
        if response.status_code != 200:
            print("  ✗ 后端未就绪")
            return False
        print("  ✓ 后端就绪")
    except Exception as e:
        print(f"  ✗ 连接失败: {e}")
        return False
    
    # 2. 启动摄像头
    print("\n2. 启动摄像头...")
    try:
        response = requests.post(f"{BASE_URL}/api/camera/start", timeout=5)
        if response.status_code == 200:
            print("  ✓ 摄像头启动成功")
        else:
            print(f"  ✗ 摄像头启动失败: HTTP {response.status_code}")
            return False
    except Exception as e:
        print(f"  ✗ 启动错误: {e}")
        return False
    
    # 3. 获取状态
    print("\n3. 获取状态...")
    try:
        response = requests.get(f"{BASE_URL}/status", timeout=5)
        if response.status_code == 200:
            data = response.json()
            if data.get('camera') == 'active':
                print("  ✓ 摄像头状态正常")
            else:
                print(f"  ⚠ 摄像头状态: {data.get('camera')}")
        else:
            print(f"  ✗ 状态获取失败: HTTP {response.status_code}")
    except Exception as e:
        print(f"  ✗ 状态获取错误: {e}")
    
    # 4. 设置参数
    print("\n4. 设置参数...")
    try:
        response = requests.post(
            f"{BASE_URL}/api/camera/set_params",
            json={"brightness": 1.2},
            timeout=5
        )
        if response.status_code == 200:
            print("  ✓ 参数设置成功")
        else:
            print(f"  ✗ 参数设置失败: HTTP {response.status_code}")
    except Exception as e:
        print(f"  ✗ 参数设置错误: {e}")
    
    # 5. 停止摄像头
    print("\n5. 停止摄像头...")
    try:
        response = requests.post(f"{BASE_URL}/api/camera/stop", timeout=5)
        if response.status_code == 200:
            print("  ✓ 摄像头停止成功")
        else:
            print(f"  ✗ 摄像头停止失败: HTTP {response.status_code}")
    except Exception as e:
        print(f"  ✗ 停止错误: {e}")
    
    print("\n" + "=" * 50)
    print("✓ 完整联调测试完成")
    return True

if __name__ == "__main__":
    success = test_full_integration()
    sys.exit(0 if success else 1)
EOF

python3 /tmp/test_full_integration.py
```

---

## 四、验证步骤

### 验证清单

- [ ] 视频流接口响应<100ms
- [ ] 控制命令执行成功
- [ ] 状态查询数据准确
- [ ] 错误处理正常
- [ ] 端到端延迟<500ms

---

## 五、预期结果

| 指标 | 目标值 | 验证方法 |
|------|--------|----------|
| 视频流响应 | <100ms | API测试 |
| 控制命令 | 成功 | 功能测试 |
| 状态查询 | 准确 | 数据验证 |
| 错误处理 | 正常 | 异常测试 |
| 端到端延迟 | <500ms | 性能测试 |

---

## 六、关联文档

- [任务跟踪-阶段6-核心业务功能验证.md](./任务跟踪-阶段6-核心业务功能验证.md)
- [任务跟踪-阶段6-核心业务功能验证-部署任务6.7-User GUI音频处理功能验证.md](./任务跟踪-阶段6-核心业务功能验证-部署任务6.7-User GUI音频处理功能验证.md)
- [任务跟踪-阶段7-监控体系完善.md](./任务跟踪-阶段7-监控体系完善.md)

---

**创建时间:** 2026-02-11
