# 阶段1 - 任务1.1: AR-backend 监控服务创建 - 详细部署文档

**任务ID:** 1.1  
**任务名称:** AR-backend 监控服务创建  
**优先级:** P0（阻塞性）  
**预计工时:** 4小时  
**状态:** 待执行

---

## 一、任务目标

为 AR-backend 创建独立的监控服务，提供 HTTP API 供 YL-monitor 查询健康状态和性能指标。

## 二、部署内容

### 2.1 创建文件清单

| 序号 | 文件路径 | 文件类型 | 说明 |
|------|----------|----------|------|
| 1 | `AR-backend/monitor_server.py` | 新建 | 监控服务主程序 |
| 2 | `AR-backend/monitor_config.yaml` | 新建 | 监控服务配置 |
| 3 | `AR-backend/start_monitor.sh` | 新建 | 启动脚本 |
| 4 | `AR-backend/requirements.txt` | 修改 | 添加Flask依赖 |

### 2.2 详细代码实现

#### 文件1: AR-backend/monitor_server.py

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
AR-backend 监控服务
提供健康检查、状态查询、性能指标等HTTP API
"""

import os
import sys
import time
import psutil
import yaml
from datetime import datetime
from pathlib import Path
from flask import Flask, jsonify, request
from flask_cors import CORS

# 添加项目路径
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

app = Flask(__name__)
CORS(app, resources={r"/*": {"origins": "*"}})

# 加载配置
config_path = project_root / "monitor_config.yaml"
if config_path.exists():
    with open(config_path, 'r', encoding='utf-8') as f:
        config = yaml.safe_load(f)
else:
    config = {
        "host": "0.0.0.0",
        "port": 5501,
        "debug": False,
        "log_level": "INFO"
    }

# 服务状态
service_status = {
    "start_time": datetime.utcnow().isoformat(),
    "last_health_check": None,
    "camera_status": "unknown",
    "audio_status": "unknown",
    "face_modules": {}
}


def get_system_metrics():
    """获取系统性能指标"""
    try:
        cpu_percent = psutil.cpu_percent(interval=1)
        memory = psutil.virtual_memory()
        disk = psutil.disk_usage('/')
        
        return {
            "cpu_percent": cpu_percent,
            "memory": {
                "total": memory.total,
                "available": memory.available,
                "percent": memory.percent,
                "used": memory.used
            },
            "disk": {
                "total": disk.total,
                "used": disk.used,
                "free": disk.free,
                "percent": (disk.used / disk.total) * 100
            },
            "timestamp": datetime.utcnow().isoformat()
        }
    except Exception as e:
        return {"error": str(e), "timestamp": datetime.utcnow().isoformat()}


def check_camera_status():
    """检查摄像头状态"""
    try:
        import cv2
        cap = cv2.VideoCapture(0)
        if cap.isOpened():
            ret, frame = cap.read()
            cap.release()
            if ret:
                return {
                    "status": "available",
                    "resolution": f"{int(cap.get(cv2.CAP_PROP_FRAME_WIDTH))}x{int(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))}"
                }
        return {"status": "unavailable", "error": "无法打开摄像头"}
    except Exception as e:
        return {"status": "error", "error": str(e)}


def check_audio_status():
    """检查音频状态"""
    try:
        # 这里可以集成实际的音频检查
        return {"status": "available", "devices": []}
    except Exception as e:
        return {"status": "error", "error": str(e)}


def check_face_modules():
    """检查人脸合成模块状态"""
    modules = {}
    module_paths = {
        "deep_live_cam": project_root / "integrations" / "Deep-Live-Cam",
        "deepface_lab": project_root / "integrations" / "DeepFaceLab",
        "faceswap": project_root / "integrations" / "faceswap"
    }
    
    for name, path in module_paths.items():
        modules[name] = {
            "available": path.exists(),
            "path": str(path)
        }
    
    return modules


@app.route('/health', methods=['GET'])
def health_check():
    """
    健康检查端点
    返回服务基本健康状态
    """
    service_status['last_health_check'] = datetime.utcnow().isoformat()
    
    return jsonify({
        "status": "healthy",
        "service": "ar-backend",
        "version": "2.0.0",
        "timestamp": datetime.utcnow().isoformat() + "Z",
        "uptime": time.time() - datetime.fromisoformat(service_status['start_time'].replace('Z', '+00:00')).timestamp()
    })


@app.route('/status', methods=['GET'])
def status():
    """
    详细状态查询端点
    返回各组件详细状态
    """
    service_status['camera_status'] = check_camera_status()
    service_status['audio_status'] = check_audio_status()
    service_status['face_modules'] = check_face_modules()
    
    return jsonify({
        "service": "ar-backend",
        "version": "2.0.0",
        "status": "running",
        "start_time": service_status['start_time'],
        "camera": service_status['camera_status'],
        "audio": service_status['audio_status'],
        "face_modules": service_status['face_modules'],
        "timestamp": datetime.utcnow().isoformat() + "Z"
    })


@app.route('/metrics', methods=['GET'])
def metrics():
    """
    性能指标端点
    返回系统性能指标
    """
    return jsonify({
        "service": "ar-backend",
        "system": get_system_metrics(),
        "timestamp": datetime.utcnow().isoformat() + "Z"
    })


@app.route('/api/camera/start', methods=['POST'])
def start_camera():
    """启动摄像头（预留接口）"""
    return jsonify({
        "status": "success",
        "message": "摄像头启动命令已接收",
        "timestamp": datetime.utcnow().isoformat() + "Z"
    })


@app.route('/api/camera/stop', methods=['POST'])
def stop_camera():
    """停止摄像头（预留接口）"""
    return jsonify({
        "status": "success",
        "message": "摄像头停止命令已接收",
        "timestamp": datetime.utcnow().isoformat() + "Z"
    })


@app.errorhandler(404)
def not_found(error):
    """404错误处理"""
    return jsonify({
        "error": "Not Found",
        "message": "请求的接口不存在",
        "timestamp": datetime.utcnow().isoformat() + "Z"
    }), 404


@app.errorhandler(500)
def internal_error(error):
    """500错误处理"""
    return jsonify({
        "error": "Internal Server Error",
        "message": str(error),
        "timestamp": datetime.utcnow().isoformat() + "Z"
    }), 500


if __name__ == '__main__':
    print(f"[*] AR-backend 监控服务启动中...")
    print(f"[*] 监听地址: {config.get('host', '0.0.0.0')}:{config.get('port', 5501)}")
    
    app.run(
        host=config.get('host', '0.0.0.0'),
        port=config.get('port', 5501),
        debug=config.get('debug', False),
        threaded=True
    )
```

#### 文件2: AR-backend/monitor_config.yaml

```yaml
# AR-backend 监控服务配置

server:
  host: "0.0.0.0"
  port: 5501
  debug: false
  
logging:
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  file: "logs/monitor_server.log"
  
monitoring:
  # 健康检查配置
  health_check_interval: 30  # 秒
  
  # 性能指标收集配置
  metrics_collection_interval: 60  # 秒
  
  # 摄像头检查配置
  camera_check_enabled: true
  
  # 音频检查配置
  audio_check_enabled: true
  
  # 人脸模块检查配置
  face_modules_check_enabled: true

# CORS配置
cors:
  enabled: true
  origins: ["*"]  # 生产环境应限制具体域名
  
# 安全配置
security:
  # 是否启用API密钥验证（生产环境建议启用）
  api_key_enabled: false
  # API密钥（启用时必填）
  api_key: ""
```

#### 文件3: AR-backend/start_monitor.sh

```bash
#!/bin/bash
# AR-backend 监控服务启动脚本

set -e

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 获取脚本所在目录
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo -e "${GREEN}[*] AR-backend 监控服务启动脚本${NC}"

# 检查Python
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}[!] 错误: 未找到 python3${NC}"
    exit 1
fi

# 检查虚拟环境
if [ -d "venv" ]; then
    echo -e "${GREEN}[*] 激活虚拟环境...${NC}"
    source venv/bin/activate
else
    echo -e "${YELLOW}[!] 警告: 未找到虚拟环境，使用系统Python${NC}"
fi

# 检查依赖
echo -e "${GREEN}[*] 检查依赖...${NC}"
pip list | grep -i flask > /dev/null || {
    echo -e "${YELLOW}[!] 安装 Flask...${NC}"
    pip install flask flask-cors pyyaml psutil
}

# 创建日志目录
mkdir -p logs

# 检查端口占用
PORT=5501
if lsof -Pi :$PORT -sTCP:LISTEN -t >/dev/null ; then
    echo -e "${YELLOW}[!] 警告: 端口 $PORT 已被占用${NC}"
    echo -e "${YELLOW}[!] 尝试查找占用进程...${NC}"
    lsof -Pi :$PORT -sTCP:LISTEN
    read -p "是否终止占用进程并继续? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${GREEN}[*] 终止占用进程...${NC}"
        lsof -Pi :$PORT -sTCP:LISTEN -t | xargs kill -9
        sleep 2
    else
        echo -e "${RED}[!] 退出${NC}"
        exit 1
    fi
fi

# 启动服务
echo -e "${GREEN}[*] 启动监控服务...${NC}"
echo -e "${GREEN}[*] 访问地址: http://localhost:$PORT${NC}"
echo -e "${GREEN}[*] 健康检查: http://localhost:$PORT/health${NC}"
echo -e "${GREEN}[*] 按 Ctrl+C 停止服务${NC}"
echo ""

# 使用nohup后台运行（可选）
if [ "$1" == "--daemon" ]; then
    nohup python3 monitor_server.py > logs/monitor_server.log 2>&1 &
    echo $! > monitor_server.pid
    echo -e "${GREEN}[*] 服务已在后台启动，PID: $(cat monitor_server.pid)${NC}"
else
    python3 monitor_server.py
fi
```

#### 文件4: 修改 AR-backend/requirements.txt

添加以下依赖（如果不存在）：

```text
# 监控服务依赖
flask>=2.0.0
flask-cors>=3.0.0
pyyaml>=5.4.0
psutil>=5.8.0
```

## 三、关联内容修复

### 3.1 需要同步修复的文件

| 文件 | 修复内容 | 原因 |
|------|----------|------|
| `AR-backend/main.py` | 添加监控服务启动选项 | 主程序需要能启动监控服务 |
| `AR-backend/start.sh` | 添加监控服务启动命令 | 统一启动脚本 |
| `AR-backend/README.md` | 添加监控服务说明 | 文档同步 |

### 3.2 详细修复说明

#### 修复1: AR-backend/main.py

在文件末尾添加监控服务启动选项：

```python
def main():
    """
    主函数：启动AR Live Studio应用程序
    """
    import argparse
    
    parser = argparse.ArgumentParser(description='AR Live Studio')
    parser.add_argument('--monitor-only', action='store_true', 
                       help='仅启动监控服务')
    args = parser.parse_args()
    
    if args.monitor_only:
        # 仅启动监控服务
        from monitor_server import app
        app.run(host='0.0.0.0', port=5501, threaded=True)
    else:
        # 启动完整GUI
        app = QApplication(sys.argv)
        window = ARApp()
        window.show()
        sys.exit(app.exec_())
```

#### 修复2: AR-backend/start.sh

添加监控服务启动函数：

```bash
# 在文件末尾添加
start_monitor() {
    echo "[*] 启动监控服务..."
    cd "$SCRIPT_DIR"
    python3 monitor_server.py &
    echo $! > monitor_server.pid
    echo "[*] 监控服务已启动，PID: $(cat monitor_server.pid)"
}

# 修改主逻辑，添加monitor选项
case $1 in
    monitor)
        start_monitor
        ;;
    # ... 其他选项
esac
```

## 四、部署执行步骤

### 4.1 执行前检查

```bash
# 1. 检查Python版本
python3 --version  # 需要3.8+

# 2. 检查端口占用
lsof -i :5501

# 3. 检查依赖
pip list | grep -i flask
```

### 4.2 部署执行

```bash
# 1. 进入AR-backend目录
cd /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/AR-backend

# 2. 创建监控服务文件（复制上述代码）
# monitor_server.py
# monitor_config.yaml
# start_monitor.sh

# 3. 添加执行权限
chmod +x start_monitor.sh

# 4. 安装依赖
pip install flask flask-cors pyyaml psutil

# 5. 启动服务
./start_monitor.sh

# 或后台运行
./start_monitor.sh --daemon
```

### 4.3 部署验证

```bash
# 1. 健康检查
curl http://localhost:5501/health

# 预期输出:
# {
#   "status": "healthy",
#   "service": "ar-backend",
#   "version": "2.0.0",
#   "timestamp": "2026-02-09T10:00:00Z"
# }

# 2. 状态查询
curl http://localhost:5501/status

# 3. 性能指标
curl http://localhost:5501/metrics

# 4. 检查日志
tail -f logs/monitor_server.log
```

## 五、常见问题及解决

### 问题1: 端口5501被占用

**现象:** 启动时报错 "Address already in use"

**解决:**
```bash
# 查找占用进程
lsof -i :5501

# 终止进程
kill -9 <PID>

# 或修改配置文件使用其他端口
# 修改 monitor_config.yaml 中的 port: 5502
```

### 问题2: Flask模块未找到

**现象:** `ModuleNotFoundError: No module named 'flask'`

**解决:**
```bash
pip install flask flask-cors pyyaml psutil

# 或在虚拟环境中安装
source venv/bin/activate
pip install flask flask-cors pyyaml psutil
```

### 问题3: CORS跨域错误

**现象:** YL-monitor无法访问API，浏览器报CORS错误

**解决:**
```python
# 确认 monitor_server.py 中已启用CORS
CORS(app, resources={r"/*": {"origins": "*"}})

# 生产环境应限制域名
CORS(app, resources={r"/*": {"origins": ["http://localhost:5500"]}})
```

### 问题4: 摄像头检测失败

**现象:** /status接口返回摄像头状态为error

**解决:**
```bash
# 检查摄像头权限
ls -l /dev/video*

# 检查OpenCV安装
python3 -c "import cv2; print(cv2.__version__)"

# 安装v4l-utils测试摄像头
sudo apt-get install v4l-utils
v4l2-ctl --list-devices
```

## 六、验证清单

- [ ] 文件创建完成（monitor_server.py, monitor_config.yaml, start_monitor.sh）
- [ ] 依赖安装完成（flask, flask-cors, pyyaml, psutil）
- [ ] 服务启动成功
- [ ] /health端点返回正确JSON
- [ ] /status端点返回详细状态
- [ ] /metrics端点返回性能指标
- [ ] 日志记录正常
- [ ] 端口5501可访问
- [ ] CORS配置正确
- [ ] 关联文件已修复（main.py, start.sh, README.md）

## 七、下一步

完成本任务后，继续执行 **任务1.2: User GUI 状态上报实现**

查看文档: `部署/任务跟踪-阶段1-监控整合-部署任务1.2-User-GUI状态上报实现.md`
