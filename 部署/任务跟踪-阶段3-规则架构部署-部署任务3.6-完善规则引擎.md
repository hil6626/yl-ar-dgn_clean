# Phase 3 - Task 3.6: Improve Rule Engine - Detailed Deployment Document

**Task ID:** 3.6  
**Task Name:** Improve Rule Engine  
**Priority:** P2 (Medium)  
**Estimated Hours:** 3 hours  
**Status:** Pending  
**Prerequisites:** Tasks 3.1-3.5 completed

---

## I. Task Objectives

Create a unified rule engine that can load, validate, and execute all L1-L5 rules.

## II. Deployment Content

### 2.1 Files to Create

| No. | File Path | Operation | Description |
|-----|-----------|-----------|-------------|
| 1 | `rules/engine.py` | New | Main rule engine |
| 2 | `rules/loader.py` | New | Rule loader |
| 3 | `rules/__init__.py` | Modify | Package init |

### 2.2 Detailed Code Implementation

#### File 1: rules/engine.py

```python
#!/usr/bin/env python3
"""
Rule Engine
Unified engine for loading and executing all rules
"""

import json
import logging
from pathlib import Path
from typing import Dict, List, Any, Optional

logger = logging.getLogger('RuleEngine')


class RuleEngine:
    """
    Unified Rule Engine
    """

    LAYERS = ['L1', 'L2', 'L3', 'L4', 'L5']

    def __init__(self, rules_dir: Optional[Path] = None):
        self.rules_dir = rules_dir or Path(__file__).parent
        self.rules: Dict[str, Dict] = {}
        self.loaded = False
        self.validators = {}
        self.executors = {}

    def load_all_rules(self) -> bool:
        """
        Load all rule layers
        """
        try:
            for layer in self.LAYERS:
                self._load_layer(layer)

            self.loaded = True
            logger.info(f"Loaded {len(self.rules)} rule layers")
            return True

        except Exception as e:
            logger.error(f"Failed to load rules: {e}")
            return False

    def _load_layer(self, layer: str):
        """
        Load a specific layer
        """
        # Find rule file
        pattern = f'{layer}-*.json'
        files = list(self.rules_dir.glob(pattern))

        if not files:
            logger.warning(f"No rule files found for {layer}")
            return

        # Load first matching file
        rule_file = files[0]
        with open(rule_file) as f:
            self.rules[layer] = json.load(f)
            logger.info(f"Loaded {layer} rules from {rule_file}")

    def get_rule(self, layer: str, key: Optional[str] = None) -> Any:
        """
        Get specific rule
        """
        if not self.loaded:
            self.load_all_rules()

        layer_rules = self.rules.get(layer, {})
        if key:
            return layer_rules.get(key)
        return layer_rules

    def validate_all(self) -> Dict[str, bool]:
        """
        Validate all rules
        """
        results = {}
        for layer in self.LAYERS:
            results[layer] = self._validate_layer(layer)
        return results

    def _validate_layer(self, layer: str) -> bool:
        """
        Validate a specific layer
        """
        rules = self.rules.get(layer, {})
        if not rules:
            return False

        # Basic validation - check required fields
        required_fields = {
            'L1': ['layer', 'name', 'goals'],
            'L2': ['layer', 'name', 'context'],
            'L3': ['layer', 'name', 'technical_constraints'],
            'L4': ['layer', 'name', 'decision_rules'],
            'L5': ['layer', 'name', 'procedures']
        }

        fields = required_fields.get(layer, [])
        return all(f in rules for f in fields)

    def execute_decision(self, decision_id: str, context: Dict) -> Dict:
        """
        Execute a decision from L4
        """
        decisions = self.get_rule('L4', 'decision_rules') or []
        decision = next((d for d in decisions if d['id'] == decision_id), None)

        if not decision:
            return {'success': False, 'error': 'Decision not found'}

        # Execute actions
        results = {'success': True, 'actions': []}
        for action in decision.get('actions', []):
            # Execute action
            results['actions'].append(action)

        return results

    def run_procedure(self, procedure_id: str) -> Dict:
        """
        Run a procedure from L5
        """
        procedures = self.get_rule('L5', 'procedures') or []
        procedure = next((p for p in procedures if p['id'] == procedure_id), None)

        if not procedure:
            return {'success': False, 'error': 'Procedure not found'}

        return {
            'success': True,
            'procedure': procedure['name'],
            'steps': len(procedure.get('steps', []))
        }

    def get_goals(self) -> List[Dict]:
        """
        Get all goals from L1
        """
        return self.get_rule('L1', 'goals') or []

    def get_context(self) -> Dict:
        """
        Get context from L2
        """
        return self.get_rule('L2', 'context') or {}

    def check_constraints(self) -> Dict:
        """
        Check constraints from L3
        """
        return self.get_rule('L3', 'technical_constraints') or {}


def main():
    """Main function"""
    engine = RuleEngine()

    # Load rules
    if engine.load_all_rules():
        print("✓ Rules loaded successfully")

        # Show summary
        for layer in engine.LAYERS:
            rules = engine.get_rule(layer)
            if rules:
                print(f"  {layer}: {rules.get('name', 'Unknown')}")

        # Validate
        validation = engine.validate_all()
        print("\nValidation:")
        for layer, valid in validation.items():
            status = "✓" if valid else "✗"
            print(f"  {status} {layer}")
    else:
        print("✗ Failed to load rules")


if __name__ == '__main__':
    main()
```

#### File 2: rules/loader.py

```python
#!/usr/bin/env python3
"""
Rule Loader
Handles loading and caching of rules
"""

import json
import hashlib
import logging
from pathlib import Path
from typing import Dict, Optional
from datetime import datetime

logger = logging.getLogger('RuleLoader')


class RuleLoader:
    """
    Rule Loader with caching
    """

    def __init__(self, rules_dir: Optional[Path] = None):
        self.rules_dir = rules_dir or Path(__file__).parent
        self.cache: Dict[str, Dict] = {}
        self.cache_time: Dict[str, datetime] = {}
        self.cache_duration = 300  # 5 minutes

    def load(self, filename: str, use_cache: bool = True) -> Optional[Dict]:
        """
        Load a rule file
        """
        cache_key = filename

        # Check cache
        if use_cache and cache_key in self.cache:
            cached_time = self.cache_time.get(cache_key)
            if cached_time:
                age = (datetime.now() - cached_time).total_seconds()
                if age < self.cache_duration:
                    return self.cache[cache_key]

        # Load from file
        file_path = self.rules_dir / filename
        if not file_path.exists():
            logger.error(f"Rule file not found: {file_path}")
            return None

        try:
            with open(file_path) as f:
                data = json.load(f)

            # Update cache
            self.cache[cache_key] = data
            self.cache_time[cache_key] = datetime.now()

            return data

        except json.JSONDecodeError as e:
            logger.error(f"Invalid JSON in {filename}: {e}")
            return None
        except Exception as e:
            logger.error(f"Error loading {filename}: {e}")
            return None

    def get_file_hash(self, filename: str) -> str:
        """
        Get MD5 hash of rule file
        """
        file_path = self.rules_dir / filename
        if not file_path.exists():
            return ""

        with open(file_path, 'rb') as f:
            return hashlib.md5(f.read()).hexdigest()

    def invalidate_cache(self, filename: Optional[str] = None):
        """
        Invalidate cache
        """
        if filename:
            self.cache.pop(filename, None)
            self.cache_time.pop(filename, None)
        else:
            self.cache.clear()
            self.cache_time.clear()


def main():
    """Main function"""
    loader = RuleLoader()

    # Test loading
    for layer in ['L1', 'L2', 'L3', 'L4', 'L5']:
        filename = f"{layer}-meta-goal.json" if layer == 'L1' else f"{layer}-*.json"
        files = list(loader.rules_dir.glob(filename.replace('*', 'understanding')))
        if files:
            data = loader.load(files[0].name)
            print(f"{layer}: {'✓' if data else '✗'}")


if __name__ == '__main__':
    main()
```

#### File 3: rules/__init__.py

```python
#!/usr/bin/env python3
"""
Rules Package
"""

from .engine import RuleEngine
from .loader import RuleLoader
from .validator import RuleValidator

__all__ = ['RuleEngine', 'RuleLoader', 'RuleValidator']
```

## III. Deployment Steps

```bash
# 1. Create rule engine
# Edit rules/engine.py

# 2. Create rule loader
# Edit rules/loader.py

# 3. Update package init
# Edit rules/__init__.py

# 4. Test rule engine
python3 rules/engine.py

# 5. Test rule loader
python3 rules/loader.py
```

## IV. Verification Checklist

- [ ] Rule engine created
- [ ] All layers loadable
- [ ] Validation works
- [ ] Execution works
- [ ] Caching works

## V. Next Step

After completing this task, proceed to **Task 3.7: Rule Validation Testing**

View document: `部署/任务跟踪-阶段3-规则架构部署-部署任务3.7-规则验证测试.md`
