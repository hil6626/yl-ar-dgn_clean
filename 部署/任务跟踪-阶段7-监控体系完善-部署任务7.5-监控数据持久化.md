# 部署任务7.5: 监控数据持久化

**任务ID:** 7.5  
**所属阶段:** 阶段7 - 监控体系完善  
**任务名称:** 监控数据持久化  
**优先级:** P1（重要优先级）  
**关键性:** 重要  
**预计工时:** 4小时  
**负责人:** 数据库工程师  
**前置依赖:** 任务7.4完成  
**状态:** 待开始

---

## 一、任务目标

实现YL-monitor监控数据持久化，包括时序数据库选型、数据模型设计、数据写入优化和历史数据查询。

---

## 二、工作内容

1. 时序数据库选型（InfluxDB）
2. 数据模型设计
3. 数据写入优化
4. 数据保留策略
5. 历史数据查询

---

## 三、实施步骤

### 步骤1: 创建InfluxDB配置

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/docker-compose.monitoring.yml << 'EOF'
version: '3.8'

services:
  influxdb:
    image: influxdb:2.0
    container_name: influxdb
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=ar-studio
      - DOCKER_INFLUXDB_INIT_BUCKET=metrics
    volumes:
      - influxdb_data:/var/lib/influxdb2

volumes:
  influxdb_data:
EOF

echo "✓ InfluxDB配置已创建"
```

### 步骤2: 创建InfluxDB存储服务

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/YL-monitor/app/services/influxdb_storage.py << 'EOF'
from influxdb_client import InfluxDBClient, Point
from influxdb_client.client.write_api import SYNCHRONOUS
from datetime import datetime
from typing import List, Dict, Optional

class InfluxDBStorage:
    def __init__(self):
        self.client = InfluxDBClient(
            url="http://localhost:8086",
            token="your-token",
            org="ar-studio"
        )
        self.write_api = self.client.write_api(write_options=SYNCHRONOUS)
        self.query_api = self.client.query_api()
        self.bucket = "metrics"
    
    def write_metric(self, measurement: str, tags: Dict, fields: Dict):
        """写入指标数据"""
        point = Point(measurement)
        
        for key, value in tags.items():
            point = point.tag(key, value)
        
        for key, value in fields.items():
            point = point.field(key, value)
        
        self.write_api.write(bucket=self.bucket, record=point)
    
    def query_metrics(self, measurement: str, start: str, stop: str = None):
        """查询指标数据"""
        query = f'''
        from(bucket: "{self.bucket}")
        |> range(start: {start})
        |> filter(fn: (r) => r._measurement == "{measurement}")
        '''
        
        if stop:
            query += f'|> range(stop: {stop})'
        
        tables = self.query_api.query(query)
        
        results = []
        for table in tables:
            for record in table.records:
                results.append({
                    'time': record.get_time(),
                    'field': record.get_field(),
                    'value': record.get_value()
                })
        
        return results
EOF

echo "✓ InfluxDB存储服务已创建"
```

---

## 四、验证步骤

### 验证清单

- [ ] InfluxDB配置完成
- [ ] 数据写入优化
- [ ] 保留策略配置
- [ ] 历史查询实现

---

## 五、预期结果

| 指标 | 目标值 | 验证方法 |
|------|--------|----------|
| InfluxDB | 配置完成 | 部署测试 |
| 数据写入 | 优化 | 性能测试 |
| 保留策略 | 配置 | 功能验证 |
| 历史查询 | 实现 | 查询测试 |

---

## 六、关联文档

- [任务跟踪-阶段7-监控体系完善.md](./任务跟踪-阶段7-监控体系完善.md)
- [任务跟踪-阶段7-监控体系完善-部署任务7.4-告警通知系统配置.md](./任务跟踪-阶段7-监控体系完善-部署任务7.4-告警通知系统配置.md)
- [任务跟踪-阶段7-监控体系完善-部署任务7.6-移动端适配.md](./任务跟踪-阶段7-监控体系完善-部署任务7.6-移动端适配.md)

---

**创建时间:** 2026-02-11
