# 6. 脚本整合方案

**版本:** 1.0.0  
**创建日期:** 2026-02-09  
**状态:** 待执行

## 一、目标

整合 `YL-monitor/scripts` 和 `scripts` 两个目录的自动化脚本，实现：
1. 明确各自职责边界
2. 消除重复功能
3. 统一调用接口
4. 建立清晰的脚本管理体系

## 二、现状分析

### 2.1 YL-monitor/scripts 目录

```
YL-monitor/scripts/
├── tools/                      # 工具脚本
│   ├── css_version_manager.py
│   ├── test_api_functionality.py
│   └── ...
├── deploy/                     # 部署脚本
│   └── ...
├── cleanup/                    # 清理脚本
│   └── ...
└── ...
```

**特点:**
- 与 YL-monitor 紧密集合
- 主要用于监控平台的管理
- 包含部署、清理、验证等脚本

### 2.2 scripts 目录（根目录）

```
scripts/
├── deploy/                    # 部署脚本 (3个)
├── cleanup/                   # 清理脚本 (5个)
├── docs/                      # 文档脚本 (2个)
├── utilities/                 # 工具脚本 (8个)
├── monitor/                   # 监控脚本 (14个)
├── security/                  # 安全脚本 (2个)
├── validation/              # 验证脚本 (5个)
└── ...
```

**特点:**
- 项目级脚本，涵盖整个项目
- 功能分类清晰
- 数量较多（39个脚本）

### 2.3 重复功能分析

| 功能 | YL-monitor/scripts | scripts | 重复程度 |
|------|-------------------|---------|----------|
| 部署 | deploy/ | deploy/ | 高 |
| 清理 | cleanup/ | cleanup/ | 高 |
| 监控 | monitor/ | monitor/ | 中 |
| 验证 | test_api_functionality.py | validation/ | 中 |
| 文档 | docs/ | docs/ | 低 |

## 三、整合方案

### 3.1 职责划分

```
┌─────────────────────────────────────────────────────────────┐
│                    脚本架构设计                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────┐    ┌─────────────────────┐       │
│  │   YL-monitor/scripts │    │   scripts/           │       │
│  │   (监控平台专用)      │    │   (项目级通用)        │       │
│  ├─────────────────────┤    ├─────────────────────┤       │
│  │ • 监控平台部署       │    │ • 整体项目部署       │       │
│  │ • 监控数据清理       │    │ • 项目级清理         │       │
│  │ • 监控配置管理       │    │ • 跨组件验证         │       │
│  │ • 监控面板工具       │    │ • 安全扫描           │       │
│  │ • 监控特定验证       │    │ • 基础设施管理       │       │
│  └─────────────────────┘    └─────────────────────┘       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 整合策略

#### 策略1: 保留双目录，明确边界

**适用:** 两个目录都有存在的必要性

**规则:**
- `YL-monitor/scripts` - 仅处理 YL-monitor 自身相关
- `scripts/` - 处理整个项目（包括 YL-monitor、AR-backend、user）

**实施:**
1. 审查 YL-monitor/scripts 中的脚本
2. 将项目级功能迁移到 scripts/
3. 保留 YL-monitor 特定功能

#### 策略2: 功能合并，消除重复

**适用:** 两个目录功能重复

**合并清单:**

| 保留位置 | 合并内容 | 处理方式 |
|---------|---------|----------|
| scripts/deploy/ | YL-monitor/scripts/deploy/ | 合并为项目级部署 |
| scripts/cleanup/ | YL-monitor/scripts/cleanup/ | 增强功能，支持全项目 |
| scripts/monitor/ | YL-monitor/scripts/monitor/ | 统一监控脚本 |
| scripts/validation/ | YL-monitor/scripts/tools/test_api_functionality.py | 整合为验证套件 |

#### 策略3: 建立统一入口

**目标:** 提供统一的脚本调用接口

**设计:**

```bash
# 统一入口脚本
scripts/yl-ar-dgn.sh

# 使用方式
./scripts/yl-ar-dgn.sh <command> [options]

# 命令列表
deploy          # 部署项目
cleanup         # 清理项目
monitor         # 启动监控
validate        # 验证项目
status          # 查看状态
help            # 显示帮助
```

### 3.3 详细实施步骤

#### 步骤1: 脚本审查与分类 (任务9.1)

**目标:** 全面审查两个目录的脚本

**操作:**
1. 列出 YL-monitor/scripts 所有脚本
2. 列出 scripts/ 所有脚本
3. 创建功能对照表
4. 标记重复和冲突

**输出:** `scripts/SCRIPT_INVENTORY.md`

#### 步骤2: 迁移 YL-monitor 通用脚本 (任务9.2)

**目标:** 将项目级脚本从 YL-monitor/scripts 迁移到 scripts/

**迁移清单:**

| 源文件 | 目标位置 | 原因 |
|--------|----------|------|
| YL-monitor/scripts/deploy/* | scripts/deploy/yl-monitor/ | 项目级部署 |
| YL-monitor/scripts/cleanup/* | scripts/cleanup/yl-monitor/ | 统一清理 |
| YL-monitor/scripts/tools/test_api_functionality.py | scripts/validation/yl-monitor_api.py | 统一验证 |

**迁移规则:**
- 保留原始文件（添加 DEPRECATED 标记）
- 在新位置创建副本
- 更新内部路径引用
- 添加迁移说明

#### 步骤3: 合并重复功能 (任务9.3)

**目标:** 合并功能重复的脚本

**合并计划:**

1. **部署脚本合并**
   - 主脚本: `scripts/deploy/deploy.sh`
   - 整合 YL-monitor 部署逻辑
   - 支持组件选择部署

2. **清理脚本合并**
   - 主脚本: `scripts/cleanup/cleanup_project.sh`
   - 整合 YL-monitor 清理逻辑
   - 添加交互式选择

3. **监控脚本合并**
   - 主脚本: `scripts/monitor/monitor_server.py`
   - 整合 YL-monitor 监控功能
   - 统一监控接口

#### 步骤4: 创建统一入口 (任务9.4)

**目标:** 创建项目级统一脚本入口

**文件:** `scripts/yl-ar-dgn.sh`

**功能设计:**

```bash
#!/bin/bash
# YL-AR-DGN 项目统一脚本入口

COMMAND=$1
shift

case $COMMAND in
    deploy)
        ./scripts/deploy/deploy.sh "$@"
        ;;
    cleanup)
        ./scripts/cleanup/cleanup_project.sh "$@"
        ;;
    monitor)
        ./scripts/monitor/monitor_server.py "$@"
        ;;
    validate)
        ./scripts/validation/validate_project.sh "$@"
        ;;
    status)
        ./scripts/monitor/project_status.sh "$@"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "未知命令: $COMMAND"
        show_help
        exit 1
        ;;
esac
```

#### 步骤5: 统一配置管理 (任务9.5)

**目标:** 建立统一的脚本配置

**文件:** `scripts/config/script_config.yaml`

**内容:**

```yaml
# 脚本统一配置

project:
  name: "YL-AR-DGN"
  root: "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean"
  
components:
  yl_monitor:
    dir: "YL-monitor"
    port: 5500
    scripts_dir: "YL-monitor/scripts"
    
  ar_backend:
    dir: "AR-backend"
    port: 5501
    
  user_gui:
    dir: "user"
    port: 5502

scripts:
  log_level: "INFO"
  log_dir: "logs"
  timeout: 300
  
deployment:
  backup_before_deploy: true
  verify_after_deploy: true
  rollback_on_failure: true
```

#### 步骤6: 统一日志格式 (任务9.6)

**目标:** 所有脚本使用统一的日志格式

**规范:**

```bash
# 日志级别
[DEBUG] - 调试信息
[INFO]  - 一般信息
[WARN]  - 警告信息
[ERROR] - 错误信息
[FATAL] - 致命错误

# 日志格式
[YYYY-MM-DD HH:MM:SS] [LEVEL] [SCRIPT_NAME] Message

# 示例
[2026-02-09 14:30:00] [INFO] [deploy.sh] 开始部署 YL-monitor
[2026-02-09 14:30:05] [DEBUG] [deploy.sh] 检查依赖...
[2026-02-09 14:30:10] [INFO] [deploy.sh] 部署完成
```

**实现:** `scripts/lib/logging.sh` (Bash) 和 `scripts/lib/logging.py` (Python)

#### 步骤7: 统一错误处理 (任务9.7)

**目标:** 建立统一的错误处理机制

**规范:**

```bash
# 退出码定义
0   - 成功
1   - 通用错误
2   - 参数错误
3   - 依赖缺失
4   - 权限不足
5   - 网络错误
10  - 部署失败
11  - 验证失败
20  - 监控服务异常
30  - 配置错误

# 错误处理函数
handle_error() {
    local exit_code=$1
    local message=$2
    
    log_error "$message"
    cleanup_on_error
    exit $exit_code
}
```

## 四、技术实现

### 4.1 统一入口脚本

```bash
#!/bin/bash
# scripts/yl-ar-dgn.sh

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
CONFIG_FILE="$SCRIPT_DIR/config/script_config.yaml"

# 加载日志库
source "$SCRIPT_DIR/lib/logging.sh"

# 加载配置
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        log_info "加载配置: $CONFIG_FILE"
        # 解析 YAML 配置
    else
        log_warn "配置文件不存在，使用默认配置"
    fi
}

# 显示帮助
show_help() {
    cat << EOF
YL-AR-DGN 项目管理脚本

用法: ./scripts/yl-ar-dgn.sh <命令> [选项]

命令:
    deploy [component]     部署项目或指定组件
    cleanup [type]          清理项目
    monitor [action]        监控管理
    validate [scope]        验证项目
    status                  查看项目状态
    logs [component]        查看日志
    restart [component]     重启组件
    help                    显示此帮助

示例:
    ./scripts/yl-ar-dgn.sh deploy              # 部署所有组件
    ./scripts/yl-ar-dgn.sh deploy yl-monitor     # 仅部署 YL-monitor
    ./scripts/yl-ar-dgn.sh cleanup logs          # 清理日志
    ./scripts/yl-ar-dgn.sh status                # 查看状态

EOF
}

# 主函数
main() {
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi
    
    load_config
    
    COMMAND=$1
    shift
    
    case $COMMAND in
        deploy)
            "$SCRIPT_DIR/deploy/deploy.sh" "$@"
            ;;
        cleanup)
            "$SCRIPT_DIR/cleanup/cleanup_project.sh" "$@"
            ;;
        monitor)
            "$SCRIPT_DIR/monitor/monitor_server.py" "$@"
            ;;
        validate)
            "$SCRIPT_DIR/validation/validate_project.sh" "$@"
            ;;
        status)
            "$SCRIPT_DIR/monitor/project_status.sh" "$@"
            ;;
        logs)
            "$SCRIPT_DIR/monitor/view_logs.sh" "$@"
            ;;
        restart)
            "$SCRIPT_DIR/deploy/restart_component.sh" "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            log_error "未知命令: $COMMAND"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
```

### 4.2 增强部署脚本

```bash
#!/bin/bash
# scripts/deploy/deploy.sh

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/logging.sh"

COMPONENT=$1

deploy_yl_monitor() {
    log_info "部署 YL-monitor..."
    
    # 检查 YL-monitor 目录
    if [ ! -d "YL-monitor" ]; then
        log_error "YL-monitor 目录不存在"
        return 1
    fi
    
    # 安装依赖
    cd YL-monitor
    pip install -r requirements.txt
    
    # 启动服务
    # 使用 nohup 或 systemd
    nohup python -m app.main > logs/yl-monitor.log 2>&1 &
    
    # 验证部署
    sleep 2
    if curl -s http://0.0.0.0:5500/api/health > /dev/null; then
        log_info "YL-monitor 部署成功"
    else
        log_error "YL-monitor 部署失败"
        return 1
    fi
    
    cd ..
}

deploy_ar_backend() {
    log_info "部署 AR-backend..."
    # 类似逻辑
}

deploy_user_gui() {
    log_info "部署 User GUI..."
    # 类似逻辑
}

deploy_all() {
    deploy_yl_monitor
    deploy_ar_backend
    deploy_user_gui
    log_info "所有组件部署完成"
}

# 主逻辑
case $COMPONENT in
    yl-monitor|yl_monitor)
        deploy_yl_monitor
        ;;
    ar-backend|ar_backend)
        deploy_ar_backend
        ;;
    user-gui|user_gui|user)
        deploy_user_gui
        ;;
    all|"")
        deploy_all
        ;;
    *)
        log_error "未知组件: $COMPONENT"
        exit 1
        ;;
esac
```

### 4.3 项目状态脚本

```python
#!/usr/bin/env python3
# scripts/monitor/project_status.py

import requests
import psutil
import yaml
from pathlib import Path
from datetime import datetime

class ProjectStatus:
    def __init__(self):
        self.config = self._load_config()
        self.components = {
            'yl-monitor': {'port': 5500, 'name': 'YL-Monitor'},
            'ar-backend': {'port': 5501, 'name': 'AR Backend'},
            'user-gui': {'port': 5502, 'name': 'User GUI'}
        }
    
    def _load_config(self):
        config_path = Path(__file__).parent.parent / 'config' / 'script_config.yaml'
        if config_path.exists():
            with open(config_path) as f:
                return yaml.safe_load(f)
        return {}
    
    def check_component(self, name, config):
        """检查组件状态"""
        try:
            response = requests.get(
                f"http://0.0.0.0:{config['port']}/health",
                timeout=5
            )
            return {
                'name': config['name'],
                'status': 'running' if response.status_code == 200 else 'error',
                'health': response.json() if response.status_code == 200 else None
            }
        except Exception as e:
            return {
                'name': config['name'],
                'status': 'stopped',
                'error': str(e)
            }
    
    def get_system_status(self):
        """获取系统状态"""
        return {
            'cpu_percent': psutil.cpu_percent(interval=1),
            'memory': psutil.virtual_memory()._asdict(),
            'disk': psutil.disk_usage('/')._asdict(),
            'timestamp': datetime.now().isoformat()
        }
    
    def show_status(self):
        """显示完整状态"""
        print("=" * 60)
        print("YL-AR-DGN 项目状态")
        print("=" * 60)
        
        # 组件状态
        print("\n组件状态:")
        print("-" * 40)
        for name, config in self.components.items():
            status = self.check_component(name, config)
            icon = "✓" if status['status'] == 'running' else "✗"
            print(f"{icon} {status['name']}: {status['status']}")
        
        # 系统状态
        print("\n系统状态:")
        print("-" * 40)
        sys_status = self.get_system_status()
        print(f"CPU: {sys_status['cpu_percent']}%")
        print(f"内存: {sys_status['memory']['percent']}%")
        print(f"磁盘: {sys_status['disk']['percent']}%")
        
        print("\n" + "=" * 60)

if __name__ == '__main__':
    status = ProjectStatus()
    status.show_status()
```

## 五、验证方案

### 5.1 功能验证

| 验证项 | 方法 | 预期结果 |
|--------|------|----------|
| 统一入口 | `./scripts/yl-ar-dgn.sh help` | 显示帮助信息 |
| 部署命令 | `./scripts/yl-ar-dgn.sh deploy --dry-run` | 显示部署计划 |
| 状态查询 | `./scripts/yl-ar-dgn.sh status` | 显示所有组件状态 |
| 日志查看 | `./scripts/yl-ar-dgn.sh logs yl-monitor` | 显示 YL-monitor 日志 |

### 5.2 集成验证

| 验证项 | 方法 | 预期结果 |
|--------|------|----------|
| 脚本调用 YL-monitor | 通过脚本启动监控 | YL-monitor 正常启动 |
| 脚本调用部署 | 通过脚本部署 | 所有组件正常部署 |
| 配置加载 | 脚本读取配置 | 配置正确加载 |
| 日志统一 | 查看日志文件 | 格式统一 |

### 5.3 回归验证

| 验证项 | 方法 | 预期结果 |
|--------|------|----------|
| 原有脚本 | 直接调用原脚本 | 功能正常 |
| 迁移脚本 | 调用迁移后的脚本 | 功能正常 |
| 路径引用 | 检查脚本内路径 | 路径正确 |

## 六、风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 脚本依赖复杂 | 迁移困难 | 先分析依赖关系，逐步迁移 |
| 路径引用错误 | 脚本失效 | 统一使用相对路径或配置化路径 |
| 权限问题 | 无法执行 | 统一设置执行权限 |
| 环境差异 | 行为不一致 | 提供环境检查脚本 |

## 七、执行检查点

- [ ] 检查点1: 脚本清单完成
- [ ] 检查点2: 迁移脚本功能正常
- [ ] 检查点3: 统一入口可用
- [ ] 检查点4: 配置管理正常
- [ ] 检查点5: 日志格式统一
- [ ] 检查点6: 文档已更新

## 八、关联文档

- [3.监控整合方案.md](./3.监控整合方案.md)
- [4.User-GUI优化方案.md](./4.User-GUI优化方案.md)
- [5.规则架构部署.md](./5.规则架构部署.md)
- [7.联调测试方案.md](./7.联调测试方案.md)

---

**下一步:** 执行步骤1 - 脚本审查与分类
