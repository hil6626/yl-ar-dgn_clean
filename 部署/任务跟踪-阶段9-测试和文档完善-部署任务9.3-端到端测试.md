# 部署任务9.3: 端到端测试

**任务ID:** 9.3  
**所属阶段:** 阶段9 - 测试和文档完善  
**任务名称:** 端到端测试  
**优先级:** P0（最高优先级）  
**关键性:** 阻塞性  
**预计工时:** 6小时  
**负责人:** 测试工程师  
**前置依赖:** 任务9.2完成  
**状态:** 待开始

---

## 一、任务目标

完成端到端测试，包括用户场景测试、完整流程测试和系统稳定性测试。

---

## 二、工作内容

1. 用户场景测试
2. 完整流程测试
3. 系统稳定性测试
4. 故障恢复测试
5. 并发用户测试

---

## 三、实施步骤

### 步骤1: 创建端到端测试脚本

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/test/test_e2e/test_full_workflow.py << 'EOF'
import pytest
import requests
import time
import websocket

BASE_URL = "http://localhost:5501"
WS_URL = "ws://localhost:5000/ws/metrics"

class TestEndToEnd:
    """端到端测试"""
    
    def test_full_workflow(self):
        """测试完整工作流程"""
        print("\n=== 端到端测试: 完整工作流程 ===")
        
        # 1. 启动服务
        print("1. 检查服务状态...")
        response = requests.get(f"{BASE_URL}/health", timeout=10)
        assert response.status_code == 200
        print("   ✓ 服务运行中")
        
        # 2. 获取初始状态
        print("2. 获取初始状态...")
        response = requests.get(f"{BASE_URL}/status", timeout=5)
        assert response.status_code == 200
        print("   ✓ 状态获取成功")
        
        # 3. 测试视频流
        print("3. 测试视频流...")
        response = requests.get(f"{BASE_URL}/api/video/info", timeout=5)
        assert response.status_code in [200, 401]
        print("   ✓ 视频流接口正常")
        
        # 4. 测试监控数据
        print("4. 测试监控数据...")
        response = requests.get("http://localhost:5000/api/metrics/realtime", timeout=5)
        assert response.status_code == 200
        print("   ✓ 监控数据获取成功")
        
        print("=== 端到端测试完成 ===")
    
    def test_websocket_connection(self):
        """测试WebSocket连接"""
        print("\n=== 测试WebSocket连接 ===")
        
        try:
            ws = websocket.create_connection(WS_URL, timeout=10)
            print("   ✓ WebSocket连接成功")
            
            # 接收数据
            data = ws.recv()
            assert data is not None
            print("   ✓ 收到实时数据")
            
            ws.close()
            print("   ✓ WebSocket连接关闭")
        except Exception as e:
            pytest.fail(f"WebSocket测试失败: {e}")
    
    def test_error_handling(self):
        """测试错误处理"""
        print("\n=== 测试错误处理 ===")
        
        # 测试无效端点
        response = requests.get(f"{BASE_URL}/invalid_endpoint", timeout=5)
        assert response.status_code == 404
        print("   ✓ 无效端点返回404")
        
        # 测试无效请求
        response = requests.post(
            f"{BASE_URL}/api/control/invalid",
            json={"invalid": "data"},
            timeout=5
        )
        # 应该返回400或404
        assert response.status_code in [400, 404]
        print("   ✓ 无效请求处理正确")
EOF

echo "✓ 端到端测试脚本已创建"
```

### 步骤2: 验证端到端测试

```bash
cat > /tmp/verify_e2e_tests.sh << 'EOF'
#!/bin/bash
echo "========================================"
echo "端到端测试验证"
echo "========================================"

errors=0

# 检查端到端测试
echo -n "检查端到端测试... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/test/test_e2e/test_full_workflow.py" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

echo "========================================"
if [ $errors -eq 0 ]; then
    echo "✓ 端到端测试验证通过"
    exit 0
else
    echo "✗ 端到端测试验证失败 ($errors 个错误)"
    exit 1
fi
EOF

chmod +x /tmp/verify_e2e_tests.sh
/tmp/verify_e2e_tests.sh
```

---

## 四、验证步骤

### 验证清单

- [ ] 用户场景测试通过
- [ ] 完整流程测试通过
- [ ] 系统稳定性测试通过
- [ ] 故障恢复测试通过

---

## 五、预期结果

| 指标 | 目标值 | 验证方法 |
|------|--------|----------|
| 用户场景测试 | 通过 | 测试执行 |
| 完整流程测试 | 通过 | 测试执行 |
| 稳定性测试 | 通过 | 长时间测试 |
| 故障恢复测试 | 通过 | 测试执行 |

---

## 六、关联文档

- [任务跟踪-阶段9-测试和文档完善.md](./任务跟踪-阶段9-测试和文档完善.md)
- [任务跟踪-阶段9-测试和文档完善-部署任务9.2-集成测试完善.md](./任务跟踪-阶段9-测试和文档完善-部署任务9.2-集成测试完善.md)
- [任务跟踪-阶段9-测试和文档完善-部署任务9.4-性能压力测试.md](./任务跟踪-阶段9-测试和文档完善-部署任务9.4-性能压力测试.md)

---

**创建时间:** 2026-02-11
