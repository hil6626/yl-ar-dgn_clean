# 1. YL-AR-DGN 项目部署大纲

**版本:** 1.0.0  
**创建日期:** 2026-02-09  
**状态:** 🟢 部分已完成（详见实际落实情况）

---

## 一、项目概述

### 1.1 项目架构

YL-AR-DGN 是一个多功能集成的 AR 实时处理与监控平台，包含三个核心组件：

```
┌─────────────────────────────────────────────────────────────┐
│                    YL-AR-DGN 项目架构                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐         ┌─────────────────┐           │
│  │   YL-monitor    │◄────────►│   AR-backend    │           │
│  │   (监控平台)     │  监控    │   (核心业务)      │           │
│  │   端口: 5500    │         │   端口: 5501    │           │
│  │   FastAPI       │         │   PyQt5+Flask   │           │
│  └────────┬────────┘         └────────┬────────┘           │
│           │                           │                    │
│           │    ┌─────────────────┐   │                    │
│           └───►│    User GUI     │◄──┘                    │
│                │   (用户界面)     │                        │
│                │   端口: 5502    │                        │
│                │   PyQt5         │                        │
│                └─────────────────┘                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 组件职责

| 组件 | 路径 | 技术栈 | 核心功能 | 端口 |
|------|------|--------|----------|------|
| **YL-monitor** | `YL-monitor/` | FastAPI + WebSocket | 统一监控平台 | 5500 |
| **AR-backend** | `AR-backend/` | PyQt5 + OpenCV + Flask | 实时视频/音频/人脸处理 | 5501 |
| **User GUI** | `user/` | PyQt5 | 用户操作界面 | 5502 |

### 1.3 部署目标

根据当前项目状态，需要完成以下4个核心部署目标：

| 目标 | 描述 | 优先级 |
|------|------|--------|
| **目标1** | YL-monitor 监控 AR-backend 和 User GUI 的部署状态 | 🔴 高 |
| **目标2** | User GUI 调用逻辑正常化，与 AR-backend 通信正常 | 🔴 高 |
| **目标3** | 部署五层规则架构 (rules/) 约束系统行为 | 🟡 中 |
| **目标4** | 整合 YL-monitor/scripts 和 scripts/ 自动化脚本 | 🟡 中 |

---

## 二、部署阶段规划

### 2.1 五阶段部署路线图（实际状态）

```
┌─────────────────────────────────────────────────────────────┐
│  阶段1: 监控整合        [████████░░░░] 60%  预计2-3天  🔴 高   │
│  ├── 任务1.1: AR-backend 监控端点    ✅ 已完成               │
│  ├── 任务1.2: User GUI 状态上报      🟡 需调整（非HTTP）    │
│  ├── 任务1.3: YL-monitor 配置        🟡 待验证              │
│  └── 任务1.4: 统一监控面板           🟡 待验证              │
├─────────────────────────────────────────────────────────────┤
│  阶段2: User GUI优化    [████████░░░░] 70%  预计2-3天  🔴 高   │
│  ├── 任务4.1: main.py 入口           ✅ 已完成              │
│  ├── 任务4.2: 路径修复               ✅ 已完成              │
│  ├── 任务4.3: GUI 导入修复           ✅ 已完成              │
│  ├── 任务4.4: 服务客户端             🟡 待验证            │
│  ├── 任务4.5: 配置管理               ✅ 已存在              │
│  ├── 任务4.6: GUI 功能测试           🟡 待测试            │
│  └── 任务4.7: 启动脚本               ✅ 已完成              │
├─────────────────────────────────────────────────────────────┤
│  阶段3: 规则架构部署    [██████░░░░░░] 50%  预计1-2天  🟡 中   │
│  ├── 任务7.1-7.5: L1-L5规则文件      ✅ 已存在            │
│  ├── 任务7.6: 规则引擎               ✅ 已实现            │
│  └── 任务8.1: 规则集成               🟡 待验证            │
├─────────────────────────────────────────────────────────────┤
│  阶段4: 脚本整合        [██████████░░] 90%  预计2天    🟡 中   │
│  ├── 任务9.1-9.3: 脚本分类整合       ✅ 已完成              │
│  ├── 任务9.4: 统一入口yl-ar-dgn.sh   ✅ 已完成              │
│  ├── 任务9.5: 配置管理               ✅ 已完成              │
│  ├── 任务9.6: 日志格式               ✅ 已完成              │
│  └── 任务9.7: 错误处理               ✅ 已完成              │
├─────────────────────────────────────────────────────────────┤
│  阶段5: 联调测试        [░░░░░░░░░░░░] 0%  预计3-4天  🔴 高   │
│  ├── 任务13.1-13.6: 全面测试         🟡 待执行            │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 关键里程碑（实际状态）

| 里程碑 | 预计时间 | 状态 | 交付物 | 验收标准 | 实际进展 |
|--------|----------|------|--------|----------|----------|
| **M1** | 第3天 | 🟢 进行中 | 监控服务代码 | YL-monitor 显示所有节点 | AR-backend监控✅ |
| **M2** | 第6天 | 🟢 进行中 | User GUI 代码 | GUI 功能完整可用 | main.py✅ 功能待测 |
| **M3** | 第8天 | 🟢 进行中 | 规则文件 | 规则引擎运行正常 | 文件✅ 集成待测 |
| **M4** | 第10天 | 🟢 已完成 | 统一入口脚本 | 脚本功能完整 | yl-ar-dgn.sh✅ |
| **M5** | 第14天 | 🟡 待开始 | 测试报告 | 所有测试通过 | 待执行 |

---

## 三、资源需求

### 3.1 硬件资源

| 资源 | 最低配置 | 推荐配置 | 说明 |
|------|----------|----------|------|
| CPU | 4核 | 8核+ | 视频处理需要 |
| 内存 | 8GB | 16GB+ | AR-backend 占用较大 |
| 磁盘 | 20GB | 50GB+ | 模型文件存储 |
| GPU | 可选 | NVIDIA GTX 1060+ | 人脸合成加速 |
| 网络 | 本地回环 | 千兆以太网 | 组件间通信 |

### 3.2 软件环境

| 软件 | 版本要求 | 用途 |
|------|----------|------|
| Python | 3.8+ | 所有组件运行 |
| Node.js | 14+ | 规则引擎 |
| OpenCV | 4.5+ | 视频处理 |
| PyQt5 | 5.15+ | GUI 界面 |
| Flask | 2.0+ | API 服务 |
| FastAPI | 0.95+ | YL-monitor |

### 3.3 端口分配

| 服务 | 端口 | 用途 | 状态 |
|------|------|------|------|
| YL-monitor | 5500 | 主监控平台 | 🟢 已规划 |
| AR-backend 监控 | 5501 | 健康检查端点 | 🟡 待创建 |
| User GUI 状态 | 5502 | 状态上报端点 | 🟡 待创建 |
| 备用端口 | 5503-5509 | 扩展使用 | ⚪ 预留 |

---

## 四、风险评估与应对

### 4.1 技术风险

| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|----------|
| AR-backend 模块依赖复杂 | 高 | 高 | 使用虚拟环境，逐步安装依赖 |
| PyQt5 版本兼容问题 | 中 | 中 | 测试多版本，准备兼容性代码 |
| 端口冲突 | 中 | 中 | 配置可调整端口，预留备用端口 |
| 模块导入路径错误 | 高 | 高 | 使用 path_manager 统一处理 |

### 4.2 进度风险

| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|----------|
| 阶段延期 | 中 | 中 | 设置缓冲时间，优先完成核心功能 |
| 需求变更 | 低 | 高 | 冻结需求，变更需评估影响 |
| 人员变动 | 低 | 高 | 文档完善，降低知识依赖 |

### 4.3 运维风险

| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|----------|
| 服务崩溃无感知 | 中 | 高 | 完善监控告警机制 |
| 日志混乱难排查 | 中 | 中 | 统一日志格式和级别 |
| 配置管理混乱 | 中 | 中 | 集中配置管理，版本控制 |

---

## 五、验收标准

### 5.1 功能验收

| 验收项 | 验收标准 | 验证方法 |
|--------|----------|----------|
| 监控功能 | YL-monitor 显示 AR-backend 和 User GUI 状态 | 访问监控面板 |
| GUI 功能 | User GUI 能正常启动视频、音频、人脸合成 | 手动操作测试 |
| 通信功能 | 组件间 API 调用正常 | curl 测试 |
| 脚本功能 | 统一入口脚本可用 | 执行验证 |
| 规则功能 | 规则引擎加载正常 | node rules/index.js |

### 5.2 性能验收

| 指标 | 目标值 | 必须 |
|------|--------|------|
| 监控检查响应时间 | < 500ms | 是 |
| GUI 操作响应时间 | < 100ms | 是 |
| 状态上报延迟 | < 5秒 | 是 |
| CPU 占用 | < 80% | 是 |
| 内存占用 | < 4GB | 是 |

### 5.3 质量验收

| 指标 | 目标值 | 必须 |
|------|--------|------|
| 功能测试通过率 | 100% | 是 |
| 代码覆盖率 | > 80% | 否 |
| 严重缺陷数 | 0 | 是 |
| 一般缺陷数 | < 5 | 是 |

---

## 六、实际落实情况

### 6.1 已实现功能 ✅

| 组件 | 实现状态 | 关键文件 | 功能说明 |
|------|----------|----------|----------|
| **AR-backend 监控** | ✅ 完全实现 | `AR-backend/monitor_server.py` | 健康检查、状态查询、性能指标、API认证、CORS支持 |
| **User GUI 入口** | ✅ 完全实现 | `user/main.py` | 路径设置、GUI启动、PyQt5初始化 |
| **统一脚本入口** | ✅ 完全实现 | `scripts/yl-ar-dgn.sh` | 部署/启动/停止/状态/验证/日志/健康检查/清理 |
| **规则架构** | ✅ 已实现 | `rules/L1-L5.json` + `index.js` | 五层规则文件和规则引擎 |
| **项目结构** | ✅ 已整理 | 清晰目录结构 | 合理分类和组织 |

### 6.2 待验证/完善 🟡

| 项目 | 状态 | 说明 | 下一步 |
|------|------|------|--------|
| **YL-monitor 节点配置** | 🟡 待验证 | 需确认 AR-backend 和 User GUI 节点配置 | 检查 `YL-monitor/app/services/ar_monitor.py` |
| **User GUI 状态监控** | 🟡 需调整 | User GUI 是 PyQt5 应用，非 HTTP 服务 | 改用进程监控或YL-monitor Agent |
| **GUI 功能测试** | 🟡 待测试 | 视频、音频、人脸合成功能 | 实际启动 GUI 测试 |
| **规则集成** | 🟡 待验证 | 规则引擎与YL-monitor/scripts集成 | 测试规则加载和执行 |
| **端到端联调** | 🟡 待执行 | 完整工作流程测试 | 执行阶段5测试 |

### 6.3 快速验证命令

```bash
# 1. 进入项目目录
cd /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean

# 2. 验证 AR-backend 监控服务
curl http://0.0.0.0:5501/health
curl http://0.0.0.0:5501/status

# 3. 验证统一脚本入口
./scripts/yl-ar-dgn.sh help
./scripts/yl-ar-dgn.sh status
./scripts/yl-ar-dgn.sh validate

# 4. 启动 User GUI
python user/main.py

# 5. 查看详细任务
cat 部署/TODO_DEPLOY.md
```

### 6.2 文档导航

| 阶段 | 详细方案 | 任务跟踪 |
|------|----------|----------|
| 准备 | [0.部署索引.md](0.部署索引.md) | [TODO_DEPLOY.md](TODO_DEPLOY.md) |
| 阶段1 | [3.监控整合方案.md](3.监控整合方案.md) | 任务1.1-1.4 |
| 阶段2 | [4.User-GUI优化方案.md](4.User-GUI优化方案.md) | 任务4.1-4.7 |
| 阶段3 | [5.规则架构部署.md](5.规则架构部署.md) | 任务7.1-8.1 |
| 阶段4 | [6.脚本整合方案.md](6.脚本整合方案.md) | 任务9.1-9.7 |
| 阶段5 | [7.联调测试方案.md](7.联调测试方案.md) | 任务13.1-13.6 |

### 6.4 关键文件位置（实际状态）

| 文件 | 所属组件 | 状态 | 说明 |
|------|----------|------|------|
| `AR-backend/monitor_server.py` | AR-backend | ✅ 已存在 | 功能完整，含健康检查、状态、指标 |
| `AR-backend/monitor_config.yaml` | AR-backend | ✅ 已存在 | 监控服务配置 |
| `user/main.py` | User GUI | ✅ 已存在 | 入口已实现，路径已设置 |
| `user/start.sh` | User GUI | ✅ 已存在 | 启动脚本 |
| `user/start.py` | User GUI | ✅ 已存在 | Python启动脚本 |
| `YL-monitor/app/services/ar_monitor.py` | YL-monitor | 🟡 待验证 | 需确认节点配置 |
| `rules/L1-meta-goal.json` | Rules | ✅ 已存在 | 规则文件 |
| `rules/index.js` | Rules | ✅ 已存在 | 规则引擎 |
| `scripts/yl-ar-dgn.sh` | Scripts | ✅ 已存在 | 统一入口，功能完整 |
| `scripts/config/` | Scripts | ✅ 已存在 | 配置目录 |
| `scripts/lib/` | Scripts | ✅ 已存在 | 库文件和日志函数 |

---

## 七、关联文档

| 文档 | 位置 | 说明 |
|------|------|------|
| 部署索引 | [0.部署索引.md](0.部署索引.md) | 详细文档导航 |
| 任务跟踪 | [TODO_DEPLOY.md](TODO_DEPLOY.md) | 当前执行进度 |
| 整体方案 | [2.整体方案.md](2.整体方案.md) | 技术架构详情 |
| 项目 README | `../README.md` | 项目总体说明 |
| YL-monitor README | `../YL-monitor/README.md` | 监控平台说明 |

---

## 八、更新记录

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| 1.0.0 | 2026-02-09 | 初始版本，创建完整部署大纲 | AI 全栈技术员 |

---

**下一步:** 查看 [TODO_DEPLOY.md](TODO_DEPLOY.md) 开始执行阶段1任务
