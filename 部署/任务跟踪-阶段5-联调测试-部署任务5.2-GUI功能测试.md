# Phase 5 - Task 5.2: GUI Functionality Testing - Detailed Deployment Document

**Task ID:** 5.2  
**Task Name:** GUI Functionality Testing  
**Priority:** P0 (Blocking)  
**Estimated Hours:** 3 hours  
**Status:** Pending  
**Prerequisites:** Task 5.1 completed

---

## I. Task Objectives

Test all User GUI functionality to ensure proper operation and integration with AR-backend.

## II. Test Scenarios

### 2.1 Test Coverage

| Feature | Test Case | Expected Result |
|---------|-----------|---------------|
| Startup | Launch GUI | Window opens without error |
| Camera | Start camera | Video feed displays |
| Face synthesis | Load model | Model loads successfully |
| Audio | Adjust effects | Audio changes applied |
| Status reporting | Heartbeat | Status sent to monitor |
| API calls | Backend communication | Requests succeed |

## III. Deployment Content

### 3.1 GUI Test Script

#### File: test/integration/test_gui.py

```python
#!/usr/bin/env python3
"""
GUI Functionality Tests
"""

import unittest
import requests
import subprocess
import time
import signal
import os
from pathlib import Path


class TestGUIStartup(unittest.TestCase):
    """
    Test GUI startup and basic functionality
    """

    def test_gui_import(self):
        """Test GUI module can be imported"""
        try:
            # Add user directory to path
            import sys
            user_dir = Path(__file__).parent.parent.parent / 'user'
            sys.path.insert(0, str(user_dir))

            from gui.gui import ARApp
            self.assertTrue(True)
        except ImportError as e:
            self.fail(f"Cannot import GUI: {e}")

    def test_gui_dependencies(self):
        """Test GUI dependencies are available"""
        required = ['PyQt5', 'cv2', 'numpy']
        for module in required:
            try:
                __import__(module)
            except ImportError:
                self.fail(f"Required module not available: {module}")


class TestGUIAPI(unittest.TestCase):
    """
    Test GUI API endpoints
    """

    GUI_URL = "http://localhost:5502"

    def test_gui_health(self):
        """Test GUI health endpoint"""
        try:
            response = requests.get(
                f"{self.GUI_URL}/health",
                timeout=5
            )
            # GUI may not have health endpoint yet
            self.assertIn(response.status_code, [200, 404])
        except requests.RequestException:
            self.skipTest("GUI not running")

    def test_gui_status(self):
        """Test GUI status endpoint"""
        try:
            response = requests.get(
                f"{self.GUI_URL}/api/status",
                timeout=5
            )
            self.assertIn(response.status_code, [200, 404])
        except requests.RequestException:
            self.skipTest("GUI API not available")


class TestGUIBackendIntegration(unittest.TestCase):
    """
    Test GUI integration with AR-backend
    """

    def test_backend_connection(self):
        """Test GUI can connect to AR-backend"""
        # This would test the actual connection
        # Implementation depends on GUI's backend client
        pass

    def test_video_pipeline(self):
        """Test video processing pipeline"""
        # Test that video flows from camera through processing to display
        pass

    def test_face_synthesis(self):
        """Test face synthesis functionality"""
        # Test that face synthesis produces output
        pass


class TestGUIStatusReporting(unittest.TestCase):
    """
    Test GUI status reporting to monitor
    """

    def test_heartbeat_sent(self):
        """Test that GUI sends heartbeat to monitor"""
        # Would need to check monitor logs or API
        pass

    def test_status_updates(self):
        """Test that GUI sends status updates"""
        pass


def run_gui_tests():
    """Run all GUI tests"""
    loader = unittest.TestLoader()
    suite = unittest.TestSuite()

    suite.addTests(loader.loadTestsFromTestCase(TestGUIStartup))
    suite.addTests(loader.loadTestsFromTestCase(TestGUIAPI))
    suite.addTests(loader.loadTestsFromTestCase(TestGUIBackendIntegration))
    suite.addTests(loader.loadTestsFromTestCase(TestGUIStatusReporting))

    runner = unittest.TextTestRunner(verbosity=2)
    result = runner.run(suite)

    return result.wasSuccessful()


if __name__ == '__main__':
    success = run_gui_tests()
    exit(0 if success else 1)
```

### 3.2 GUI Test Runner

#### File: test/integration/run_gui_tests.sh

```bash
#!/bin/bash
# Run GUI Functionality Tests

set -e

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
LOG_FILE="$PROJECT_ROOT/logs/gui_tests_$(date +%Y%m%d_%H%M%S).log"

mkdir -p "$(dirname "$LOG_FILE")"

echo "========================================"
echo "GUI Functionality Tests"
echo "Started: $(date)"
echo "========================================"

# Check GUI dependencies
echo ""
echo "Checking GUI dependencies..."

check_python_module() {
    local module=$1
    if python3 -c "import $module" 2>/dev/null; then
        echo "  ✓ $module"
        return 0
    else
        echo "  ✗ $module (missing)"
        return 1
    fi
}

DEPENDENCIES_OK=true

for module in PyQt5 cv2 numpy; do
    if ! check_python_module "$module"; then
        DEPENDENCIES_OK=false
    fi
done

if [ "$DEPENDENCIES_OK" = false ]; then
    echo ""
    echo "Some dependencies are missing!"
    echo "Install with: pip install PyQt5 opencv-python numpy"
fi

# Check if GUI is running
echo ""
echo "Checking GUI status..."

if curl -s http://localhost:5502/health > /dev/null 2>&1; then
    echo "  ✓ GUI is running"
    GUI_RUNNING=true
else
    echo "  ✗ GUI is not running (tests will be limited)"
    GUI_RUNNING=false
fi

# Run Python tests
echo ""
echo "Running Python tests..."

cd "$PROJECT_ROOT"
if python3 test/integration/test_gui.py 2>&1 | tee -a "$LOG_FILE"; then
    echo ""
    echo "✓ GUI tests completed"
    TEST_RESULT=0
else
    echo ""
    echo "✗ Some GUI tests failed"
    TEST_RESULT=1
fi

# Generate report
echo ""
echo "========================================"
echo "Test Report"
echo "========================================"
echo "Dependencies: $([ "$DEPENDENCIES_OK" = true ] && echo 'OK' || echo 'MISSING')"
echo "GUI Running: $([ "$GUI_RUNNING" = true ] && echo 'YES' || echo 'NO')"
echo "Log file: $LOG_FILE"

exit $TEST_RESULT
```

## IV. Deployment Steps

```bash
# 1. Create GUI test
# Edit test/integration/test_gui.py

# 2. Create test runner
# Edit test/integration/run_gui_tests.sh

# 3. Make executable
chmod +x test/integration/run_gui_tests.sh

# 4. Run tests
./test/integration/run_gui_tests.sh
```

## V. Verification Checklist

- [ ] GUI test created
- [ ] Dependencies checked
- [ ] Import test passes
- [ ] API tests pass
- [ ] Integration tests pass

## VI. Next Step

After completing this task, proceed to **Task 5.3: Fault Simulation Testing**

View document: `部署/任务跟踪-阶段5-联调测试-部署任务5.3-故障模拟测试.md`
