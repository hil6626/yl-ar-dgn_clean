# 阶段6：核心业务功能验证 - 详细任务跟踪文档

**阶段:** 6  
**名称:** 核心业务功能验证  
**预计工期:** 2-3天  
**优先级:** P0（最高优先级）  
**前置依赖:** 阶段1-5完成  
**状态:** 待开始

---

## 一、阶段目标

验证AR-backend核心业务功能和User GUI实际功能，确保AR实时合成系统的核心能力可用。

---

## 二、任务优先级矩阵

| 任务ID | 任务名称 | 优先级 | 关键性 | 风险等级 | 依赖任务 |
|--------|----------|--------|--------|----------|----------|
| 6.1 | AR-backend实时视频处理验证 | P0 | 阻塞性 | 高 | 无 |
| 6.2 | AR-backend人脸合成功能验证 | P0 | 阻塞性 | 高 | 6.1 |
| 6.3 | AR-backend音频处理功能验证 | P0 | 阻塞性 | 中 | 无 |
| 6.4 | AR-backend虚拟摄像头验证 | P1 | 重要 | 中 | 6.1 |
| 6.5 | User GUI启动和初始化验证 | P0 | 阻塞性 | 高 | 无 |
| 6.6 | User GUI视频合成功能验证 | P0 | 阻塞性 | 高 | 6.5, 6.1 |
| 6.7 | User GUI音频处理功能验证 | P1 | 重要 | 中 | 6.5 |
| 6.8 | GUI→后端接口联调验证 | P0 | 阻塞性 | 高 | 6.1-6.7 |

---

## 三、详细任务清单

### 任务6.1: AR-backend实时视频处理验证

**优先级:** P0  
**关键性:** 阻塞性  
**负责人:** 后端开发工程师  
**预计工时:** 4小时

#### 工作内容
1. 摄像头捕获功能测试
2. 视频流处理功能测试
3. 视频编码/解码功能测试
4. 虚拟摄像头输出测试
5. 性能基准测试

#### 验证步骤

```bash
# 1. 启动AR-backend监控服务
cd AR-backend && ./start_monitor.sh

# 2. 检查视频处理模块
python3 -c "
from app.core.video_processor import VideoProcessor
vp = VideoProcessor()
print('视频处理器初始化成功')
print(f'支持的格式: {vp.supported_formats}')
"

# 3. 测试摄像头捕获
python3 -c "
import cv2
cap = cv2.VideoCapture(0)
if cap.isOpened():
    ret, frame = cap.read()
    if ret:
        print(f'摄像头捕获成功: {frame.shape}')
    cap.release()
else:
    print('摄像头打开失败')
"

# 4. 测试视频流处理
python3 AR-backend/test_video_processing.py

# 5. 验证虚拟摄像头
ls -l /dev/video*  # 检查虚拟摄像头设备
```

#### 预期结果
- [ ] 摄像头捕获成功，帧率≥30fps
- [ ] 视频流处理无丢帧
- [ ] 虚拟摄像头设备创建成功
- [ ] 内存占用<500MB

#### 可能产生的问题及解决方案

| 问题 | 风险等级 | 产生原因 | 解决方式 | 预防方式 |
|------|----------|----------|----------|----------|
| 摄像头无法打开 | 高 | 权限不足或设备占用 | 1. 检查权限: `ls -l /dev/video*`<br>2. 关闭其他使用摄像头的程序<br>3. 使用备用摄像头 | 1. 添加udev规则<br>2. 文档说明权限配置 |
| 视频处理卡顿 | 高 | CPU性能不足或编码器问题 | 1. 降低分辨率<br>2. 更换编码器<br>3. 启用硬件加速 | 1. 性能基准测试<br>2. 自动降级机制 |
| 虚拟摄像头创建失败 | 中 | v4l2loopback模块未加载 | 1. `sudo modprobe v4l2loopback`<br>2. 检查内核模块 | 1. 安装脚本检查依赖 |
| 内存泄漏 | 中 | 视频帧未正确释放 | 1. 代码审查<br>2. 内存分析工具 | 1. 单元测试覆盖<br>2. 自动化内存检测 |

#### 执行检查点
- [ ] 摄像头捕获测试通过
- [ ] 视频流处理测试通过
- [ ] 虚拟摄像头设备创建成功
- [ ] 性能基准达标
- [ ] 内存无泄漏

---

### 任务6.2: AR-backend人脸合成功能验证

**优先级:** P0  
**关键性:** 阻塞性  
**负责人:** AI算法工程师  
**预计工时:** 6小时

#### 工作内容
1. Deep-Live-Cam引擎测试
2. DeepFaceLab集成测试
3. FaceSwap功能测试
4. 人脸检测和关键点识别
5. 合成效果质量评估

#### 验证步骤

```bash
# 1. 检查人脸合成模型
ls -l AR-backend/models/face_swap/
ls -l AR-backend/models/deep_live_cam/

# 2. 测试人脸检测
python3 -c "
from app.core.face_detector import FaceDetector
fd = FaceDetector()
import cv2
cap = cv2.VideoCapture(0)
ret, frame = cap.read()
if ret:
    faces = fd.detect(frame)
    print(f'检测到 {len(faces)} 个人脸')
cap.release()
"

# 3. 测试Deep-Live-Cam
python3 AR-backend/test_deep_live_cam.py --source 0 --target data/target_face.jpg

# 4. 测试FaceSwap
python3 AR-backend/test_faceswap.py --source 0 --swap-face data/swap_face.jpg

# 5. 合成效果评估
python3 AR-backend/evaluate_face_swap_quality.py
```

#### 预期结果
- [ ] 人脸检测准确率≥95%
- [ ] 单帧合成时间<100ms
- [ ] 合成效果自然，无明显边界
- [ ] 支持实时视频流合成

#### 可能产生的问题及解决方案

| 问题 | 风险等级 | 产生原因 | 解决方式 | 预防方式 |
|------|----------|----------|----------|----------|
| 模型加载失败 | 高 | 模型文件缺失或损坏 | 1. 重新下载模型<br>2. 验证模型完整性<br>3. 使用备用模型 | 1. 模型版本管理<br>2. 自动下载脚本 |
| 合成效果差 | 高 | 模型质量或参数设置 | 1. 调整合成参数<br>2. 更换高质量模型<br>3. 预处理优化 | 1. 模型评估流程<br>2. 参数调优工具 |
| 合成速度慢 | 中 | GPU未启用或模型过大 | 1. 启用CUDA<br>2. 使用轻量级模型<br>3. 模型量化 | 1. 性能基准测试<br>2. 自动选择模型 |
| 人脸检测失败 | 中 | 光线或角度问题 | 1. 改善光线条件<br>2. 多角度检测<br>3. 预处理增强 | 1. 检测鲁棒性测试 |

#### 执行检查点
- [ ] 人脸检测测试通过
- [ ] Deep-Live-Cam测试通过
- [ ] FaceSwap测试通过
- [ ] 合成效果评估通过
- [ ] 性能基准达标

---

### 任务6.3: AR-backend音频处理功能验证

**优先级:** P0  
**关键性:** 阻塞性  
**负责人:** 音频处理工程师  
**预计工时:** 4小时

#### 工作内容
1. 音频捕获功能测试
2. 音高调整效果测试
3. 混响效果测试
4. 变速处理测试
5. 相位效果测试

#### 验证步骤

```bash
# 1. 检查音频设备
arecord -l  # 列出录音设备
aplay -l    # 列出播放设备

# 2. 测试音频捕获
python3 -c "
import pyaudio
p = pyaudio.PyAudio()
print(f'音频设备数量: {p.get_device_count()}')
for i in range(p.get_device_count()):
    info = p.get_device_info_by_index(i)
    print(f'{i}: {info[\"name\"]}')
p.terminate()
"

# 3. 测试音频处理效果
python3 AR-backend/test_audio_effects.py --effect pitch --value 1.5
python3 AR-backend/test_audio_effects.py --effect reverb --value 0.7
python3 AR-backend/test_audio_effects.py --effect speed --value 1.2

# 4. 实时音频处理测试
python3 AR-backend/test_realtime_audio.py --input-device 0 --output-device 1

# 5. 音频质量评估
python3 AR-backend/evaluate_audio_quality.py
```

#### 预期结果
- [ ] 音频捕获延迟<50ms
- [ ] 音高调整自然，无失真
- [ ] 混响效果可调，无明显回声
- [ ] 变速处理保持音调
- [ ] 实时处理CPU占用<20%

#### 可能产生的问题及解决方案

| 问题 | 风险等级 | 产生原因 | 解决方式 | 预防方式 |
|------|----------|----------|----------|----------|
| 音频设备无法打开 | 高 | 权限或设备占用 | 1. 检查ALSA/PulseAudio<br>2. 释放占用设备<br>3. 使用备用设备 | 1. 音频设备检测脚本<br>2. 权限配置文档 |
| 音频延迟高 | 高 | 缓冲区设置或处理慢 | 1. 减小缓冲区<br>2. 优化处理算法<br>3. 使用低延迟模式 | 1. 延迟基准测试<br>2. 自动优化配置 |
| 音质损失 | 中 | 重采样或压缩 | 1. 使用高质量重采样<br>2. 调整比特率<br>3. 无损处理 | 1. 音质评估工具<br>2. 参数推荐 |
| 效果不明显 | 低 | 参数设置或算法问题 | 1. 调整参数范围<br>2. 更换算法实现<br>3. 预处理增强 | 1. 效果预览功能 |

#### 执行检查点
- [ ] 音频捕获测试通过
- [ ] 音高调整测试通过
- [ ] 混响效果测试通过
- [ ] 变速处理测试通过
- [ ] 实时处理性能达标

---

### 任务6.4: AR-backend虚拟摄像头验证

**优先级:** P1  
**关键性:** 重要  
**负责人:** 系统工程师  
**预计工时:** 3小时

#### 工作内容
1. v4l2loopback模块配置
2. 虚拟摄像头设备创建
3. OBS集成测试
4. 多应用同时访问测试
5. 稳定性测试

#### 验证步骤

```bash
# 1. 检查v4l2loopback模块
lsmod | grep v4l2loopback || echo "模块未加载"

# 2. 加载模块
sudo modprobe v4l2loopback devices=1 video_nr=20 card_label="AR Virtual Cam" exclusive_caps=1

# 3. 检查虚拟摄像头设备
ls -l /dev/video20
v4l2-ctl --list-devices

# 4. 测试视频输出到虚拟摄像头
python3 AR-backend/test_virtual_camera.py --output /dev/video20

# 5. OBS集成测试
# 在OBS中添加视频源: V4L2 Video Capture Device -> /dev/video20

# 6. 多应用访问测试
# 同时打开Zoom、Teams等应用，选择AR Virtual Cam
```

#### 预期结果
- [ ] 虚拟摄像头设备创建成功
- [ ] OBS可以正常捕获视频
- [ ] 支持多应用同时访问
- [ ] 连续运行1小时无崩溃

#### 可能产生的问题及解决方案

| 问题 | 风险等级 | 产生原因 | 解决方式 | 预防方式 |
|------|----------|----------|----------|----------|
| 模块加载失败 | 高 | 内核版本不兼容 | 1. 安装对应版本模块<br>2. 编译安装<br>3. 升级内核 | 1. 兼容性检查脚本<br>2. 自动安装 |
| OBS无法识别 | 中 | 设备格式不支持 | 1. 调整输出格式<br>2. 使用兼容分辨率<br>3. 重启OBS | 1. 格式兼容性测试<br>2. 自动配置 |
| 画面卡顿 | 中 | 帧率或分辨率过高 | 1. 降低分辨率<br>2. 调整帧率<br>3. 优化编码 | 1. 性能基准测试<br>2. 自动降级 |
| 应用冲突 | 低 | 独占访问模式 | 1. 关闭其他应用<br>2. 使用非独占模式<br>3. 创建多个虚拟设备 | 1. 设备管理工具 |

#### 执行检查点
- [ ] 模块加载成功
- [ ] 设备创建成功
- [ ] OBS集成测试通过
- [ ] 多应用访问测试通过
- [ ] 稳定性测试通过

---

### 任务6.5: User GUI启动和初始化验证

**优先级:** P0  
**关键性:** 阻塞性  
**负责人:** 前端开发工程师  
**预计工时:** 3小时

#### 工作内容
1. GUI启动时间测试
2. 资源初始化验证
3. 配置加载验证
4. 依赖检查验证
5. 异常处理验证

#### 验证步骤

```bash
# 1. 启动时间测试
time python3 user/main.py --dry-run

# 2. 检查资源加载
python3 -c "
import sys
sys.path.insert(0, 'user')
from gui.gui import ARApp
from PyQt5.QtWidgets import QApplication
import time
start = time.time()
app = QApplication(sys.argv)
window = ARApp()
print(f'GUI初始化时间: {time.time() - start:.2f}s')
"

# 3. 配置加载测试
python3 -c "
import sys
sys.path.insert(0, 'user')
from config.config_manager import ConfigManager
cm = ConfigManager()
config = cm.load_config()
print(f'配置加载成功: {list(config.keys())}')
"

# 4. 依赖检查
python3 user/check_dependencies.py

# 5. 异常处理测试
python3 user/test_error_handling.py
```

#### 预期结果
- [ ] GUI启动时间<5秒
- [ ] 资源加载无错误
- [ ] 配置加载成功
- [ ] 所有依赖已安装
- [ ] 异常处理正常

#### 可能产生的问题及解决方案

| 问题 | 风险等级 | 产生原因 | 解决方式 | 预防方式 |
|------|----------|----------|----------|----------|
| 启动慢 | 高 | 资源加载过多 | 1. 延迟加载<br>2. 优化资源<br>3. 预加载缓存 | 1. 启动性能分析<br>2. 懒加载机制 |
| PyQt5导入失败 | 高 | 未安装或版本不兼容 | 1. 安装PyQt5<br>2. 指定版本<br>3. 使用虚拟环境 | 1. 依赖检查脚本<br>2. 自动安装 |
| 配置加载失败 | 中 | 配置文件损坏 | 1. 使用默认配置<br>2. 修复配置文件<br>3. 重新生成 | 1. 配置验证<br>2. 备份机制 |
| 主题加载失败 | 低 | 主题文件缺失 | 1. 使用默认主题<br>2. 重新安装主题<br>3. 在线下载 | 1. 主题包管理 |

#### 执行检查点
- [ ] 启动时间测试通过
- [ ] 资源加载测试通过
- [ ] 配置加载测试通过
- [ ] 依赖检查通过
- [ ] 异常处理测试通过

---

### 任务6.6: User GUI视频合成功能验证

**优先级:** P0  
**关键性:** 阻塞性  
**负责人:** 前端开发工程师  
**预计工时:** 6小时

#### 工作内容
1. 视频源选择功能测试
2. 合成参数设置测试
3. 实时预览功能测试
4. 合成效果调整测试
5. 输出控制测试

#### 验证步骤

```bash
# 1. 启动GUI
cd user && python3 main.py &

# 2. 测试视频源选择
# 在GUI中测试:
# - 摄像头选择
# - 视频文件选择
# - 网络视频流

# 3. 测试合成参数
python3 user/test_video_params.py --brightness 1.2 --contrast 1.1 --saturation 1.0

# 4. 测试实时预览
python3 user/test_preview.py --source 0 --enable-preview

# 5. 测试输出控制
python3 user/test_output_control.py --virtual-cam --file-output --streaming

# 6. 完整流程测试
python3 user/test_full_video_workflow.py
```

#### 预期结果
- [ ] 视频源切换流畅
- [ ] 合成参数实时生效
- [ ] 预览延迟<200ms
- [ ] 输出控制正常
- [ ] 完整流程无错误

#### 可能产生的问题及解决方案

| 问题 | 风险等级 | 产生原因 | 解决方式 | 预防方式 |
|------|----------|----------|----------|----------|
| 预览卡顿 | 高 | 视频流处理慢 | 1. 降低预览分辨率<br>2. 优化渲染<br>3. 使用硬件加速 | 1. 预览性能测试<br>2. 自动质量调整 |
| 参数不生效 | 高 | 后端接口问题 | 1. 检查API调用<br>2. 修复参数传递<br>3. 重新连接后端 | 1. 接口单元测试<br>2. 参数验证 |
| 输出失败 | 中 | 虚拟摄像头或编码问题 | 1. 检查输出设备<br>2. 更换编码器<br>3. 重启服务 | 1. 输出设备检测<br>2. 错误重试 |
| 界面无响应 | 中 | 主线程阻塞 | 1. 使用多线程<br>2. 异步处理<br>3. 添加加载提示 | 1. 响应性测试<br>2. 性能监控 |

#### 执行检查点
- [ ] 视频源选择测试通过
- [ ] 合成参数测试通过
- [ ] 实时预览测试通过
- [ ] 输出控制测试通过
- [ ] 完整流程测试通过

---

### 任务6.7: User GUI音频处理功能验证

**优先级:** P1  
**关键性:** 重要  
**负责人:** 前端开发工程师  
**预计工时:** 4小时

#### 工作内容
1. 音频源选择功能测试
2. 音效应用测试
3. 实时处理测试
4. 音频输出测试
5. 音视频同步测试

#### 验证步骤

```bash
# 1. 测试音频源选择
python3 user/test_audio_source.py --source microphone --device 0

# 2. 测试音效
python3 user/test_audio_effects.py --pitch 1.5 --reverb 0.6 --speed 1.0

# 3. 实时处理测试
python3 user/test_realtime_audio_gui.py --input-device 0 --output-device 1

# 4. 音频输出测试
python3 user/test_audio_output.py --virtual-audio --file-output

# 5. 音视频同步测试
python3 user/test_av_sync.py --video-source 0 --audio-source 0
```

#### 预期结果
- [ ] 音频源切换正常
- [ ] 音效实时生效
- [ ] 处理延迟<100ms
- [ ] 音视频同步误差<40ms

#### 可能产生的问题及解决方案

| 问题 | 风险等级 | 产生原因 | 解决方式 | 预防方式 |
|------|----------|----------|----------|----------|
| 音频延迟 | 高 | 处理链路过长 | 1. 优化处理链路<br>2. 减少效果数量<br>3. 使用低延迟模式 | 1. 延迟基准测试<br>2. 自动优化 |
| 音视频不同步 | 高 | 时钟源不一致 | 1. 同步时钟源<br>2. 添加同步机制<br>3. 调整缓冲区 | 1. 同步测试<br>2. 自动校准 |
| 音效不明显 | 中 | 参数范围或算法 | 1. 调整参数<br>2. 更换算法<br>3. 预处理增强 | 1. 效果预览<br>2. 参数推荐 |
| 爆音/杂音 | 中 |  clipping或采样问题 | 1. 调整增益<br>2. 使用limiter<br>3. 检查采样率 | 1. 音频质量检测<br>2. 自动增益 |

#### 执行检查点
- [ ] 音频源选择测试通过
- [ ] 音效应用测试通过
- [ ] 实时处理测试通过
- [ ] 音频输出测试通过
- [ ] 音视频同步测试通过

---

### 任务6.8: GUI→后端接口联调验证

**优先级:** P0  
**关键性:** 阻塞性  
**负责人:** 全栈工程师  
**预计工时:** 4小时

#### 工作内容
1. 视频流接口联调
2. 控制命令接口联调
3. 状态查询接口联调
4. 错误处理联调
5. 性能基准测试

#### 验证步骤

```bash
# 1. 启动后端服务
cd AR-backend && ./start_monitor.sh

# 2. 检查后端健康
curl http://localhost:5501/health

# 3. 测试视频流接口
python3 user/test_backend_video_api.py --endpoint http://localhost:5501

# 4. 测试控制命令
python3 user/test_backend_control_api.py --command start_camera
python3 user/test_backend_control_api.py --command stop_camera
python3 user/test_backend_control_api.py --command set_params --params '{"brightness": 1.2}'

# 5. 测试状态查询
python3 user/test_backend_status_api.py

# 6. 完整联调测试
python3 user/test_full_integration.py
```

#### 预期结果
- [ ] 视频流接口响应<100ms
- [ ] 控制命令执行成功
- [ ] 状态查询数据准确
- [ ] 错误处理正常
- [ ] 端到端延迟<500ms

#### 可能产生的问题及解决方案

| 问题 | 风险等级 | 产生原因 | 解决方式 | 预防方式 |
|------|----------|----------|----------|----------|
| 接口无响应 | 高 | 后端未启动或网络问题 | 1. 检查后端状态<br>2. 检查网络连接<br>3. 重启服务 | 1. 健康检查<br>2. 自动重连 |
| 数据格式错误 | 高 | 接口版本不匹配 | 1. 更新API客户端<br>2. 检查数据格式<br>3. 版本协商 | 1. API版本管理<br>2. 兼容性测试 |
| 性能不达标 | 中 | 网络延迟或处理慢 | 1. 优化传输<br>2. 压缩数据<br>3. 使用WebSocket | 1. 性能基准测试<br>2. 自动优化 |
| 连接断开 | 中 | 超时或网络波动 | 1. 添加心跳机制<br>2. 自动重连<br>3. 状态恢复 | 1. 连接管理<br>2. 断线重连 |

#### 执行检查点
- [ ] 视频流接口测试通过
- [ ] 控制命令接口测试通过
- [ ] 状态查询接口测试通过
- [ ] 错误处理测试通过
- [ ] 性能基准测试通过

---

## 四、验证工具清单

### 4.1 自动化测试脚本

| 脚本 | 用途 | 位置 |
|------|------|------|
| test_video_processing.py | 视频处理测试 | AR-backend/ |
| test_deep_live_cam.py | Deep-Live-Cam测试 | AR-backend/ |
| test_faceswap.py | FaceSwap测试 | AR-backend/ |
| test_audio_effects.py | 音频效果测试 | AR-backend/ |
| test_virtual_camera.py | 虚拟摄像头测试 | AR-backend/ |
| test_preview.py | 实时预览测试 | user/ |
| test_video_params.py | 视频参数测试 | user/ |
| test_backend_video_api.py | 视频接口测试 | user/ |
| test_backend_control_api.py | 控制接口测试 | user/ |
| test_full_integration.py | 完整联调测试 | user/ |

### 4.2 性能测试工具

```bash
# 视频处理性能
python3 AR-backend/benchmark_video.py --duration 60

# 人脸合成性能
python3 AR-backend/benchmark_face_swap.py --iterations 100

# 音频处理性能
python3 AR-backend/benchmark_audio.py --duration 60

# 端到端性能
python3 user/benchmark_end_to_end.py --duration 60
```

### 4.3 质量评估工具

```bash
# 视频质量
python3 AR-backend/evaluate_video_quality.py --reference ref.mp4 --test test.mp4

# 人脸合成质量
python3 AR-backend/evaluate_face_swap_quality.py

# 音频质量
python3 AR-backend/evaluate_audio_quality.py --reference ref.wav --test test.wav

# 同步质量
python3 user/evaluate_av_sync.py
```

---

## 五、执行时间表

| 天数 | 上午 | 下午 | 晚上 | 交付物 |
|------|------|------|------|--------|
| 第1天 | 任务6.1+6.2 | 任务6.2+6.3 | 任务6.3 | 视频/人脸/音频功能验证 |
| 第2天 | 任务6.4+6.5 | 任务6.6 | 任务6.6 | 虚拟摄像头/GUI功能验证 |
| 第3天 | 任务6.7 | 任务6.8 | 问题修复 | 完整联调验证 |

---

## 六、风险总览

### 高风险项
1. **摄像头无法打开** - 影响视频功能验证
2. **模型加载失败** - 影响人脸合成功能
3. **GPU未启用** - 影响合成性能
4. **GUI启动慢** - 影响用户体验
5. **接口无响应** - 影响联调验证

### 中风险项
1. 视频处理卡顿
2. 合成效果差
3. 音频延迟高
4. 虚拟摄像头创建失败
5. 预览卡顿
6. 音视频不同步

### 低风险项
1. 主题加载失败
2. 音效不明显
3. 应用冲突

---

## 七、验收标准

### 7.1 功能验收
- [ ] 所有8个任务完成
- [ ] 测试通过率≥90%
- [ ] 无P0级别缺陷
- [ ] 性能指标达标

### 7.2 性能验收
- [ ] 视频处理≥30fps
- [ ] 人脸合成<100ms/帧
- [ ] 音频延迟<50ms
- [ ] GUI启动<5s
- [ ] 端到端延迟<500ms

### 7.3 质量验收
- [ ] 人脸合成效果自然
- [ ] 音频处理无失真
- [ ] 音视频同步误差<40ms
- [ ] 连续运行1小时稳定

---

## 八、关联文档

- [任务跟踪-阶段5-联调测试.md](./任务跟踪-阶段5-联调测试.md)
- [7.联调测试方案.md](./7.联调测试方案.md)
- [TODO.md](../TODO.md)

---

**前置条件:** 阶段1-5完成  
**下一步:** 阶段7 - 生产环境准备
