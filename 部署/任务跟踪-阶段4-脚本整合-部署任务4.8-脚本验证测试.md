# Phase 4 - Task 4.8: Script Validation Testing - Detailed Deployment Document

**Task ID:** 4.8  
**Task Name:** Script Validation Testing  
**Priority:** P1 (High)  
**Estimated Hours:** 2 hours  
**Status:** Pending  
**Prerequisites:** Task 4.7 completed

---

## I. Task Objectives

Validate all consolidated scripts work correctly and meet quality standards.

## II. Test Coverage

### 2.1 Test Categories

| Category | Scripts to Test | Test Type |
|----------|-----------------|-----------|
| Entry Point | yl-ar-dgn.sh | Integration |
| Deployment | deploy.sh, rollback.sh | Integration |
| Monitoring | health_check.py, monitor.py | Unit + Integration |
| Utilities | config_loader.py, logger.py | Unit |
| Libraries | error_handler.py, logging.sh | Unit |

## III. Deployment Content

### 3.1 Test Suite

#### File: test/scripts/test_scripts.py

```python
#!/usr/bin/env python3
"""
Script Validation Test Suite
"""

import unittest
import subprocess
import tempfile
import shutil
from pathlib import Path


class TestScriptStructure(unittest.TestCase):
    """Test script file structure"""

    def setUp(self):
        self.project_root = Path(__file__).parent.parent.parent
        self.scripts_dir = self.project_root / 'scripts'

    def test_main_entry_point_exists(self):
        """Test main entry point exists"""
        entry_point = self.scripts_dir / 'yl-ar-dgn.sh'
        self.assertTrue(entry_point.exists())
        self.assertTrue(entry_point.stat().st_mode & 0o111)  # Executable

    def test_lib_directory_exists(self):
        """Test library directory exists"""
        lib_dir = self.scripts_dir / 'lib'
        self.assertTrue(lib_dir.exists())

    def test_config_loader_exists(self):
        """Test config loader exists"""
        config_loader = self.scripts_dir / 'lib' / 'config_loader.py'
        self.assertTrue(config_loader.exists())

    def test_logger_exists(self):
        """Test logger exists"""
        logger = self.scripts_dir / 'lib' / 'logger.py'
        self.assertTrue(logger.exists())

    def test_error_handler_exists(self):
        """Test error handler exists"""
        error_handler = self.scripts_dir / 'lib' / 'error_handler.py'
        self.assertTrue(error_handler.exists())


class TestConfigLoader(unittest.TestCase):
    """Test configuration loader"""

    def test_import(self):
        """Test config loader can be imported"""
        try:
            from scripts.lib.config_loader import get_config
            self.assertTrue(True)
        except ImportError as e:
            self.fail(f"Cannot import config_loader: {e}")

    def test_load_config(self):
        """Test configuration loading"""
        from scripts.lib.config_loader import get_config
        config = get_config()
        self.assertIsNotNone(config)

    def test_get_value(self):
        """Test getting configuration values"""
        from scripts.lib.config_loader import get
        project_name = get('project.name')
        self.assertIsNotNone(project_name)


class TestLogger(unittest.TestCase):
    """Test logging system"""

    def test_import(self):
        """Test logger can be imported"""
        try:
            from scripts.lib.logger import get_logger
            self.assertTrue(True)
        except ImportError as e:
            self.fail(f"Cannot import logger: {e}")

    def test_create_logger(self):
        """Test logger creation"""
        from scripts.lib.logger import get_logger
        import tempfile
        import os

        with tempfile.TemporaryDirectory() as tmpdir:
            os.chdir(tmpdir)
            logger = get_logger('test')
            self.assertIsNotNone(logger)

    def test_log_levels(self):
        """Test different log levels"""
        from scripts.lib.logger import get_logger
        logger = get_logger('test_levels')
        # Should not raise exceptions
        logger.debug('Debug message')
        logger.info('Info message')
        logger.warning('Warning message')
        logger.error('Error message')


class TestErrorHandler(unittest.TestCase):
    """Test error handling"""

    def test_import(self):
        """Test error handler can be imported"""
        try:
            from scripts.lib.error_handler import ErrorHandler, ScriptError
            self.assertTrue(True)
        except ImportError as e:
            self.fail(f"Cannot import error_handler: {e}")

    def test_error_creation(self):
        """Test error creation"""
        from scripts.lib.error_handler import ScriptError, ErrorCode
        error = ScriptError('Test error', ErrorCode.GENERAL_ERROR)
        self.assertEqual(error.message, 'Test error')

    def test_error_handling(self):
        """Test error handling"""
        from scripts.lib.error_handler import ErrorHandler, ScriptError, ErrorCode
        handler = ErrorHandler()
        error = ScriptError('Test', ErrorCode.VALIDATION_ERROR)
        result = handler.handle(error, 'test_context')
        self.assertTrue(result['error'])


class TestEntryPoint(unittest.TestCase):
    """Test main entry point"""

    def setUp(self):
        self.project_root = Path(__file__).parent.parent.parent

    def test_help_command(self):
        """Test help command"""
        result = subprocess.run(
            ['./scripts/yl-ar-dgn.sh', 'help'],
            cwd=self.project_root,
            capture_output=True,
            text=True
        )
        self.assertEqual(result.returncode, 0)
        self.assertIn('YL-AR-DGN', result.stdout)

    def test_status_command(self):
        """Test status command"""
        result = subprocess.run(
            ['./scripts/yl-ar-dgn.sh', 'status'],
            cwd=self.project_root,
            capture_output=True,
            text=True
        )
        # Should complete without error
        self.assertIn('System Status', result.stdout)


class TestHealthCheck(unittest.TestCase):
    """Test health check script"""

    def test_import(self):
        """Test health check can be imported"""
        try:
            from scripts.monitor.health_check import HealthChecker
            self.assertTrue(True)
        except ImportError as e:
            self.fail(f"Cannot import health_check: {e}")

    def test_health_checker_creation(self):
        """Test health checker creation"""
        from scripts.monitor.health_check import HealthChecker
        checker = HealthChecker(mode='general')
        self.assertIsNotNone(checker)


class TestShellLibraries(unittest.TestCase):
    """Test shell library functions"""

    def setUp(self):
        self.project_root = Path(__file__).parent.parent.parent

    def test_config_sh_exists(self):
        """Test config.sh exists"""
        config_sh = self.project_root / 'scripts' / 'lib' / 'config.sh'
        self.assertTrue(config_sh.exists())

    def test_logging_sh_exists(self):
        """Test logging.sh exists"""
        logging_sh = self.project_root / 'scripts' / 'lib' / 'logging.sh'
        self.assertTrue(logging_sh.exists())

    def test_error_sh_exists(self):
        """Test error.sh exists"""
        error_sh = self.project_root / 'scripts' / 'lib' / 'error.sh'
        self.assertTrue(error_sh.exists())


def run_all_tests():
    """Run all tests"""
    loader = unittest.TestLoader()
    suite = unittest.TestSuite()

    # Add all test classes
    suite.addTests(loader.loadTestsFromTestCase(TestScriptStructure))
    suite.addTests(loader.loadTestsFromTestCase(TestConfigLoader))
    suite.addTests(loader.loadTestsFromTestCase(TestLogger))
    suite.addTests(loader.loadTestsFromTestCase(TestErrorHandler))
    suite.addTests(loader.loadTestsFromTestCase(TestEntryPoint))
    suite.addTests(loader.loadTestsFromTestCase(TestHealthCheck))
    suite.addTests(loader.loadTestsFromTestCase(TestShellLibraries))

    runner = unittest.TextTestRunner(verbosity=2)
    result = runner.run(suite)

    return result.wasSuccessful()


if __name__ == '__main__':
    success = run_all_tests()
    exit(0 if success else 1)
```

### 3.2 Validation Script

#### File: scripts/tools/validate_all.sh

```bash
#!/bin/bash
# Validate All Scripts

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
LOG_FILE="$PROJECT_ROOT/logs/validation_$(date +%Y%m%d_%H%M%S).log"

mkdir -p "$(dirname "$LOG_FILE")"

echo "========================================" | tee -a "$LOG_FILE"
echo "Script Validation" | tee -a "$LOG_FILE"
echo "Started: $(date)" | tee -a "$LOG_FILE"
echo "========================================" | tee -a "$LOG_FILE"

PASSED=0
FAILED=0

# Function to run test
run_test() {
    local name=$1
    local command=$2
    
    echo "" | tee -a "$LOG_FILE"
    echo "Testing: $name" | tee -a "$LOG_FILE"
    
    if eval "$command" >> "$LOG_FILE" 2>&1; then
        echo "  ✓ PASS" | tee -a "$LOG_FILE"
        ((PASSED++))
    else
        echo "  ✗ FAIL" | tee -a "$LOG_FILE"
        ((FAILED++))
    fi
}

# Test 1: Python syntax
run_test "Python Syntax (config_loader)" \
    "python3 -m py_compile $PROJECT_ROOT/scripts/lib/config_loader.py"

run_test "Python Syntax (logger)" \
    "python3 -m py_compile $PROJECT_ROOT/scripts/lib/logger.py"

run_test "Python Syntax (error_handler)" \
    "python3 -m py_compile $PROJECT_ROOT/scripts/lib/error_handler.py"

# Test 2: Shell syntax
run_test "Shell Syntax (yl-ar-dgn.sh)" \
    "bash -n $PROJECT_ROOT/scripts/yl-ar-dgn.sh"

run_test "Shell Syntax (config.sh)" \
    "bash -n $PROJECT_ROOT/scripts/lib/config.sh"

# Test 3: Imports
run_test "Python Imports" \
    "cd $PROJECT_ROOT && python3 -c 'from scripts.lib.config_loader import get_config'"

# Test 4: Entry point help
run_test "Entry Point Help" \
    "cd $PROJECT_ROOT && ./scripts/yl-ar-dgn.sh help > /dev/null"

# Test 5: Unit tests
run_test "Unit Tests" \
    "cd $PROJECT_ROOT && python3 test/scripts/test_scripts.py"

# Summary
echo "" | tee -a "$LOG_FILE"
echo "========================================" | tee -a "$LOG_FILE"
echo "Validation Summary" | tee -a "$LOG_FILE"
echo "========================================" | tee -a "$LOG_FILE"
echo "Passed: $PASSED" | tee -a "$LOG_FILE"
echo "Failed: $FAILED" | tee -a "$LOG_FILE"
echo "Log: $LOG_FILE" | tee -a "$LOG_FILE"

if [[ $FAILED -eq 0 ]]; then
    echo "All validations passed! ✓" | tee -a "$LOG_FILE"
    exit 0
else
    echo "Some validations failed! ✗" | tee -a "$LOG_FILE"
    exit 1
fi
```

## IV. Deployment Steps

```bash
# 1. Create test directory
mkdir -p test/scripts

# 2. Create test suite
# Edit test/scripts/test_scripts.py

# 3. Create validation script
# Edit scripts/tools/validate_all.sh

# 4. Make executable
chmod +x scripts/tools/validate_all.sh

# 5. Run validation
./scripts/tools/validate_all.sh

# 6. Run unit tests
python3 test/scripts/test_scripts.py
```

## V. Verification Checklist

- [ ] Test suite created
- [ ] All scripts tested
- [ ] Validation script created
- [ ] All tests pass
- [ ] Validation report generated

## VI. Phase 4 Completion Summary

After completing this task, Phase 4 (Script Consolidation) is fully complete!

### Phase 4 Deliverables

| Task | Deliverable | Status |
|------|-------------|--------|
| 4.1 | Script inventory and classification | ✓ |
| 4.2 | YL-monitor script migration | ✓ |
| 4.3 | Duplicate script merging | ✓ |
| 4.4 | Unified entry point | ✓ |
| 4.5 | Unified configuration | ✓ |
| 4.6 | Unified logging | ✓ |
| 4.7 | Unified error handling | ✓ |
| 4.8 | Script validation testing | ✓ |

---

**Next Step:** Begin Phase 5 - Integration Testing

View document: `部署/任务跟踪-阶段5-联调测试-部署任务5.1-监控联调测试.md`
