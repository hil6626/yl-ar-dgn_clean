# 部署任务7.4: 告警通知系统配置

**任务ID:** 7.4  
**所属阶段:** 阶段7 - 监控体系完善  
**任务名称:** 告警通知系统配置  
**优先级:** P0（最高优先级）  
**关键性:** 阻塞性  
**预计工时:** 6小时  
**负责人:** 运维工程师  
**前置依赖:** 任务7.3完成  
**状态:** 待开始

---

## 一、任务目标

配置YL-monitor告警通知系统，实现邮件通知、钉钉Webhook、告警分级路由和告警抑制机制。

---

## 二、工作内容

1. 邮件通知配置
2. 钉钉Webhook配置
3. 告警分级和路由
4. 告警抑制和合并

---

## 三、实施步骤

### 步骤1: 创建告警渠道配置

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/YL-monitor/config/alert_channels.yaml << 'EOF'
# 告警通知渠道配置

channels:
  email:
    enabled: true
    smtp:
      host: smtp.gmail.com
      port: 587
      username: ${EMAIL_USER}
      password: ${EMAIL_PASSWORD}
      use_tls: true
    from: alerts@ar-studio.com
    to:
      - admin@ar-studio.com
      - ops@ar-studio.com

  dingtalk:
    enabled: true
    webhook_url: ${DINGTALK_WEBHOOK_URL}
    secret: ${DINGTALK_SECRET}
    at_mobiles:
      - 13800138000

# 告警路由规则
routing:
  - level: critical
    channels:
      - email
      - dingtalk
    throttle: 0
  
  - level: warning
    channels:
      - email
      - dingtalk
    throttle: 300
  
  - level: info
    channels:
      - email
    throttle: 3600

# 告警抑制规则
suppression:
  - condition: same_alert
    window: 1800
EOF

echo "✓ 告警渠道配置已创建"
```

### 步骤2: 创建告警通知服务

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/YL-monitor/app/services/alert_notifier.py << 'EOF'
import asyncio
import smtplib
import requests
import hmac
import hashlib
import base64
import urllib.parse
import time
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from typing import Dict, List
import yaml

class AlertNotifier:
    def __init__(self):
        with open('config/alert_channels.yaml') as f:
            self.config = yaml.safe_load(f)
        
        self.recent_alerts: Dict[str, float] = {}
    
    async def send_alert(self, alert: Dict):
        """发送告警通知"""
        if self.should_suppress(alert):
            return
        
        routing = self.get_routing(alert['level'])
        
        tasks = []
        for channel in routing['channels']:
            if self.config['channels'][channel]['enabled']:
                tasks.append(self.send_to_channel(channel, alert))
        
        await asyncio.gather(*tasks, return_exceptions=True)
        self.recent_alerts[alert['id']] = time.time()
    
    async def send_to_channel(self, channel: str, alert: Dict):
        """发送到指定渠道"""
        if channel == 'email':
            await self.send_email(alert)
        elif channel == 'dingtalk':
            await self.send_dingtalk(alert)
    
    async def send_email(self, alert: Dict):
        """发送邮件"""
        config = self.config['channels']['email']
        
        msg = MIMEMultipart()
        msg['From'] = config['from']
        msg['To'] = ', '.join(config['to'])
        msg['Subject'] = f"[AR-Studio告警] {alert['level']} - {alert['title']}"
        
        body = f"""
        告警时间: {alert['timestamp']}
        告警级别: {alert['level']}
        告警标题: {alert['title']}
        告警内容: {alert['message']}
        节点: {alert['node_id']}
        """
        
        msg.attach(MIMEText(body, 'html'))
        
        loop = asyncio.get_event_loop()
        await loop.run_in_executor(None, self._send_smtp, config, msg)
    
    def _send_smtp(self, config: Dict, msg: MIMEMultipart):
        """同步SMTP发送"""
        with smtplib.SMTP(config['smtp']['host'], config['smtp']['port']) as server:
            server.starttls()
            server.login(config['smtp']['username'], config['smtp']['password'])
            server.send_message(msg)
    
    async def send_dingtalk(self, alert: Dict):
        """发送钉钉通知"""
        config = self.config['channels']['dingtalk']
        
        timestamp = str(round(time.time() * 1000))
        secret = config['secret']
        string_to_sign = f"{timestamp}\n{secret}"
        sign = base64.b64encode(
            hmac.new(secret.encode(), string_to_sign.encode(), hashlib.sha256).digest()
        ).decode()
        
        url = f"{config['webhook_url']}&timestamp={timestamp}&sign={urllib.parse.quote(sign)}"
        
        payload = {
            "msgtype": "markdown",
            "markdown": {
                "title": f"AR-Studio告警: {alert['title']}",
                "text": f"**级别**: {alert['level']}\\n**时间**: {alert['timestamp']}\\n**节点**: {alert['node_id']}\\n**标题**: {alert['title']}\\n\\n{alert['message']}"
            }
        }
        
        loop = asyncio.get_event_loop()
        await loop.run_in_executor(
            None, 
            lambda: requests.post(url, json=payload, timeout=10)
        )
    
    def should_suppress(self, alert: Dict) -> bool:
        """检查是否应该抑制告警"""
        alert_id = alert['id']
        now = time.time()
        
        if alert_id in self.recent_alerts:
            last_sent = self.recent_alerts[alert_id]
            routing = self.get_routing(alert['level'])
            throttle = routing.get('throttle', 0)
            
            if now - last_sent < throttle:
                return True
        
        return False
    
    def get_routing(self, level: str) -> Dict:
        """获取告警路由配置"""
        for route in self.config['routing']:
            if route['level'] == level:
                return route
        return {'channels': ['email'], 'throttle': 3600}
EOF

echo "✓ 告警通知服务已创建"
```

---

## 四、验证步骤

### 验证清单

- [ ] 邮件通知配置完成
- [ ] 钉钉通知配置完成
- [ ] 告警路由规则生效
- [ ] 告警抑制机制正常

---

## 五、预期结果

| 指标 | 目标值 | 验证方法 |
|------|--------|----------|
| 邮件通知 | 配置完成 | SMTP测试 |
| 钉钉通知 | 配置完成 | Webhook测试 |
| 告警分级 | 生效 | 规则测试 |
| 抑制机制 | 正常 | 功能测试 |

---

## 六、关联文档

- [任务跟踪-阶段7-监控体系完善.md](./任务跟踪-阶段7-监控体系完善.md)
- [任务跟踪-阶段7-监控体系完善-部署任务7.3-WebSocket实时推送优化.md](./任务跟踪-阶段7-监控体系完善-部署任务7.3-WebSocket实时推送优化.md)
- [任务跟踪-阶段7-监控体系完善-部署任务7.5-监控数据持久化.md](./任务跟踪-阶段7-监控体系完善-部署任务7.5-监控数据持久化.md)

---

**创建时间:** 2026-02-11
