# Phase 4 - Task 4.2: Migrate YL-monitor Common Scripts - Detailed Deployment Document

**Task ID:** 4.2  
**Task Name:** Migrate YL-monitor Common Scripts  
**Priority:** P1 (High)  
**Estimated Hours:** 2 hours  
**Status:** Pending  
**Prerequisites:** Task 4.1 completed

---

## I. Task Objectives

Migrate common scripts from YL-monitor/scripts to the main scripts/ directory to eliminate duplication.

## II. Scripts to Migrate

### 2.1 Migration List

| Script | From | To | Action |
|--------|------|-----|--------|
| deploy.sh | YL-monitor/scripts/deploy/ | scripts/deploy/yl-monitor-deploy.sh | Rename & adapt |
| rollback.sh | YL-monitor/scripts/deploy/ | scripts/deploy/yl-monitor-rollback.sh | Rename & adapt |
| notify.py | YL-monitor/scripts/deploy/ | scripts/deploy/notify.py | Merge functionality |
| monitor.py | YL-monitor/scripts/monitor/ | scripts/monitor/yl-monitor-specific.py | Rename |
| health_check.py | YL-monitor/scripts/monitor/ | scripts/monitor/health_check.py | Merge with existing |
| log_analyzer.py | YL-monitor/scripts/monitor/ | scripts/monitor/log_analyzer.py | Move |
| test_api.py | YL-monitor/scripts/tools/ | scripts/utilities/test_yl_monitor_api.py | Rename & move |

## III. Deployment Content

### 3.1 Migration Script

#### File: scripts/tools/migrate_yl_monitor_scripts.sh

```bash
#!/bin/bash
# Migrate YL-monitor scripts to main scripts directory

set -e

YL_MONITOR_SCRIPTS="YL-monitor/scripts"
MAIN_SCRIPTS="scripts"
MIGRATION_LOG="migration_$(date +%Y%m%d_%H%M%S).log"

echo "Starting YL-monitor script migration..." | tee -a $MIGRATION_LOG

# Create target directories
mkdir -p $MAIN_SCRIPTS/deploy
mkdir -p $MAIN_SCRIPTS/monitor
mkdir -p $MAIN_SCRIPTS/utilities

# Function to migrate with backup
migrate_script() {
    local src=$1
    local dest=$2
    local action=$3
    
    echo "Migrating: $src -> $dest ($action)" | tee -a $MIGRATION_LOG
    
    if [ ! -f "$src" ]; then
        echo "  Source not found, skipping" | tee -a $MIGRATION_LOG
        return
    fi
    
    # Backup original
    cp "$src" "$src.backup.$(date +%Y%m%d)"
    
    case $action in
        "move")
            mv "$src" "$dest"
            echo "  Moved successfully" | tee -a $MIGRATION_LOG
            ;;
        "copy")
            cp "$src" "$dest"
            echo "  Copied successfully" | tee -a $MIGRATION_LOG
            ;;
        "merge")
            if [ -f "$dest" ]; then
                echo "  Merging with existing..." | tee -a $MIGRATION_LOG
                # Create merged version
                cat > "$dest.merged" << 'MERGE_HEADER'
#!/bin/bash
# Merged script - supports both YL-monitor and general usage

MODE="${MODE:-general}"  # Set MODE=yl-monitor for YL-monitor specific

if [ "$MODE" = "yl-monitor" ]; then
    # YL-monitor specific configuration
    CONFIG_FILE="YL-monitor/config.yaml"
else
    # General configuration
    CONFIG_FILE="config/default.yaml"
fi

MERGE_HEADER
                cat "$src" >> "$dest.merged"
                mv "$dest.merged" "$dest"
                chmod +x "$dest"
            else
                cp "$src" "$dest"
            fi
            echo "  Merged successfully" | tee -a $MIGRATION_LOG
            ;;
    esac
}

# Migrate deployment scripts
echo "" | tee -a $MIGRATION_LOG
echo "=== Deployment Scripts ===" | tee -a $MIGRATION_LOG
migrate_script "$YL_MONITOR_SCRIPTS/deploy/deploy.sh" \
    "$MAIN_SCRIPTS/deploy/yl-monitor-deploy.sh" "copy"
migrate_script "$YL_MONITOR_SCRIPTS/deploy/rollback.sh" \
    "$MAIN_SCRIPTS/deploy/yl-monitor-rollback.sh" "copy"
migrate_script "$YL_MONITOR_SCRIPTS/deploy/notify.py" \
    "$MAIN_SCRIPTS/deploy/notify.py" "merge"

# Migrate monitoring scripts
echo "" | tee -a $MIGRATION_LOG
echo "=== Monitoring Scripts ===" | tee -a $MIGRATION_LOG
migrate_script "$YL_MONITOR_SCRIPTS/monitor/monitor.py" \
    "$MAIN_SCRIPTS/monitor/yl-monitor-specific.py" "copy"
migrate_script "$YL_MONITOR_SCRIPTS/monitor/health_check.py" \
    "$MAIN_SCRIPTS/monitor/health_check.py" "merge"
migrate_script "$YL_MONITOR_SCRIPTS/monitor/log_analyzer.py" \
    "$MAIN_SCRIPTS/monitor/log_analyzer.py" "move"

# Migrate utility scripts
echo "" | tee -a $MIGRATION_LOG
echo "=== Utility Scripts ===" | tee -a $MIGRATION_LOG
migrate_script "$YL_MONITOR_SCRIPTS/tools/test_api.py" \
    "$MAIN_SCRIPTS/utilities/test_yl_monitor_api.py" "copy"

# Create compatibility wrappers
echo "" | tee -a $MIGRATION_LOG
echo "=== Creating Compatibility Wrappers ===" | tee -a $MIGRATION_LOG

# Wrapper for YL-monitor to use main scripts
cat > "$YL_MONITOR_SCRIPTS/wrapper.sh" << 'EOF'
#!/bin/bash
# YL-monitor script wrapper
# Redirects to main scripts directory with YL-monitor mode

YL_MONITOR_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
PROJECT_ROOT="$(cd "$YL_MONITOR_DIR/.." && pwd)"

export MODE="yl-monitor"
export YL_MONITOR_DIR

# Delegate to main scripts
exec "$PROJECT_ROOT/scripts/$1" "${@:2}"
EOF
chmod +x "$YL_MONITOR_SCRIPTS/wrapper.sh"

echo "Created wrapper: $YL_MONITOR_SCRIPTS/wrapper.sh" | tee -a $MIGRATION_LOG

# Generate migration report
echo "" | tee -a $MIGRATION_LOG
echo "=== Migration Summary ===" | tee -a $MIGRATION_LOG
echo "Migration completed at $(date)" | tee -a $MIGRATION_LOG
echo "Log file: $MIGRATION_LOG" | tee -a $MIGRATION_LOG

# Create summary document
cat > scripts/MIGRATION_SUMMARY.md << EOF
# YL-monitor Script Migration Summary

**Date:** $(date +%Y-%m-%d)  
**Migration Log:** $MIGRATION_LOG

## Migrated Scripts

### Deployment
- yl-monitor-deploy.sh (copied)
- yl-monitor-rollback.sh (copied)
- notify.py (merged)

### Monitoring
- yl-monitor-specific.py (copied)
- health_check.py (merged)
- log_analyzer.py (moved)

### Utilities
- test_yl_monitor_api.py (copied)

## Compatibility
- Created wrapper.sh in YL-monitor/scripts/ for backward compatibility

## Next Steps
1. Update YL-monitor documentation
2. Test all migrated scripts
3. Remove original scripts after validation
EOF

echo "" | tee -a $MIGRATION_LOG
echo "Migration summary: scripts/MIGRATION_SUMMARY.md" | tee -a $MIGRATION_LOG
```

### 3.2 Post-Migration Validation Script

#### File: scripts/tools/validate_migration.py

```python
#!/usr/bin/env python3
"""
Validate YL-monitor script migration
"""

import sys
from pathlib import Path

def check_migrated_scripts():
    """Check that scripts were migrated correctly"""
    project_root = Path(__file__).parent.parent.parent
    
    checks = [
        ("scripts/deploy/yl-monitor-deploy.sh", "file"),
        ("scripts/deploy/yl-monitor-rollback.sh", "file"),
        ("scripts/monitor/yl-monitor-specific.py", "file"),
        ("scripts/monitor/log_analyzer.py", "file"),
        ("YL-monitor/scripts/wrapper.sh", "file"),
        ("scripts/MIGRATION_SUMMARY.md", "file"),
    ]
    
    all_pass = True
    print("Migration Validation")
    print("=" * 50)
    
    for path, check_type in checks:
        full_path = project_root / path
        exists = full_path.exists()
        
        status = "✓" if exists else "✗"
        print(f"{status} {path}")
        
        if not exists:
            all_pass = False
    
    print("=" * 50)
    if all_pass:
        print("All migrations validated ✓")
        return 0
    else:
        print("Some migrations failed ✗")
        return 1

if __name__ == '__main__':
    sys.exit(check_migrated_scripts())
```

## IV. Deployment Steps

```bash
# 1. Create migration script
# Edit scripts/tools/migrate_yl_monitor_scripts.sh

# 2. Make executable
chmod +x scripts/tools/migrate_yl_monitor_scripts.sh

# 3. Run migration
cd /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean
./scripts/tools/migrate_yl_monitor_scripts.sh

# 4. Validate migration
python3 scripts/tools/validate_migration.py

# 5. Review migration summary
cat scripts/MIGRATION_SUMMARY.md
```

## V. Verification Checklist

- [ ] Migration script created
- [ ] All scripts migrated
- [ ] Backups created
- [ ] Compatibility wrapper created
- [ ] Validation passes
- [ ] Migration summary generated

## VI. Next Step

After completing this task, proceed to **Task 4.3: Merge Duplicate Scripts**

View document: `部署/任务跟踪-阶段4-脚本整合-部署任务4.3-合并重复脚本.md`
