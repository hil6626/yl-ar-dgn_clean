# 部署任务8.6: 备份和恢复机制

**任务ID:** 8.6  
**所属阶段:** 阶段8 - 生产环境准备  
**任务名称:** 备份和恢复机制  
**优先级:** P1（重要优先级）  
**关键性:** 重要  
**预计工时:** 4小时  
**负责人:** 运维工程师  
**前置依赖:** 任务8.5完成  
**状态:** 待开始

---

## 一、任务目标

建立完整的备份和恢复机制，包括数据备份、配置备份、定时任务和恢复测试。

---

## 二、工作内容

1. 数据备份脚本
2. 配置备份脚本
3. 定时任务配置
4. 恢复脚本
5. 恢复测试

---

## 三、实施步骤

### 步骤1: 创建备份脚本

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/backup.sh << 'EOF'
#!/bin/bash
set -e

BACKUP_DIR="/backup/ar-studio"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="backup_${DATE}"

echo "========================================"
echo "AR Studio 备份脚本"
echo "时间: $(date)"
echo "========================================"

# 创建备份目录
mkdir -p ${BACKUP_DIR}/${BACKUP_NAME}

# 1. 备份数据
echo "1. 备份数据..."
if [ -d "AR-backend/data" ]; then
    tar -czf ${BACKUP_DIR}/${BACKUP_NAME}/data.tar.gz AR-backend/data/
    echo "  ✓ 数据备份完成"
fi

# 2. 备份配置
echo "2. 备份配置..."
tar -czf ${BACKUP_DIR}/${BACKUP_NAME}/config.tar.gz config/
echo "  ✓ 配置备份完成"

# 3. 备份数据库
echo "3. 备份数据库..."
if command -v pg_dump &> /dev/null; then
    pg_dump -h localhost -U ar_studio ar_studio > ${BACKUP_DIR}/${BACKUP_NAME}/database.sql 2>/dev/null || echo "  ⚠ 数据库备份跳过"
else
    echo "  ⚠ pg_dump未安装，跳过数据库备份"
fi

# 4. 备份日志
echo "4. 备份日志..."
tar -czf ${BACKUP_DIR}/${BACKUP_NAME}/logs.tar.gz AR-backend/logs/ YL-monitor/logs/ 2>/dev/null || echo "  ⚠ 日志备份跳过"

# 5. 创建备份信息
echo "5. 创建备份信息..."
cat > ${BACKUP_DIR}/${BACKUP_NAME}/backup.info << INFO
备份时间: $(date)
备份版本: $(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
系统信息: $(uname -a)
INFO

echo "========================================"
echo "备份完成: ${BACKUP_DIR}/${BACKUP_NAME}"
echo "========================================"
EOF

chmod +x /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/backup.sh
echo "✓ 备份脚本已创建"
```

### 步骤2: 创建恢复脚本

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/restore.sh << 'EOF'
#!/bin/bash
set -e

BACKUP_PATH=$1

if [ -z "$BACKUP_PATH" ]; then
    echo "用法: $0 <备份路径>"
    echo "可用备份:"
    ls -1d /backup/ar-studio/* 2>/dev/null || echo "无可用备份"
    exit 1
fi

echo "========================================"
echo "AR Studio 恢复脚本"
echo "备份: $BACKUP_PATH"
echo "时间: $(date)"
echo "========================================"

if [ ! -d "$BACKUP_PATH" ]; then
    echo "错误: 备份路径不存在"
    exit 1
fi

# 1. 停止服务
echo "1. 停止服务..."
docker-compose down 2>/dev/null || true

# 2. 恢复数据
echo "2. 恢复数据..."
if [ -f "${BACKUP_PATH}/data.tar.gz" ]; then
    tar -xzf ${BACKUP_PATH}/data.tar.gz
    echo "  ✓ 数据恢复完成"
fi

# 3. 恢复配置
echo "3. 恢复配置..."
if [ -f "${BACKUP_PATH}/config.tar.gz" ]; then
    tar -xzf ${BACKUP_PATH}/config.tar.gz
    echo "  ✓ 配置恢复完成"
fi

# 4. 恢复数据库
echo "4. 恢复数据库..."
if [ -f "${BACKUP_PATH}/database.sql" ]; then
    psql -h localhost -U ar_studio ar_studio < ${BACKUP_PATH}/database.sql 2>/dev/null || echo "  ⚠ 数据库恢复跳过"
fi

# 5. 启动服务
echo "5. 启动服务..."
docker-compose up -d

echo "========================================"
echo "恢复完成!"
echo "========================================"
EOF

chmod +x /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/restore.sh
echo "✓ 恢复脚本已创建"
```

### 步骤3: 验证备份恢复机制

```bash
cat > /tmp/verify_backup.sh << 'EOF'
#!/bin/bash
echo "========================================"
echo "备份和恢复机制验证"
echo "========================================"

errors=0

# 检查备份脚本
echo -n "检查备份脚本... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/backup.sh" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

# 检查恢复脚本
echo -n "检查恢复脚本... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/restore.sh" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

echo "========================================"
if [ $errors -eq 0 ]; then
    echo "✓ 备份和恢复机制验证通过"
    exit 0
else
    echo "✗ 备份和恢复机制验证失败 ($errors 个错误)"
    exit 1
fi
EOF

chmod +x /tmp/verify_backup.sh
/tmp/verify_backup.sh
```

---

## 四、验证步骤

### 验证清单

- [ ] 数据备份脚本创建
- [ ] 配置备份脚本创建
- [ ] 定时任务配置完成
- [ ] 恢复脚本创建

---

## 五、预期结果

| 指标 | 目标值 | 验证方法 |
|------|--------|----------|
| 数据备份 | 创建 | 脚本检查 |
| 配置备份 | 创建 | 脚本检查 |
| 定时任务 | 配置 | 配置检查 |
| 恢复脚本 | 创建 | 脚本检查 |

---

## 六、关联文档

- [任务跟踪-阶段8-生产环境准备.md](./任务跟踪-阶段8-生产环境准备.md)
- [任务跟踪-阶段8-生产环境准备-部署任务8.5-日志和监控集成.md](./任务跟踪-阶段8-生产环境准备-部署任务8.5-日志和监控集成.md)
- [任务跟踪-阶段8-生产环境准备-部署任务8.7-性能优化.md](./任务跟踪-阶段8-生产环境准备-部署任务8.7-性能优化.md)

---

**创建时间:** 2026-02-11
