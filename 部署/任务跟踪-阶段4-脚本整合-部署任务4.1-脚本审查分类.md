# Phase 4 - Task 4.1: Script Review and Classification - Detailed Deployment Document

**Task ID:** 4.1  
**Task Name:** Script Review and Classification  
**Priority:** P0 (Blocking)  
**Estimated Hours:** 3 hours  
**Status:** Pending  
**Prerequisites:** Phase 3 completed

---

## I. Task Objectives

Review all scripts in the project and classify them by function to identify duplicates and consolidation opportunities.

## II. Current Script Inventory

### 2.1 YL-monitor Scripts

| Directory | Count | Main Scripts |
|-----------|-------|--------------|
| YL-monitor/scripts/deploy/ | 3 | deploy.sh, rollback.sh, notify.py |
| YL-monitor/scripts/monitor/ | 5 | monitor.py, health_check.py, log_analyzer.py |
| YL-monitor/scripts/tools/ | 7 | css_version_manager.py, test_api.py, etc. |

### 2.2 Root Scripts Directory

| Directory | Count | Main Scripts |
|-----------|-------|--------------|
| scripts/deploy/ | 3 | deploy.sh, rollback.sh, notify_deployment.py |
| scripts/cleanup/ | 5 | cleanup_project.sh, final_cleanup.sh, etc. |
| scripts/docs/ | 2 | docs_generator.py, verify_docs.sh |
| scripts/utilities/ | 8 | check_dependencies.py, env.sh, etc. |
| scripts/monitor/ | 14 | monitor.py, health_check.py, api_health_check.py, etc. |
| scripts/security/ | 2 | security_scan.py, vulnerability_check.py |
| scripts/validation/ | 6 | validate_backend_services.py, etc. |

**Total: 54+ scripts**

## III. Classification Results

### 3.1 Category 1: Deployment Scripts (8 scripts)

| Script | Location | Function | Consolidation |
|--------|----------|----------|---------------|
| deploy.sh | YL-monitor/scripts/deploy/ | Deploy YL-monitor | Merge |
| deploy.sh | scripts/deploy/ | Deploy system | Keep as master |
| rollback.sh | YL-monitor/scripts/deploy/ | Rollback YL-monitor | Merge |
| rollback.sh | scripts/deploy/ | Rollback system | Keep as master |
| notify.py | YL-monitor/scripts/deploy/ | Deployment notifications | Merge |
| notify_deployment.py | scripts/deploy/ | Deployment notifications | Keep as master |

### 3.2 Category 2: Monitoring Scripts (12 scripts)

| Script | Location | Function | Consolidation |
|--------|----------|----------|---------------|
| monitor.py | YL-monitor/scripts/monitor/ | YL-monitor specific | Keep |
| monitor.py | scripts/monitor/ | General monitoring | Keep as master |
| health_check.py | YL-monitor/scripts/ | YL-monitor health | Merge |
| health_check.py | scripts/monitor/ | General health check | Keep as master |
| api_health_check.py | scripts/monitor/ | API health check | Keep |
| auto_log_monitor.py | scripts/monitor/ | Log monitoring | Keep |
| resource_monitor.py | scripts/monitor/ | Resource monitoring | Keep |

### 3.3 Category 3: Cleanup Scripts (5 scripts)

| Script | Location | Function | Consolidation |
|--------|----------|----------|---------------|
| cleanup_project.sh | scripts/cleanup/ | Project cleanup | Keep as master |
| cleanup_tasks_docs.sh | scripts/cleanup/ | Task docs cleanup | Keep |
| final_cleanup.sh | scripts/cleanup/ | Final cleanup | Keep |
| clean_cache.sh | scripts/cleanup/ | Cache cleanup | Keep |
| refactor_directories.sh | scripts/cleanup/ | Directory refactoring | Keep |

### 3.4 Category 4: Validation Scripts (6 scripts)

| Script | Location | Function | Consolidation |
|--------|----------|----------|---------------|
| validate_backend_services.py | scripts/validation/ | Backend validation | Keep |
| validate_frontend_architecture.py | scripts/validation/ | Frontend validation | Keep |
| validate_entrypoints.py | scripts/validation/ | Entry point validation | Keep |
| validate_rules_engine.py | scripts/validation/ | Rules validation | Keep |
| check_scripts_integrity.py | scripts/validation/ | Script integrity | Keep |
| verify_infrastructure.sh | scripts/ | Infrastructure verification | Move to validation/ |

### 3.5 Category 5: Utility Scripts (15 scripts)

| Script | Location | Function | Consolidation |
|--------|----------|----------|---------------|
| check_dependencies.py | scripts/utilities/ | Dependency check | Keep |
| env.sh | scripts/utilities/ | Environment setup | Keep |
| fix_paths_to_local.sh | scripts/utilities/ | Path fixing | Keep |
| scripts_manager.py | scripts/utilities/ | Script management | Keep |
| build_gui_components.py | scripts/utilities/ | GUI building | Keep |

## IV. Deployment Content

### 4.1 Create Script Inventory Tool

#### File: scripts/tools/inventory.py

```python
#!/usr/bin/env python3
"""
Script Inventory Tool
Scans and catalogs all scripts in the project
"""

import os
import json
from pathlib import Path
from typing import Dict, List
from collections import defaultdict


class ScriptInventory:
    """
    Script Inventory
    """

    def __init__(self, project_root: Path):
        self.project_root = project_root
        self.scripts = defaultdict(list)
        self.categories = {
            'deploy': ['deploy', 'rollback', 'install', 'setup'],
            'monitor': ['monitor', 'health', 'check', 'watch'],
            'cleanup': ['cleanup', 'clean', 'remove', 'delete', 'purge'],
            'validation': ['validate', 'verify', 'test', 'check'],
            'utility': ['util', 'tool', 'helper', 'manage'],
            'docs': ['doc', 'generate', 'readme'],
            'security': ['security', 'scan', 'vulnerability', 'audit']
        }

    def scan(self):
        """
        Scan for scripts
        """
        for ext in ['*.sh', '*.py']:
            for script_file in self.project_root.rglob(ext):
                # Skip hidden and cache directories
                if any(part.startswith('.') or part == '__pycache__'
                       for part in script_file.parts):
                    continue

                # Categorize
                category = self._categorize(script_file)
                self.scripts[category].append({
                    'path': str(script_file.relative_to(self.project_root)),
                    'name': script_file.name,
                    'size': script_file.stat().st_size,
                    'lines': self._count_lines(script_file)
                })

    def _categorize(self, script_file: Path) -> str:
        """
        Categorize a script
        """
        name = script_file.name.lower()
        path = str(script_file).lower()

        # Check path first
        for category, keywords in self.categories.items():
            if category in path:
                return category

        # Check name
        for category, keywords in self.categories.items():
            if any(kw in name for kw in keywords):
                return category

        return 'other'

    def _count_lines(self, script_file: Path) -> int:
        """
        Count lines in script
        """
        try:
            with open(script_file, 'r', encoding='utf-8', errors='ignore') as f:
                return len(f.readlines())
        except:
            return 0

    def generate_report(self) -> str:
        """
        Generate inventory report
        """
        lines = []
        lines.append("# Script Inventory Report")
        lines.append("")
        lines.append(f"**Project Root:** {self.project_root}")
        lines.append(f"**Scan Date:** {__import__('datetime').datetime.now().isoformat()}")
        lines.append("")

        total_scripts = 0
        total_lines = 0

        for category, scripts in sorted(self.scripts.items()):
            count = len(scripts)
            lines_count = sum(s['lines'] for s in scripts)
            total_scripts += count
            total_lines += lines_count

            lines.append(f"## {category.upper()} ({count} scripts, {lines_count} lines)")
            lines.append("")

            for script in sorted(scripts, key=lambda x: x['path']):
                lines.append(f"- `{script['path']}` ({script['lines']} lines)")

            lines.append("")

        lines.append("## Summary")
        lines.append(f"- **Total Scripts:** {total_scripts}")
        lines.append(f"- **Total Lines:** {total_lines}")
        lines.append(f"- **Categories:** {len(self.scripts)}")

        return '\n'.join(lines)

    def find_duplicates(self) -> List[Dict]:
        """
        Find potential duplicate scripts
        """
        duplicates = []

        # Group by name
        by_name = defaultdict(list)
        for category, scripts in self.scripts.items():
            for script in scripts:
                by_name[script['name']].append(script)

        # Find duplicates
        for name, scripts in by_name.items():
            if len(scripts) > 1:
                duplicates.append({
                    'name': name,
                    'locations': [s['path'] for s in scripts],
                    'suggestion': 'Consider consolidating'
                })

        return duplicates


def main():
    """Main function"""
    project_root = Path(__file__).parent.parent.parent

    inventory = ScriptInventory(project_root)
    inventory.scan()

    # Generate report
    report = inventory.generate_report()
    print(report)

    # Save report
    report_file = project_root / 'scripts_inventory.md'
    with open(report_file, 'w') as f:
        f.write(report)

    print(f"\nReport saved to: {report_file}")

    # Find duplicates
    duplicates = inventory.find_duplicates()
    if duplicates:
        print("\nPotential Duplicates:")
        for dup in duplicates:
            print(f"  {dup['name']}: {', '.join(dup['locations'])}")


if __name__ == '__main__':
    main()
```

## V. Deployment Steps

```bash
# 1. Create inventory tool directory
mkdir -p scripts/tools

# 2. Create inventory script
# Edit scripts/tools/inventory.py

# 3. Run inventory
python3 scripts/tools/inventory.py

# 4. Review generated report
cat scripts_inventory.md

# 5. Create classification document
cat > scripts_classification.md << 'EOF'
# Script Classification

## Categories
1. Deployment (8 scripts)
2. Monitoring (12 scripts)
3. Cleanup (5 scripts)
4. Validation (6 scripts)
5. Utility (15 scripts)
6. Other (8 scripts)

## Consolidation Plan
- Merge YL-monitor deploy scripts into main deploy/
- Consolidate health check scripts
- Unify monitoring entry points
EOF
```

## VI. Verification Checklist

- [ ] All scripts inventoried
- [ ] Scripts classified by function
- [ ] Duplicate functions identified
- [ ] Classification report generated
- [ ] Consolidation plan created

## VII. Next Step

After completing this task, proceed to **Task 4.2: Migrate YL-monitor Common Scripts**

View document: `部署/任务跟踪-阶段4-脚本整合-部署任务4.2-迁移YL-monitor公共脚本.md`
