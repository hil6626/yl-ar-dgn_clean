# 部署任务9.2: 集成测试完善

**任务ID:** 9.2  
**所属阶段:** 阶段9 - 测试和文档完善  
**任务名称:** 集成测试完善  
**优先级:** P1（重要优先级）  
**关键性:** 重要  
**预计工时:** 4小时  
**负责人:** 测试开发工程师  
**前置依赖:** 任务9.1完成  
**状态:** 待开始

---

## 一、任务目标

完善集成测试，包括API集成测试、服务间集成测试和数据流集成测试。

---

## 二、工作内容

1. API集成测试
2. 服务间集成测试
3. 数据流集成测试
4. 错误处理测试
5. 性能集成测试

---

## 三、实施步骤

### 步骤1: 创建API集成测试

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/test/test_integration/test_api_integration.py << 'EOF'
import pytest
import requests

BASE_URL = "http://localhost:5501"

class TestAPIIntegration:
    """API集成测试"""
    
    def test_health_endpoint(self):
        """测试健康检查端点"""
        response = requests.get(f"{BASE_URL}/health", timeout=5)
        assert response.status_code == 200
        data = response.json()
        assert data.get('status') == 'healthy'
    
    def test_status_endpoint(self):
        """测试状态端点"""
        response = requests.get(f"{BASE_URL}/status", timeout=5)
        assert response.status_code == 200
        data = response.json()
        assert 'status' in data
    
    def test_metrics_endpoint(self):
        """测试指标端点"""
        response = requests.get(f"{BASE_URL}/metrics", timeout=5)
        assert response.status_code == 200
    
    def test_video_api(self):
        """测试视频API"""
        # 测试视频流端点
        response = requests.get(f"{BASE_URL}/api/video/stream", timeout=5)
        # 可能返回200或需要认证
        assert response.status_code in [200, 401, 403]
    
    def test_control_api(self):
        """测试控制API"""
        # 测试控制端点
        response = requests.post(
            f"{BASE_URL}/api/control/start",
            json={},
            timeout=5
        )
        # 可能返回200或需要认证
        assert response.status_code in [200, 401, 403]
EOF

echo "✓ API集成测试已创建"
```

### 步骤2: 创建服务间集成测试

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/test/test_integration/test_service_integration.py << 'EOF'
import pytest
import requests

class TestServiceIntegration:
    """服务间集成测试"""
    
    def test_ar_backend_to_monitor(self):
        """测试AR-backend到监控服务"""
        # 检查AR-backend健康
        ar_response = requests.get(
            "http://localhost:5501/health",
            timeout=5
        )
        assert ar_response.status_code == 200
        
        # 检查YL-monitor健康
        monitor_response = requests.get(
            "http://localhost:5000/api/health",
            timeout=5
        )
        assert monitor_response.status_code == 200
    
    def test_monitor_data_collection(self):
        """测试监控数据收集"""
        response = requests.get(
            "http://localhost:5000/api/metrics/realtime",
            timeout=5
        )
        assert response.status_code == 200
        data = response.json()
        assert 'cpu_percent' in data or 'error' in data
    
    def test_end_to_end_data_flow(self):
        """测试端到端数据流"""
        # 1. 获取AR-backend状态
        ar_status = requests.get(
            "http://localhost:5501/status",
            timeout=5
        )
        
        # 2. 检查监控是否收到数据
        monitor_data = requests.get(
            "http://localhost:5000/api/nodes",
            timeout=5
        )
        
        assert ar_status.status_code == 200
        assert monitor_data.status_code == 200
EOF

echo "✓ 服务间集成测试已创建"
```

### 步骤3: 验证集成测试

```bash
cat > /tmp/verify_integration_tests.sh << 'EOF'
#!/bin/bash
echo "========================================"
echo "集成测试验证"
echo "========================================"

errors=0

# 检查API集成测试
echo -n "检查API集成测试... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/test/test_integration/test_api_integration.py" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

# 检查服务间集成测试
echo -n "检查服务间集成测试... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/test/test_integration/test_service_integration.py" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

echo "========================================"
if [ $errors -eq 0 ]; then
    echo "✓ 集成测试验证通过"
    exit 0
else
    echo "✗ 集成测试验证失败 ($errors 个错误)"
    exit 1
fi
EOF

chmod +x /tmp/verify_integration_tests.sh
/tmp/verify_integration_tests.sh
```

---

## 四、验证步骤

### 验证清单

- [ ] API集成测试完善
- [ ] 服务间集成测试完善
- [ ] 数据流集成测试完善
- [ ] 错误处理测试完善

---

## 五、预期结果

| 指标 | 目标值 | 验证方法 |
|------|--------|----------|
| API集成测试 | 完善 | 测试执行 |
| 服务间集成测试 | 完善 | 测试执行 |
| 数据流集成测试 | 完善 | 测试执行 |
| 错误处理测试 | 完善 | 测试执行 |

---

## 六、关联文档

- [任务跟踪-阶段9-测试和文档完善.md](./任务跟踪-阶段9-测试和文档完善.md)
- [任务跟踪-阶段9-测试和文档完善-部署任务9.1-单元测试补充.md](./任务跟踪-阶段9-测试和文档完善-部署任务9.1-单元测试补充.md)
- [任务跟踪-阶段9-测试和文档完善-部署任务9.3-端到端测试.md](./任务跟踪-阶段9-测试和文档完善-部署任务9.3-端到端测试.md)

---

**创建时间:** 2026-02-11
