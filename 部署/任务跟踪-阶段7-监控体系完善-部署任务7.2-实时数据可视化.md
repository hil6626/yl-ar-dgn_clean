# 部署任务7.2: 实时数据可视化

**任务ID:** 7.2  
**所属阶段:** 阶段7 - 监控体系完善  
**任务名称:** 实时数据可视化  
**优先级:** P1（重要优先级）  
**关键性:** 重要  
**预计工时:** 4小时  
**负责人:** 前端开发工程师  
**前置依赖:** 任务7.1完成  
**状态:** 待开始

---

## 一、任务目标

实现YL-monitor实时数据可视化功能，包括实时性能图表、历史数据趋势、数据下钻分析和自定义仪表盘。

---

## 二、工作内容

1. 实时性能图表
2. 历史数据趋势
3. 数据下钻分析
4. 自定义仪表盘
5. 数据导出功能

---

## 三、实施步骤

### 步骤1: 创建数据可视化API

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/YL-monitor/app/routes/dashboard_api.py << 'EOF'
from flask import Blueprint, jsonify, request
from datetime import datetime, timedelta
from app.services.metrics_storage import MetricsStorage

dashboard_bp = Blueprint('dashboard', __name__)
metrics_storage = MetricsStorage()

@dashboard_bp.route('/api/metrics/realtime')
def get_realtime_metrics():
    """获取实时性能指标"""
    return jsonify({
        'timestamp': datetime.utcnow().isoformat(),
        'cpu_percent': metrics_storage.get_latest_cpu(),
        'memory_percent': metrics_storage.get_latest_memory(),
        'disk_usage': metrics_storage.get_latest_disk(),
        'network_io': metrics_storage.get_latest_network(),
        'active_connections': metrics_storage.get_active_connections()
    })

@dashboard_bp.route('/api/metrics/history')
def get_metrics_history():
    """获取历史性能数据"""
    metric_type = request.args.get('type', 'cpu')
    hours = int(request.args.get('hours', 24))
    
    end_time = datetime.utcnow()
    start_time = end_time - timedelta(hours=hours)
    
    data = metrics_storage.get_history(
        metric_type=metric_type,
        start_time=start_time,
        end_time=end_time,
        interval='5m'
    )
    
    return jsonify({
        'metric': metric_type,
        'interval': '5m',
        'data': [
            {
                'timestamp': point.timestamp.isoformat(),
                'value': point.value,
                'min': point.min_value,
                'max': point.max_value
            }
            for point in data
        ]
    })

@dashboard_bp.route('/api/metrics/nodes/<node_id>/detail')
def get_node_detail(node_id):
    """获取节点详细指标"""
    node_metrics = metrics_storage.get_node_metrics(node_id)
    
    return jsonify({
        'node_id': node_id,
        'current': {
            'cpu_percent': node_metrics.cpu_percent,
            'memory_percent': node_metrics.memory_percent,
            'disk_percent': node_metrics.disk_percent,
            'network_sent': node_metrics.network_sent,
            'network_recv': node_metrics.network_recv
        },
        'processes': node_metrics.top_processes,
        'alerts': node_metrics.recent_alerts,
        'uptime': node_metrics.uptime_seconds
    })
EOF

echo "✓ 数据可视化API已创建"
```

### 步骤2: 创建数据存储服务

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/YL-monitor/app/services/metrics_storage.py << 'EOF'
from datetime import datetime, timedelta
from typing import List, Dict, Optional
import sqlite3
import json

class MetricsStorage:
    def __init__(self, db_path='data/metrics.db'):
        self.db_path = db_path
        self.init_db()
    
    def init_db(self):
        """初始化数据库"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS metrics (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
                metric_type TEXT,
                node_id TEXT,
                value REAL,
                min_value REAL,
                max_value REAL
            )
        ''')
        
        conn.commit()
        conn.close()
    
    def store_metric(self, metric_type: str, node_id: str, value: float):
        """存储指标"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO metrics (metric_type, node_id, value, min_value, max_value)
            VALUES (?, ?, ?, ?, ?)
        ''', (metric_type, node_id, value, value, value))
        
        conn.commit()
        conn.close()
    
    def get_latest_cpu(self) -> float:
        """获取最新CPU使用率"""
        return self._get_latest_metric('cpu')
    
    def get_latest_memory(self) -> float:
        """获取最新内存使用率"""
        return self._get_latest_metric('memory')
    
    def get_latest_disk(self) -> float:
        """获取最新磁盘使用率"""
        return self._get_latest_metric('disk')
    
    def get_latest_network(self) -> Dict:
        """获取最新网络IO"""
        return {'sent': 0, 'recv': 0}  # 占位实现
    
    def get_active_connections(self) -> int:
        """获取活跃连接数"""
        return 0  # 占位实现
    
    def _get_latest_metric(self, metric_type: str) -> float:
        """获取最新指标值"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT value FROM metrics 
            WHERE metric_type = ? 
            ORDER BY timestamp DESC 
            LIMIT 1
        ''', (metric_type,))
        
        result = cursor.fetchone()
        conn.close()
        
        return result[0] if result else 0.0
    
    def get_history(self, metric_type: str, start_time: datetime, 
                    end_time: datetime, interval: str = '5m') -> List:
        """获取历史数据"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT timestamp, value, min_value, max_value 
            FROM metrics 
            WHERE metric_type = ? AND timestamp BETWEEN ? AND ?
            ORDER BY timestamp
        ''', (metric_type, start_time, end_time))
        
        results = cursor.fetchall()
        conn.close()
        
        # 转换为对象列表
        class MetricPoint:
            def __init__(self, timestamp, value, min_value, max_value):
                self.timestamp = timestamp
                self.value = value
                self.min_value = min_value
                self.max_value = max_value
        
        return [MetricPoint(*row) for row in results]
    
    def get_node_metrics(self, node_id: str):
        """获取节点指标"""
        # 占位实现
        class NodeMetrics:
            def __init__(self):
                self.cpu_percent = 0.0
                self.memory_percent = 0.0
                self.disk_percent = 0.0
                self.network_sent = 0
                self.network_recv = 0
                self.top_processes = []
                self.recent_alerts = []
                self.uptime_seconds = 0
        
        return NodeMetrics()
EOF

echo "✓ 数据存储服务已创建"
```

### 步骤3: 验证数据可视化

```bash
cat > /tmp/verify_visualization.sh << 'EOF'
#!/bin/bash
echo "========================================"
echo "数据可视化验证"
echo "========================================"

errors=0

# 检查API文件
echo -n "检查API文件... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/YL-monitor/app/routes/dashboard_api.py" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

# 检查存储服务
echo -n "检查存储服务... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/YL-monitor/app/services/metrics_storage.py" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

echo "========================================"
if [ $errors -eq 0 ]; then
    echo "✓ 数据可视化验证通过"
    exit 0
else
    echo "✗ 数据可视化验证失败 ($errors 个错误)"
    exit 1
fi
EOF

chmod +x /tmp/verify_visualization.sh
/tmp/verify_visualization.sh
```

---

## 四、验证步骤

### 验证清单

- [ ] 实时数据API实现
- [ ] 历史数据查询实现
- [ ] 数据聚合和统计实现

---

## 五、预期结果

| 指标 | 目标值 | 验证方法 |
|------|--------|----------|
| 实时数据API | 实现 | API测试 |
| 历史查询 | 实现 | 功能测试 |
| 数据聚合 | 实现 | 数据验证 |

---

## 六、关联文档

- [任务跟踪-阶段7-监控体系完善.md](./任务跟踪-阶段7-监控体系完善.md)
- [任务跟踪-阶段7-监控体系完善-部署任务7.1-监控面板UI美化.md](./任务跟踪-阶段7-监控体系完善-部署任务7.1-监控面板UI美化.md)
- [任务跟踪-阶段7-监控体系完善-部署任务7.3-WebSocket实时推送优化.md](./任务跟踪-阶段7-监控体系完善-部署任务7.3-WebSocket实时推送优化.md)

---

**创建时间:** 2026-02-11
