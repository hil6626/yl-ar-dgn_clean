# Phase 3 - Task 3.7: Rule Validation Testing - Detailed Deployment Document

**Task ID:** 3.7  
**Task Name:** Rule Validation Testing  
**Priority:** P1 (High)  
**Estimated Hours:** 2 hours  
**Status:** Pending  
**Prerequisites:** Task 3.6 completed

---

## I. Task Objectives

Validate all rules are correctly loaded, valid, and functional.

## II. Deployment Content

### 2.1 Files to Create

| No. | File Path | Operation | Description |
|-----|-----------|-----------|-------------|
| 1 | `test/rules/test_rules.py` | New | Rule test suite |
| 2 | `test/rules/validate_all.py` | New | Validation script |

### 2.2 Detailed Code Implementation

#### File 1: test/rules/test_rules.py

```python
#!/usr/bin/env python3
"""
Rule Validation Test Suite
"""

import unittest
import json
from pathlib import Path

class TestRuleFiles(unittest.TestCase):
    """Test rule files"""

    RULES_DIR = Path(__file__).parent.parent.parent / 'rules'

    def test_l1_file_exists(self):
        """Test L1 file exists"""
        l1_file = self.RULES_DIR / 'L1-meta-goal.json'
        self.assertTrue(l1_file.exists())

    def test_l1_valid_json(self):
        """Test L1 is valid JSON"""
        l1_file = self.RULES_DIR / 'L1-meta-goal.json'
        with open(l1_file) as f:
            data = json.load(f)
            self.assertIn('layer', data)
            self.assertEqual(data['layer'], 'L1')

    def test_l2_file_exists(self):
        """Test L2 file exists"""
        l2_file = self.RULES_DIR / 'L2-understanding.json'
        self.assertTrue(l2_file.exists())

    def test_l3_file_exists(self):
        """Test L3 file exists"""
        l3_file = self.RULES_DIR / 'L3-constraints.json'
        self.assertTrue(l3_file.exists())

    def test_l4_file_exists(self):
        """Test L4 file exists"""
        l4_file = self.RULES_DIR / 'L4-decisions.json'
        self.assertTrue(l4_file.exists())

    def test_l5_file_exists(self):
        """Test L5 file exists"""
        l5_file = self.RULES_DIR / 'L5-execution.json'
        self.assertTrue(l5_file.exists())

    def test_all_layers_have_required_fields(self):
        """Test all layers have required fields"""
        required = {
            'L1': ['layer', 'name', 'goals'],
            'L2': ['layer', 'name', 'context'],
            'L3': ['layer', 'name', 'technical_constraints'],
            'L4': ['layer', 'name', 'decision_rules'],
            'L5': ['layer', 'name', 'procedures']
        }

        for layer, fields in required.items():
            file_path = self.RULES_DIR / f'{layer}-*.json'
            # Find file
            files = list(self.RULES_DIR.glob(f'{layer}-*.json'))
            if files:
                with open(files[0]) as f:
                    data = json.load(f)
                    for field in fields:
                        self.assertIn(field, data, f"{layer} missing {field}")


class TestRuleEngine(unittest.TestCase):
    """Test rule engine"""

    def test_engine_import(self):
        """Test engine can be imported"""
        try:
            from rules.engine import RuleEngine
            self.assertTrue(True)
        except ImportError as e:
            self.fail(f"Cannot import RuleEngine: {e}")

    def test_engine_loads_rules(self):
        """Test engine loads rules"""
        from rules.engine import RuleEngine
        engine = RuleEngine()
        success = engine.load_all_rules()
        self.assertTrue(success)

    def test_engine_validates_rules(self):
        """Test engine validates rules"""
        from rules.engine import RuleEngine
        engine = RuleEngine()
        engine.load_all_rules()
        results = engine.validate_all()
        self.assertIsInstance(results, dict)


if __name__ == '__main__':
    unittest.main()
```

#### File 2: test/rules/validate_all.py

```python
#!/usr/bin/env python3
"""
Validate All Rules
"""

import sys
import json
from pathlib import Path
from typing import Dict, List

def validate_json_file(file_path: Path) -> tuple:
    """
    Validate a JSON file
    """
    try:
        with open(file_path) as f:
            data = json.load(f)
            return True, data, None
    except json.JSONDecodeError as e:
        return False, None, str(e)
    except Exception as e:
        return False, None, str(e)

def validate_layer(layer: str, data: Dict) -> List[str]:
    """
    Validate a specific layer
    """
    errors = []

    # Check required fields
    if 'layer' not in data:
        errors.append("Missing 'layer' field")
    elif data['layer'] != layer:
        errors.append(f"Layer mismatch: expected {layer}, got {data['layer']}")

    if 'name' not in data:
        errors.append("Missing 'name' field")

    if 'description' not in data:
        errors.append("Missing 'description' field")

    # Layer-specific validation
    if layer == 'L1':
        if 'goals' not in data:
            errors.append("Missing 'goals' field")
        elif not isinstance(data['goals'], list):
            errors.append("'goals' must be a list")

    elif layer == 'L2':
        if 'context' not in data:
            errors.append("Missing 'context' field")

    elif layer == 'L3':
        if 'technical_constraints' not in data:
            errors.append("Missing 'technical_constraints' field")

    elif layer == 'L4':
        if 'decision_rules' not in data:
            errors.append("Missing 'decision_rules' field")

    elif layer == 'L5':
        if 'procedures' not in data:
            errors.append("Missing 'procedures' field")

    return errors

def main():
    """Main function"""
    rules_dir = Path(__file__).parent.parent.parent / 'rules'

    print("=" * 60)
    print("Rule Validation")
    print("=" * 60)

    layers = ['L1', 'L2', 'L3', 'L4', 'L5']
    all_valid = True

    for layer in layers:
        # Find rule file
        files = list(rules_dir.glob(f'{layer}-*.json'))
        if not files:
            print(f"\n{layer}: ✗ No rule file found")
            all_valid = False
            continue

        file_path = files[0]
        print(f"\n{layer}: {file_path.name}")

        # Validate JSON
        valid, data, error = validate_json_file(file_path)
        if not valid:
            print(f"  ✗ Invalid JSON: {error}")
            all_valid = False
            continue

        print(f"  ✓ Valid JSON")

        # Validate content
        errors = validate_layer(layer, data)
        if errors:
            print(f"  ✗ Content errors:")
            for error in errors:
                print(f"    - {error}")
            all_valid = False
        else:
            print(f"  ✓ Content valid")

    print("\n" + "=" * 60)
    if all_valid:
        print("All rules valid ✓")
        return 0
    else:
        print("Some rules invalid ✗")
        return 1

if __name__ == '__main__':
    sys.exit(main())
```

## III. Deployment Steps

```bash
# 1. Create test directory
mkdir -p test/rules

# 2. Create test files
# test/rules/test_rules.py
# test/rules/validate_all.py

# 3. Run validation
python3 test/rules/validate_all.py

# 4. Run tests
python3 -m pytest test/rules/test_rules.py -v
```

## IV. Verification Checklist

- [ ] All 5 layer files exist
- [ ] All files valid JSON
- [ ] All required fields present
- [ ] Rule engine loads successfully
- [ ] Validation tests pass

## V. Next Step

After completing this task, proceed to **Task 3.8: Rule Integration**

View document: `部署/任务跟踪-阶段3-规则架构部署-部署任务3.8-规则集成.md`
