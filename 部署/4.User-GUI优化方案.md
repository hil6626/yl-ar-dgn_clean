# 4. User GUI 优化方案

**版本:** 1.0.0  
**创建日期:** 2026-02-09  
**状态:** 待执行

## 一、目标

修复并优化 `/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/user` 目录中的 AR 合成软件 GUI，确保：
1. 所有调用逻辑正常
2. 与 AR-backend 的通信正常
3. 功能完整可用

## 二、现状分析

### 2.1 代码结构

```
user/
├── main.py              # 空文件或缺失
├── gui/
│   └── gui.py           # 完整的 AR Live Studio GUI (1400+ 行)
├── controllers/         # 空目录
├── assets/              # 资源目录
└── manuals/             # 手册目录
```

### 2.2 发现的问题

#### 问题1: main.py 为空
**影响:** 无法直接启动应用  
**位置:** `user/main.py`

#### 问题2: Backend 模块导入错误
**代码位置:** `user/gui/gui.py` 第 600-630 行

```python
def init_deep_live_cam(self):
    try:
        from backend.face_live_cam import FaceLiveCamProcessor  # 错误路径
        processor = FaceLiveCamProcessor()
        ...
```

**问题:** `backend` 模块不存在，实际应在 `AR-backend/core/` 或 `AR-backend/integrations/`

#### 问题3: Camera 和 Audio 模块路径
**代码位置:** `user/gui/gui.py` 第 30-35 行

```python
from camera import CameraModule
from audio_module import AudioModule
```

**问题:** 这两个模块实际位于 `AR-backend/core/`

#### 问题4: 无服务发现机制
**问题:** GUI 无法自动发现 AR-backend 服务地址

#### 问题5: 缺少配置管理
**问题:** 无配置文件管理连接参数

## 三、优化方案

### 3.1 架构设计

```
┌─────────────────────────────────────────┐
│           User GUI (PyQt5)              │
│  ┌─────────────┐    ┌─────────────┐    │
│  │  GUI Layer  │◄──►│  Controller │    │
│  └─────────────┘    └──────┬──────┘    │
└─────────────────────────────┼───────────┘
                              │
                              ▼
┌─────────────────────────────────────────┐
│         Service Client Layer            │
│  ┌─────────────┐    ┌─────────────┐    │
│  │ AR-backend  │    │ YL-monitor  │    │
│  │   Client    │    │   Client    │    │
│  └─────────────┘    └─────────────┘    │
└─────────────────────────────────────────┘
```

### 3.2 实施步骤

#### 步骤1: 创建 main.py 入口 (任务4.1)

**目标:** 创建可执行的启动入口

**文件:** `user/main.py`

**内容要求:**
- 导入并启动 GUI
- 初始化服务客户端
- 加载配置文件
- 异常处理

#### 步骤2: 创建路径修复模块 (任务4.2)

**目标:** 解决模块导入路径问题

**文件:** `user/core/path_manager.py`

**功能:**
- 动态添加 AR-backend 到 Python 路径
- 提供统一的模块导入接口
- 处理不同部署场景的路径

**实现思路:**
```python
import sys
from pathlib import Path

def setup_paths():
    """设置正确的模块导入路径"""
    project_root = Path(__file__).parent.parent.parent
    ar_backend = project_root / "AR-backend"
    
    # 添加核心模块路径
    sys.path.insert(0, str(ar_backend))
    sys.path.insert(0, str(ar_backend / "core"))
    sys.path.insert(0, str(ar_backend / "integrations"))
    
    return project_root
```

#### 步骤3: 修复 GUI 导入语句 (任务4.3)

**目标:** 修复 `user/gui/gui.py` 中的导入错误

**修改清单:**

| 行号 | 原代码 | 修改后 |
|------|--------|--------|
| 30 | `from camera import CameraModule` | `from user.core.path_manager import get_camera_module` |
| 31 | `from audio_module import AudioModule` | `from user.core.path_manager import get_audio_module` |
| 600 | `from backend.face_live_cam import FaceLiveCamProcessor` | `from user.core.module_loader import get_face_processor` |
| 612 | `from backend.deep_face_lab import DeepFaceLabModule` | `from user.core.module_loader import get_deepface_module` |
| 624 | `from backend.faceswap_module import FaceSwapModule` | `from user.core.module_loader import get_faceswap_module` |

#### 步骤4: 创建服务客户端 (任务4.4)

**目标:** 实现与 AR-backend 和 YL-monitor 的通信

**文件:** `user/services/ar_backend_client.py`

**功能:**
- 服务发现（自动查找 AR-backend）
- API 调用封装
- 健康检查
- 配置同步

**核心接口:**
```python
class ARBackendClient:
    def __init__(self, base_url=None):
        self.base_url = base_url or self._discover_service()
        
    def _discover_service(self):
        """自动发现服务地址"""
        # 尝试本地端口
        # 尝试配置文件
        # 尝试环境变量
        pass
        
    def get_status(self):
        """获取服务状态"""
        pass
        
    def process_frame(self, frame_data):
        """提交帧处理"""
        pass
```

**文件:** `user/services/monitor_client.py`

**功能:**
- 向 YL-monitor 上报状态
- 接收远程命令
- 获取监控配置

#### 步骤5: 创建配置管理 (任务4.5)

**目标:** 统一管理配置参数

**文件:** `user/config/settings.py`

**配置项:**
```python
@dataclass
class UserGUIConfig:
    # AR-backend 连接
    ar_backend_host: str = "0.0.0.0"
    ar_backend_port: int = 5501
    
    # YL-monitor 连接
    monitor_host: str = "0.0.0.0"
    monitor_port: int = 5500
    node_id: str = "user-gui"
    
    # 功能开关
    auto_connect: bool = True
    report_interval: int = 30
```

**文件:** `user/config/config.yaml` (默认配置)

#### 步骤6: 修复 GUI 功能 (任务4.6)

**目标:** 确保所有 GUI 功能正常

**修复清单:**

1. **视频启动功能**
   - 检查 CameraModule 初始化
   - 验证视频流捕获
   - 测试帧处理回调

2. **人脸合成功能**
   - 修复模块加载
   - 测试算法切换
   - 验证参数调节

3. **音频处理功能**
   - 修复 AudioModule 导入
   - 测试音效处理
   - 验证音量控制

4. **监控面板功能**
   - 实现 `open_monitor()` 方法
   - 集成 YL-monitor 链接
   - 显示实时状态

#### 步骤7: 添加启动脚本 (任务4.7)

**目标:** 提供便捷的启动方式

**文件:** `user/start.sh`

**功能:**
- 检查依赖
- 设置环境变量
- 启动 GUI
- 错误处理

**文件:** `user/start.py` (Windows 兼容)

## 四、技术实现

### 4.1 路径管理器实现

```python
# user/core/path_manager.py
import sys
import os
from pathlib import Path

class PathManager:
    _instance = None
    
    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
            cls._instance._initialized = False
        return cls._instance
    
    def __init__(self):
        if self._initialized:
            return
        self._initialized = True
        self.project_root = self._find_project_root()
        self._setup_paths()
    
    def _find_project_root(self):
        """查找项目根目录"""
        current = Path(__file__).resolve()
        for parent in current.parents:
            if (parent / "AR-backend").exists() and (parent / "YL-monitor").exists():
                return parent
        raise RuntimeError("无法找到项目根目录")
    
    def _setup_paths(self):
        """设置 Python 路径"""
        ar_backend = self.project_root / "AR-backend"
        
        paths_to_add = [
            str(ar_backend),
            str(ar_backend / "core"),
            str(ar_backend / "services"),
            str(ar_backend / "integrations"),
        ]
        
        for path in paths_to_add:
            if path not in sys.path:
                sys.path.insert(0, path)
    
    def get_camera_module(self):
        """获取 CameraModule"""
        from camera import CameraModule
        return CameraModule
    
    def get_audio_module(self):
        """获取 AudioModule"""
        from audio_module import AudioModule
        return AudioModule
```

### 4.2 模块加载器实现

```python
# user/core/module_loader.py
import importlib
import logging

logger = logging.getLogger(__name__)

class ModuleLoader:
    """动态加载 AR-backend 模块"""
    
    @staticmethod
    def get_face_processor(processor_type="deep_live_cam"):
        """获取人脸处理器"""
        loaders = {
            "deep_live_cam": "AR_backend.integrations.deep_live_cam.FaceLiveCamProcessor",
            "deepface_lab": "AR_backend.integrations.deep_face_lab.DeepFaceLabModule",
            "faceswap": "AR_backend.integrations.faceswap.FaceSwapModule",
        }
        
        module_path = loaders.get(processor_type)
        if not module_path:
            raise ValueError(f"未知的处理器类型: {processor_type}")
        
        try:
            module_name, class_name = module_path.rsplit(".", 1)
            module = importlib.import_module(module_name)
            return getattr(module, class_name)
        except Exception as e:
            logger.error(f"加载模块失败: {e}")
            return None
```

### 4.3 服务客户端实现

```python
# user/services/ar_backend_client.py
import requests
import socket
from typing import Optional

class ARBackendClient:
    DEFAULT_PORTS = [5501, 5000, 8080]
    
    def __init__(self, host: Optional[str] = None, port: Optional[int] = None):
        self.host = host or self._discover_host()
        self.port = port or self._discover_port()
        self.base_url = f"http://{self.host}:{self.port}"
        self._session = requests.Session()
        
    def _discover_host(self) -> str:
        """发现服务主机"""
        # 1. 检查环境变量
        host = os.getenv("AR_BACKEND_HOST")
        if host:
            return host
            
        # 2. 检查配置文件
        config = self._load_config()
        if config.get("ar_backend_host"):
            return config["ar_backend_host"]
            
        # 3. 默认本地
        return "0.0.0.0"
    
    def _discover_port(self) -> int:
        """发现服务端口"""
        # 检查环境变量
        port = os.getenv("AR_BACKEND_PORT")
        if port:
            return int(port)
        
        # 尝试默认端口
        for port in self.DEFAULT_PORTS:
            if self._check_port("0.0.0.0", port):
                return port
        
        return 5501  # 默认端口
    
    def _check_port(self, host: str, port: int) -> bool:
        """检查端口是否开放"""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(1)
            result = sock.connect_ex((host, port))
            sock.close()
            return result == 0
        except:
            return False
    
    def health_check(self) -> dict:
        """健康检查"""
        try:
            response = self._session.get(
                f"{self.base_url}/health",
                timeout=5
            )
            return response.json()
        except Exception as e:
            return {"status": "unhealthy", "error": str(e)}
```

## 五、验证方案

### 5.1 单元测试

| 测试项 | 测试方法 | 预期结果 |
|--------|----------|----------|
| 路径管理器 | `python -c "from user.core.path_manager import PathManager; pm = PathManager()"` | 无异常 |
| 模块加载 | `python -c "from user.core.module_loader import ModuleLoader; m = ModuleLoader.get_face_processor()"` | 返回类对象 |
| 服务发现 | `python -c "from user.services.ar_backend_client import ARBackendClient; c = ARBackendClient()"` | 找到服务 |
| 配置加载 | `python -c "from user.config.settings import UserGUIConfig; c = UserGUIConfig()"` | 配置对象创建 |

### 5.2 集成测试

| 测试项 | 操作 | 预期结果 |
|--------|------|----------|
| GUI 启动 | `python user/main.py` | 窗口正常显示 |
| 视频启动 | 点击"启动视频" | 视频流正常显示 |
| 人脸加载 | 选择图片 | 图片正常加载 |
| 音频启动 | 点击"启动音频" | 音频处理正常 |
| 监控链接 | 点击"监控面板" | 打开 YL-monitor 页面 |

### 5.3 端到端测试

1. 启动 AR-backend
2. 启动 YL-monitor
3. 启动 User GUI
4. 验证三者通信正常

## 六、风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| AR-backend 模块依赖复杂 | 导入失败 | 使用动态加载，失败时优雅降级 |
| PyQt5 版本兼容 | 界面异常 | 测试多版本，提供兼容性代码 |
| 服务发现失败 | 无法连接 | 提供手动配置选项 |
| 性能问题 | GUI 卡顿 | 使用多线程，异步操作 |

## 七、执行检查点

- [ ] 检查点1: main.py 可正常启动
- [ ] 检查点2: 所有导入错误已修复
- [ ] 检查点3: 视频功能正常
- [ ] 检查点4: 人脸合成功能正常
- [ ] 检查点5: 音频处理功能正常
- [ ] 检查点6: 监控链接功能正常
- [ ] 检查点7: 文档已更新

## 八、关联文档

- [3.监控整合方案.md](./3.监控整合方案.md)
- [5.规则架构部署.md](./5.规则架构部署.md)
- [7.联调测试方案.md](./7.联调测试方案.md)

---

**下一步:** 执行步骤1 - 创建 main.py 入口
