# YL-Monitor 统一监控面板架构方案

**版本:** 2.0.0  
**创建日期:** 2026-02-15  
**状态:** 设计方案

---

## 🎯 设计目标

将 YL-Monitor 打造为**统一监控中心**，清晰分类展示：

1. **🎨 用户界面层** - User GUI 部署状态
2. **🔧 后端API层** - AR-backend 服务状态  
3. **📊 DAG流水线** - 任务编排执行情况
4. **🔗 系统总览** - 整体健康状态

---

## 🏗️ 统一监控架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    YL-Monitor 统一监控中心                        │
│                     http://0.0.0.0:5500                        │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────┐ │
│  │   🎨 用户   │  │   🔧 后端   │  │   📊 DAG   │  │  🔗 总览 │ │
│  │   界面层    │  │   API层    │  │   流水线   │  │  仪表盘  │ │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └────┬────┘ │
│         │                │                │              │      │
│         ▼                ▼                ▼              ▼      │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    统一数据聚合层                             │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │ │
│  │  │ 进程监控 │  │ HTTP监控 │  │ DAG引擎  │  │ 系统指标 │   │ │
│  │  │ User GUI│  │AR-backend│  │  状态    │  │  采集    │   │ │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📑 监控面板分类设计

### 1. 🎨 用户界面监控面板 (`/monitor/ui`)

**功能定位:** 专门监控 User GUI 桌面应用

**展示内容:**
```yaml
面板标题: "用户界面监控 - User GUI"
URL: /monitor/ui

监控指标:
  进程状态:
    - 运行状态: running / stopped / error
    - PID: 进程ID
    - 启动时间: 运行时长
    - 内存占用: MB
    - CPU使用率: %
  
  功能状态:
    - 视频模块: 正常/异常
    - 音频模块: 正常/异常
    - 人脸合成: 正常/异常
    - 虚拟摄像头: 正常/异常
  
  连接状态:
    - 后端连接: connected / disconnected
    - 延迟: ms
    - 最后心跳: 时间戳

操作按钮:
  - [刷新状态]
  - [查看日志]
  - [重启GUI] (如实现远程控制)
```

**API端点:**
```python
GET /api/v1/monitor/ui/status      # 获取UI状态
GET /api/v1/monitor/ui/metrics     # 获取UI性能指标
GET /api/v1/monitor/ui/logs        # 获取UI日志
```

---

### 2. 🔧 后端API监控面板 (`/monitor/api`)

**功能定位:** 专门监控 AR-backend 服务及API健康

**展示内容:**
```yaml
面板标题: "后端API监控 - AR Backend"
URL: /monitor/api

服务状态:
  整体健康:
    - 状态: healthy / degraded / unhealthy
    - 运行时间: uptime
    - 版本: version
  
  模块状态:
    - 视频处理: 正常/异常
    - 音频处理: 正常/异常
    - 人脸合成: 正常/异常
    - 虚拟摄像头: 正常/异常
    - 系统监控: 正常/异常

API端点监控:
  - GET /health: 响应时间, 状态码
  - GET /status: 响应时间, 状态码
  - GET /metrics: 响应时间, 数据完整性
  
性能指标:
  - CPU使用率: %
  - 内存使用: MB
  - 请求QPS: 次/秒
  - 平均响应时间: ms
  - 错误率: %

告警记录:
  - 最近告警列表
  - 告警级别分布
```

**API端点:**
```python
GET /api/v1/monitor/api/status      # 获取API整体状态
GET /api/v1/monitor/api/endpoints   # 获取端点健康状态
GET /api/v1/monitor/api/performance # 获取性能指标
GET /api/v1/monitor/api/alerts     # 获取API相关告警
```

---

### 3. 📊 DAG流水线监控面板 (`/monitor/dag`)

**功能定位:** 专门监控 DAG 任务编排执行情况

**展示内容:**
```yaml
面板标题: "DAG流水线监控"
URL: /monitor/dag

流水线列表:
  - DAG名称: 描述
  - 状态: idle / running / completed / failed
  - 最后执行: 时间
  - 成功率: %
  - 执行次数: 次

当前执行:
  - 执行ID: uuid
  - DAG名称: name
  - 当前节点: node_id
  - 进度: %
  - 开始时间: timestamp
  - 预计完成: timestamp

节点状态:
  - 节点ID: id
  - 节点名称: name
  - 状态: pending / running / completed / failed
  - 执行时长: duration
  - 重试次数: retries

历史记录:
  - 最近执行列表
  - 执行结果统计
  - 失败原因分析
```

**API端点:**
```python
GET /api/v1/monitor/dag/list        # 获取DAG列表
GET /api/v1/monitor/dag/running     # 获取正在执行的DAG
GET /api/v1/monitor/dag/history     # 获取执行历史
GET /api/v1/monitor/dag/stats       # 获取统计信息
```

---

### 4. 🔗 系统总览仪表盘 (`/dashboard`)

**功能定位:** 整体系统健康状态一览

**展示内容:**
```yaml
面板标题: "系统总览仪表盘"
URL: /dashboard

健康评分:
  - 综合评分: 0-100
  - 状态: 优秀 / 良好 / 一般 / 差

组件状态卡片:
  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
  │  🎨 User GUI │  │  🔧 AR后端  │  │  📊 DAG引擎 │  │  🖥️ 系统   │
  │   [在线]     │  │   [健康]    │  │   [空闲]    │  │   [正常]   │
  │  内存: 45MB  │  │  CPU: 23%   │  │  队列: 0    │  │  磁盘: 67% │
  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘

实时指标:
  - 系统CPU: % (实时图表)
  - 系统内存: % (实时图表)
  - 网络IO: KB/s (实时图表)
  - 磁盘IO: MB/s (实时图表)

最近活动:
  - 最近告警 (3条)
  - 最近DAG执行 (3条)
  - 最近API调用 (3条)

快捷操作:
  - [查看用户界面详情] → /monitor/ui
  - [查看后端API详情] → /monitor/api
  - [查看DAG流水线] → /monitor/dag
  - [查看所有告警] → /alerts
```

---

## 🔌 统一导航菜单

```yaml
主导航:
  - 🏠 首页: /dashboard
  - 🎨 用户界面: /monitor/ui
  - 🔧 后端API: /monitor/api
  - 📊 DAG流水线: /monitor/dag
  - 🔔 告警中心: /alerts
  - 📈 系统指标: /metrics
  - 🔧 脚本管理: /scripts
  - 📚 API文档: /api-docs

监控子菜单 (在监控页面内):
  - 用户界面层
    - 进程状态
    - 功能状态
    - 连接状态
    - 性能指标
  
  - 后端API层
    - 服务健康
    - 模块状态
    - API端点
    - 性能指标
  
  - DAG流水线层
    - 流水线列表
    - 当前执行
    - 节点状态
    - 历史记录
```

---

## 🛠️ 技术实现方案

### 1. 路由结构

```
YL-monitor/app/routes/monitor/
├── __init__.py          # 路由聚合
├── ui.py                # 用户界面监控路由
├── api.py               # 后端API监控路由
└── dag.py               # DAG流水线监控路由
```

### 2. 前端页面结构

```
YL-monitor/templates/monitor/
├── ui.html              # 用户界面监控面板
├── api.html             # 后端API监控面板
├── dag.html             # DAG流水线监控面板
└── components/          # 共享组件
    ├── status_card.html
    ├── metric_chart.html
    └── alert_list.html
```

### 3. 数据流架构

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   数据源     │     │   聚合层    │     │   展示层    │
├─────────────┤     ├─────────────┤     ├─────────────┤
│ User GUI    │────▶│ UI Monitor  │────▶│ /monitor/ui │
│ (进程监控)   │     │  Service    │     │   页面      │
├─────────────┤     ├─────────────┤     ├─────────────┤
│ AR-backend  │────▶│ API Monitor │────▶│ /monitor/api│
│ (HTTP监控)   │     │  Service    │     │   页面      │
├─────────────┤     ├─────────────┤     ├─────────────┤
│ DAG Engine  │────▶│ DAG Monitor │────▶│ /monitor/dag│
│ (事件监听)   │     │  Service    │     │   页面      │
└─────────────┘     └─────────────┘     └─────────────┘
```

---

## 📋 实施步骤

### 阶段1: 创建监控路由 (1天)

1. **创建监控路由文件**
   - `app/routes/monitor/ui.py` - 用户界面监控API
   - `app/routes/monitor/api.py` - 后端API监控API
   - `app/routes/monitor/dag.py` - DAG流水线监控API

2. **注册路由**
   ```python
   # app/main.py
   from app.routes.monitor import ui, api, dag
   
   app.include_router(ui.router, prefix="/api/v1/monitor")
   app.include_router(api.router, prefix="/api/v1/monitor")
   app.include_router(dag.router, prefix="/api/v1/monitor")
   ```

### 阶段2: 创建监控页面 (2天)

1. **创建HTML模板**
   - `templates/monitor/ui.html`
   - `templates/monitor/api.html`
   - `templates/monitor/dag.html`

2. **添加前端路由**
   ```python
   # app/routes/pages.py
   @router.get("/monitor/ui", response_class=HTMLResponse)
   async def ui_monitor_page(request: Request):
       return templates.TemplateResponse("monitor/ui.html", {"request": request})
   ```

### 阶段3: 数据聚合服务 (2天)

1. **创建监控服务类**
   ```python
   # app/services/monitor/
   ├── ui_monitor_service.py    # UI监控数据聚合
   ├── api_monitor_service.py   # API监控数据聚合
   └── dag_monitor_service.py   # DAG监控数据聚合
   ```

2. **实现数据缓存**
   - 使用 Redis 或内存缓存
   - 设置合理的缓存时间（5-30秒）

### 阶段4: 前端组件开发 (2天)

1. **创建共享组件**
   - 状态卡片组件
   - 实时图表组件
   - 告警列表组件

2. **实现WebSocket实时更新**
   ```javascript
   // 建立WebSocket连接
   const ws = new WebSocket('ws://0.0.0.0:5500/ws/monitor');
   
   ws.onmessage = (event) => {
       const data = JSON.parse(event.data);
       updateDashboard(data);
   };
   ```

### 阶段5: 集成与测试 (1天)

1. **集成测试**
   - 验证各监控面板数据准确性
   - 测试WebSocket实时更新
   - 测试页面导航

2. **性能优化**
   - 优化API响应时间
   - 减少不必要的数据传输

---

## 🎨 页面设计草图

### 用户界面监控面板 (`/monitor/ui`)

```
┌─────────────────────────────────────────────────────────────┐
│  🎨 用户界面监控 - User GUI                    [刷新] [日志]  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   进程状态      │  │   功能状态      │  │   连接状态   │ │
│  │                 │  │                 │  │             │ │
│  │  🟢 运行中     │  │  视频: 🟢 正常  │  │  后端: 🟢   │ │
│  │  PID: 12345    │  │  音频: 🟢 正常  │  │  延迟: 23ms │ │
│  │  内存: 45MB    │  │  人脸: 🟢 正常  │  │  心跳: 5s前 │ │
│  │  CPU: 12%      │  │  虚拟: 🟢 正常  │  │             │ │
│  │  运行: 2h 15m  │  │                 │  │             │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              性能指标趋势图 (最近1小时)              │   │
│  │  内存使用 ████████████████████ 45MB                  │   │
│  │  CPU使用  ████████░░░░░░░░░░░░ 12%                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 后端API监控面板 (`/monitor/api`)

```
┌─────────────────────────────────────────────────────────────┐
│  🔧 后端API监控 - AR Backend                   [刷新] [告警]  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  整体健康: 🟢 Healthy    运行时间: 3d 12h    版本: 2.0.0   │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌────────┐│
│  │  视频处理   │ │  音频处理   │ │  人脸合成   │ │ 虚拟摄像││
│  │    🟢      │ │    🟢      │ │    🟢      │ │   🟢   ││
│  │   正常     │ │   正常     │ │   正常     │ │  正常  ││
│  └─────────────┘ └─────────────┘ └─────────────┘ └────────┘│
│                                                             │
│  API端点健康                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ GET /health    200 OK    12ms    99.9%  ✅          │   │
│  │ GET /status    200 OK    45ms    99.5%  ✅          │   │
│  │ GET /metrics   200 OK    23ms    99.8%  ✅          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  性能指标                                                   │
│  CPU: 23%    内存: 1.2GB    QPS: 45/s    平均延迟: 28ms    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### DAG流水线监控面板 (`/monitor/dag`)

```
┌─────────────────────────────────────────────────────────────┐
│  📊 DAG流水线监控                              [刷新] [执行] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  当前执行                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ DAG: 人脸合成流水线                                  │   │
│  │ 执行ID: dag-20240215-001                            │   │
│  │ 进度: [████████░░░░░░░░░░] 60%                      │   │
│  │ 当前节点: face_swap_node (运行中)                    │   │
│  │ 开始: 14:30:00    预计完成: 14:35:00                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  流水线列表                                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 名称              状态    成功率   最后执行          │   │
│  │ 人脸合成流水线    🟢     98%      2分钟前           │   │
│  │ 视频处理流水线    🟢     95%      1小时前           │   │
│  │ 音频处理流水线    🟡     87%      3小时前           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  节点状态图                                                 │
│  [视频输入] → [人脸检测] → [🟢 人脸合成] → [视频输出]      │
│                [音频输入] → [🟢 音频处理] → [音频输出]      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 📊 数据模型设计

### 统一监控响应格式

```python
# 统一监控响应基类
class MonitorResponse(BaseModel):
    status: str           # "ok" / "error"
    timestamp: datetime
    component: str        # "ui" / "api" / "dag"
    
class UIMonitorResponse(MonitorResponse):
    component: str = "ui"
    process_status: ProcessStatus
    function_status: FunctionStatus
    connection_status: ConnectionStatus
    metrics: UIMetrics

class APIMonitorResponse(MonitorResponse):
    component: str = "api"
    service_health: ServiceHealth
    module_status: List[ModuleStatus]
    endpoint_status: List[EndpointStatus]
    performance: APIPerformance

class DAGMonitorResponse(MonitorResponse):
    component: str = "dag"
    pipelines: List[PipelineStatus]
    running_executions: List[ExecutionStatus]
    recent_history: List[ExecutionHistory]
```

---

## 🚀 快速启动方案

### 方案A: 最小可行产品 (MVP)

**目标:** 1天内实现基础功能

**实施内容:**
1. 创建3个监控API端点
2. 创建3个基础HTML页面
3. 添加导航菜单

**文件清单:**
```
app/routes/monitor/
├── ui.py    (50行)
├── api.py   (50行)
└── dag.py   (50行)

templates/monitor/
├── ui.html   (基础表格)
├── api.html  (基础表格)
└── dag.html  (基础表格)
```

### 方案B: 完整功能实现

**目标:** 1周内实现完整功能

**实施内容:**
1. 完整的监控服务类
2. 实时WebSocket更新
3. 美观的前端界面
4. 历史数据存储

---

## ✅ 验收标准

- [ ] 访问 `/monitor/ui` 能看到 User GUI 状态
- [ ] 访问 `/monitor/api` 能看到 AR-backend 状态
- [ ] 访问 `/monitor/dag` 能看到 DAG 执行状态
- [ ] 导航菜单能正确切换各面板
- [ ] 数据每5秒自动刷新
- [ ] 各面板数据准确无误

---

**下一步:** 选择实施方案（MVP或完整版），开始编码实现
