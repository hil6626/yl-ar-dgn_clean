# 部署任务6.1: AR-backend实时视频处理验证

**任务ID:** 6.1  
**所属阶段:** 阶段6 - 核心业务功能验证  
**任务名称:** AR-backend实时视频处理验证  
**优先级:** P0（最高优先级）  
**关键性:** 阻塞性  
**预计工时:** 4小时  
**负责人:** 后端开发工程师  
**前置依赖:** 阶段1-5完成  
**状态:** 待开始

---

## 一、任务目标

验证AR-backend实时视频处理功能，确保摄像头捕获、视频流处理、编码/解码和虚拟摄像头输出功能正常。

---

## 二、工作内容

1. 摄像头捕获功能测试
2. 视频流处理功能测试
3. 视频编码/解码功能测试
4. 虚拟摄像头输出测试
5. 性能基准测试

---

## 三、实施步骤

### 步骤1: 启动AR-backend监控服务

```bash
# 1. 进入AR-backend目录
cd /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/AR-backend

# 2. 启动监控服务
./start_monitor.sh

# 3. 检查服务状态
curl http://localhost:5501/health
```

### 步骤2: 检查视频处理模块

```bash
# 测试视频处理器初始化
python3 -c "
from app.core.video_processor import VideoProcessor
vp = VideoProcessor()
print('✓ 视频处理器初始化成功')
print(f'✓ 支持的格式: {vp.supported_formats}')
print(f'✓ 默认分辨率: {vp.default_resolution}')
"
```

### 步骤3: 测试摄像头捕获

```bash
# 测试摄像头捕获功能
python3 -c "
import cv2
import sys

print('测试摄像头捕获...')

# 尝试打开默认摄像头
cap = cv2.VideoCapture(0)

if not cap.isOpened():
    print('✗ 摄像头打开失败')
    # 尝试其他摄像头索引
    for i in range(1, 5):
        cap = cv2.VideoCapture(i)
        if cap.isOpened():
            print(f'✓ 找到可用摄像头: 索引 {i}')
            break
    else:
        print('✗ 未找到可用摄像头')
        sys.exit(1)
else:
    print('✓ 默认摄像头打开成功')

# 读取测试帧
ret, frame = cap.read()
if ret:
    print(f'✓ 摄像头捕获成功: 分辨率 {frame.shape[1]}x{frame.shape[0]}')
    print(f'✓ 帧率: {cap.get(cv2.CAP_PROP_FPS)}')
else:
    print('✗ 帧读取失败')
    sys.exit(1)

cap.release()
print('✓ 摄像头测试完成')
"
```

### 步骤4: 测试视频流处理

```bash
# 创建视频处理测试脚本
cat > /tmp/test_video_processing.py << 'EOF'
#!/usr/bin/env python3
import cv2
import time
import sys
import numpy as np

sys.path.insert(0, '/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/AR-backend')

from app.core.video_processor import VideoProcessor

def test_video_processing():
    print("=" * 50)
    print("视频流处理测试")
    print("=" * 50)
    
    # 初始化视频处理器
    processor = VideoProcessor()
    print("✓ 视频处理器初始化成功")
    
    # 打开摄像头
    cap = cv2.VideoCapture(0)
    if not cap.isOpened():
        print("✗ 无法打开摄像头")
        return False
    
    print("✓ 摄像头已打开")
    
    # 测试参数
    test_duration = 10  # 测试10秒
    frame_count = 0
    processed_count = 0
    dropped_frames = 0
    start_time = time.time()
    
    print(f"\n开始 {test_duration} 秒视频处理测试...")
    
    while time.time() - start_time < test_duration:
        ret, frame = cap.read()
        if not ret:
            dropped_frames += 1
            continue
        
        frame_count += 1
        
        # 处理帧
        try:
            processed_frame = processor.process_frame(frame)
            processed_count += 1
            
            # 每30帧显示一次进度
            if frame_count % 30 == 0:
                elapsed = time.time() - start_time
                fps = frame_count / elapsed
                print(f"  已处理 {frame_count} 帧, 当前FPS: {fps:.2f}")
                
        except Exception as e:
            print(f"✗ 帧处理错误: {e}")
            dropped_frames += 1
    
    # 计算结果
    elapsed = time.time() - start_time
    actual_fps = frame_count / elapsed
    drop_rate = dropped_frames / frame_count if frame_count > 0 else 0
    
    print(f"\n" + "=" * 50)
    print("测试结果:")
    print(f"  总帧数: {frame_count}")
    print(f"  成功处理: {processed_count}")
    print(f"  丢帧数: {dropped_frames}")
    print(f"  实际FPS: {actual_fps:.2f}")
    print(f"  丢帧率: {drop_rate * 100:.2f}%")
    print("=" * 50)
    
    cap.release()
    
    # 验证结果
    success = actual_fps >= 25 and drop_rate < 0.05
    if success:
        print("✓ 视频处理测试通过")
    else:
        print("✗ 视频处理测试失败")
        if actual_fps < 25:
            print("  - FPS低于25fps")
        if drop_rate >= 0.05:
            print("  - 丢帧率过高")
    
    return success

if __name__ == "__main__":
    success = test_video_processing()
    sys.exit(0 if success else 1)
EOF

# 执行测试
python3 /tmp/test_video_processing.py
```

### 步骤5: 验证虚拟摄像头

```bash
# 检查虚拟摄像头设备
echo "检查虚拟摄像头设备..."
ls -l /dev/video* 2>/dev/null || echo "未找到视频设备"

# 检查v4l2loopback模块
lsmod | grep v4l2loopback || echo "v4l2loopback模块未加载"

# 加载v4l2loopback模块（如需要）
sudo modprobe v4l2loopback devices=1 video_nr=20 card_label="AR Virtual Cam" exclusive_caps=1 2>/dev/null || echo "无法加载v4l2loopback模块"

# 再次检查设备
ls -l /dev/video20 2>/dev/null && echo "✓ 虚拟摄像头设备创建成功" || echo "✗ 虚拟摄像头设备未创建"
```

### 步骤6: 性能基准测试

```bash
# 创建性能测试脚本
cat > /tmp/benchmark_video.py << 'EOF'
#!/usr/bin/env python3
import cv2
import time
import sys
import psutil
import os

sys.path.insert(0, '/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/AR-backend')

from app.core.video_processor import VideoProcessor

def benchmark_video_processing():
    print("=" * 50)
    print("视频处理性能基准测试")
    print("=" * 50)
    
    processor = VideoProcessor()
    cap = cv2.VideoCapture(0)
    
    if not cap.isOpened():
        print("✗ 无法打开摄像头")
        return False
    
    # 获取进程信息
    process = psutil.Process(os.getpid())
    
    # 测试参数
    test_duration = 60  # 测试60秒
    frame_count = 0
    processing_times = []
    memory_usage = []
    cpu_usage = []
    
    print(f"开始 {test_duration} 秒性能测试...")
    start_time = time.time()
    
    while time.time() - start_time < test_duration:
        ret, frame = cap.read()
        if not ret:
            continue
        
        # 记录处理时间
        process_start = time.time()
        processed = processor.process_frame(frame)
        process_end = time.time()
        
        processing_times.append((process_end - process_start) * 1000)  # 转换为ms
        frame_count += 1
        
        # 每5秒记录资源使用
        if frame_count % 150 == 0:  # 假设30fps
            memory_usage.append(process.memory_info().rss / 1024 / 1024)  # MB
            cpu_usage.append(process.cpu_percent())
    
    elapsed = time.time() - start_time
    
    # 计算统计信息
    import statistics
    avg_time = statistics.mean(processing_times)
    max_time = max(processing_times)
    min_time = min(processing_times)
    p95_time = statistics.quantiles(processing_times, n=20)[18] if len(processing_times) >= 20 else max_time
    
    avg_memory = statistics.mean(memory_usage) if memory_usage else 0
    max_memory = max(memory_usage) if memory_usage else 0
    avg_cpu = statistics.mean(cpu_usage) if cpu_usage else 0
    
    actual_fps = frame_count / elapsed
    
    print(f"\n" + "=" * 50)
    print("性能基准结果:")
    print(f"  测试时长: {elapsed:.2f}秒")
    print(f"  处理帧数: {frame_count}")
    print(f"  实际FPS: {actual_fps:.2f}")
    print(f"\n处理时间统计:")
    print(f"  平均: {avg_time:.2f}ms")
    print(f"  最小: {min_time:.2f}ms")
    print(f"  最大: {max_time:.2f}ms")
    print(f"  P95: {p95_time:.2f}ms")
    print(f"\n资源使用:")
    print(f"  平均内存: {avg_memory:.2f}MB")
    print(f"  峰值内存: {max_memory:.2f}MB")
    print(f"  平均CPU: {avg_cpu:.2f}%")
    print("=" * 50)
    
    cap.release()
    
    # 性能指标验证
    success = (
        actual_fps >= 30 and
        avg_time < 33 and  # 30fps = 33ms/帧
        max_memory < 500  # 内存占用<500MB
    )
    
    if success:
        print("✓ 性能基准测试通过")
    else:
        print("✗ 性能基准测试失败")
        if actual_fps < 30:
            print("  - FPS未达到30fps")
        if avg_time >= 33:
            print("  - 处理时间超过33ms")
        if max_memory >= 500:
            print("  - 内存占用超过500MB")
    
    return success

if __name__ == "__main__":
    success = benchmark_video_processing()
    sys.exit(0 if success else 1)
EOF

# 执行性能测试
python3 /tmp/benchmark_video.py
```

---

## 四、验证步骤

### 验证清单

- [ ] 监控服务启动成功 (curl http://localhost:5501/health 返回200)
- [ ] 视频处理器初始化成功
- [ ] 摄像头捕获成功，帧率≥30fps
- [ ] 视频流处理无丢帧 (丢帧率<5%)
- [ ] 虚拟摄像头设备创建成功 (/dev/video20存在)
- [ ] 内存占用<500MB
- [ ] 处理延迟<33ms (满足30fps要求)

### 验证命令

```bash
# 快速验证脚本
cat > /tmp/verify_task_6.1.sh << 'EOF'
#!/bin/bash
echo "========================================"
echo "任务6.1验证: AR-backend实时视频处理"
echo "========================================"

errors=0

# 1. 检查服务健康
echo -n "检查服务健康... "
if curl -sf http://localhost:5501/health > /dev/null 2>&1; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

# 2. 检查视频设备
echo -n "检查视频设备... "
if ls /dev/video* > /dev/null 2>&1; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

# 3. 检查虚拟摄像头
echo -n "检查虚拟摄像头... "
if ls /dev/video20 > /dev/null 2>&1; then
    echo "✓ 通过"
else
    echo "⚠ 警告 (非阻塞)"
fi

echo "========================================"
if [ $errors -eq 0 ]; then
    echo "✓ 任务6.1验证通过"
    exit 0
else
    echo "✗ 任务6.1验证失败 ($errors 个错误)"
    exit 1
fi
EOF

chmod +x /tmp/verify_task_6.1.sh
/tmp/verify_task_6.1.sh
```

---

## 五、预期结果

### 成功标准

| 指标 | 目标值 | 验证方法 |
|------|--------|----------|
| 服务启动 | 成功 | curl返回200 |
| 摄像头捕获 | 成功 | 能读取帧 |
| 视频处理FPS | ≥30fps | 基准测试 |
| 丢帧率 | <5% | 测试脚本统计 |
| 处理延迟 | <33ms | 性能测试 |
| 内存占用 | <500MB | psutil监控 |
| 虚拟摄像头 | 创建成功 | /dev/video20存在 |

### 交付物

- [ ] 视频处理测试报告
- [ ] 性能基准数据
- [ ] 验证通过标记

---

## 六、可能产生的问题及解决方案

| 问题 | 风险等级 | 产生原因 | 解决方式 | 预防方式 |
|------|----------|----------|----------|----------|
| 摄像头无法打开 | 高 | 权限不足或设备占用 | 1. 检查权限: `ls -l /dev/video*`<br>2. 关闭其他使用摄像头的程序<br>3. 使用备用摄像头 | 1. 添加udev规则<br>2. 文档说明权限配置 |
| 视频处理卡顿 | 高 | CPU性能不足或编码器问题 | 1. 降低分辨率<br>2. 更换编码器<br>3. 启用硬件加速 | 1. 性能基准测试<br>2. 自动降级机制 |
| 虚拟摄像头创建失败 | 中 | v4l2loopback模块未加载 | 1. `sudo modprobe v4l2loopback`<br>2. 检查内核模块 | 1. 安装脚本检查依赖 |
| 内存泄漏 | 中 | 视频帧未正确释放 | 1. 代码审查<br>2. 内存分析工具 | 1. 单元测试覆盖<br>2. 自动化内存检测 |

---

## 七、执行检查点

- [ ] 摄像头捕获测试通过
- [ ] 视频流处理测试通过
- [ ] 虚拟摄像头设备创建成功
- [ ] 性能基准达标
- [ ] 内存无泄漏

---

## 八、关联文档

- [任务跟踪-阶段6-核心业务功能验证.md](./任务跟踪-阶段6-核心业务功能验证.md)
- [任务跟踪-阶段6-核心业务功能验证-部署任务6.2-AR-backend人脸合成功能验证.md](./任务跟踪-阶段6-核心业务功能验证-部署任务6.2-AR-backend人脸合成功能验证.md)
- [AR-backend/README.md](../AR-backend/README.md)

---

**创建时间:** 2026-02-11  
**最后更新:** 2026-02-11
