# 部署任务6.6: User GUI视频合成功能验证

**任务ID:** 6.6  
**所属阶段:** 阶段6 - 核心业务功能验证  
**任务名称:** User GUI视频合成功能验证  
**优先级:** P0（最高优先级）  
**关键性:** 阻塞性  
**预计工时:** 6小时  
**负责人:** 前端开发工程师  
**前置依赖:** 任务6.5, 6.1完成  
**状态:** 待开始

---

## 一、任务目标

验证User GUI视频合成功能，确保视频源选择、合成参数设置、实时预览、合成效果调整和输出控制功能正常。

---

## 二、工作内容

1. 视频源选择功能测试
2. 合成参数设置测试
3. 实时预览功能测试
4. 合成效果调整测试
5. 输出控制测试

---

## 三、实施步骤

### 步骤1: 测试视频源选择

```bash
cat > /tmp/test_video_source.py << 'EOF'
#!/usr/bin/env python3
import sys
sys.path.insert(0, '/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/user')

def test_video_source_selection():
    print("=" * 50)
    print("视频源选择功能测试")
    print("=" * 50)
    
    try:
        from PyQt5.QtWidgets import QApplication
        from gui.gui import ARApp
        
        app = QApplication(sys.argv)
        window = ARApp()
        
        # 测试摄像头选择
        print("\n测试摄像头选择:")
        if hasattr(window, 'camera_combo'):
            combo = window.camera_combo
            count = combo.count()
            print(f"  可用摄像头数量: {count}")
            
            for i in range(count):
                combo.setCurrentIndex(i)
                print(f"  ✓ 选择摄像头 {i}: {combo.currentText()}")
        
        # 测试视频文件选择
        print("\n测试视频文件选择:")
        if hasattr(window, 'select_video_file'):
            print("  ✓ 视频文件选择功能存在")
        
        # 测试网络流输入
        print("\n测试网络流输入:")
        if hasattr(window, 'stream_input'):
            print("  ✓ 网络流输入功能存在")
        
        print("\n✓ 视频源选择测试完成")
        return True
        
    except Exception as e:
        print(f"✗ 测试错误: {e}")
        return False

if __name__ == "__main__":
    success = test_video_source_selection()
    sys.exit(0 if success else 1)
EOF

python3 /tmp/test_video_source.py
```

### 步骤2: 测试合成参数

```bash
cat > /tmp/test_video_params.py << 'EOF'
#!/usr/bin/env python3
import sys
sys.path.insert(0, '/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/user')

def test_video_parameters():
    print("=" * 50)
    print("合成参数设置测试")
    print("=" * 50)
    
    try:
        from PyQt5.QtWidgets import QApplication
        from gui.gui import ARApp
        
        app = QApplication(sys.argv)
        window = ARApp()
        
        # 测试参数滑块
        params = [
            ("亮度", "brightness_slider", 0.5, 2.0, 1.2),
            ("对比度", "contrast_slider", 0.5, 2.0, 1.1),
            ("饱和度", "saturation_slider", 0.0, 2.0, 1.0),
        ]
        
        print("\n测试参数调整:")
        for name, attr, min_val, max_val, test_val in params:
            if hasattr(window, attr):
                slider = getattr(window, attr)
                slider.setValue(int(test_val * 100))
                actual_val = slider.value() / 100
                
                print(f"  ✓ {name}: 设置 {test_val}, 实际 {actual_val}")
            else:
                print(f"  ✗ {name}: 控件不存在")
        
        # 测试参数应用
        print("\n测试参数应用:")
        if hasattr(window, 'apply_video_params'):
            print("  ✓ 参数应用功能存在")
        
        print("\n✓ 合成参数测试完成")
        return True
        
    except Exception as e:
        print(f"✗ 测试错误: {e}")
        return False

if __name__ == "__main__":
    success = test_video_parameters()
    sys.exit(0 if success else 1)
EOF

python3 /tmp/test_video_params.py
```

### 步骤3: 测试实时预览

```bash
cat > /tmp/test_preview.py << 'EOF'
#!/usr/bin/env python3
import sys
import time
sys.path.insert(0, '/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/user')

def test_realtime_preview():
    print("=" * 50)
    print("实时预览功能测试")
    print("=" * 50)
    
    try:
        from PyQt5.QtWidgets import QApplication
        from gui.gui import ARApp
        
        app = QApplication(sys.argv)
        window = ARApp()
        
        # 启用预览
        print("\n启用实时预览...")
        if hasattr(window, 'preview_checkbox'):
            window.preview_checkbox.setChecked(True)
            print("  ✓ 预览已启用")
        
        # 测试预览延迟
        print("\n测试预览延迟:")
        start = time.time()
        
        # 模拟预览更新
        if hasattr(window, 'update_preview'):
            window.update_preview()
            end = time.time()
            delay = (end - start) * 1000
            print(f"  预览更新延迟: {delay:.2f}ms")
            
            if delay < 200:
                print("  ✓ 延迟达标 (<200ms)")
            else:
                print("  ⚠ 延迟较高")
        
        # 测试预览帧率
        print("\n测试预览帧率:")
        frame_times = []
        for i in range(30):
            start = time.time()
            if hasattr(window, 'update_preview'):
                window.update_preview()
            end = time.time()
            frame_times.append(end - start)
            time.sleep(0.033)  # 30fps
        
        import statistics
        avg_time = statistics.mean(frame_times)
        fps = 1.0 / avg_time if avg_time > 0 else 0
        
        print(f"  平均帧率: {fps:.2f}fps")
        
        if fps >= 25:
            print("  ✓ 帧率达标 (≥25fps)")
        else:
            print("  ⚠ 帧率较低")
        
        print("\n✓ 实时预览测试完成")
        return True
        
    except Exception as e:
        print(f"✗ 测试错误: {e}")
        return False

if __name__ == "__main__":
    success = test_realtime_preview()
    sys.exit(0 if success else 1)
EOF

python3 /tmp/test_preview.py
```

### 步骤4: 测试输出控制

```bash
cat > /tmp/test_output_control.py << 'EOF'
#!/usr/bin/env python3
import sys
sys.path.insert(0, '/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/user')

def test_output_control():
    print("=" * 50)
    print("输出控制测试")
    print("=" * 50)
    
    try:
        from PyQt5.QtWidgets import QApplication
        from gui.gui import ARApp
        
        app = QApplication(sys.argv)
        window = ARApp()
        
        # 测试虚拟摄像头输出
        print("\n测试虚拟摄像头输出:")
        if hasattr(window, 'virtual_cam_checkbox'):
            window.virtual_cam_checkbox.setChecked(True)
            print("  ✓ 虚拟摄像头输出已启用")
        
        # 测试文件录制
        print("\n测试文件录制:")
        if hasattr(window, 'record_button'):
            print("  ✓ 录制功能存在")
        
        # 测试网络推流
        print("\n测试网络推流:")
        if hasattr(window, 'stream_button'):
            print("  ✓ 推流功能存在")
        
        print("\n✓ 输出控制测试完成")
        return True
        
    except Exception as e:
        print(f"✗ 测试错误: {e}")
        return False

if __name__ == "__main__":
    success = test_output_control()
    sys.exit(0 if success else 1)
EOF

python3 /tmp/test_output_control.py
```

---

## 四、验证步骤

### 验证清单

- [ ] 视频源切换流畅
- [ ] 合成参数实时生效
- [ ] 预览延迟<200ms
- [ ] 输出控制正常
- [ ] 完整流程无错误

### 验证命令

```bash
cat > /tmp/verify_task_6.6.sh << 'EOF'
#!/bin/bash
echo "========================================"
echo "任务6.6验证: User GUI视频合成"
echo "========================================"

errors=0

# 检查GUI模块
echo -n "检查GUI模块... "
if python3 -c "import sys; sys.path.insert(0, '/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/user'); from gui.gui import ARApp; print('OK')" 2>/dev/null; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

echo "========================================"
if [ $errors -eq 0 ]; then
    echo "✓ 任务6.6基础验证通过"
    exit 0
else
    echo "✗ 任务6.6验证失败 ($errors 个错误)"
    exit 1
fi
EOF

chmod +x /tmp/verify_task_6.6.sh
/tmp/verify_task_6.6.sh
```

---

## 五、预期结果

| 指标 | 目标值 | 验证方法 |
|------|--------|----------|
| 视频源切换 | 流畅 | 功能测试 |
| 参数生效 | 实时 | 响应测试 |
| 预览延迟 | <200ms | 性能测试 |
| 输出控制 | 正常 | 功能测试 |
| 完整流程 | 无错误 | 端到端测试 |

---

## 六、关联文档

- [任务跟踪-阶段6-核心业务功能验证.md](./任务跟踪-阶段6-核心业务功能验证.md)
- [任务跟踪-阶段6-核心业务功能验证-部署任务6.5-User GUI启动和初始化验证.md](./任务跟踪-阶段6-核心业务功能验证-部署任务6.5-User GUI启动和初始化验证.md)
- [任务跟踪-阶段6-核心业务功能验证-部署任务6.7-User GUI音频处理功能验证.md](./任务跟踪-阶段6-核心业务功能验证-部署任务6.7-User GUI音频处理功能验证.md)

---

**创建时间:** 2026-02-11
