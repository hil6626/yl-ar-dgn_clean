# Phase 3 - Task 3.8: Rule Integration - Detailed Deployment Document

**Task ID:** 3.8  
**Task Name:** Rule Integration  
**Priority:** P2 (Medium)  
**Estimated Hours:** 2 hours  
**Status:** Pending  
**Prerequisites:** Task 3.7 completed

---

## I. Task Objectives

Integrate rules with YL-monitor and scripts to enable rule-based operations.

## II. Deployment Content

### 2.1 Files to Create/Modify

| No. | File Path | Operation | Description |
|-----|-----------|-----------|-------------|
| 1 | `YL-monitor/app/rules_integration.py` | New | YL-monitor rule integration |
| 2 | `scripts/rules_hook.sh` | New | Script rule hooks |

### 2.2 Detailed Code Implementation

#### File 1: YL-monitor/app/rules_integration.py

```python
#!/usr/bin/env python3
"""
Rules Integration for YL-monitor
"""

import sys
import logging
from pathlib import Path
from typing import Dict, Optional

# Add rules to path
sys.path.insert(0, str(Path(__file__).parent.parent.parent / 'rules'))

from rules.engine import RuleEngine

logger = logging.getLogger('RulesIntegration')


class RulesIntegration:
    """
    Rules Integration
    """

    def __init__(self):
        self.engine = RuleEngine()
        self.initialized = False

    def initialize(self) -> bool:
        """
        Initialize rules integration
        """
        try:
            if self.engine.load_all_rules():
                self.initialized = True
                logger.info("Rules integration initialized")
                return True
            else:
                logger.error("Failed to load rules")
                return False
        except Exception as e:
            logger.error(f"Initialization error: {e}")
            return False

    def get_system_goals(self) -> list:
        """
        Get system goals from L1
        """
        if not self.initialized:
            return []
        return self.engine.get_goals()

    def get_context(self) -> dict:
        """
        Get system context from L2
        """
        if not self.initialized:
            return {}
        return self.engine.get_context()

    def check_constraints(self) -> dict:
        """
        Check constraints from L3
        """
        if not self.initialized:
            return {}
        return self.engine.check_constraints()

    def execute_decision(self, decision_id: str, context: dict) -> dict:
        """
        Execute a decision from L4
        """
        if not self.initialized:
            return {'success': False, 'error': 'Not initialized'}
        return self.engine.execute_decision(decision_id, context)

    def run_procedure(self, procedure_id: str) -> dict:
        """
        Run a procedure from L5
        """
        if not self.initialized:
            return {'success': False, 'error': 'Not initialized'}
        return self.engine.run_procedure(procedure_id)


# Global instance
_rules_integration: Optional[RulesIntegration] = None

def get_rules_integration() -> RulesIntegration:
    """
    Get rules integration instance
    """
    global _rules_integration
    if _rules_integration is None:
        _rules_integration = RulesIntegration()
    return _rules_integration


def initialize_rules():
    """
    Initialize rules (convenience function)
    """
    return get_rules_integration().initialize()
```

#### File 2: scripts/rules_hook.sh

```bash
#!/bin/bash
# Rules Hook for Scripts

RULES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../rules" && pwd)"

# Load rule function
load_rule() {
    local layer=$1
    local key=$2
    
    python3 -c "
import json
import sys
from pathlib import Path

rules_dir = Path('$RULES_DIR')
files = list(rules_dir.glob('${layer}-*.json'))
if files:
    with open(files[0]) as f:
        data = json.load(f)
        value = data
        for k in '$key'.split('.'):
            if isinstance(value, dict):
                value = value.get(k, {})
            else:
                value = None
                break
        print(value if value else '')
"
}

# Check constraint
check_constraint() {
    local constraint=$1
    local value=$2
    
    limit=$(load_rule "L3" "technical_constraints.$constraint")
    
    if [ -n "$limit" ]; then
        echo "Constraint $constraint: limit=$limit, actual=$value"
        # Comparison logic here
    fi
}

# Execute decision
execute_decision() {
    local decision_id=$1
    
    python3 -c "
import sys
sys.path.insert(0, '$RULES_DIR')
from rules.engine import RuleEngine

engine = RuleEngine()
if engine.load_all_rules():
    result = engine.execute_decision('$decision_id', {})
    print(result)
"
}

# Example usage
echo "Rules Hook Loaded"
echo "System Goals:"
load_rule "L1" "goals"
```

## III. Deployment Steps

```bash
# 1. Create YL-monitor integration
# Edit YL-monitor/app/rules_integration.py

# 2. Create script hooks
# Edit scripts/rules_hook.sh

# 3. Add execute permission
chmod +x scripts/rules_hook.sh

# 4. Test integration
cd YL-monitor
python3 -c "
from app.rules_integration import initialize_rules, get_rules_integration
if initialize_rules():
    integration = get_rules_integration()
    print('Goals:', len(integration.get_system_goals()))
    print('Context:', integration.get_context().get('project_overview', {}).get('name'))
"

# 5. Test script hooks
source scripts/rules_hook.sh
load_rule "L1" "name"
```

## IV. Verification Checklist

- [ ] YL-monitor integration created
- [ ] Script hooks created
- [ ] Rules loadable from YL-monitor
- [ ] Rules accessible from scripts
- [ ] Integration tests pass

## V. Phase 3 Completion Summary

After completing this task, Phase 3 (Rule Architecture Deployment) is fully complete!

### Phase 3 Deliverables

| Task | Deliverable | Status |
|------|-------------|--------|
| 3.1 | L1 Meta-Goal rules | ✓ |
| 3.2 | L2 Understanding rules | ✓ |
| 3.3 | L3 Constraint rules | ✓ |
| 3.4 | L4 Decision rules | ✓ |
| 3.5 | L5 Execution rules | ✓ |
| 3.6 | Rule engine | ✓ |
| 3.7 | Rule validation | ✓ |
| 3.8 | Rule integration | ✓ |

---

**Next Step:** Begin Phase 4 - Script Consolidation

View document: `部署/任务跟踪-阶段4-脚本整合-部署任务4.1-脚本审查分类.md`
