# Phase 4: Script Consolidation - Detailed Task Collection

**Phase:** 4  
**Name:** Script Consolidation  
**Estimated Duration:** 2-3 days  
**Priority:** P1 (High)  
**Status:** Pending  
**Prerequisites:** Phase 3 completed

---

This document contains detailed deployment guides for all 8 tasks of Phase 4 (Script Consolidation).

---

# Task 4.1: Script Review and Classification

**Task ID:** 4.1  
**Priority:** P0  
**Estimated Hours:** 3 hours

## Objectives

Review all scripts in the project and classify them by function.

## Current Script Inventory

| Directory | Count | Main Scripts |
|-----------|-------|--------------|
| YL-monitor/scripts/ | 15+ | deploy, monitor, tools |
| scripts/ | 39 | deploy, cleanup, docs, utilities, monitor, security, validation |

## Classification Results

### Category 1: Deployment Scripts
- `scripts/deploy/deploy.sh`
- `scripts/deploy/rollback.sh`
- `YL-monitor/scripts/deploy/`

### Category 2: Monitoring Scripts
- `scripts/monitor/monitor.py`
- `scripts/monitor/health_check.py`
- `YL-monitor/scripts/monitor/`

### Category 3: Cleanup Scripts
- `scripts/cleanup/cleanup_project.sh`
- `scripts/cleanup/final_cleanup.sh`

### Category 4: Validation Scripts
- `scripts/validation/validate_backend_services.py`
- `scripts/validation/validate_frontend_architecture.py`

### Category 5: Utility Scripts
- `scripts/utilities/check_dependencies.py`
- `scripts/utilities/env.sh`

## Deployment Steps

```bash
# 1. Create script inventory
find . -name "*.sh" -o -name "*.py" | grep -E "(scripts|deploy)" | sort > scripts_inventory.txt

# 2. Classify scripts
python3 -c "
import json
from pathlib import Path

categories = {
    'deploy': [],
    'monitor': [],
    'cleanup': [],
    'validation': [],
    'utility': [],
    'other': []
}

# Classification logic...
print(json.dumps(categories, indent=2))
"

# 3. Create classification report
cat > scripts_classification.md << 'EOF'
# Script Classification Report

## Summary
- Total scripts: 54
- Deployment: 8
- Monitoring: 12
- Cleanup: 5
- Validation: 6
- Utility: 15
- Other: 8
EOF
```

### Verification Checklist

- [ ] All scripts inventoried
- [ ] Scripts classified by function
- [ ] Duplicate functions identified
- [ ] Classification report generated

---

# Task 4.2: Migrate YL-monitor Common Scripts

**Task ID:** 4.2  
**Priority:** P0  
**Estimated Hours:** 4 hours

## Objectives

Migrate common scripts from YL-monitor to the unified scripts directory.

## Migration Plan

| Script | Source | Destination | Action |
|--------|--------|-------------|--------|
| deploy.sh | YL-monitor/scripts/deploy/ | scripts/deploy/ | Merge |
| monitor.py | YL-monitor/scripts/monitor/ | scripts/monitor/ | Merge |
| health_check.py | YL-monitor/scripts/ | scripts/monitor/ | Move |
| cleanup.sh | YL-monitor/scripts/ | scripts/cleanup/ | Move |

## Deployment Steps

```bash
# 1. Create migration list
cat > migration_plan.txt << 'EOF'
YL-monitor/scripts/deploy/deploy.sh -> scripts/deploy/yl-deploy.sh
YL-monitor/scripts/monitor/monitor.py -> scripts/monitor/yl_monitor.py
YL-monitor/scripts/health_check.py -> scripts/monitor/yl_health_check.py
EOF

# 2. Execute migration
while read line; do
    src=$(echo $line | cut -d'>' -f1 | tr -d ' ')
    dst=$(echo $line | cut -d'>' -f2 | tr -d ' ')
    
    if [ -f "$src" ]; then
        cp "$src" "$dst"
        echo "Migrated: $src -> $dst"
    fi
done < migration_plan.txt

# 3. Update imports
find scripts/ -name "*.py" -exec sed -i 's/from YL-monitor\./from /g' {} \;
```

### Verification Checklist

- [ ] All planned scripts migrated
- [ ] No broken imports
- [ ] Scripts work in new location

---

# Task 4.3: Merge Duplicate Functions

**Task ID:** 4.3  
**Priority:** P1  
**Estimated Hours:** 4 hours

## Objectives

Identify and merge scripts with duplicate functions.

## Duplicate Analysis

| Function | Scripts | Merge Strategy |
|----------|---------|----------------|
| Health check | health_check.py, check_health.sh, monitor_health.py | Merge into unified health_check.py |
| Deployment | deploy.sh, deploy.py, start.sh | Create unified deploy.sh |
| Cleanup | cleanup.sh, clean_cache.sh, cleanup_project.sh | Merge into cleanup.sh |
| Validation | validate_*.py | Create validation suite |

## Unified Script: scripts/health_check.py

```python
#!/usr/bin/env python3
"""
Unified Health Check Script
"""

import sys
import requests
import argparse
from typing import Dict, List

# Service configurations
SERVICES = {
    'yl-monitor': {'url': 'http://localhost:5500/health', 'type': 'http'},
    'ar-backend': {'url': 'http://localhost:5501/health', 'type': 'http'},
    'user-gui': {'url': 'http://localhost:5502/health', 'type': 'http'},
}

def check_service(name: str, config: Dict) -> bool:
    """Check single service health"""
    try:
        if config['type'] == 'http':
            response = requests.get(config['url'], timeout=5)
            return response.status_code == 200
        # Add other types...
        return False
    except Exception as e:
        print(f"Error checking {name}: {e}")
        return False

def main():
    """Main function"""
    parser = argparse.ArgumentParser(description='Health Check')
    parser.add_argument('--service', '-s', help='Check specific service')
    parser.add_argument('--all', '-a', action='store_true', help='Check all services')
    args = parser.parse_args()
    
    if args.service:
        if args.service in SERVICES:
            healthy = check_service(args.service, SERVICES[args.service])
            print(f"{args.service}: {'✓' if healthy else '✗'}")
            return 0 if healthy else 1
        else:
            print(f"Unknown service: {args.service}")
            return 1
    
    if args.all:
        results = {}
        for name, config in SERVICES.items():
            results[name] = check_service(name, config)
            print(f"{name}: {'✓' if results[name] else '✗'}")
        
        all_healthy = all(results.values())
        return 0 if all_healthy else 1
    
    parser.print_help()
    return 0

if __name__ == '__main__':
    sys.exit(main())
```

### Verification Checklist

- [ ] Duplicate functions identified
- [ ] Unified scripts created
- [ ] Old scripts deprecated
- [ ] No functionality lost

---

# Task 4.4: Create Unified Entry Point

**Task ID:** 4.4  
**Priority:** P1  
**Estimated Hours:** 3 hours

## Objectives

Create a unified script entry point for all operations.

## Deployment Content

### File: scripts/yl-manager.sh

```bash
#!/bin/bash
# YL-AR-DGN Unified Management Script

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Help message
show_help() {
    cat << EOF
YL-AR-DGN Project Manager

Usage: $0 <command> [options]

Commands:
    deploy          Deploy the system
    start           Start all services
    stop            Stop all services
    restart         Restart all services
    status          Check service status
    health          Health check
    logs            View logs
    backup          Create backup
    cleanup         Clean up temporary files
    validate        Run validation tests
    update          Update configuration

Options:
    -h, --help      Show this help message
    -v, --verbose   Verbose output
    -y, --yes       Auto-confirm

Examples:
    $0 deploy
    $0 start --verbose
    $0 status
    $0 health --service ar-backend
EOF
}

# Commands
cmd_deploy() {
    echo -e "${BLUE}Deploying system...${NC}"
    bash "$SCRIPT_DIR/deploy/deploy.sh" "$@"
}

cmd_start() {
    echo -e "${BLUE}Starting services...${NC}"
    # Start YL-monitor
    cd "$PROJECT_ROOT/YL-monitor" && ./start.sh &
    # Start AR-backend
    cd "$PROJECT_ROOT/AR-backend" && ./start.sh &
    # Start User GUI
    cd "$PROJECT_ROOT/user" && ./start.sh &
    
    echo -e "${GREEN}All services started${NC}"
}

cmd_stop() {
    echo -e "${BLUE}Stopping services...${NC}"
    pkill -f "YL-monitor" || true
    pkill -f "AR-backend" || true
    pkill -f "user/main.py" || true
    echo -e "${GREEN}All services stopped${NC}"
}

cmd_status() {
    echo -e "${BLUE}Service Status:${NC}"
    python3 "$SCRIPT_DIR/monitor/health_check.py" --all
}

cmd_health() {
    python3 "$SCRIPT_DIR/monitor/health_check.py" "$@"
}

cmd_logs() {
    service=${1:-all}
    log_dir="$PROJECT_ROOT/logs"
    
    if [ "$service" == "all" ]; then
        tail -f "$log_dir"/*.log
    else
        tail -f "$log_dir/$service.log"
    fi
}

cmd_backup() {
    echo -e "${BLUE}Creating backup...${NC}"
    backup_dir="$PROJECT_ROOT/backups/$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$backup_dir"
    
    cp -r "$PROJECT_ROOT/config" "$backup_dir/"
    cp -r "$PROJECT_ROOT/data" "$backup_dir/" 2>/dev/null || true
    
    echo -e "${GREEN}Backup created: $backup_dir${NC}"
}

cmd_cleanup() {
    echo -e "${BLUE}Cleaning up...${NC}"
    bash "$SCRIPT_DIR/cleanup/cleanup_project.sh" "$@"
}

cmd_validate() {
    echo -e "${BLUE}Running validation...${NC}"
    python3 "$SCRIPT_DIR/validation/validate_backend_services.py"
    python3 "$SCRIPT_DIR/validation/validate_frontend_architecture.py"
}

# Main
main() {
    command=$1
    shift || true
    
    case $command in
        deploy)     cmd_deploy "$@" ;;
        start)      cmd_start "$@" ;;
        stop)       cmd_stop "$@" ;;
        restart)    cmd_stop; sleep 2; cmd_start "$@" ;;
        status)     cmd_status "$@" ;;
        health)     cmd_health "$@" ;;
        logs)       cmd_logs "$@" ;;
        backup)     cmd_backup "$@" ;;
        cleanup)    cmd_cleanup "$@" ;;
        validate)   cmd_validate "$@" ;;
        -h|--help|help) show_help ;;
        *)          echo "Unknown command: $command"; show_help; exit 1 ;;
    esac
}

main "$@"
```

### Verification Checklist

- [ ] Entry script created
- [ ] All commands work
- [ ] Help message clear
- [ ] Error handling effective

---

# Task 4.5: Unified Configuration Management

**Task ID:** 4.5  
**Priority:** P1  
**Estimated Hours:** 2 hours

## Objectives

Create unified configuration management for all scripts.

## Deployment Content

### File: scripts/config/manager.sh

```bash
#!/bin/bash
# Configuration Manager

CONFIG_FILE="scripts/config/global.conf"

load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
    fi
}

save_config() {
    cat > "$CONFIG_FILE" << EOF
# YL-AR-DGN Global Configuration

# Service ports
YL_MONITOR_PORT=${YL_MONITOR_PORT:-5500}
AR_BACKEND_PORT=${AR_BACKEND_PORT:-5501}
USER_GUI_PORT=${USER_GUI_PORT:-5502}

# Paths
LOG_DIR=${LOG_DIR:-logs}
DATA_DIR=${DATA_DIR:-data}
BACKUP_DIR=${BACKUP_DIR:-backups}

# Options
AUTO_START=${AUTO_START:-false}
DEBUG_MODE=${DEBUG_MODE:-false}
EOF
}

get_config() {
    key=$1
    load_config
    eval "echo \$$key"
}

set_config() {
    key=$1
    value=$2
    load_config
    export $key="$value"
    save_config
}
```

---

# Task 4.6: Unified Log Format

**Task ID:** 4.6  
**Priority:** P2  
**Estimated Hours:** 2 hours

## Objectives

Standardize log format across all scripts.

## Log Format Standard

```
[TIMESTAMP] [LEVEL] [COMPONENT] [MESSAGE]
```

Example:
```
[2026-02-09 14:30:25] [INFO] [deploy] Starting deployment
[2026-02-09 14:30:26] [ERROR] [health] Service not responding
```

### Implementation

```bash
# In scripts/utils/logging.sh
log() {
    level=$1
    component=$2
    message=$3
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] [$level] [$component] $message"
}

log_info() { log "INFO" "$1" "$2"; }
log_error() { log "ERROR" "$1" "$2"; }
log_warn() { log "WARN" "$1" "$2"; }
```

---

# Task 4.7: Unified Error Handling

**Task ID:** 4.7  
**Priority:** P2  
**Estimated Hours:** 2 hours

## Objectives

Standardize error handling across all scripts.

### Error Handling Template

```bash
#!/bin/bash
set -e  # Exit on error

# Error handler
error_handler() {
    line=$1
    echo "Error at line $line"
    # Cleanup...
    exit 1
}

trap 'error_handler $LINENO' ERR

# Functions with error handling
safe_execute() {
    cmd=$1
    if ! eval "$cmd"; then
        echo "Command failed: $cmd"
        return 1
    fi
}
```

---

# Task 4.8: Script Validation Testing

**Task ID:** 4.8  
**Priority:** P0  
**Estimated Hours:** 3 hours

## Objectives

Validate all consolidated scripts work correctly.

## Test Suite

```bash
#!/bin/bash
# Script Validation Test

test_count=0
pass_count=0

run_test() {
    name=$1
    cmd=$2
    
    test_count=$((test_count + 1))
    echo "Testing: $name"
    
    if eval "$cmd"; then
        echo "  ✓ PASS"
        pass_count=$((pass_count + 1))
    else
        echo "  ✗ FAIL"
    fi
}

# Tests
run_test "Help command" "./scripts/yl-manager.sh --help"
run_test "Status command" "./scripts/yl-manager.sh status"
run_test "Health check" "./scripts/yl-manager.sh health --all"
run_test "Config load" "source scripts/config/manager.sh && load_config"

# Summary
echo ""
echo "Results: $pass_count/$test_count tests passed"
[ $pass_count -eq $test_count ] && exit 0 || exit 1
```

### Verification Checklist

- [ ] All scripts tested
- [ ] Unified entry works
- [ ] No broken functionality
- [ ] Test report generated

---

## Phase 4 Completion Summary

After completing all 8 tasks, Phase 4 (Script Consolidation) is fully complete!

### Phase 4 Deliverables

| Task | Deliverable | Status |
|------|-------------|--------|
| 4.1 | Script classification | ✓ |
| 4.2 | YL-monitor scripts migrated | ✓ |
| 4.3 | Duplicate functions merged | ✓ |
| 4.4 | Unified entry point | ✓ |
| 4.5 | Unified configuration | ✓ |
| 4.6 | Unified log format | ✓ |
| 4.7 | Unified error handling | ✓ |
| 4.8 | Script validation | ✓ |

---

**Next Step:** Begin Phase 5 - Integration Testing

View document: `部署/任务跟踪-阶段5-联调测试-详细部署任务合集.md`
