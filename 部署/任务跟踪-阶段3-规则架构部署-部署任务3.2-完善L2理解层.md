# Phase 3 - Task 3.2: Improve L2 Understanding Layer - Detailed Deployment Document

**Task ID:** 3.2  
**Task Name:** Improve L2 Understanding Layer  
**Priority:** P1 (High)  
**Estimated Hours:** 2 hours  
**Status:** Pending  
**Prerequisites:** Task 3.1 completed

---

## I. Task Objectives

Improve the L2 Understanding layer rules to ensure accurate understanding of project requirements, environment, and context.

## II. Deployment Content

### 2.1 Files to Create/Modify

| No. | File Path | Operation | Description |
|-----|-----------|-----------|-------------|
| 1 | `rules/L2-understanding.json` | Modify | Improve understanding rules |
| 2 | `rules/context_mapper.py` | New | Context mapping tool |

### 2.2 Detailed Code Implementation

#### File 1: rules/L2-understanding.json

```json
{
  "layer": "L2",
  "name": "understanding",
  "description": "Understanding layer - comprehends project context, requirements, and environment",
  "version": "1.0.0",
  "last_updated": "2026-02-09",
  "context": {
    "project_overview": {
      "name": "YL-AR-DGN",
      "description": "AR Live Studio with integrated monitoring system",
      "type": "multimedia-processing-platform",
      "scale": "small-to-medium",
      "users": ["content-creators", "live-streamers", "video-producers"]
    },
    "project_structure": {
      "root": "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean",
      "components": [
        {
          "name": "YL-monitor",
          "path": "YL-monitor",
          "type": "monitoring-platform",
          "port": 5500,
          "technology_stack": ["FastAPI", "WebSocket", "Jinja2", "SQLAlchemy"],
          "responsibilities": [
            "System health monitoring",
            "Real-time alerting",
            "Performance metrics collection",
            "Unified dashboard"
          ],
          "dependencies": ["AR-backend", "User GUI"],
          "interfaces": ["REST API", "WebSocket", "Web UI"]
        },
        {
          "name": "AR-backend",
          "path": "AR-backend",
          "type": "backend-service",
          "port": 5501,
          "technology_stack": ["Flask", "PyQt5", "OpenCV", "NumPy", "TensorFlow"],
          "responsibilities": [
            "Real-time video processing",
            "Face synthesis using AI models",
            "Audio processing and effects",
            "Virtual camera output"
          ],
          "dependencies": ["Deep-Live-Cam", "DeepFaceLab", "FaceSwap", "OBS Studio"],
          "interfaces": ["REST API", "Local GUI", "Virtual Camera"]
        },
        {
          "name": "User GUI",
          "path": "user",
          "type": "desktop-application",
          "port": 5502,
          "technology_stack": ["PyQt5", "OpenCV", "NumPy"],
          "responsibilities": [
            "User interface for AR operations",
            "Camera control",
            "Face synthesis configuration",
            "Audio effect adjustment"
          ],
          "dependencies": ["AR-backend"],
          "interfaces": ["Desktop GUI", "Local HTTP API"]
        }
      ]
    },
    "data_flow": {
      "description": "Data flows between components",
      "flows": [
        {
          "from": "AR-backend",
          "to": "YL-monitor",
          "data": ["health metrics", "status updates", "performance data"],
          "protocol": "HTTP REST API",
          "frequency": "every 30 seconds"
        },
        {
          "from": "User GUI",
          "to": "YL-monitor",
          "data": ["heartbeat", "status reports", "user actions"],
          "protocol": "HTTP REST API",
          "frequency": "every 30 seconds"
        },
        {
          "from": "YL-monitor",
          "to": "All components",
          "data": ["commands", "configuration updates"],
          "protocol": "HTTP REST API",
          "frequency": "on-demand"
        }
      ]
    },
    "technical_environment": {
      "operating_systems": ["Linux (Ubuntu 20.04+)", "Windows 10/11", "macOS 12+"],
      "python_version": ">=3.8",
      "hardware_requirements": {
        "cpu": "4+ cores recommended",
        "memory": "8GB+ recommended",
        "gpu": "NVIDIA GPU with CUDA support (optional but recommended)",
        "storage": "10GB+ free space"
      },
      "network": {
        "type": "local-network",
        "ports": [5500, 5501, 5502],
        "firewall": "ports must be accessible locally"
      }
    }
  },
  "requirements": {
    "functional": [
      {
        "id": "FR1",
        "description": "Real-time video capture and display",
        "priority": "P0",
        "source": "user-need"
      },
      {
        "id": "FR2",
        "description": "Face synthesis with multiple model support",
        "priority": "P0",
        "source": "user-need"
      },
      {
        "id": "FR3",
        "description": "Audio processing with real-time effects",
        "priority": "P0",
        "source": "user-need"
      },
      {
        "id": "FR4",
        "description": "System monitoring with unified dashboard",
        "priority": "P0",
        "source": "operational-need"
      },
      {
        "id": "FR5",
        "description": "Alert system for critical issues",
        "priority": "P1",
        "source": "operational-need"
      },
      {
        "id": "FR6",
        "description": "Configuration management",
        "priority": "P1",
        "source": "technical-need"
      }
    ],
    "non_functional": [
      {
        "id": "NFR1",
        "description": "Response time < 500ms for API calls",
        "priority": "P0",
        "category": "performance"
      },
      {
        "id": "NFR2",
        "description": "Video processing > 25 FPS",
        "priority": "P0",
        "category": "performance"
      },
      {
        "id": "NFR3",
        "description": "System availability > 99%",
        "priority": "P1",
        "category": "reliability"
      },
      {
        "id": "NFR4",
        "description": "Concurrent users > 10",
        "priority": "P2",
        "category": "scalability"
      },
      {
        "id": "NFR5",
        "description": "Data persistence for configuration",
        "priority": "P1",
        "category": "reliability"
      }
    ]
  },
  "assumptions": [
    "Users have basic technical knowledge",
    "System runs in controlled environment",
    "Network is stable and low-latency",
    "Hardware meets minimum requirements"
  ],
  "risks": [
    {
      "id": "R1",
      "description": "AI model compatibility issues",
      "impact": "high",
      "mitigation": "Test with multiple model versions"
    },
    {
      "id": "R2",
      "description": "Performance degradation under load",
      "impact": "medium",
      "mitigation": "Implement resource monitoring and limits"
    }
  ]
}
```

#### File 2: rules/context_mapper.py

```python
#!/usr/bin/env python3
"""
Context Mapper
Maps project context to operational parameters
"""

import json
import logging
from pathlib import Path
from typing import Dict, List, Optional

logger = logging.getLogger('ContextMapper')


class ContextMapper:
    """
    Context Mapper
    """

    def __init__(self, rules_dir: Optional[Path] = None):
        self.rules_dir = rules_dir or Path(__file__).parent
        self.context = {}
        self.load_context()

    def load_context(self):
        """Load L2 context"""
        l2_file = self.rules_dir / 'L2-understanding.json'
        if l2_file.exists():
            with open(l2_file) as f:
                data = json.load(f)
                self.context = data.get('context', {})

    def get_component(self, name: str) -> Optional[Dict]:
        """Get component by name"""
        components = self.context.get('project_structure', {}).get('components', [])
        for comp in components:
            if comp['name'] == name:
                return comp
        return None

    def get_dependencies(self, component_name: str) -> List[str]:
        """Get dependencies for component"""
        comp = self.get_component(component_name)
        return comp.get('dependencies', []) if comp else []

    def get_data_flows(self, from_component: Optional[str] = None) -> List[Dict]:
        """Get data flows"""
        flows = self.context.get('data_flow', {}).get('flows', [])
        if from_component:
            flows = [f for f in flows if f['from'] == from_component]
        return flows

    def check_compatibility(self, component1: str, component2: str) -> bool:
        """Check if two components are compatible"""
        # Get interfaces
        comp1 = self.get_component(component1)
        comp2 = self.get_component(component2)

        if not comp1 or not comp2:
            return False

        # Check if they can communicate
        interfaces1 = set(comp1.get('interfaces', []))
        interfaces2 = set(comp2.get('interfaces', []))

        # Check data flows
        flows = self.get_data_flows()
        for flow in flows:
            if (flow['from'] == component1 and flow['to'] == component2) or \
               (flow['from'] == component2 and flow['to'] == component1):
                return True

        return False


def main():
    """Main function"""
    mapper = ContextMapper()

    # Test
    print("Components:")
    for comp in ['YL-monitor', 'AR-backend', 'User GUI']:
        info = mapper.get_component(comp)
        if info:
            print(f"  {comp}: {info['type']} on port {info['port']}")

    print("\nDependencies:")
    for comp in ['YL-monitor', 'AR-backend', 'User GUI']:
        deps = mapper.get_dependencies(comp)
        print(f"  {comp}: {deps}")


if __name__ == '__main__':
    main()
```

## III. Deployment Steps

```bash
# 1. Create L2 rules file
# Edit rules/L2-understanding.json

# 2. Create context mapper
# Edit rules/context_mapper.py

# 3. Validate JSON
python3 -c "import json; json.load(open('rules/L2-understanding.json'))"

# 4. Test context mapper
python3 rules/context_mapper.py

# 5. Verify context loading
python3 -c "
from rules.context_mapper import ContextMapper
mapper = ContextMapper()
print('YL-monitor:', mapper.get_component('YL-monitor'))
print('Dependencies:', mapper.get_dependencies('YL-monitor'))
"
```

## IV. Verification Checklist

- [ ] L2 rules file created
- [ ] Project structure defined
- [ ] Components described
- [ ] Data flows mapped
- [ ] Requirements listed
- [ ] Context mapper works

## V. Next Step

After completing this task, proceed to **Task 3.3: Improve L3 Constraint Layer**

View document: `部署/任务跟踪-阶段3-规则架构部署-部署任务3.3-完善L3约束层.md`
