# 部署任务8.8: 生产环境验证

**任务ID:** 8.8  
**所属阶段:** 阶段8 - 生产环境准备  
**任务名称:** 生产环境验证  
**优先级:** P0（最高优先级）  
**关键性:** 阻塞性  
**预计工时:** 4小时  
**负责人:** 测试工程师  
**前置依赖:** 任务8.1-8.7完成  
**状态:** 待开始

---

## 一、任务目标

完成生产环境部署验证，包括部署测试、功能验证、性能测试和安全扫描。

---

## 二、工作内容

1. 生产环境部署测试
2. 端到端功能验证
3. 性能基准测试
4. 安全扫描验证
5. 灾难恢复演练

---

## 三、实施步骤

### 步骤1: 创建生产环境验证脚本

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/verify_production.sh << 'EOF'
#!/bin/bash
set -e

echo "========================================"
echo "生产环境验证"
echo "时间: $(date)"
echo "========================================"

errors=0

# 1. 服务状态检查
echo "1. 检查服务状态..."
services=("ar-backend" "yl-monitor")
for service in "${services[@]}"; do
    if docker ps | grep -q "$service"; then
        echo "  ✓ $service 运行中"
    else
        echo "  ✗ $service 未运行"
        errors=$((errors + 1))
    fi
done

# 2. 健康检查
echo "2. 执行健康检查..."
if curl -sf http://localhost:5501/health > /dev/null 2>&1; then
    echo "  ✓ AR-backend健康"
else
    echo "  ✗ AR-backend健康检查失败"
    errors=$((errors + 1))
fi

if curl -sf http://localhost:5000/api/health > /dev/null 2>&1; then
    echo "  ✓ YL-monitor健康"
else
    echo "  ✗ YL-monitor健康检查失败"
    errors=$((errors + 1))
fi

# 3. 端口检查
echo "3. 检查端口..."
ports=(5501 5000)
for port in "${ports[@]}"; do
    if netstat -tuln | grep -q ":$port "; then
        echo "  ✓ 端口 $port 开放"
    else
        echo "  ✗ 端口 $port 未开放"
        errors=$((errors + 1))
    fi
done

# 4. 日志检查
echo "4. 检查日志..."
if [ -f "AR-backend/logs/app.log" ]; then
    echo "  ✓ AR-backend日志存在"
else
    echo "  ⚠ AR-backend日志不存在"
fi

# 5. 配置检查
echo "5. 检查配置..."
if [ -f "config/production.env" ]; then
    echo "  ✓ 生产环境配置存在"
else
    echo "  ✗ 生产环境配置不存在"
    errors=$((errors + 1))
fi

echo "========================================"
if [ $errors -eq 0 ]; then
    echo "✓ 生产环境验证通过"
    exit 0
else
    echo "✗ 生产环境验证失败 ($errors 个错误)"
    exit 1
fi
EOF

chmod +x /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/verify_production.sh
echo "✓ 生产环境验证脚本已创建"
```

### 步骤2: 创建端到端测试

```bash
cat > /tmp/test_production_e2e.py << 'EOF'
#!/usr/bin/env python3
import sys
import requests
import time

BASE_URL = "http://localhost:5501"

def test_production():
    print("=" * 50)
    print("生产环境端到端测试")
    print("=" * 50)
    
    # 1. 测试服务启动
    print("\n1. 测试服务启动...")
    max_retries = 30
    for i in range(max_retries):
        try:
            response = requests.get(f"{BASE_URL}/health", timeout=5)
            if response.status_code == 200:
                print("  ✓ 服务已启动")
                break
        except:
            pass
        
        if i == max_retries - 1:
            print("  ✗ 服务启动超时")
            return False
        
        time.sleep(1)
    
    # 2. 测试核心功能
    print("\n2. 测试核心功能...")
    try:
        response = requests.get(f"{BASE_URL}/status", timeout=5)
        if response.status_code == 200:
            data = response.json()
            print(f"  ✓ 状态查询成功: {data.get('status', 'unknown')}")
        else:
            print(f"  ✗ 状态查询失败: HTTP {response.status_code}")
    except Exception as e:
        print(f"  ✗ 状态查询错误: {e}")
    
    # 3. 测试性能
    print("\n3. 测试性能...")
    start_time = time.time()
    try:
        response = requests.get(f"{BASE_URL}/health", timeout=5)
        elapsed = time.time() - start_time
        if elapsed < 1.0:
            print(f"  ✓ 响应时间达标: {elapsed:.3f}s")
        else:
            print(f"  ⚠ 响应时间较慢: {elapsed:.3f}s")
    except Exception as e:
        print(f"  ✗ 性能测试错误: {e}")
    
    print("\n✓ 端到端测试完成")
    return True

if __name__ == "__main__":
    success = test_production()
    sys.exit(0 if success else 1)
EOF

python3 /tmp/test_production_e2e.py
```

### 步骤3: 验证生产环境

```bash
cat > /tmp/verify_production_env.sh << 'EOF'
#!/bin/bash
echo "========================================"
echo "生产环境验证"
echo "========================================"

errors=0

# 检查验证脚本
echo -n "检查验证脚本... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/verify_production.sh" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

echo "========================================"
if [ $errors -eq 0 ]; then
    echo "✓ 生产环境验证通过"
    exit 0
else
    echo "✗ 生产环境验证失败 ($errors 个错误)"
    exit 1
fi
EOF

chmod +x /tmp/verify_production_env.sh
/tmp/verify_production_env.sh
```

---

## 四、验证步骤

### 验证清单

- [ ] 部署测试通过
- [ ] 功能验证通过
- [ ] 性能测试达标
- [ ] 安全扫描通过
- [ ] 灾难恢复演练通过

---

## 五、预期结果

| 指标 | 目标值 | 验证方法 |
|------|--------|----------|
| 部署测试 | 通过 | 部署验证 |
| 功能验证 | 通过 | 功能测试 |
| 性能测试 | 达标 | 性能基准 |
| 安全扫描 | 通过 | 扫描工具 |
| 灾难恢复 | 通过 | 演练测试 |

---

## 六、关联文档

- [任务跟踪-阶段8-生产环境准备.md](./任务跟踪-阶段8-生产环境准备.md)
- [任务跟踪-阶段8-生产环境准备-部署任务8.7-性能优化.md](./任务跟踪-阶段8-生产环境准备-部署任务8.7-性能优化.md)
- [任务跟踪-阶段9-测试和文档完善.md](./任务跟踪-阶段9-测试和文档完善.md)

---

**创建时间:** 2026-02-11
