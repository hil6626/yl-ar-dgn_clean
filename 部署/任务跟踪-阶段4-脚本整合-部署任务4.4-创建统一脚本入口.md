# Phase 4 - Task 4.4: Create Unified Script Entry Point - Detailed Deployment Document

**Task ID:** 4.4  
**Task Name:** Create Unified Script Entry Point  
**Priority:** P1 (High)  
**Estimated Hours:** 2 hours  
**Status:** Pending  
**Prerequisites:** Task 4.3 completed

---

## I. Task Objectives

Create a unified entry point for all scripts to simplify usage and provide consistent interface.

## II. Deployment Content

### 2.1 Unified Entry Point Script

#### File: scripts/yl-ar-dgn.sh (Main Entry Point)

```bash
#!/bin/bash
# YL-AR-DGN Unified Script Entry Point
# Usage: ./yl-ar-dgn.sh <command> [options]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
COMMAND="${1:-help}"
shift || true

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[OK]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Show help
show_help() {
    cat << 'EOF'
YL-AR-DGN Script Manager
========================

Usage: ./yl-ar-dgn.sh <command> [options]

Commands:
  deploy      Deploy components (yl-monitor|ar-backend|user-gui|all)
  monitor     Start monitoring services
  health      Check system health
  cleanup     Clean up resources (cache|logs|temp|all)
  validate    Validate configuration and services
  backup      Create system backup
  restore     Restore from backup
  logs        View component logs
  restart     Restart services
  stop        Stop all services
  status      Show system status
  test        Run tests
  rules       Execute rule-based operations

Options:
  -h, --help     Show this help message
  -v, --verbose  Enable verbose output
  -y, --yes      Auto-confirm prompts
  --dry-run      Show what would be done without executing

Examples:
  ./yl-ar-dgn.sh deploy all
  ./yl-ar-dgn.sh health --json
  ./yl-ar-dgn.sh cleanup cache --dry-run
  ./yl-ar-dgn.sh monitor --verbose

EOF
}

# Deploy command
cmd_deploy() {
    local component="${1:-all}"
    log_info "Deploying: $component"

    case "$component" in
        yl-monitor|monitor)
            "$SCRIPT_DIR/deploy/yl-monitor-deploy.sh" "${@:2}"
            ;;
        ar-backend|backend)
            "$SCRIPT_DIR/deploy/ar-backend-deploy.sh" "${@:2}"
            ;;
        user-gui|gui)
            "$SCRIPT_DIR/deploy/user-gui-deploy.sh" "${@:2}"
            ;;
        all)
            cmd_deploy yl-monitor
            cmd_deploy ar-backend
            cmd_deploy user-gui
            ;;
        *)
            log_error "Unknown component: $component"
            log_info "Available: yl-monitor, ar-backend, user-gui, all"
            return 1
            ;;
    esac
}

# Monitor command
cmd_monitor() {
    log_info "Starting monitoring..."
    python3 "$SCRIPT_DIR/monitor/monitor.py" "$@"
}

# Health check command
cmd_health() {
    log_info "Checking system health..."
    python3 "$SCRIPT_DIR/monitor/health_check.py" "$@"
}

# Cleanup command
cmd_cleanup() {
    local target="${1:-all}"
    log_info "Cleaning up: $target"

    case "$target" in
        cache)
            find "$PROJECT_ROOT" -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
            find "$PROJECT_ROOT" -name "*.pyc" -delete 2>/dev/null || true
            log_success "Cache cleaned"
            ;;
        logs)
            find "$PROJECT_ROOT" -name "*.log" -mtime +7 -delete 2>/dev/null || true
            log_success "Old logs cleaned"
            ;;
        temp)
            rm -rf /tmp/yl-ar-dgn-* 2>/dev/null || true
            log_success "Temp files cleaned"
            ;;
        all)
            cmd_cleanup cache
            cmd_cleanup logs
            cmd_cleanup temp
            ;;
        *)
            log_error "Unknown cleanup target: $target"
            return 1
            ;;
    esac
}

# Validate command
cmd_validate() {
    log_info "Validating system..."
    python3 "$SCRIPT_DIR/validation/validate_all.py" "$@"
}

# Backup command
cmd_backup() {
    log_info "Creating backup..."
    "$SCRIPT_DIR/utilities/backup.sh" "$@"
}

# Restore command
cmd_restore() {
    log_info "Restoring from backup..."
    "$SCRIPT_DIR/utilities/restore.sh" "$@"
}

# Logs command
cmd_logs() {
    local component="${1:-all}"
    log_info "Showing logs for: $component"

    case "$component" in
        yl-monitor)
            tail -f "$PROJECT_ROOT/YL-monitor/logs/app.log" 2>/dev/null || \
                log_warn "YL-monitor logs not found"
            ;;
        ar-backend)
            tail -f "$PROJECT_ROOT/AR-backend/logs/app.log" 2>/dev/null || \
                log_warn "AR-backend logs not found"
            ;;
        user-gui)
            tail -f "$PROJECT_ROOT/user/logs/app.log" 2>/dev/null || \
                log_warn "User GUI logs not found"
            ;;
        all)
            # Show last 50 lines from each
            for comp in yl-monitor ar-backend user-gui; do
                echo "=== $comp ==="
                cmd_logs "$comp" 2>/dev/null | tail -n 50
                echo ""
            done
            ;;
    esac
}

# Restart command
cmd_restart() {
    log_info "Restarting services..."
    cmd_stop
    sleep 2
    cmd_deploy all
}

# Stop command
cmd_stop() {
    log_info "Stopping all services..."
    pkill -f "YL-monitor" 2>/dev/null || true
    pkill -f "AR-backend" 2>/dev/null || true
    pkill -f "user/main.py" 2>/dev/null || true
    log_success "Services stopped"
}

# Status command
cmd_status() {
    log_info "System Status"
    echo "==============="

    # Check each component
    for port in 5500 5501 5502; do
        if nc -z localhost $port 2>/dev/null; then
            log_success "Port $port: ACTIVE"
        else
            log_warn "Port $port: INACTIVE"
        fi
    done

    # Show resource usage
    echo ""
    echo "Resource Usage:"
    ps aux | grep -E "(YL-monitor|AR-backend|user/main)" | grep -v grep || \
        echo "No processes found"
}

# Test command
cmd_test() {
    log_info "Running tests..."
    python3 -m pytest "$PROJECT_ROOT/test/" -v "$@"
}

# Rules command
cmd_rules() {
    local action="${1:-list}"
    log_info "Rules: $action"

    case "$action" in
        list)
            python3 -c "
from rules.engine import RuleEngine
engine = RuleEngine()
engine.load_all_rules()
for layer in ['L1', 'L2', 'L3', 'L4', 'L5']:
    rules = engine.get_rule(layer)
    if rules:
        print(f'{layer}: {rules.get(\"name\", \"Unknown\")}')
"
            ;;
        validate)
            python3 "$PROJECT_ROOT/test/rules/validate_all.py"
            ;;
        execute)
            shift
            python3 -c "
from rules.engine import RuleEngine
engine = RuleEngine()
engine.load_all_rules()
result = engine.execute_decision('$1', {})
print(result)
"
            ;;
        *)
            log_error "Unknown rules action: $action"
            return 1
            ;;
    esac
}

# Main command dispatcher
main() {
    case "$COMMAND" in
        help|-h|--help)
            show_help
            ;;
        deploy)
            cmd_deploy "$@"
            ;;
        monitor)
            cmd_monitor "$@"
            ;;
        health)
            cmd_health "$@"
            ;;
        cleanup)
            cmd_cleanup "$@"
            ;;
        validate)
            cmd_validate "$@"
            ;;
        backup)
            cmd_backup "$@"
            ;;
        restore)
            cmd_restore "$@"
            ;;
        logs)
            cmd_logs "$@"
            ;;
        restart)
            cmd_restart "$@"
            ;;
        stop)
            cmd_stop "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        test)
            cmd_test "$@"
            ;;
        rules)
            cmd_rules "$@"
            ;;
        *)
            log_error "Unknown command: $COMMAND"
            show_help
            return 1
            ;;
    esac
}

# Run main
main "$@"
```

### 2.2 Command Completion Script

#### File: scripts/yl-ar-dgn-completion.bash

```bash
#!/bin/bash
# Bash completion for yl-ar-dgn.sh

_yl_ar_dgn_completions() {
    local cur prev opts
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"

    # Main commands
    local commands="deploy monitor health cleanup validate backup restore logs restart stop status test rules help"

    # Options
    local options="-h --help -v --verbose -y --yes --dry-run"

    case "${prev}" in
        deploy)
            COMPREPLY=( $(compgen -W "yl-monitor ar-backend user-gui all" -- ${cur}) )
            return 0
            ;;
        cleanup)
            COMPREPLY=( $(compgen -W "cache logs temp all" -- ${cur}) )
            return 0
            ;;
        logs)
            COMPREPLY=( $(compgen -W "yl-monitor ar-backend user-gui all" -- ${cur}) )
            return 0
            ;;
        rules)
            COMPREPLY=( $(compgen -W "list validate execute" -- ${cur}) )
            return 0
            ;;
        *)
            ;;
    esac

    if [[ ${cur} == -* ]]; then
        COMPREPLY=( $(compgen -W "${options}" -- ${cur}) )
    else
        COMPREPLY=( $(compgen -W "${commands}" -- ${cur}) )
    fi
}

complete -F _yl_ar_dgn_completions ./yl-ar-dgn.sh
complete -F _yl_ar_dgn_completions yl-ar-dgn
```

## III. Deployment Steps

```bash
# 1. Create main entry point
# Edit scripts/yl-ar-dgn.sh

# 2. Make executable
chmod +x scripts/yl-ar-dgn.sh

# 3. Create completion script
# Edit scripts/yl-ar-dgn-completion.bash

# 4. Test help
./scripts/yl-ar-dgn.sh help

# 5. Test status
./scripts/yl-ar-dgn.sh status

# 6. Install completion (optional)
cp scripts/yl-ar-dgn-completion.bash /etc/bash_completion.d/ 2>/dev/null || \
    echo "Source scripts/yl-ar-dgn-completion.bash in your .bashrc"
```

## IV. Verification Checklist

- [ ] Main entry point created
- [ ] All commands implemented
- [ ] Help text complete
- [ ] Completion script created
- [ ] Basic commands work
- [ ] Error handling works

## V. Next Step

After completing this task, proceed to **Task 4.5: Create Unified Configuration**

View document: `部署/任务跟踪-阶段4-脚本整合-部署任务4.5-创建统一配置.md`
