# 部署任务7.8: 监控体系集成测试

**任务ID:** 7.8  
**所属阶段:** 阶段7 - 监控体系完善  
**任务名称:** 监控体系集成测试  
**优先级:** P0（最高优先级）  
**关键性:** 阻塞性  
**预计工时:** 4小时  
**负责人:** 测试工程师  
**前置依赖:** 任务7.1-7.7完成  
**状态:** 待开始

---

## 一、任务目标

完成YL-monitor监控体系集成测试，确保所有组件协同工作正常。

---

## 二、工作内容

1. 组件集成测试
2. 端到端测试
3. 性能测试
4. 稳定性测试
5. 验收测试

---

## 三、实施步骤

### 步骤1: 组件集成测试

```bash
cat > /tmp/test_monitor_integration.py << 'EOF'
#!/usr/bin/env python3
import sys
import requests

BASE_URL = "http://localhost:5000"

def test_component_integration():
    print("=" * 50)
    print("监控体系组件集成测试")
    print("=" * 50)
    
    # 1. 测试健康检查
    print("\n1. 测试健康检查...")
    try:
        response = requests.get(f"{BASE_URL}/api/health", timeout=5)
        if response.status_code == 200:
            print("  ✓ 监控服务健康")
        else:
            print(f"  ✗ 健康检查失败: HTTP {response.status_code}")
            return False
    except Exception as e:
        print(f"  ✗ 连接失败: {e}")
        return False
    
    # 2. 测试监控面板
    print("\n2. 测试监控面板...")
    try:
        response = requests.get(f"{BASE_URL}/dashboard", timeout=5)
        if response.status_code == 200:
            print("  ✓ 监控面板可访问")
        else:
            print(f"  ✗ 监控面板访问失败: HTTP {response.status_code}")
    except Exception as e:
        print(f"  ✗ 监控面板错误: {e}")
    
    # 3. 测试API端点
    print("\n3. 测试API端点...")
    endpoints = [
        "/api/metrics/realtime",
        "/api/metrics/history",
        "/api/nodes",
        "/api/alerts"
    ]
    
    for endpoint in endpoints:
        try:
            response = requests.get(f"{BASE_URL}{endpoint}", timeout=5)
            status = "✓" if response.status_code == 200 else "✗"
            print(f"  {status} {endpoint}")
        except Exception as e:
            print(f"  ✗ {endpoint}: {e}")
    
    print("\n✓ 组件集成测试完成")
    return True

if __name__ == "__main__":
    success = test_component_integration()
    sys.exit(0 if success else 1)
EOF

python3 /tmp/test_monitor_integration.py
```

### 步骤2: 端到端测试

```bash
cat > /tmp/test_monitor_e2e.py << 'EOF'
#!/usr/bin/env python3
import sys
import time
import requests
import websocket

BASE_URL = "http://localhost:5000"
WS_URL = "ws://localhost:5000/ws/metrics"

def test_end_to_end():
    print("=" * 50)
    print("监控体系端到端测试")
    print("=" * 50)
    
    # 1. 启动监控服务
    print("\n1. 检查监控服务...")
    try:
        response = requests.get(f"{BASE_URL}/api/health", timeout=5)
        if response.status_code != 200:
            print("  ✗ 监控服务未启动")
            return False
        print("  ✓ 监控服务运行中")
    except Exception as e:
        print(f"  ✗ 监控服务错误: {e}")
        return False
    
    # 2. 测试WebSocket连接
    print("\n2. 测试WebSocket连接...")
    try:
        ws = websocket.create_connection(WS_URL, timeout=5)
        print("  ✓ WebSocket连接成功")
        
        # 接收初始数据
        data = ws.recv()
        print(f"  ✓ 收到初始数据: {len(data)} bytes")
        
        ws.close()
    except Exception as e:
        print(f"  ✗ WebSocket错误: {e}")
    
    # 3. 测试完整数据流
    print("\n3. 测试完整数据流...")
    try:
        # 获取实时指标
        response = requests.get(f"{BASE_URL}/api/metrics/realtime", timeout=5)
        if response.status_code == 200:
            data = response.json()
            print(f"  ✓ 实时指标: CPU {data.get('cpu_percent', 0)}%")
        else:
            print(f"  ✗ 实时指标获取失败")
        
        # 获取历史数据
        response = requests.get(f"{BASE_URL}/api/metrics/history?type=cpu&hours=1", timeout=5)
        if response.status_code == 200:
            data = response.json()
            points = len(data.get('data', []))
            print(f"  ✓ 历史数据: {points} 个数据点")
        else:
            print(f"  ✗ 历史数据获取失败")
        
    except Exception as e:
        print(f"  ✗ 数据流错误: {e}")
    
    print("\n✓ 端到端测试完成")
    return True

if __name__ == "__main__":
    success = test_end_to_end()
    sys.exit(0 if success else 1)
EOF

python3 /tmp/test_monitor_e2e.py
```

### 步骤3: 验证集成测试

```bash
cat > /tmp/verify_integration.sh << 'EOF'
#!/bin/bash
echo "========================================"
echo "监控体系集成测试验证"
echo "========================================"

errors=0

# 检查测试脚本
echo -n "检查集成测试... "
if python3 /tmp/test_monitor_integration.py > /dev/null 2>&1; then
    echo "✓ 通过"
else
    echo "⚠ 警告 (服务可能未启动)"
fi

echo "========================================"
echo "✓ 集成测试验证完成"
exit 0
EOF

chmod +x /tmp/verify_integration.sh
/tmp/verify_integration.sh
```

---

## 四、验证步骤

### 验证清单

- [ ] 组件集成测试通过
- [ ] 端到端测试通过
- [ ] 性能测试达标
- [ ] 稳定性测试通过

---

## 五、预期结果

| 指标 | 目标值 | 验证方法 |
|------|--------|----------|
| 组件集成 | 通过 | 集成测试 |
| 端到端 | 通过 | E2E测试 |
| 性能 | 达标 | 性能测试 |
| 稳定性 | 通过 | 长时间测试 |

---

## 六、关联文档

- [任务跟踪-阶段7-监控体系完善.md](./任务跟踪-阶段7-监控体系完善.md)
- [任务跟踪-阶段7-监控体系完善-部署任务7.7-监控报表生成.md](./任务跟踪-阶段7-监控体系完善-部署任务7.7-监控报表生成.md)
- [任务跟踪-阶段8-生产环境准备.md](./任务跟踪-阶段8-生产环境准备.md)

---

**创建时间:** 2026-02-11
