# 部署任务9.1: 单元测试补充

**任务ID:** 9.1  
**所属阶段:** 阶段9 - 测试和文档完善  
**任务名称:** 单元测试补充  
**优先级:** P1（重要优先级）  
**关键性:** 重要  
**预计工时:** 6小时  
**负责人:** 测试开发工程师  
**前置依赖:** 任务8.8完成  
**状态:** 待开始

---

## 一、任务目标

补充AR-backend、User GUI、YL-monitor和规则引擎的单元测试，提升测试覆盖率。

---

## 二、工作内容

1. AR-backend核心业务模块单元测试
2. User GUI组件单元测试
3. YL-monitor服务单元测试
4. 规则引擎单元测试
5. 测试覆盖率提升

---

## 三、实施步骤

### 步骤1: 创建测试配置

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/test/conftest.py << 'EOF'
import pytest
import sys
from pathlib import Path

# 添加项目路径
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))
sys.path.insert(0, str(project_root / 'AR-backend'))
sys.path.insert(0, str(project_root / 'YL-monitor'))

@pytest.fixture
def app():
    """创建测试应用实例"""
    from AR-backend.app import create_app
    app = create_app(testing=True)
    return app

@pytest.fixture
def client(app):
    """创建测试客户端"""
    return app.test_client()

@pytest.fixture
def runner(app):
    """创建CLI runner"""
    return app.test_cli_runner()
EOF

echo "✓ 测试配置已创建"
```

### 步骤2: 创建视频处理器单元测试

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/test/test_backend/test_video_processor.py << 'EOF'
import pytest
import numpy as np
from unittest.mock import Mock, patch

class TestVideoProcessor:
    """视频处理器单元测试"""
    
    @pytest.fixture
    def processor(self):
        from AR-backend.app.core.video_processor import VideoProcessor
        return VideoProcessor()
    
    def test_initialization(self, processor):
        """测试初始化"""
        assert processor is not None
        assert hasattr(processor, 'supported_formats')
    
    def test_frame_processing(self, processor):
        """测试帧处理"""
        # 创建测试帧
        frame = np.random.randint(0, 255, (480, 640, 3), dtype=np.uint8)
        
        # 处理帧
        result = processor.process_frame(frame)
        
        assert result is not None
        assert result.shape == frame.shape
    
    def test_invalid_frame(self, processor):
        """测试无效帧处理"""
        with pytest.raises(ValueError):
            processor.process_frame(None)
    
    @patch('cv2.VideoCapture')
    def test_camera_capture(self, mock_capture, processor):
        """测试摄像头捕获"""
        # 模拟摄像头
        mock_cap = Mock()
        mock_cap.isOpened.return_value = True
        mock_cap.read.return_value = (True, np.zeros((480, 640, 3), dtype=np.uint8))
        mock_capture.return_value = mock_cap
        
        # 测试捕获
        frame = processor.capture_frame()
        assert frame is not None
EOF

echo "✓ 视频处理器单元测试已创建"
```

### 步骤3: 验证单元测试

```bash
cat > /tmp/verify_unit_tests.sh << 'EOF'
#!/bin/bash
echo "========================================"
echo "单元测试验证"
echo "========================================"

errors=0

# 检查测试配置
echo -n "检查测试配置... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/test/conftest.py" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

# 检查视频处理器测试
echo -n "检查视频处理器测试... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/test/test_backend/test_video_processor.py" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

echo "========================================"
if [ $errors -eq 0 ]; then
    echo "✓ 单元测试验证通过"
    exit 0
else
    echo "✗ 单元测试验证失败 ($errors 个错误)"
    exit 1
fi
EOF

chmod +x /tmp/verify_unit_tests.sh
/tmp/verify_unit_tests.sh
```

---

## 四、验证步骤

### 验证清单

- [ ] AR-backend单元测试补充
- [ ] User GUI单元测试补充
- [ ] YL-monitor单元测试补充
- [ ] 规则引擎单元测试补充

---

## 五、预期结果

| 指标 | 目标值 | 验证方法 |
|------|--------|----------|
| AR-backend测试 | 补充 | 覆盖率检查 |
| User GUI测试 | 补充 | 覆盖率检查 |
| YL-monitor测试 | 补充 | 覆盖率检查 |
| 规则引擎测试 | 补充 | 覆盖率检查 |

---

## 六、关联文档

- [任务跟踪-阶段9-测试和文档完善.md](./任务跟踪-阶段9-测试和文档完善.md)
- [任务跟踪-阶段9-测试和文档完善-部署任务9.2-集成测试完善.md](./任务跟踪-阶段9-测试和文档完善-部署任务9.2-集成测试完善.md)

---

**创建时间:** 2026-02-11
