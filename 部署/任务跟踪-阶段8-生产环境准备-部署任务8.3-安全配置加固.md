# 部署任务8.3: 安全配置加固

**任务ID:** 8.3  
**所属阶段:** 阶段8 - 生产环境准备  
**任务名称:** 安全配置加固  
**优先级:** P0（最高优先级）  
**关键性:** 阻塞性  
**预计工时:** 4小时  
**负责人:** 安全工程师  
**前置依赖:** 任务8.2完成  
**状态:** 待开始

---

## 一、任务目标

完成生产环境安全配置加固，包括HTTPS配置、访问控制、安全头部和漏洞扫描。

---

## 二、工作内容

1. HTTPS/TLS配置
2. 访问控制配置
3. 安全头部配置
4. 输入验证加固
5. 安全扫描

---

## 三、实施步骤

### 步骤1: 创建安全中间件

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/AR-backend/app/middleware/security.py << 'EOF'
from flask import request, g
from functools import wraps
import hashlib
import time
import re

class SecurityMiddleware:
    def __init__(self, app=None):
        self.app = app
        if app:
            self.init_app(app)
    
    def init_app(self, app):
        """初始化安全中间件"""
        app.before_request(self.before_request)
        app.after_request(self.after_request)
    
    def before_request(self):
        """请求前处理"""
        # 记录请求时间
        g.start_time = time.time()
        
        # 输入验证
        if not self.validate_input():
            return {"error": "Invalid input"}, 400
        
        # 速率限制检查
        if not self.check_rate_limit():
            return {"error": "Rate limit exceeded"}, 429
    
    def after_request(self, response):
        """响应后处理"""
        # 添加安全头部
        response.headers['X-Content-Type-Options'] = 'nosniff'
        response.headers['X-Frame-Options'] = 'DENY'
        response.headers['X-XSS-Protection'] = '1; mode=block'
        response.headers['Strict-Transport-Security'] = 'max-age=31536000; includeSubDomains'
        response.headers['Content-Security-Policy'] = "default-src 'self'"
        
        # 移除敏感头部
        response.headers.pop('Server', None)
        response.headers.pop('X-Powered-By', None)
        
        return response
    
    def validate_input(self) -> bool:
        """验证输入数据"""
        # 检查SQL注入
        sql_patterns = [
            r'(\%27)|(\')|(\-\-)|(\%23)|(#)',
            r'((\%3D)|(=))[^\n]*((\%27)|(\')|(\-\-)|(\%3B)|(;))',
            r'\w*((\%27)|(\'))((\%6F)|o|(\%4F))((\%72)|r|(\%52))',
            r'((\%27)|(\'))union',
            r'exec(\s|\+)+(s|x)p\w+',
            r'UNION\s+SELECT',
            r'INSERT\s+INTO',
            r'DELETE\s+FROM',
            r'DROP\s+TABLE'
        ]
        
        for pattern in sql_patterns:
            if re.search(pattern, request.url, re.IGNORECASE):
                return False
        
        return True
    
    def check_rate_limit(self) -> bool:
        """检查速率限制"""
        # 简单的速率限制实现
        client_ip = request.remote_addr
        current_time = time.time()
        
        # 这里应该使用Redis等存储来跟踪请求
        # 简化实现，实际生产环境需要更完善的方案
        return True

def require_auth(f):
    """认证装饰器"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        auth_header = request.headers.get('Authorization')
        if not auth_header:
            return {"error": "Authentication required"}, 401
        
        # 验证token
        # 实际实现需要验证JWT或其他token机制
        return f(*args, **kwargs)
    return decorated_function
EOF

echo "✓ 安全中间件已创建"
```

### 步骤2: 创建安全扫描脚本

```bash
cat > /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/security_scan.sh << 'EOF'
#!/bin/bash
echo "========================================"
echo "安全扫描"
echo "========================================"

# 依赖安全扫描
echo "扫描依赖漏洞..."
pip install safety
safety check -r AR-backend/requirements.txt || true
safety check -r YL-monitor/requirements.txt || true

# 代码安全扫描
echo "扫描代码安全问题..."
pip install bandit
bandit -r AR-backend/app -f json -o reports/security/bandit_ar_backend.json || true
bandit -r YL-monitor/app -f json -o reports/security/bandit_yl_monitor.json || true

echo "安全扫描完成"
EOF

chmod +x /home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/security_scan.sh
echo "✓ 安全扫描脚本已创建"
```

### 步骤3: 验证安全配置

```bash
cat > /tmp/verify_security.sh << 'EOF'
#!/bin/bash
echo "========================================"
echo "安全配置验证"
echo "========================================"

errors=0

# 检查安全中间件
echo -n "检查安全中间件... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/AR-backend/app/middleware/security.py" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

# 检查安全扫描脚本
echo -n "检查安全扫描脚本... "
if [ -f "/home/vboxuser/桌面/项目部署/项目1/yl-ar-dgn_clean/scripts/security_scan.sh" ]; then
    echo "✓ 通过"
else
    echo "✗ 失败"
    errors=$((errors + 1))
fi

echo "========================================"
if [ $errors -eq 0 ]; then
    echo "✓ 安全配置验证通过"
    exit 0
else
    echo "✗ 安全配置验证失败 ($errors 个错误)"
    exit 1
fi
EOF

chmod +x /tmp/verify_security.sh
/tmp/verify_security.sh
```

---

## 四、验证步骤

### 验证清单

- [ ] HTTPS配置完成
- [ ] 访问控制配置完成
- [ ] 安全头部配置完成
- [ ] 安全扫描通过

---

## 五、预期结果

| 指标 | 目标值 | 验证方法 |
|------|--------|----------|
| HTTPS | 配置 | 连接测试 |
| 访问控制 | 配置 | 权限测试 |
| 安全头部 | 配置 | 头部检查 |
| 安全扫描 | 通过 | 扫描工具 |

---

## 六、关联文档

- [任务跟踪-阶段8-生产环境准备.md](./任务跟踪-阶段8-生产环境准备.md)
- [任务跟踪-阶段8-生产环境准备-部署任务8.2-生产环境配置.md](./任务跟踪-阶段8-生产环境准备-部署任务8.2-生产环境配置.md)
- [任务跟踪-阶段8-生产环境准备-部署任务8.4-自动化部署脚本.md](./任务跟踪-阶段8-生产环境准备-部署任务8.4-自动化部署脚本.md)

---

**创建时间:** 2026-02-11
