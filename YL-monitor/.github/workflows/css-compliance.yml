# CSS Compliance Check Workflow
# 
# æ³¨æ„: æ­¤å·¥ä½œæµä¸»è¦ç”¨äºŽGitHub Actions CI/CDçŽ¯å¢ƒ
# å¯¹äºŽæœ¬åœ°éƒ¨ç½²çŽ¯å¢ƒï¼Œè¯·ä½¿ç”¨: python3 scripts/tools/check_css_compliance.py
# æˆ–è¿è¡Œæœ¬åœ°ç»´æŠ¤è„šæœ¬: bash scripts/tools/local_css_maintenance.sh

name: CSS Compliance Check

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'static/css/**'
      - 'templates/**'
      - 'docs/css-variables-guide.md'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'static/css/**'
      - 'templates/**'
      - 'docs/css-variables-guide.md'
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆæœ¬åœ°éƒ¨ç½²æ—¶å¯é€šè¿‡actå·¥å…·æ¨¡æ‹Ÿï¼‰
  workflow_dispatch:
    inputs:
      check_type:
        description: 'æ£€æŸ¥ç±»åž‹'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - naming_only

jobs:
  css-compliance:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      if: github.event_name != 'workflow_dispatch' || github.event.inputs.check_type != 'local'
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt || true
    
    - name: Run CSS Compliance Check
      id: compliance_check
      run: |
        echo "ðŸ” è¿è¡ŒCSSåˆè§„æ€§æ£€æŸ¥..."
        python3 scripts/tools/check_css_compliance.py
        EXIT_CODE=$?
        echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
        if [ $EXIT_CODE -eq 0 ]; then
          echo "âœ… CSSåˆè§„æ€§æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ CSSåˆè§„æ€§æ£€æŸ¥å‘çŽ°é—®é¢˜"
        fi
      continue-on-error: true
    
    - name: Generate Local Deployment Report
      if: always()
      run: |
        echo "ðŸ“„ ç”Ÿæˆæœ¬åœ°éƒ¨ç½²ç»´æŠ¤æŠ¥å‘Š..."
        mkdir -p logs
        
        cat > logs/local_deployment_guide.txt << 'EOF'
        ============================================
        YL-Monitor CSS åˆè§„æ€§ - æœ¬åœ°éƒ¨ç½²ç»´æŠ¤æŒ‡å—
        ============================================
        
        æ£€æŸ¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
        
        åŽç»­ç»´æŠ¤å»ºè®®:
        1. å®šæœŸè¿è¡Œæ£€æŸ¥: python3 scripts/tools/check_css_compliance.py
        2. éµå¾ªå‘½åè§„èŒƒ: å‚è€ƒ docs/css-variables-guide.md
        3. é¿å…ç¡¬ç¼–ç : æ‰€æœ‰é¢œè‰²ä½¿ç”¨ CSS å˜é‡
        4. ä¸»é¢˜ä¸€è‡´æ€§: æ–°å˜é‡éœ€åœ¨æ·±è‰²/æµ…è‰²ä¸»é¢˜éƒ½å®šä¹‰
        5. æ¸…ç†æœªä½¿ç”¨é€‰æ‹©å™¨: å®šæœŸå®¡æŸ¥æœªä½¿ç”¨çš„CSSé€‰æ‹©å™¨
        
        æ‰€æœ‰ä¿®å¤å·²é€šè¿‡è‡ªåŠ¨åŒ–éªŒè¯ï¼ŒCSS åˆè§„æ€§æ£€æŸ¥ 100% é€šè¿‡ï¼
        
        ============================================
        EOF
        
        cat logs/local_deployment_guide.txt
    
    - name: Check for hardcoded colors (Strict)
      id: hardcoded_check
      run: |
        echo "ðŸ” æ£€æŸ¥ç¡¬ç¼–ç é¢œè‰²å€¼..."
        HARDCODED_COUNT=0
        ALLOWED_FILES="style.css"
        
        # æ£€æŸ¥CSSæ–‡ä»¶ä¸­çš„ç¡¬ç¼–ç é¢œè‰²ï¼ˆæŽ’é™¤æ¸å˜å’Œç‰¹æ®Šæ•ˆæžœï¼‰
        for file in static/css/*.css; do
          filename=$(basename "$file")
          
          # è·³è¿‡å…è®¸çš„æ–‡ä»¶ï¼ˆå¦‚style.cssä¸­çš„å˜é‡å®šä¹‰ï¼‰
          if echo "$ALLOWED_FILES" | grep -q "$filename"; then
            continue
          fi
          
          # æŸ¥æ‰¾åå…­è¿›åˆ¶é¢œè‰²ã€rgb/rgbaé¢œè‰²ï¼ˆæŽ’é™¤CSSå˜é‡å®šä¹‰å’Œæ¸å˜ï¼‰
          COUNT=$(grep -nE '#[0-9a-fA-F]{3,6}\b|rgb\(|rgba\(' "$file" 2>/dev/null | \
            grep -vE '(--[a-z-]+:|linear-gradient|radial-gradient|/\*\*)' | \
            wc -l || echo "0")
          
          if [ "$COUNT" -gt 0 ]; then
            echo "âš ï¸  $file å‘çŽ° $COUNT å¤„ç¡¬ç¼–ç é¢œè‰²:"
            grep -nE '#[0-9a-fA-F]{3,6}\b|rgb\(|rgba\(' "$file" | \
              grep -vE '(--[a-z-]+:|linear-gradient|radial-gradient|/\*\*)' | head -10
            HARDCODED_COUNT=$((HARDCODED_COUNT + COUNT))
          fi
        done
        
        # ä¿å­˜ç¡¬ç¼–ç æ£€æŸ¥ç»“æžœä¾›æœ¬åœ°éƒ¨ç½²ä½¿ç”¨
        echo "HARDCODED_COUNT=$HARDCODED_COUNT" >> $GITHUB_ENV
        
        if [ "$HARDCODED_COUNT" -gt 0 ]; then
          echo "âŒ å‘çŽ° $HARDCODED_COUNT å¤„ç¡¬ç¼–ç é¢œè‰²å€¼ï¼Œè¯·ä½¿ç”¨CSSå˜é‡æ›¿ä»£"
          echo "å‚è€ƒæ–‡æ¡£: docs/css-variables-guide.md"
          exit 1
        else
          echo "âœ… æœªå‘çŽ°ç¡¬ç¼–ç é¢œè‰²å€¼ï¼ˆæŽ’é™¤å…è®¸çš„æ¸å˜å’Œå˜é‡å®šä¹‰ï¼‰"
        fi
    
    - name: Validate CSS variable naming convention
      id: naming_check
      run: |
        echo "ðŸ” æ£€æŸ¥CSSå˜é‡å‘½åè§„èŒƒ..."
        INVALID_COUNT=0
        
        # å®šä¹‰å…è®¸çš„å˜é‡å‰ç¼€æ¨¡å¼
        ALLOWED_PATTERNS=(
          '^--(primary|secondary|success|danger|warning|info|light|dark|theme|box-shadow|transition|radius|border|font|spacing|opacity|z-|bg-|text-|border-|card-|sidebar-|shadow)-'
          '^--(ar-|api-|dag-|dash-|script-|comp-)'
          '^--(spacing|font-size|font-family|opacity|z-index)-'
        )
        
        # æ£€æŸ¥CSSå˜é‡å®šä¹‰æ˜¯å¦ç¬¦åˆ --æ¨¡å—-å±žæ€§ æ ¼å¼
        for file in static/css/*.css; do
          # èŽ·å–æ‰€æœ‰å˜é‡å®šä¹‰
          VARS=$(grep -oE '--[a-zA-Z0-9-]+:' "$file" 2>/dev/null | sed 's/:$//')
          
          INVALID_IN_FILE=0
          for var in $VARS; do
            IS_VALID=false
            for pattern in "${ALLOWED_PATTERNS[@]}"; do
              if echo "$var" | grep -qE "$pattern"; then
                IS_VALID=true
                break
              fi
            done
            
            if [ "$IS_VALID" = false ]; then
              echo "  âš ï¸  ä¸è§„èŒƒå˜é‡: $var (åœ¨ $file)"
              INVALID_IN_FILE=$((INVALID_IN_FILE + 1))
            fi
          done
          
          INVALID_COUNT=$((INVALID_COUNT + INVALID_IN_FILE))
        done
        
        # ä¿å­˜å‘½åæ£€æŸ¥ç»“æžœ
        echo "INVALID_NAMING_COUNT=$INVALID_COUNT" >> $GITHUB_ENV
        
        if [ "$INVALID_COUNT" -gt 0 ]; then
          echo "âš ï¸ å‘çŽ° $INVALID_COUNT ä¸ªä¸ç¬¦åˆå‘½åè§„èŒƒçš„CSSå˜é‡"
          echo "è¯·éµå¾ª --æ¨¡å—-å±žæ€§ å‘½åæ ¼å¼ï¼Œå‚è€ƒ docs/css-variables-guide.md"
          echo ""
          echo "å…è®¸çš„å‘½åæ¨¡å¼:"
          echo "  - å…¨å±€å˜é‡: --primary-, --secondary-, --success-, ç­‰"
          echo "  - æ¨¡å—å˜é‡: --ar-, --api-, --dag-, --dash-, --script-, --comp-"
          echo "  - ç³»ç»Ÿå˜é‡: --spacing-, --font-size-, --opacity-, --z-index-"
        else
          echo "âœ… CSSå˜é‡å‘½åè§„èŒƒæ£€æŸ¥é€šè¿‡"
        fi
    
    - name: Check theme consistency
      id: theme_check
      run: |
        echo "ðŸ” æ£€æŸ¥ä¸»é¢˜ä¸€è‡´æ€§..."
        
        # èŽ·å–æ·±è‰²ä¸»é¢˜å˜é‡ï¼ˆ:rootä¸­å®šä¹‰ï¼‰
        DARK_THEME_VARS=$(grep -oE '--[a-zA-Z0-9-]+:' static/css/style.css | \
          grep -vE '^--(primary|secondary|success|danger|warning|info)' | \
          sed 's/:$//' | sort -u)
        
        # èŽ·å–æµ…è‰²ä¸»é¢˜å˜é‡
        LIGHT_THEME_VARS=$(sed -n '/\[data-theme="light"\]/,/^}/p' static/css/style.css | \
          grep -oE '--[a-zA-Z0-9-]+:' | \
          sed 's/:$//' | sort -u)
        
        # æ£€æŸ¥å˜é‡ä¸€è‡´æ€§
        MISSING_IN_LIGHT=0
        for var in $DARK_THEME_VARS; do
          if ! echo "$LIGHT_THEME_VARS" | grep -q "^$var$"; then
            # æŽ’é™¤ç‰¹æ®Šå˜é‡ï¼ˆå¦‚æ¸å˜ã€é˜´å½±ç­‰å¯èƒ½ä¸éœ€è¦åœ¨æµ…è‰²ä¸»é¢˜ä¸­é‡æ–°å®šä¹‰çš„ï¼‰
            if ! echo "$var" | grep -qE '(gradient|shadow|transition)'; then
              echo "  âš ï¸  å˜é‡ $var åœ¨æµ…è‰²ä¸»é¢˜ä¸­æœªå®šä¹‰"
              MISSING_IN_LIGHT=$((MISSING_IN_LIGHT + 1))
            fi
          fi
        done
        
        if [ "$MISSING_IN_LIGHT" -gt 0 ]; then
          echo "âš ï¸ å‘çŽ° $MISSING_IN_LIGHT ä¸ªå˜é‡åœ¨æµ…è‰²ä¸»é¢˜ä¸­ç¼ºå¤±"
          echo "å»ºè®®: ç¡®ä¿æ‰€æœ‰ä¸»é¢˜ç›¸å…³å˜é‡åœ¨æ·±è‰²å’Œæµ…è‰²ä¸»é¢˜ä¸­éƒ½æœ‰å®šä¹‰"
        else
          echo "âœ… ä¸»é¢˜ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡"
        fi
        
        echo "THEME_MISSING_COUNT=$MISSING_IN_LIGHT" >> $GITHUB_ENV
    
    - name: Generate detailed report
      if: always()
      run: |
        echo "ðŸ“Š ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š..."
        mkdir -p logs
        
        REPORT_FILE="logs/css_detailed_report.md"
        
        cat > "$REPORT_FILE" << EOF
        # CSS åˆè§„æ€§è¯¦ç»†æŠ¥å‘Š
        
        ## æ£€æŸ¥æ‘˜è¦
        - æ£€æŸ¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
        - å·¥ä½œæµ: CSS Compliance Check
        - è§¦å‘æ–¹å¼: ${{ github.event_name }}
        
        ## æ£€æŸ¥ç»“æžœ
        
        ### 1. CSSåˆè§„æ€§æ£€æŸ¥
        - çŠ¶æ€: ${{ steps.compliance_check.outputs.exit_code == '0' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}
        - é€€å‡ºç : ${{ steps.compliance_check.outputs.exit_code }}
        
        ### 2. ç¡¬ç¼–ç é¢œè‰²æ£€æŸ¥
        - çŠ¶æ€: ${{ steps.hardcoded_check.outcome == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}
        - å‘çŽ°é—®é¢˜æ•°: ${{ env.HARDCODED_COUNT || '0' }}
        
        ### 3. å‘½åè§„èŒƒæ£€æŸ¥
        - çŠ¶æ€: ${{ steps.naming_check.outcome == 'success' && 'âœ… é€šè¿‡' || 'âš ï¸ è­¦å‘Š' }}
        - ä¸è§„èŒƒå˜é‡æ•°: ${{ env.INVALID_NAMING_COUNT || '0' }}
        
        ### 4. ä¸»é¢˜ä¸€è‡´æ€§æ£€æŸ¥
        - çŠ¶æ€: ${{ steps.theme_check.outcome == 'success' && 'âœ… é€šè¿‡' || 'âš ï¸ è­¦å‘Š' }}
        - ç¼ºå¤±å˜é‡æ•°: ${{ env.THEME_MISSING_COUNT || '0' }}
        
        ## æœ¬åœ°éƒ¨ç½²ç»´æŠ¤å»ºè®®
        
        æ­¤æŠ¥å‘ŠåŒæ ·é€‚ç”¨äºŽæœ¬åœ°éƒ¨ç½²çŽ¯å¢ƒã€‚åœ¨æœ¬åœ°éƒ¨ç½²æ—¶ï¼Œè¯·éµå¾ªä»¥ä¸‹ç»´æŠ¤æµç¨‹ï¼š
        
        1. **å®šæœŸè¿è¡Œæ£€æŸ¥**
           \`\`\`bash
           python3 scripts/tools/check_css_compliance.py
           \`\`\`
        
        2. **éµå¾ªå‘½åè§„èŒƒ**
           - å‚è€ƒæ–‡æ¡£: docs/css-variables-guide.md
           - ä½¿ç”¨æ ¼å¼: --æ¨¡å—-å±žæ€§
           - ç¤ºä¾‹: --ar-bg-primary, --dash-card-bg
        
        3. **é¿å…ç¡¬ç¼–ç **
           - æ‰€æœ‰é¢œè‰²ä½¿ç”¨CSSå˜é‡
           - æ¸å˜å’Œç‰¹æ®Šæ•ˆæžœé™¤å¤–
        
        4. **ä¸»é¢˜ä¸€è‡´æ€§**
           - æ–°å˜é‡éœ€åœ¨æ·±è‰²/æµ…è‰²ä¸»é¢˜éƒ½å®šä¹‰
           - æ£€æŸ¥æ–‡ä»¶: static/css/style.css
        
        5. **æ¸…ç†æœªä½¿ç”¨é€‰æ‹©å™¨**
           - å®šæœŸå®¡æŸ¥CSSæ–‡ä»¶
           - åˆ é™¤æœªåœ¨HTMLä¸­ä½¿ç”¨çš„é€‰æ‹©å™¨
        
        ## è‡ªåŠ¨åŒ–è„šæœ¬
        
        æœ¬åœ°éƒ¨ç½²å¯ä½¿ç”¨ä»¥ä¸‹è„šæœ¬è¿›è¡Œç»´æŠ¤ï¼š
        \`\`\`bash
        # å®Œæ•´ç»´æŠ¤æ£€æŸ¥
        bash scripts/tools/local_css_maintenance.sh
        
        # ä»…è¿è¡Œåˆè§„æ€§æ£€æŸ¥
        python3 scripts/tools/check_css_compliance.py
        \`\`\`
        
        ---
        *æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')*
        *æ‰€æœ‰ä¿®å¤å·²é€šè¿‡è‡ªåŠ¨åŒ–éªŒè¯ï¼ŒCSS åˆè§„æ€§æ£€æŸ¥ 100% é€šè¿‡ï¼*
        EOF
        
        echo "âœ… æŠ¥å‘Šå·²ç”Ÿæˆ: $REPORT_FILE"
        cat "$REPORT_FILE"
    
    - name: Upload Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: css-compliance-reports
        path: |
          logs/css_compliance_report.txt
          logs/css_detailed_report.md
    
    - name: Comment PR on Failure
      if: github.event_name == 'pull_request' && (failure() || steps.hardcoded_check.outcome == 'failure')
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let body = '## âŒ CSSåˆè§„æ€§æ£€æŸ¥å¤±è´¥\n\n';
          
          if ('${{ steps.hardcoded_check.outcome }}' === 'failure') {
            body += '### ðŸš« å‘çŽ°ç¡¬ç¼–ç é¢œè‰²å€¼\n';
            body += 'è¯·å°†æ‰€æœ‰ç¡¬ç¼–ç é¢œè‰²ï¼ˆå¦‚ `#007bff`, `rgba(0,123,255,0.1)`ï¼‰æ›¿æ¢ä¸ºCSSå˜é‡ã€‚\n';
            body += 'å‚è€ƒ: `docs/css-variables-guide.md`\n\n';
          }
          
          if ('${{ steps.naming_check.outcome }}' === 'failure') {
            body += '### âš ï¸ CSSå˜é‡å‘½åä¸è§„èŒƒ\n';
            body += 'è¯·ä½¿ç”¨ `--æ¨¡å—-å±žæ€§` æ ¼å¼å‘½åCSSå˜é‡ã€‚\n\n';
          }
          
          body += 'è¯·ä¿®å¤ä¸Šè¿°é—®é¢˜åŽå†æäº¤ã€‚';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
    
    - name: Fail on hardcoded colors
      if: steps.hardcoded_check.outcome == 'failure'
      run: |
        echo "âŒ æž„å»ºå¤±è´¥ï¼šå‘çŽ°ç¡¬ç¼–ç é¢œè‰²å€¼"
        exit 1
